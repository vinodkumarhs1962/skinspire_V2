{% extends "layouts/dashboard.html" %}

{% block title %}Create Purchase Order{% endblock %}

{% block styles %}
{{ super() }}
<!-- Purchase Order Enhanced Styles -->
<style>
    /* Force two-column layout */
    .po-two-column-grid {
        display: grid !important;
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        gap: 1rem !important;
        width: 100% !important;
    }
    
    @media (max-width: 768px) {
        .po-two-column-grid {
            grid-template-columns: 1fr !important;
        }
    }
    
    /* Single row for compact fields */
    .po-compact-row {
        display: grid !important;
        grid-template-columns: repeat(4, minmax(0, 1fr)) !important;
        gap: 1rem !important;
        padding: 1rem !important;
        background: #e5e7eb !important; /* Darker background for non-editable fields */
        border-radius: 0.5rem !important;
        margin-bottom: 1rem !important;
        width: 100% !important;
    }
    
    @media (max-width: 768px) {
        .po-compact-row {
            grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        }
    }
    
    .dark .po-compact-row {
        background: rgb(31 41 55) !important; /* Darker in dark mode */
    }
    
    /* Compact field display */
    .compact-field {
        background: white !important;
        border: 1px solid #d1d5db !important;
        border-radius: 0.375rem !important;
        padding: 0.5rem 0.75rem !important;
        font-size: 0.875rem !important;
        color: #6b7280 !important;
        width: 100% !important;
    }
    
    .dark .compact-field {
        background: rgb(55 65 81) !important;
        border-color: rgb(75 85 99) !important;
        color: #9ca3af !important;
    }
    
    /* Container styles */
    .po-enhanced-container {
        background: #f3f4f6;
        min-height: 100vh;
        padding: 0;
        margin: -1.5rem;
    }
    
    .dark .po-enhanced-container {
        background: #0f172a;
    }
    
    /* Header styling following Universal View pattern */
    .po-header {
        background: white;
        padding: 1.5rem;
        margin-bottom: 0;
        position: relative;
    }
    
    .dark .po-header {
        background: rgb(31 41 55);
    }
    
    /* Badge styling to match Universal View */
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    .badge-info {
        background-color: rgb(219 234 254);
        color: rgb(30 64 175);
        border: 1px solid rgb(147 197 253);
    }
    
    .dark .badge-info {
        background-color: rgba(59, 130, 246, 0.2);
        color: rgb(147 197 253);
        border-color: rgb(59 130 246);
    }
    
    /* Quick actions bar */
    .quick-actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem 1.5rem;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 1rem;
    }
    
    .dark .quick-actions-bar {
        background: rgb(31 41 55);
        border-bottom-color: rgb(55 65 81);
    }
    
    .quick-actions-left {
        display: flex;
        gap: 0.5rem;
    }
    
    /* Line Items Table */
    .line-items-section {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 0;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }
    
    .dark .line-items-section {
        background: rgb(31 41 55);
    }
    
    /* Table footer totals */
    .table-footer-totals {
        background: #f9fafb;
        border-top: 2px solid #e5e7eb;
    }
    
    .dark .table-footer-totals {
        background: rgb(55 65 81);
        border-top-color: rgb(75 85 99);
    }
    
    .grand-total-row {
        background: linear-gradient(135deg, rgb(239 246 255) 0%, rgb(219 234 254) 100%);
        font-size: 1.125rem;
    }
    
    .dark .grand-total-row {
        background: linear-gradient(135deg, rgba(30, 58, 138, 0.3) 0%, rgba(59, 130, 246, 0.2) 100%);
    }
    
    /* Bottom action buttons */
    .bottom-actions {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding: 1.5rem;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        gap: 0.75rem;
    }
    
    .dark .bottom-actions {
        background: rgb(31 41 55);
    }
    
    /* Override form styles */
    .universal-form-group {
        margin-bottom: 1rem !important;
    }
    
    .universal-form-label {
        display: block !important;
        margin-bottom: 0.25rem !important;
        font-size: 0.875rem !important;
        font-weight: 500 !important;
        color: rgb(55 65 81) !important;
    }
    
    .dark .universal-form-label {
        color: rgb(209 213 219) !important;
    }
    .po-header-right {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="po-enhanced-container">
    <!-- Page Header following Universal View pattern -->
    <div class="po-header">
        <!-- Info card style header matching Universal View -->
        <div class="info-card" style="box-shadow: none; border: none; margin: 0;">
            <div class="card-body" style="padding: 0; background: transparent;">
                <!-- Row 1: Title and Date/Status -->
                <div class="flex justify-between items-start mb-3">
                    <div style="max-width: 60%;">
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                            <i class="fas fa-file-invoice text-blue-500"></i>
                            <span class="ml-2">{{ page_title }}</span>
                        </h1>
                        <p class="text-gray-600 dark:text-gray-400 mt-1" style="font-style: italic; font-size: 1.125rem; padding-left: 2.5rem;">
                            Create draft purchase order for a supplier
                        </p>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem; padding-right: 1rem;">
                        <span class="badge badge-info">Draft</span>
                        <div style="text-align: right;">
                            <div class="text-gray-600 dark:text-gray-400">
                                <i class="fas fa-calendar text-gray-500"></i>
                                <span class="ml-1 font-bold text-base">{{ current_date|default(today, true)|default('14 Sep 2025', true) }}</span>
                            </div>
                            <div class="text-gray-500 dark:text-gray-400 mt-1 font-bold text-sm">
                                {{ current_date|default(today, true)|date('l') if current_date else 'Sunday' }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 2: Breadcrumb only -->
                <div class="mb-3">
                    <nav class="flex items-center space-x-1 text-sm text-gray-500">
                        <a href="{{ url_for('auth_views.dashboard') }}" class="hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                            Dashboard
                        </a>
                        <span class="text-gray-400 mx-2">/</span>
                        <a href="{{ url_for('universal_views.universal_list_view', entity_type='purchase_orders') }}" class="hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                            Purchase Orders
                        </a>
                        <span class="text-gray-400 mx-2">/</span>
                        <span class="text-gray-700 dark:text-gray-300 font-medium">Create New</span>
                    </nav>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions Bar with all buttons in one row -->
    <div class="quick-actions-bar">
        <div class="quick-actions-left">
            <!-- Standard Back Button (Always First) -->
            <button onclick="window.history.back()" type="button" class="btn-back">
                <i class="fas fa-arrow-left icon-left"></i>Back
            </button>
            <a href="{{ url_for('universal_views.universal_list_view', entity_type='purchase_orders') }}" class="btn-outline">
                <i class="fas fa-list mr-2"></i>
                Purchase Orders
            </a>
            <a href="{{ url_for('universal_views.universal_list_view', entity_type='suppliers') }}" class="btn-outline">
                <i class="fas fa-users mr-2"></i>
                Suppliers
            </a>
            <a href="{{ url_for('universal_views.universal_list_view', entity_type='supplier_invoices') }}" class="btn-outline">
                <i class="fas fa-file-invoice mr-2"></i>
                Invoices
            </a>
            <a href="{{ url_for('universal_views.universal_list_view', entity_type='supplier_payments') }}" class="btn-outline">
                <i class="fas fa-money-bill mr-2"></i>
                Payments
            </a>
        </div>
        <button type="button" onclick="document.getElementById('purchase-order-form').reset()" class="btn-outline">
            <i class="fas fa-undo mr-2"></i>
            Reset Form
        </button>
    </div>

    <div class="px-6">
        <form id="purchase-order-form" method="POST" action="{{ url_for('supplier_views.add_purchase_order') }}" class="space-y-6">
            {{ form.csrf_token }}
            
            <!-- Hidden PO Number field -->
            <input type="hidden" name="po_number" id="po_number" value="{{ form.po_number.data }}">
            
            <!-- Section 1: Basic Information -->
            <div class="universal-filter-card">
                <div class="universal-filter-card-header">
                    <h3 class="universal-filter-card-title">
                        <i class="fas fa-info-circle"></i>
                        Basic Information
                    </h3>
                </div>
                
                <div class="universal-filter-card-body">
                    <div class="po-two-column-grid">
                        <!-- Left Column -->
                        <div>
                            <!-- Supplier Selection -->
                            <div class="universal-form-group">
                                <label class="universal-form-label" for="{{ form.supplier_id.id }}">
                                    Supplier <span class="text-red-500">*</span>
                                </label>
                                <select id="supplier_id" name="supplier_id" 
                                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                        required>
                                    <option value="">Select Supplier</option>
                                    {% for supplier in suppliers %}
                                    <option value="{{ supplier.supplier_id }}" 
                                            data-gst="{{ supplier.gst_registration_number }}"
                                            data-state="{{ supplier.state_code }}"
                                            data-payment-terms="{{ supplier.payment_terms }}">
                                        {{ supplier.supplier_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- PO Date -->
                            <div class="universal-form-group">
                                <label class="universal-form-label" for="{{ form.po_date.id }}">
                                    PO Date <span class="text-red-500">*</span>
                                </label>
                                {{ form.po_date(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline") }}
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div>
                            <!-- Hidden branch field -->
                            <input type="hidden" name="branch_id" value="{{ current_user.branch_id if current_user.branch_id else '' }}">
                            
                            <!-- Expected Delivery Date -->
                            <div class="universal-form-group">
                                <label class="universal-form-label" for="{{ form.expected_delivery_date.id }}">
                                    Expected Delivery
                                </label>
                                {{ form.expected_delivery_date(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline") }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden Supplier Info -->
                    <div class="hidden">
                        <input type="hidden" id="supplier-gst-value" value="">
                        <input type="hidden" id="supplier-state-value" value="">
                        <input type="hidden" id="supplier-terms-value" value="">
                    </div>
                </div>
            </div>

            <!-- Section 2: Reference Information -->
            <div class="universal-filter-card">
                <div class="universal-filter-card-header">
                    <h3 class="universal-filter-card-title">
                        <i class="fas fa-file-alt"></i>
                        Reference Information
                    </h3>
                    <span class="text-sm text-gray-500">Optional</span>
                </div>
                
                <div class="universal-filter-card-body">
                    <!-- Non-editing fields in single row with darker background -->
                    <div class="po-compact-row">
                        <div>
                            <label class="text-xs text-gray-600 dark:text-gray-400 block mb-1">Currency</label>
                            <div class="compact-field">INR</div>
                            <input type="hidden" name="currency_code" value="INR">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600 dark:text-gray-400 block mb-1">Exchange Rate</label>
                            <div class="compact-field">1.000000</div>
                            <input type="hidden" name="exchange_rate" value="1.000000">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600 dark:text-gray-400 block mb-1">Status</label>
                            <div class="compact-field">Draft</div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-600 dark:text-gray-400 block mb-1">Created By</label>
                            <div class="compact-field">{{ current_user.username if current_user else 'System' }}</div>
                        </div>
                    </div>
                    
                    <!-- Editable fields -->
                    <div class="po-two-column-grid">
                        <div class="universal-form-group">
                            <label class="universal-form-label" for="{{ form.quotation_id.id }}">
                                Quotation Reference
                            </label>
                            {{ form.quotation_id(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline", placeholder="Enter reference") }}
                        </div>
                        
                        <div class="universal-form-group">
                            <label class="universal-form-label" for="{{ form.quotation_date.id }}">
                                Quotation Date
                            </label>
                            {{ form.quotation_date(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline") }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Line Items -->
            <div class="line-items-section">
                <div class="universal-filter-card-header">
                    <h3 class="universal-filter-card-title">
                        <i class="fas fa-list"></i>
                        Line Items
                    </h3>
                    <button type="button" id="add-line-item" class="btn-primary btn-primary">
                        <i class="fas fa-plus mr-2"></i>Add Item
                    </button>
                </div>
                
                <div class="p-0">
                    <table class="universal-table w-full">
                        <thead class="universal-table-header">
                            <tr>
                                <th class="text-center w-12">#</th>
                                <th class="w-2/5">Medicine</th>
                                <th class="text-right w-18">Qty</th>
                                <th class="text-right w-24">Rate</th>
                                <th class="text-right w-24">MRP</th>
                                <th class="text-right w-20">Disc%</th>  <!-- NEW COLUMN -->
                                <th class="text-center w-20">GST%</th>
                                <th class="text-center w-16">Free</th>
                                <th class="text-right w-32">Amount</th>
                                <th class="text-center w-16">Action</th>
                            </tr>
                        </thead>
                        <tbody id="line-items-container" class="universal-table-body"></tbody>
                        <tfoot class="table-footer-totals">
                            <tr>
                                <td colspan="8" class="text-right font-semibold px-4 py-2">Subtotal:</td>
                                <td class="text-right font-semibold px-4 py-2">
                                    <span class="currency-symbol">{{ hospital_currency.symbol }}</span>
                                    <span id="subtotal-display">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                            <!-- NEW: Discount Row -->
                            <tr id="discount-row" style="display: none;">
                                <td colspan="8" class="text-right font-semibold px-4 py-2">Total Discount:</td>
                                <td class="text-right font-semibold px-4 py-2 text-red-600">
                                    <span class="currency-symbol">{{ hospital_currency.symbol }}</span>
                                    <span id="discount-display">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="8" class="text-right font-semibold px-4 py-2">Total GST:</td>
                                <td class="text-right font-semibold px-4 py-2">
                                    <span class="currency-symbol">{{ hospital_currency.symbol }}</span>
                                    <span id="total-gst-display">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                            <tr class="grand-total-row">
                                <td colspan="8" class="text-right font-bold text-base px-4 py-3">Grand Total:</td>
                                <td class="text-right font-bold text-base text-blue-600 dark:text-blue-400 px-4 py-3">
                                    <span class="currency-symbol text-base">{{ hospital_currency.symbol }}</span>
                                    <span id="grand-total-display" class="text-base">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Section 4: Additional Information -->
            <div class="universal-filter-card">
                <div class="universal-filter-card-header">
                    <h3 class="universal-filter-card-title">
                        <i class="fas fa-file-alt"></i>
                        Additional Information
                    </h3>
                </div>
                
                <div id="additional-info-content" class="universal-filter-card-body">
                    <div class="po-two-column-grid">
                        <div class="universal-form-group">
                            <label class="universal-form-label" for="{{ form.delivery_instructions.id }}">
                                Delivery Instructions
                            </label>
                            {{ form.delivery_instructions(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline", rows=4) }}
                        </div>
                        
                        <div class="universal-form-group">
                            <label class="universal-form-label" for="{{ form.terms_conditions.id }}">
                                Terms and Conditions
                            </label>
                            {{ form.terms_conditions(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline", rows=4) }}
                        </div>
                    </div>
                    
                    <div class="universal-form-group mt-4">
                        <label class="universal-form-label" for="{{ form.notes.id }}">
                            Internal Notes
                        </label>
                        {{ form.notes(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline", rows=3) }}
                    </div>
                </div>
            </div>

            <!-- Hidden fields for line items data -->
            <div class="hidden">
                {{ form.medicine_ids }}
                {{ form.medicine_names }}
                {{ form.quantities }}
                {{ form.pack_purchase_prices }}
                {{ form.pack_mrps }}
                {{ form.units_per_packs }}
                {{ form.hsn_codes }}
                {{ form.gst_rates }}
                {{ form.cgst_rates }}
                {{ form.sgst_rates }}
                {{ form.igst_rates }}
                {{ form.discount_percents }}
                {{ form.is_free_items }}
            </div>
        </form>

        <!-- Bottom Action Buttons (only Create button) -->
        <div class="bottom-actions">
            <a href="{{ url_for('universal_views.universal_list_view', entity_type='purchase_orders') }}" class="btn-secondary">
                <i class="fas fa-times mr-2"></i>
                Cancel
            </a>
            <button type="submit" form="purchase-order-form" name="save_draft" value="1" class="btn-primary">
                <i class="fas fa-check mr-2"></i>
                Create Purchase Order
            </button>
        </div>
    </div>
</div>

<!-- Line Item Template -->
<template id="line-item-template">
    <tr class="line-item-row universal-table-row hover:bg-gray-50 dark:hover:bg-gray-700">
        <td class="text-center px-2 py-2">
            <span class="line-number text-sm font-medium">1</span>
        </td>
        <td class="px-2 py-2">
            <select class="medicine-select form-select text-sm w-full border rounded px-2 py-1" required>
                <option value="">Select Medicine</option>
                {% for medicine in medicines %}
                <option value="{{ medicine.medicine_id }}" 
                        data-gst="{{ medicine.gst_rate or 0 }}"
                        data-hsn="{{ medicine.hsn_code or '' }}"
                        data-pack-size="{{ medicine.pack_size or 1 }}"
                        data-mrp="{{ medicine.mrp or 0 }}"
                        data-last-purchase="{{ medicine.last_purchase_price or 0 }}">  <!-- NEW ATTRIBUTES -->
                    {{ medicine.medicine_name }}
                    {% if medicine.strength %} - {{ medicine.strength }}{% endif %}
                </option>
                {% endfor %}
            </select>
        </td>
        <td class="px-2 py-2">
            <input type="number" class="quantity form-input text-sm w-full text-right border rounded px-2 py-1" 
                   min="0" step="1" placeholder="0" required>
        </td>
        <td class="px-2 py-2">
            <div class="flex items-center">
                <span class="absolute left-2 text-gray-500 text-sm">{{ hospital_currency.symbol|default('₹') }}</span>
                <input type="number" class="rate form-input text-sm flex-1 text-right border rounded px-2 py-1" 
                       min="0" step="0.01" placeholder="0.00" required>
            </div>
        </td>
        <td class="px-2 py-2">
            <div class="flex items-center">
                <span class="absolute left-2 text-gray-500 text-sm">{{ hospital_currency.symbol|default('₹') }}</span>
                <input type="number" class="mrp form-input text-sm flex-1 text-right border rounded px-2 py-1" 
                       min="0" step="0.01" placeholder="0.00">
            </div>
        </td>
        <td class="px-2 py-2">  <!-- NEW DISCOUNT FIELD -->
            <input type="number" class="discount-percent form-input text-sm w-full text-right border rounded px-2 py-1" 
                   min="0" max="100" step="0.01" placeholder="0" value="0">
        </td>
        <td class="text-center px-2 py-2">
            <span class="gst-rate text-sm">0%</span>
        </td>
        <td class="text-center px-2 py-2">
            <input type="checkbox" class="is-free-item">
        </td>
        <td class="text-right px-4 py-2">
            <div class="line-total font-semibold text-sm">
                <span class="currency-symbol">{{ hospital_currency.symbol|default('₹') }}</span> <span class="amount-value">0.00</span>
            </div>
            <div class="text-xs text-gray-500 gst-details mt-1"></div>
        </td>
        <td class="text-center px-2 py-2">
            <button type="button" class="remove-line-item btn-danger btn-sm btn-icon-only" title="Remove item">
                <i class="fas fa-trash"></i>
            </button>
        </td>
        <input type="hidden" class="units-per-pack" value="1">
        <input type="hidden" class="hsn-code" value="">
    </tr>
</template>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/components/form_handler.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/universal_dropdown_search_adapter.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let lineItemIndex = 0;
    let currentSupplierId = '';
    let currentSupplierStateCode = '';
    let hospitalStateCode = '{{ hospital_state_code|default("29") }}';
    
    // Initialize form handler
    const formHandler = new FormHandler({
        formSelector: '#purchase-order-form',
        validations: [
            {
                field: '#supplier_id',
                rules: [function(fieldEl) { 
                    return !fieldEl.value ? 'Supplier is required' : null; 
                }]
            }
        ]
    });
    
    // Supplier selection handler
    document.getElementById('supplier_id').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        
        if (selectedOption.value) {
            currentSupplierId = selectedOption.value;
            currentSupplierStateCode = selectedOption.dataset.state || '';
            
            // Store in hidden fields
            document.getElementById('supplier-gst-value').value = selectedOption.dataset.gst || '';
            document.getElementById('supplier-state-value').value = selectedOption.dataset.state || '';
            document.getElementById('supplier-terms-value').value = selectedOption.dataset.paymentTerms || '';
        }
    });
    
    // Add line item handler
    document.getElementById('add-line-item').addEventListener('click', function() {
        const template = document.getElementById('line-item-template');
        const clone = template.content.cloneNode(true);
        
        lineItemIndex++;
        const row = clone.querySelector('tr');
        row.dataset.index = lineItemIndex;
        
        clone.querySelector('.line-number').textContent = lineItemIndex;
        
        document.getElementById('line-items-container').appendChild(clone);
        
        const newRow = document.querySelector(`tr[data-index="${lineItemIndex}"]`);
        attachLineItemHandlers(newRow);
        
        updateTotals();
    });
    
    // Attach event handlers to line item row
    function attachLineItemHandlers(row) {
        const medicineSelect = row.querySelector('.medicine-select');
        // Manually initialize Universal Dropdown for this new medicine select
        if (window.UniversalDropdownAdapter && medicineSelect) {
            window.UniversalDropdownAdapter.initializeElement(medicineSelect, 'medicines', {
                apiBaseUrl: '/api/universal',  // ✅ Explicitly set API base URL
                minSearchLength: 2,
                maxResults: 30
            });
        }
        // Medicine selection handler - Compatible with Universal Dropdown
        async function handleMedicineSelection() {
            const selectedOption = medicineSelect.options[medicineSelect.selectedIndex];
            if (selectedOption && selectedOption.value) {
                // Auto-populate MRP if available
                const mrpValue = selectedOption.dataset.mrp || selectedOption.dataset.lastMrp || '0';
                const mrpInput = row.querySelector('.mrp');
                if (mrpInput && mrpValue !== '0') {
                    mrpInput.value = mrpValue;
                }
                
                // Auto-populate rate/purchase price if available
                const lastPurchase = selectedOption.dataset.lastPurchase || '0';
                const rateInput = row.querySelector('.rate');
                if (rateInput && lastPurchase !== '0' && parseFloat(lastPurchase) > 0) {
                    rateInput.value = lastPurchase;
                }
                
                // Get GST from data attribute
                let gstRate = parseFloat(selectedOption.dataset.gstRate) || parseFloat(selectedOption.dataset.gst) || 0;
                
                // If GST is 0, try to fetch from backend
                if (gstRate === 0 && selectedOption.dataset.medicineId) {
                    try {
                        const response = await fetch(`/supplier/api/medicine/${selectedOption.dataset.medicineId}/gst-info`);
                        if (response.ok) {
                            const data = await response.json();
                            gstRate = data.gst_rate || 12.0;
                        } else {
                            gstRate = 12.0;
                        }
                    } catch (error) {
                        console.error('Error fetching GST:', error);
                        gstRate = 12.0;
                    }
                }
                
                // Update GST display
                const gstRateElement = row.querySelector('.gst-rate');
                gstRateElement.textContent = gstRate.toFixed(1) + '%';
                gstRateElement.dataset.rate = gstRate;
                
                // Update other fields
                row.querySelector('.units-per-pack').value = selectedOption.dataset.packSize || 1;
                row.querySelector('.hsn-code').value = selectedOption.dataset.hsn || '';
                
                calculateLineTotal(row);
            } else {
                // Clear GST display when no medicine selected
                const gstRateElement = row.querySelector('.gst-rate');
                gstRateElement.textContent = '0%';
                gstRateElement.dataset.rate = 0;
                calculateLineTotal(row);
            }
        }
        
        // Regular change event for fallback
        medicineSelect.addEventListener('change', handleMedicineSelection);
        
        // Universal Dropdown compatibility - watch for value changes
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                    handleMedicineSelection();
                }
            });
        });
        observer.observe(medicineSelect, { attributes: true, attributeFilter: ['value'] });
        
        // Also watch for option changes in case Universal Dropdown modifies options
        const selectObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList' || 
                    (mutation.type === 'attributes' && mutation.attributeName === 'selected')) {
                    handleMedicineSelection();
                }
            });
        });
        selectObserver.observe(medicineSelect, { 
            childList: true, 
            attributes: true, 
            attributeFilter: ['selected'],
            subtree: true 
        });
        
        // Add input handlers for quantity, rate, mrp, discount
        ['quantity', 'rate', 'mrp', 'discount-percent'].forEach(field => {
            const input = row.querySelector(`.${field}`);
            if (input) {
                input.addEventListener('input', () => {
                    if (field === 'discount-percent') {
                        const value = parseFloat(input.value) || 0;
                        if (value > 100) input.value = 100;
                        if (value < 0) input.value = 0;
                    }
                    calculateLineTotal(row);
                });
            }
        });
        
        // Add handler for free item checkbox
        const freeItemCheckbox = row.querySelector('.is-free-item');
        if (freeItemCheckbox) {
            freeItemCheckbox.addEventListener('change', function() {
                calculateLineTotal(row);
            });
        }
        
        // Add remove handler
        const removeBtn = row.querySelector('.remove-line-item');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                if (confirm('Remove this item?')) {
                    row.remove();
                    updateRowNumbers();
                    updateTotals();
                }
            });
        }
    }
    
    // Calculate line total with GST
    function calculateLineTotal(row) {
        const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
        const rate = parseFloat(row.querySelector('.rate').value) || 0;
        const discountPercent = parseFloat(row.querySelector('.discount-percent').value) || 0;
        const gstRate = parseFloat(row.querySelector('.gst-rate').dataset.rate) || 0;
        const isFree = row.querySelector('.is-free-item').checked;
        
        // Step 1: Calculate base amount (quantity × rate)
        let baseAmount = quantity * rate;
        
        // Step 2: Calculate GST on ORIGINAL rate (before discount)
        let gstAmount = (baseAmount * gstRate) / 100;  // GST on full amount
        
        // Step 3: Calculate discount on base amount
        let discountAmount = (baseAmount * discountPercent) / 100;
        
        // Step 4: Calculate final line total
        // Line Total = Base Amount + GST - Discount
        // Or: Line Total = (Base Amount - Discount) + GST
        let lineTotal = baseAmount + gstAmount - discountAmount;
        
        if (isFree) {
            baseAmount = 0;
            discountAmount = 0;
            gstAmount = 0;
            lineTotal = 0;
        }
        
        // Update display
        row.querySelector('.line-total').textContent = lineTotal.toFixed(2);
        
        // Determine interstate for GST breakdown display
        const isInterstate = (currentSupplierStateCode && currentSupplierStateCode !== hospitalStateCode);
        
        // Show GST details
        const gstDetails = row.querySelector('.gst-details');
        if (gstDetails && gstAmount > 0) {
            if (isInterstate) {
                gstDetails.textContent = `IGST: ₹${gstAmount.toFixed(2)}`;
            } else {
                gstDetails.textContent = `CGST/SGST: ₹${(gstAmount/2).toFixed(2)} each`;
            }
        }
        
        // Show discount info if present
        const marginInfo = row.querySelector('.margin-info');
        if (marginInfo && discountPercent > 0) {
            marginInfo.textContent = `Discount: ₹${discountAmount.toFixed(2)} (${discountPercent}%)`;
        }
        
        // Store values for totals calculation
        row.dataset.baseAmount = baseAmount.toFixed(2);
        row.dataset.discountAmount = discountAmount.toFixed(2);
        row.dataset.gstAmount = gstAmount.toFixed(2);
        row.dataset.lineTotal = lineTotal.toFixed(2);
        row.dataset.taxableAmount = baseAmount.toFixed(2);  // Taxable is full amount
        
        // Store GST breakdown
        row.dataset.cgst = isInterstate ? '0' : (gstAmount/2).toFixed(2);
        row.dataset.sgst = isInterstate ? '0' : (gstAmount/2).toFixed(2);
        row.dataset.igst = isInterstate ? gstAmount.toFixed(2) : '0';
        
        updateTotals();
    }
    
    // Update line numbers after removal
    function updateRowNumbers() {
        const rows = document.querySelectorAll('.line-item-row');
        rows.forEach((row, index) => {
            row.querySelector('.line-number').textContent = index + 1;
            row.dataset.index = index + 1;
        });
        lineItemIndex = rows.length;
    }
    
    // Update totals
    function updateTotals() {
        let subtotal = 0;      // Total of base amounts
        let totalDiscount = 0;  // Total discounts
        let totalGst = 0;       // Total GST
        
        document.querySelectorAll('.line-item-row').forEach(row => {
            subtotal += parseFloat(row.dataset.baseAmount || 0);
            totalDiscount += parseFloat(row.dataset.discountAmount || 0);
            totalGst += parseFloat(row.dataset.gstAmount || 0);
        });
        
        // Grand Total = Subtotal + GST - Discount
        const grandTotal = subtotal + totalGst - totalDiscount;
        
        // Update display elements
        const subtotalDisplay = document.getElementById('subtotal-display');
        const discountDisplay = document.getElementById('discount-display');
        const totalGstDisplay = document.getElementById('total-gst-display');
        const grandTotalDisplay = document.getElementById('grand-total-display');
        const discountRow = document.getElementById('discount-row');
        
        if (subtotalDisplay) subtotalDisplay.textContent = subtotal.toFixed(2);
        if (totalGstDisplay) totalGstDisplay.textContent = totalGst.toFixed(2);
        if (grandTotalDisplay) grandTotalDisplay.textContent = grandTotal.toFixed(2);
        
        // FIXED: Show/hide discount row and update discount display
        if (discountDisplay && discountRow) {
            if (totalDiscount > 0) {
                discountDisplay.textContent = totalDiscount.toFixed(2);
                discountRow.style.display = 'table-row';
            } else {
                discountRow.style.display = 'none';
            }
        }
    }

    // Example calculation breakdown:
    // Rate: ₹100
    // Quantity: 10
    // Base Amount: ₹1000
    // GST (12%): ₹120 (on ₹1000)
    // Discount (10%): ₹100 (on ₹1000)
    // Final Amount: ₹1000 + ₹120 - ₹100 = ₹1020

    // The clinic pays: ₹1020 (not ₹1008 which would be if GST was on discounted amount)
    
    // Update hidden fields function (moved outside)
    function updateHiddenFields(lineItems) {
        const form = document.getElementById('purchase-order-form');
        
        form.medicine_ids.value = lineItems.map(item => item.medicine_id).join(',');
        form.medicine_names.value = lineItems.map(item => item.medicine_name).join(',');
        form.quantities.value = lineItems.map(item => item.quantity).join(',');
        form.pack_purchase_prices.value = lineItems.map(item => item.rate).join(',');
        form.pack_mrps.value = lineItems.map(item => item.mrp || 0).join(',');
        form.units_per_packs.value = lineItems.map(item => item.units_per_pack || 1).join(',');
        form.hsn_codes.value = lineItems.map(item => item.hsn_code || '').join(',');
        form.gst_rates.value = lineItems.map(item => item.gst_rate || 0).join(',');
        
        // Include discount percents
        form.discount_percents.value = lineItems.map(item => item.discount || 0).join(',');
        form.is_free_items.value = lineItems.map(item => item.is_free ? '1' : '0').join(',');
        
        // CGST/SGST/IGST calculation (for backward compatibility)
        const cgstRates = [];
        const sgstRates = [];
        const igstRates = [];
        
        lineItems.forEach(item => {
            const isInterstate = currentSupplierStateCode && hospitalStateCode && 
                                currentSupplierStateCode !== hospitalStateCode;
            
            if (isInterstate) {
                cgstRates.push(0);
                sgstRates.push(0);
                igstRates.push(item.gst_rate);
            } else {
                cgstRates.push(item.gst_rate / 2);
                sgstRates.push(item.gst_rate / 2);
                igstRates.push(0);
            }
        });
        
        form.cgst_rates.value = cgstRates.join(',');
        form.sgst_rates.value = sgstRates.join(',');
        form.igst_rates.value = igstRates.join(',');
    }
    
    // Form submission handler
    document.getElementById('purchase-order-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const lineItems = [];
        document.querySelectorAll('.line-item-row').forEach(row => {
            const medicineSelect = row.querySelector('.medicine-select');
            if (medicineSelect && medicineSelect.value) {
                const gstRateElement = row.querySelector('.gst-rate');
                let gstRate = 0;
                
                // Get GST rate properly
                if (gstRateElement) {
                    if (gstRateElement.dataset.rate) {
                        gstRate = parseFloat(gstRateElement.dataset.rate);
                    } else if (gstRateElement.textContent) {
                        gstRate = parseFloat(gstRateElement.textContent.replace('%', ''));
                    }
                }
                
                lineItems.push({
                    medicine_id: medicineSelect.value,
                    medicine_name: medicineSelect.options[medicineSelect.selectedIndex].text,
                    quantity: row.querySelector('.quantity').value || 0,
                    rate: row.querySelector('.rate').value || 0,
                    mrp: row.querySelector('.mrp').value || 0,
                    discount: row.querySelector('.discount-percent')?.value || 0,
                    gst_rate: gstRate,
                    is_free: row.querySelector('.is-free-item').checked,
                    units_per_pack: row.querySelector('.units-per-pack').value || 1,
                    hsn_code: row.querySelector('.hsn-code').value || ''
                });
            }
        });
        
        // Validation
        if (lineItems.length === 0) {
            alert('Please add at least one line item before submitting.');
            return;
        }
        
        // Update hidden fields
        updateHiddenFields(lineItems);
        
        // Use HTMLFormElement.requestSubmit() to properly submit
        const form = this;
        if (form.requestSubmit) {
            // Remove the event listener to prevent recursion
            form.removeEventListener('submit', arguments.callee);
            form.requestSubmit();
        } else {
            // Fallback for older browsers
            form.removeEventListener('submit', arguments.callee);
            form.submit();
        }
    });
    
    // Add first line item on page load
    setTimeout(function() {
        const addButton = document.getElementById('add-line-item');
        if (addButton) {
            addButton.click();
        }
    }, 100);
    
}); // End of DOMContentLoaded
</script>
<script>
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('medicine-select')) {
        const row = e.target.closest('tr');
        
        if (row) {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const medicineId = selectedOption ? selectedOption.dataset.medicineId : null;
            
            if (medicineId) {
                fetch(`/supplier/api/medicine/${medicineId}/gst-info`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            const mrp = row.querySelector('.mrp');
                            if (mrp && data.mrp > 0) {
                                mrp.value = data.mrp.toFixed(2);
                                mrp.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                            
                            const rate = row.querySelector('.rate');
                            if (rate && data.last_purchase_price > 0) {
                                rate.value = data.last_purchase_price.toFixed(2);
                                rate.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        }
                    });
            }
        }
    }
});
</script>
{% endblock %}