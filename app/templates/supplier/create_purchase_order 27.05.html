{% extends "layouts/dashboard.html" %}

{% block title %}Create Purchase Order{% endblock %}

{% block head %}
{{ super() }}
<!-- Include supplier-specific CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/supplier.css') }}">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-4">
    
    <!-- Flash messages section -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="bg-{{ 'green' if category == 'success' else 'red' if category == 'error' else 'blue' }}-100 border-l-4 border-{{ 'green' if category == 'success' else 'red' if category == 'error' else 'blue' }}-500 text-{{ 'green' if category == 'success' else 'red' if category == 'error' else 'blue' }}-700 p-4 mb-6" role="alert">
            <p>{{ message }}</p>
        </div>
        {% endfor %}
    {% endif %}
    {% if messages %}
        <div class="mb-6">
            {% for category, message in messages %}
                {% if category == 'error' %}
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-3" role="alert">
                        <div class="flex">
                            <div class="py-1">
                                <svg class="fill-current h-6 w-6 text-red-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                    <path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM9 11V9h2v6H9v-4zm0-6h2v2H9V5z"/>
                                </svg>
                            </div>
                            <div>
                                <p class="font-bold">Validation Error</p>
                                <p class="text-sm">{{ message }}</p>
                            </div>
                        </div>
                    </div>
                {% elif category == 'warning' %}
                    <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-2" role="alert">
                        <div class="flex">
                            <div class="py-1">
                                <svg class="fill-current h-4 w-4 text-yellow-500 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                    <path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm1.41-1.41A8 8 0 1 0 15.66 4.34 8 8 0 0 0 4.34 15.66zm9.9-8.49L11.41 10l2.83 2.83-1.41 1.41L10 11.41l-2.83 2.83-1.41-1.41L8.59 10 5.76 7.17l1.41-1.41L10 8.59l2.83-2.83z"/>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm">{{ message }}</p>
                            </div>
                        </div>
                    </div>
                {% elif category == 'success' %}
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-3" role="alert">
                        <div class="flex">
                            <div class="py-1">
                                <svg class="fill-current h-6 w-6 text-green-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                    <path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM6.7 9.29L9 11.6l4.3-4.3 1.4 1.42L9 14.4l-3.7-3.7 1.4-1.41z"/>
                                </svg>
                            </div>
                            <div>
                                <p class="font-bold">Success</p>
                                <p class="text-sm">{{ message }}</p>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-3" role="alert">
                        <p class="text-sm">{{ message }}</p>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}
    {% endwith %}

    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">{{ page_title or "Create Purchase Order" }}</h1>
        <a href="{{ url_for('supplier_views.purchase_order_list') }}" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-white font-semibold py-2 px-4 rounded inline-flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" />
            </svg>
            Back to Purchase Orders
        </a>
    </div>

    <form id="purchase-order-form" method="POST" class="invoice-container">
        {{ form.csrf_token }}
        
        <!-- Compact PO Header -->
        <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 mb-6">
            <!-- Row 1: Supplier and PO Date -->
            <div class="flex gap-4 mb-4">
                <!-- Supplier Selection -->
                <div class="flex-grow">
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1">
                        Supplier <span class="text-red-500">*</span>
                    </label>
                    <select id="supplier_id" name="supplier_id" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="">Select Supplier</option>
                        {% for supplier in suppliers %}
                        <option value="{{ supplier.supplier_id }}" 
                                data-gst="{{ supplier.gst_registration_number }}"
                                data-state="{{ supplier.state_code }}"
                                data-payment-terms="{{ supplier.payment_terms }}">
                            {{ supplier.supplier_name }}
                        </option>
                        {% endfor %}
                    </select>
                    {% if form.supplier_id.errors %}
                        <p class="text-red-500 text-xs italic">{{ form.supplier_id.errors[0] }}</p>
                    {% endif %}
                </div>
                
                <!-- PO Date -->
                <div class="w-48">
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1" for="{{ form.po_date.id }}">
                        PO Date <span class="text-red-500">*</span>
                    </label>
                    {{ form.po_date(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline", required=true) }}
                    {% if form.po_date.errors %}
                        <p class="text-red-500 text-xs italic">{{ form.po_date.errors[0] }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Hidden PO Number field -->
            {{ form.po_number(type="hidden") }}
            
            <!-- Row 2: Combined all other fields with justify -->
            <div class="flex justify-between gap-4 mb-4">
                <!-- Expected Delivery Date -->
                <div class="w-40">
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1" for="{{ form.expected_delivery_date.id }}">
                        Expected Delivery
                    </label>
                    {{ form.expected_delivery_date(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline") }}
                </div>
                
                <!-- Currency -->
                <div class="w-28">
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1" for="{{ form.currency_code.id }}">
                        Currency
                    </label>
                    {{ form.currency_code(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline") }}
                </div>
                
                <!-- Exchange Rate (conditional) -->
                <div id="exchange-rate-container" class="w-32" style="display: none;">
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1" for="{{ form.exchange_rate.id }}">
                        Exchange Rate
                    </label>
                    {{ form.exchange_rate(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline", step="0.000001") }}
                </div>
                
                <!-- Quotation Ref -->
                <div class="w-56">
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1" for="{{ form.quotation_id.id }}">
                        Quotation Reference
                    </label>
                    {{ form.quotation_id(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline", placeholder="Enter quotation reference") }}
                </div>
                
                <!-- Quotation Date -->
                <div class="w-40">
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1" for="{{ form.quotation_date.id }}">
                        Quotation Date
                    </label>
                    {{ form.quotation_date(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline") }}
                </div>
            </div>
            
            <!-- Selected supplier info (compact) -->
            <div id="supplier-info-display" class="hidden bg-blue-50 dark:bg-blue-900 p-3 rounded">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
                    <div>
                        <span class="font-medium text-gray-700 dark:text-gray-300">GSTIN:</span>
                        <span id="supplier-gst-display" class="text-gray-600 dark:text-gray-400"></span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700 dark:text-gray-300">State Code:</span>
                        <span id="supplier-state-display" class="text-gray-600 dark:text-gray-400"></span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700 dark:text-gray-300">Payment Terms:</span>
                        <span id="supplier-terms-display" class="text-gray-600 dark:text-gray-400"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Line Items with better padded Add button -->
        <div class="line-items-section">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Items</h2>
                <button type="button" id="add-line-item" class="bg-blue-500 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded text-sm whitespace-nowrap inline-flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Add Item
                </button>
            </div>
            
            <div class="invoice-table-wrapper">
                <table class="invoice-table w-full">
                    <thead>
                        <tr class="bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 text-xs">
                            <th class="px-2 py-2 text-center font-medium uppercase">#</th>
                            <th class="px-2 py-2 text-left font-medium uppercase">Medicine</th>
                            <th class="px-2 py-2 text-right font-medium uppercase">Qty</th>
                            <th class="px-2 py-2 text-right font-medium uppercase">Rate</th>
                            <th class="px-2 py-2 text-right font-medium uppercase">MRP</th>
                            <th class="px-2 py-2 text-right font-medium uppercase">Disc%</th>
                            <th class="px-2 py-2 text-center font-medium uppercase">Free</th>
                            <th class="px-2 py-2 text-right font-medium uppercase">GST</th>
                            <th class="px-2 py-2 text-right font-medium uppercase">Total</th>
                            <th class="px-2 py-2 text-center font-medium uppercase">Action</th>
                        </tr>
                    </thead>
                    <tbody id="line-items-container" class="text-xs">
                        <tr id="no-items-row">
                            <td colspan="10" class="px-3 py-4 text-center text-gray-500 dark:text-gray-400">
                                No items added. Click "Add Item" to add line items.
                            </td>
                        </tr>
                    </tbody>
                    <tfoot class="bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-300 text-sm">
                        <tr class="border-t-2 border-gray-300 dark:border-gray-600">
                            <td colspan="8" class="px-2 py-2 text-right font-medium">Subtotal:</td>
                            <td class="px-2 py-2 text-right font-medium" id="subtotal">0.00</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="8" class="px-2 py-2 text-right font-medium">Total GST:</td>
                            <td class="px-2 py-2 text-right font-medium" id="total-gst">0.00</td>
                            <td></td>
                        </tr>
                        <tr class="border-t border-gray-400 dark:border-gray-500">
                            <td colspan="8" class="px-2 py-2 text-right font-bold">Grand Total:</td>
                            <td class="px-2 py-2 text-right font-bold text-lg" id="grand-total">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Additional Information section (collapsible) -->
        <div class="mb-6">
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4 cursor-pointer" 
                    onclick="document.getElementById('additional-info').classList.toggle('hidden')">
                    Additional Information 
                    <span class="text-sm text-gray-500">(Click to expand/collapse)</span>
                </h3>
                
                <div id="additional-info" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="{{ form.delivery_instructions.id }}">
                                Delivery Instructions
                            </label>
                            {{ form.delivery_instructions(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24") }}
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="{{ form.terms_conditions.id }}">
                                Terms and Conditions
                            </label>
                            {{ form.terms_conditions(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24") }}
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="{{ form.notes.id }}">
                            Internal Notes
                        </label>
                        {{ form.notes(class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24") }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden fields for line items data -->
        <div class="hidden">
            {{ form.medicine_ids }}
            {{ form.medicine_names }}
            {{ form.quantities }}
            {{ form.pack_purchase_prices }}
            {{ form.pack_mrps }}
            {{ form.units_per_packs }}
            {{ form.hsn_codes }}
            {{ form.gst_rates }}
            {{ form.cgst_rates }}
            {{ form.sgst_rates }}
            {{ form.igst_rates }}
            {{ form.discount_percents }}
            {{ form.is_free_items }}
        </div>

        <!-- TEMPORARY: Debug Information -->
        <div class="mt-6 bg-gray-100 p-4 rounded text-xs font-mono">
            <h3 class="text-sm mb-2">Debug Info:</h3>
            <p>Page Title: {{ page_title }}</p>
            <p>Medicine IDs: {{ form.medicine_ids.data[:100] if form.medicine_ids.data else 'None' }}...</p>
            <p>Quantities: {{ form.quantities.data[:50] if form.quantities.data else 'None' }}...</p>
            <p>Free Items: {{ form.is_free_items.data[:50] if form.is_free_items.data else 'None' }}...</p>
        </div>

        <!-- Submit Button with separated Draft message -->
        <div class="text-right">
            {% if page_title and 'Edit' in page_title %}
            <p class="text-sm text-gray-600 dark:text-gray-400 italic mb-3">
                Note: Only draft purchase orders can be edited. Status will remain unchanged.
            </p>
            <button type="submit" name="save_draft" value="1" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded focus:outline-none focus:shadow-outline">
                Update Purchase Order
            </button>
            {% else %}
            <p class="text-sm text-gray-600 dark:text-gray-400 italic mb-3">
                Note: All purchase orders are created in draft status and must be approved before activation.
            </p>
            <button type="submit" name="save_draft" value="1" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded focus:outline-none focus:shadow-outline">
                Create Purchase Order
            </button>
            {% endif %}
        </div>
    </form>
</div>

<!-- Line item template for JavaScript -->
<template id="line-item-template">
    <tr class="line-item-row border-b dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700">
        <!-- # Column -->
        <td class="px-2 py-2 text-center">
            <span class="line-number text-sm text-gray-600 font-medium">1</span>
        </td>
        
        <!-- Medicine Column (Wider) -->
        <td class="px-2 py-2">
            <select class="medicine-select form-select text-xs w-full border rounded px-2 py-1" required>
                <option value="">Select Medicine</option>
                {% for medicine in medicines %}
                <option value="{{ medicine.medicine_id }}" 
                        data-gst="{{ medicine.gst_rate or 0 }}"
                        data-hsn="{{ medicine.hsn_code or '' }}"
                        data-pack-size="{{ medicine.pack_size or 1 }}">
                    {{ medicine.medicine_name }}
                    {% if medicine.strength %} - {{ medicine.strength }}{% endif %}
                </option>
                {% endfor %}
            </select>
        </td>
        
        <!-- Quantity Column (Narrower) -->
        <td class="px-2 py-2">
            <input type="number" class="quantity form-input text-xs w-full text-right border rounded px-2 py-1" 
                   min="0" step="1" placeholder="0" required>
        </td>
        
        <!-- Rate Column (Narrower) -->
        <td class="px-2 py-2">
            <input type="number" class="pack-price form-input text-xs w-full text-right border rounded px-2 py-1" 
                   min="0" step="0.01" placeholder="0.00" required>
        </td>
        
        <!-- MRP Column (Narrower) -->
        <td class="px-2 py-2">
            <input type="number" class="mrp form-input text-xs w-full text-right border rounded px-2 py-1" 
                   min="0" step="0.01" placeholder="0.00" required>
        </td>
        
        <!-- Discount Column -->
        <td class="px-2 py-2">
            <input type="number" class="discount-percent form-input text-xs w-full text-right border rounded px-2 py-1" 
                   min="0" max="100" step="0.1" placeholder="0" value="0">
        </td>
        
        <!-- Free Item Column -->
        <td class="px-2 py-2 text-center">
            <label class="inline-flex items-center justify-center">
                <input type="checkbox" class="is-free-item form-checkbox text-xs rounded">
                <span class="ml-1 text-xs hidden sm:inline">Free</span>
            </label>
        </td>
        
        <!-- GST Column (Wider) -->
        <td class="px-2 py-2">
            <input type="number" class="gst-rate form-input text-xs w-full text-right border rounded px-2 py-1" 
                   min="0" max="100" step="0.1" placeholder="0" readonly>
            <div class="text-xs text-gray-500 mt-1 leading-tight">
                <div class="gst-breakdown"></div>
            </div>
        </td>
        
        <!-- Total Column (Wider) -->
        <td class="px-2 py-2 text-right">
            <div class="line-total font-medium text-sm">0.00</div>
            <div class="text-xs text-gray-500 gst-details mt-1 leading-tight"></div>
        </td>
        
        <!-- Action Column with Proper Delete Icon -->
        <td class="px-2 py-2 text-center">
            <button type="button" class="remove-line-item text-red-600 hover:text-red-800 hover:bg-red-100 rounded p-1 transition-colors" 
                    title="Remove this item">
                <!-- SVG Trash Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
        </td>
        
        <!-- Hidden fields for this line -->
        <input type="hidden" class="units-per-pack" value="1">
        <input type="hidden" class="hsn-code" value="">
    </tr>
</template>

<!-- ADD this client-side validation summary display -->
<div id="client-validation-summary" class="hidden mb-6">
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" role="alert">
        <div class="flex">
            <div class="py-1">
                <svg class="fill-current h-6 w-6 text-red-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                    <path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM9 11V9h2v6H9v-4zm0-6h2v2H9V5z"/>
                </svg>
            </div>
            <div>
                <p class="font-bold">Please fix the following errors:</p>
                <ul id="client-validation-list" class="text-sm mt-2 list-disc list-inside">
                    <!-- JavaScript will populate this -->
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/components/form_handler.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let lineItemIndex = 0;
    let currentSupplierId = '';
    let currentSupplierStateCode = '';
    
    // Initialize form handler with minimal validation (let server handle complex validation)
    const formHandler = new FormHandler({
        formSelector: '#purchase-order-form',
        validations: [
            {
                field: '#supplier_id',
                rules: [function(fieldEls) { return !!fieldEls[0].value; }],
                message: 'Please select a supplier'
            }
        ],
        onBeforeSubmit: function() {
            return collectAndValidateLineItems();
        }
    });

    // =============================================================================
    // SUPPLIER HANDLING
    // =============================================================================
    
    const supplierSelect = document.getElementById('supplier_id');
    const supplierInfoDisplay = document.getElementById('supplier-info-display');
    
    if (supplierSelect) {
        supplierSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            
            if (this.value) {
                // Display supplier info
                document.getElementById('supplier-gst-display').textContent = selectedOption.getAttribute('data-gst') || 'N/A';
                document.getElementById('supplier-state-display').textContent = selectedOption.getAttribute('data-state') || 'N/A';
                document.getElementById('supplier-terms-display').textContent = selectedOption.getAttribute('data-payment-terms') || 'N/A';
                supplierInfoDisplay.classList.remove('hidden');
                
                // Store supplier info for calculations
                currentSupplierId = this.value;
                currentSupplierStateCode = selectedOption.getAttribute('data-state') || '';
                
                // Recalculate all line items
                recalculateAllLines();
            } else {
                supplierInfoDisplay.classList.add('hidden');
                currentSupplierId = '';
                currentSupplierStateCode = '';
            }
        });
    }
    
    // =============================================================================
    // CURRENCY HANDLING
    // =============================================================================
    
    const currencySelect = document.getElementById('currency_code');
    const exchangeRateContainer = document.getElementById('exchange-rate-container');
    
    if (currencySelect) {
        currencySelect.addEventListener('change', function() {
            if (this.value === 'INR') {
                exchangeRateContainer.style.display = 'none';
                document.getElementById('exchange_rate').value = '1';
            } else {
                exchangeRateContainer.style.display = '';
            }
        });
    }
    
    // =============================================================================
    // LINE ITEMS MANAGEMENT
    // =============================================================================
    
    const addLineItemButton = document.getElementById('add-line-item');
    const lineItemsContainer = document.getElementById('line-items-container');
    const noItemsRow = document.getElementById('no-items-row');
    const lineItemTemplate = document.getElementById('line-item-template');
    
    if (addLineItemButton) {
        addLineItemButton.addEventListener('click', function() {
            noItemsRow.style.display = 'none';
            
            const content = lineItemTemplate.content.cloneNode(true);
            const row = content.querySelector('.line-item-row');
            lineItemsContainer.appendChild(row);
            
            initializeLineItem(row);
            updateLineNumbers();
            lineItemIndex++;
        });
    }
    
    // =============================================================================
    // LINE ITEM INITIALIZATION
    // =============================================================================
    
    function initializeLineItem(row) {
        const medicineSelect = row.querySelector('.medicine-select');
        const quantity = row.querySelector('.quantity');
        const packPrice = row.querySelector('.pack-price');
        const mrp = row.querySelector('.mrp');
        const discountPercent = row.querySelector('.discount-percent');
        const isFreeItem = row.querySelector('.is-free-item');
        const gstRate = row.querySelector('.gst-rate');
        const removeButton = row.querySelector('.remove-line-item');
        
        // Medicine selection
        if (medicineSelect) {
            medicineSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    gstRate.value = selectedOption.getAttribute('data-gst') || '0';
                    row.querySelector('.hsn-code').value = selectedOption.getAttribute('data-hsn') || '';
                    row.querySelector('.units-per-pack').value = selectedOption.getAttribute('data-pack-size') || '1';
                    calculateLineGST(row);
                }
            });
        }
        
        // Input change handlers
        [quantity, packPrice, mrp, discountPercent, gstRate].forEach(input => {
            if (input) {
                input.addEventListener('input', debounce(() => calculateLineGST(row), 300));
            }
        });
        
        // ENHANCED: Free item checkbox with proper validation
        if (isFreeItem) {
            isFreeItem.addEventListener('change', function() {
                const isChecked = this.checked;
                console.log(`Free item checkbox changed for row: ${isChecked}`);
                
                if (isChecked) {
                    // ONLY reset price and discount, NEVER touch quantity
                    if (packPrice) {
                        packPrice.value = '0';
                        packPrice.readOnly = true;
                        packPrice.classList.add('bg-gray-100', 'dark:bg-gray-600');
                    }
                    if (discountPercent) {
                        discountPercent.value = '0';
                        discountPercent.readOnly = true;
                        discountPercent.classList.add('bg-gray-100', 'dark:bg-gray-600');
                    }
                    
                    // Add visual styling
                    row.classList.add('bg-green-50', 'dark:bg-green-900');
                    
                    // Add free badge if not already present
                    const medicineCell = row.querySelector('.medicine-select').parentNode;
                    if (medicineCell && !medicineCell.querySelector('.free-badge')) {
                        const badge = document.createElement('span');
                        badge.className = 'free-badge ml-2 px-2 py-1 text-xs bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-200 rounded';
                        badge.textContent = 'Free';
                        medicineCell.appendChild(badge);
                    }
                    
                    console.log('Item marked as free - rate and discount set to zero, quantity preserved');
                } else {
                    // When unchecked, allow editing price and discount again
                    if (packPrice) {
                        packPrice.readOnly = false;
                        packPrice.classList.remove('bg-gray-100', 'dark:bg-gray-600');
                    }
                    if (discountPercent) {
                        discountPercent.readOnly = false;
                        discountPercent.classList.remove('bg-gray-100', 'dark:bg-gray-600');
                    }
                    
                    // Remove visual styling
                    row.classList.remove('bg-green-50', 'dark:bg-green-900');
                    
                    // Remove free badge
                    const freeBadge = row.querySelector('.free-badge');
                    if (freeBadge) {
                        freeBadge.remove();
                    }
                }
                calculateLineGST(row);
            });
        }
        
        // Remove button
        if (removeButton) {
            removeButton.addEventListener('click', function() {
                row.remove();
                updateLineNumbers();
                updateTotalsDisplay();
                
                if (lineItemsContainer.querySelectorAll('.line-item-row').length === 0) {
                    noItemsRow.style.display = '';
                }
            });
        }
    }
    
    // =============================================================================
    // GST CALCULATIONS (Server-side)
    // =============================================================================
    
    async function calculateLineGST(row) {
        try {
            const quantity = parseFloat(row.querySelector('.quantity')?.value) || 0;
            const unitRate = parseFloat(row.querySelector('.pack-price')?.value) || 0;
            const gstRate = parseFloat(row.querySelector('.gst-rate')?.value) || 0;
            const discountPercent = parseFloat(row.querySelector('.discount-percent')?.value) || 0;
            const isFreeItem = row.querySelector('.is-free-item')?.checked || false;
            
            if (quantity === 0 || (unitRate === 0 && !isFreeItem)) {
                clearLineDisplay(row);
                updateTotalsDisplay();
                return;
            }
            
            const response = await fetch('/supplier/api/po/preview-gst', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    quantity: quantity,
                    unit_rate: unitRate,
                    gst_rate: gstRate,
                    discount_percent: discountPercent,
                    is_free_item: isFreeItem,
                    conversion_factor: 1,
                    supplier_state_code: currentSupplierStateCode
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                updateLineDisplay(row, data.calculations);
            } else {
                clearLineDisplay(row);
            }
            
            updateTotalsDisplay();
            
        } catch (error) {
            console.error('GST calculation error:', error);
            clearLineDisplay(row);
        }
    }
    
    function updateLineDisplay(row, calculations) {
        row.querySelector('.line-total').textContent = calculations.line_total.toFixed(2);
        
        const gstBreakdown = row.querySelector('.gst-breakdown');
        if (calculations.is_interstate) {
            gstBreakdown.textContent = `IGST:  Rs.${calculations.igst_amount.toFixed(2)}`;
        } else {
            gstBreakdown.textContent = `C: Rs.${calculations.cgst_amount.toFixed(2)} S: Rs.${calculations.sgst_amount.toFixed(2)}`;
        }
        
        const gstDetails = row.querySelector('.gst-details');
        gstDetails.textContent = `Base:  Rs.${calculations.base_amount.toFixed(2)} | GST:  Rs.${calculations.total_gst_amount.toFixed(2)}`;
    }
    
    function clearLineDisplay(row) {
        row.querySelector('.line-total').textContent = '0.00';
        row.querySelector('.gst-breakdown').textContent = '';
        row.querySelector('.gst-details').textContent = '';
    }
    
    async function updateTotalsDisplay() {
        try {
            const lineItems = collectLineItemsForAPI();
            
            if (lineItems.length === 0) {
                updateTotalElements(0, 0, 0);
                return;
            }
            
            const response = await fetch('/supplier/api/po/preview-totals', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    line_items: lineItems,
                    supplier_state_code: currentSupplierStateCode
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                const totals = data.totals;
                updateTotalElements(totals.total_taxable_amount, totals.total_gst_amount, totals.grand_total);
            }
            
        } catch (error) {
            console.error('Totals calculation error:', error);
        }
    }
    
    function updateTotalElements(subtotal, totalGst, grandTotal) {
        document.getElementById('subtotal').textContent = subtotal.toFixed(2);
        document.getElementById('total-gst').textContent = totalGst.toFixed(2);
        document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
    }
    
    function collectLineItemsForAPI() {
        const rows = document.querySelectorAll('.line-item-row');
        return Array.from(rows).map(row => ({
            quantity: parseFloat(row.querySelector('.quantity')?.value) || 0,
            unit_rate: parseFloat(row.querySelector('.pack-price')?.value) || 0,
            gst_rate: parseFloat(row.querySelector('.gst-rate')?.value) || 0,
            discount_percent: parseFloat(row.querySelector('.discount-percent')?.value) || 0,
            is_free_item: row.querySelector('.is-free-item')?.checked || false,
            conversion_factor: 1
        })).filter(item => item.quantity > 0);
    }
    
    function recalculateAllLines() {
        document.querySelectorAll('.line-item-row').forEach(row => calculateLineGST(row));
    }
    
    function updateLineNumbers() {
        document.querySelectorAll('.line-item-row').forEach((row, index) => {
            row.querySelector('.line-number').textContent = index + 1;
        });
    }

    // =============================================================================
    // FORM SUBMISSION (Simplified - Let Server Handle Validation)
    // =============================================================================
    
    function collectAndValidateLineItems() {
        const rows = document.querySelectorAll('.line-item-row');
        
        if (rows.length === 0) {
            alert('Please add at least one item to the purchase order');
            return false;
        }
        

        // CRITICAL FIX: Detect edit mode and collect current values
        const pageTitle = document.querySelector('h1')?.textContent || '';
        const isEditMode = pageTitle.includes('Edit') || window.location.pathname.includes('/edit/');
        
        if (isEditMode) {
            console.log('=== EDIT MODE DETECTED: Updating hidden fields with current values ===');
            updateHiddenFieldsWithCurrentValues();
        }

        // Enhanced validation with free item support
        let hasValidItems = false;
        let validationErrors = [];
        
        rows.forEach((row, index) => {
            const medicineSelect = row.querySelector('.medicine-select');
            const quantity = row.querySelector('.quantity');
            const isFreeItem = row.querySelector('.is-free-item')?.checked || false;
            const packPrice = row.querySelector('.pack-price');
            const mrp = row.querySelector('.mrp');
            
            const lineNumber = index + 1;
            
            // Medicine validation
            if (!medicineSelect?.value) {
                validationErrors.push(`Line ${lineNumber}: Please select a medicine`);
                return;
            }
            
            // Quantity validation (required for all items)
            const qtyValue = parseFloat(quantity?.value) || 0;
            if (qtyValue <= 0) {
                validationErrors.push(`Line ${lineNumber}: Quantity must be greater than 0`);
                return;
            }
            
            // Free item specific validation
            if (isFreeItem) {
                // Free items: zero rate is expected
                const priceValue = parseFloat(packPrice?.value) || 0;
                if (priceValue > 0) {
                    validationErrors.push(`Line ${lineNumber}: Free items should have zero rate`);
                    return;
                }
                console.log(`Valid free item: Line ${lineNumber}, Qty=${qtyValue}`);
            } else {
                // Non-free items: must have positive rate and MRP
                const priceValue = parseFloat(packPrice?.value) || 0;
                const mrpValue = parseFloat(mrp?.value) || 0;
                
                if (priceValue <= 0) {
                    validationErrors.push(`Line ${lineNumber}: Rate must be greater than 0 for non-free items`);
                    return;
                }
                
                if (mrpValue <= 0) {
                    validationErrors.push(`Line ${lineNumber}: MRP must be greater than 0`);
                    return;
                }
            }
            
            hasValidItems = true;
        });
        
        // Show validation errors
        if (validationErrors.length > 0) {
            alert('Please fix the following validation errors:\n\n' + validationErrors.join('\n'));
            return false;
        }
        
        if (!hasValidItems) {
            alert('Please add at least one valid item with medicine and quantity');
            return false;
        }
        
        // If all validations pass, collect form data
        return collectFormData();
    }

    
    function updateHiddenFieldsWithCurrentValues() {
        console.log('=== UPDATING HIDDEN FIELDS WITH CURRENT INPUT VALUES ===');
        
        const rows = document.querySelectorAll('.line-item-row');
        
        if (rows.length === 0) {
            console.log('No line items to update');
            return;
        }
        
        // Arrays to collect CURRENT values from form inputs
        const currentQuantities = [];
        const currentPrices = [];
        const currentMrps = [];
        const currentDiscounts = [];
        const currentFreeItems = [];
        
        rows.forEach((row, index) => {
            const medicineSelect = row.querySelector('.medicine-select');
            
            if (!medicineSelect?.value) {
                return; // Skip rows without medicine selection
            }
            
            // Read CURRENT values from visible form inputs
            const quantityInput = row.querySelector('.quantity');
            const priceInput = row.querySelector('.pack-price');
            const mrpInput = row.querySelector('.mrp');
            const discountInput = row.querySelector('.discount-percent');
            const freeCheckbox = row.querySelector('.is-free-item');
            
            // Get the actual current values from the inputs
            const currentQty = quantityInput?.value || '0';
            const currentPrice = priceInput?.value || '0';
            const currentMrp = mrpInput?.value || '0';
            const currentDiscount = discountInput?.value || '0';
            const isFree = freeCheckbox?.checked || false;
            
            console.log(`Line ${index + 1} current values:`);
            console.log(`  Quantity: "${currentQty}" (from input: ${quantityInput?.value})`);
            console.log(`  Price: "${currentPrice}" (from input: ${priceInput?.value})`);
            console.log(`  MRP: "${currentMrp}"`);
            console.log(`  Discount: "${currentDiscount}"`);
            console.log(`  Free: ${isFree}`);
            
            currentQuantities.push(currentQty);
            currentPrices.push(currentPrice);
            currentMrps.push(currentMrp);
            currentDiscounts.push(currentDiscount);
            currentFreeItems.push(isFree ? 'true' : 'false');
        });
        
        // Update the hidden form fields that the controller reads
        // These correspond to the fields processed in supplier_controller.py _process_update()
        
        const quantitiesField = document.getElementById('quantities');
        if (quantitiesField && currentQuantities.length > 0) {
            const oldValue = quantitiesField.value;
            quantitiesField.value = currentQuantities.join(',');
            console.log(`UPDATED quantities field: "${oldValue}" -> "${quantitiesField.value}"`);
        }
        
        const pricesField = document.getElementById('pack_purchase_prices');
        if (pricesField && currentPrices.length > 0) {
            const oldValue = pricesField.value;
            pricesField.value = currentPrices.join(',');
            console.log(`UPDATED pack_purchase_prices field: "${oldValue}" -> "${pricesField.value}"`);
        }
        
        const mrpsField = document.getElementById('pack_mrps');
        if (mrpsField && currentMrps.length > 0) {
            const oldValue = mrpsField.value;
            mrpsField.value = currentMrps.join(',');
            console.log(`UPDATED pack_mrps field: "${oldValue}" -> "${mrpsField.value}"`);
        }
        
        const discountsField = document.getElementById('discount_percents');
        if (discountsField && currentDiscounts.length > 0) {
            const oldValue = discountsField.value;
            discountsField.value = currentDiscounts.join(',');
            console.log(`UPDATED discount_percents field: "${oldValue}" -> "${discountsField.value}"`);
        }
        
        const freeItemsField = document.getElementById('is_free_items');
        if (freeItemsField && currentFreeItems.length > 0) {
            const oldValue = freeItemsField.value;
            freeItemsField.value = currentFreeItems.join(',');
            console.log(`UPDATED is_free_items field: "${oldValue}" -> "${freeItemsField.value}"`);
        }
        
        console.log('=== HIDDEN FIELDS UPDATE COMPLETE ===');
        console.log(`Updated ${currentQuantities.length} line items`);
    }

    function collectFormData() {
        console.log('=== COLLECTING CURRENT FORM DATA ===');
        
        const rows = document.querySelectorAll('.line-item-row');
        console.log(`Found ${rows.length} line item rows`);
        
        const medicineIds = [];
        const medicineNames = [];
        const quantities = [];
        const packPurchasePrices = [];
        const packMrps = [];
        const unitsPerPacks = [];
        const hsnCodes = [];
        const gstRates = [];
        const discountPercents = [];
        const isFreeItems = [];

        rows.forEach((row, index) => {
            const medicineSelect = row.querySelector('.medicine-select');
            if (medicineSelect?.value) {
                const selectedOption = medicineSelect.options[medicineSelect.selectedIndex];
                const isFreeItem = row.querySelector('.is-free-item')?.checked || false;
                
                // CRITICAL FIX: Get CURRENT values from form fields (not just defaults)
                const quantityInput = row.querySelector('.quantity');
                const priceInput = row.querySelector('.pack-price');
                const mrpInput = row.querySelector('.mrp');
                const discountInput = row.querySelector('.discount-percent');
                
                // Read actual current values
                const currentQuantity = quantityInput?.value || '0';
                const currentPrice = priceInput?.value || '0';
                const currentMrp = mrpInput?.value || '0';
                const currentDiscount = discountInput?.value || '0';
                
                console.log(`Line ${index + 1} CURRENT VALUES:`);
                console.log(`  Medicine: ${selectedOption.text}`);
                console.log(`  Quantity: ${currentQuantity} (from input: ${quantityInput?.value})`);
                console.log(`  Price: ${currentPrice} (from input: ${priceInput?.value})`);
                console.log(`  Free: ${isFreeItem}`);
                
                medicineIds.push(medicineSelect.value);
                medicineNames.push(selectedOption.text || '');
                quantities.push(currentQuantity);  // Use current value
                
                // Handle free vs regular items with current values
                if (isFreeItem) {
                    packPurchasePrices.push('0');      // Rate = 0 for free items
                    discountPercents.push('0');        // Discount = 0 for free items
                    console.log(`  -> Free item: Rate=0, Discount=0, Qty preserved=${currentQuantity}`);
                } else {
                    packPurchasePrices.push(currentPrice);    // Use current price
                    discountPercents.push(currentDiscount);   // Use current discount
                    console.log(`  -> Regular item: Rate=${currentPrice}, Discount=${currentDiscount}`);
                }
                
                // Other fields (using current values)
                packMrps.push(currentMrp);
                unitsPerPacks.push(row.querySelector('.units-per-pack')?.value || '1');
                hsnCodes.push(row.querySelector('.hsn-code')?.value || '');
                gstRates.push(row.querySelector('.gst-rate')?.value || '0');
                isFreeItems.push(isFreeItem ? 'true' : 'false');
            }
        });
        
        // Update hidden form fields with CURRENT data
        const hiddenFields = {
            'medicine_ids': medicineIds.join(','),
            'medicine_names': medicineNames.join(','),
            'quantities': quantities.join(','),
            'pack_purchase_prices': packPurchasePrices.join(','),
            'pack_mrps': packMrps.join(','),
            'units_per_packs': unitsPerPacks.join(','),
            'hsn_codes': hsnCodes.join(','),
            'gst_rates': gstRates.join(','),
            'discount_percents': discountPercents.join(','),
            'is_free_items': isFreeItems.join(',')
        };
        
        console.log('=== SETTING HIDDEN FORM FIELDS WITH CURRENT VALUES ===');
        
        // Set hidden fields with current data
        Object.keys(hiddenFields).forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = hiddenFields[fieldId];
                console.log(`Set ${fieldId} = "${field.value}"`);
            } else {
                console.error(`Hidden field ${fieldId} not found!`);
            }
        });
        
        console.log('=== CURRENT FORM DATA COLLECTION SUMMARY ===');
        console.log(`Total line items: ${medicineIds.length}`);
        console.log(`Current Quantities: ${quantities.join(',')}`);
        console.log(`Current Prices: ${packPurchasePrices.join(',')}`);
        console.log(`Free items: ${isFreeItems.join(',')}`);
        
        return true;
    }

    
    // =============================================================================
    // UTILITY FUNCTIONS
    // =============================================================================
    
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    function getCSRFToken() {
        return document.querySelector('input[name="csrf_token"]')?.value || '';
    }

    // =============================================================================
    // EDIT MODE: LOAD EXISTING LINE ITEMS - MOVED INSIDE DOMContentLoaded
    // =============================================================================
    
    function loadExistingLineItems() {
        const medicineIdsField = document.getElementById('medicine_ids');
        
        // Check if we have existing line items data
        if (!medicineIdsField || !medicineIdsField.value || !medicineIdsField.value.trim()) {
            console.log('No existing line items to load (create mode)');
            return;
        }
        
        console.log('=== LOADING EXISTING LINE ITEMS FOR EDIT MODE ===');
        console.log('Medicine IDs field value:', medicineIdsField.value);
        
        try {
            // Parse hidden field data
            const medicineIds = medicineIdsField.value.split(',');
            const medicineNames = document.getElementById('medicine_names').value.split(',');
            const quantities = document.getElementById('quantities').value.split(',');
            const packPrices = document.getElementById('pack_purchase_prices').value.split(',');
            const packMrps = document.getElementById('pack_mrps').value.split(',');
            const unitsPerPacks = document.getElementById('units_per_packs').value.split(',');
            const hsnCodes = document.getElementById('hsn_codes').value.split(',');
            const gstRates = document.getElementById('gst_rates').value.split(',');
            const discountPercents = document.getElementById('discount_percents').value.split(',');
            
            // CRITICAL: Debug free items data
            const freeItemsField = document.getElementById('is_free_items');
            console.log('Free items field exists:', !!freeItemsField);
            console.log('Free items field value:', freeItemsField ? freeItemsField.value : 'FIELD NOT FOUND');
            
            let isFreeItems = [];
            if (freeItemsField && freeItemsField.value) {
                isFreeItems = freeItemsField.value.split(',');
                console.log('Parsed free items array:', isFreeItems);
            } else {
                // Default all to false if no data
                isFreeItems = new Array(medicineIds.length).fill('false');
                console.log('Defaulting all items to non-free');
            }
            
            console.log(`Loading ${medicineIds.length} existing line items`);
            console.log('Raw data check:');
            console.log('- Medicine IDs:', medicineIds);
            console.log('- Quantities:', quantities);
            console.log('- Prices:', packPrices);
            console.log('- Free Items:', isFreeItems);
            
            // Hide "no items" row
            if (noItemsRow) {
                noItemsRow.style.display = 'none';
            }
            
            // Create line items from existing data
            for (let i = 0; i < medicineIds.length; i++) {
                if (medicineIds[i] && medicineIds[i].trim()) {
                    // Create new line item row
                    const content = lineItemTemplate.content.cloneNode(true);
                    const row = content.querySelector('.line-item-row');
                    
                    // Parse free item value properly with debugging
                    const freeItemString = (i < isFreeItems.length) ? isFreeItems[i].trim() : 'false';
                    const isFreeValue = freeItemString.toLowerCase() === 'true';
                    
                    console.log(`Line ${i+1} DEBUG:`);
                    console.log(`  Medicine: ${medicineNames[i]}`);
                    console.log(`  Quantity: ${quantities[i]}`);
                    console.log(`  Price: ${packPrices[i]}`);
                    console.log(`  Free item string: "${freeItemString}"`);
                    console.log(`  Free item boolean: ${isFreeValue}`);
                    
                    // Populate the row with existing data
                    populateLineItemRow(row, {
                        medicineId: medicineIds[i],
                        medicineName: medicineNames[i] || '',
                        quantity: quantities[i] || '0',
                        packPrice: packPrices[i] || '0',
                        packMrp: packMrps[i] || '0',
                        unitsPerPack: unitsPerPacks[i] || '1',
                        hsnCode: hsnCodes[i] || '',
                        gstRate: gstRates[i] || '0',
                        discountPercent: discountPercents[i] || '0',
                        isFreeItem: isFreeValue
                    });
                    
                    // Add to container
                    lineItemsContainer.appendChild(row);
                    
                    // Initialize the row
                    initializeLineItem(row);
                    
                    // Calculate GST for this row
                    calculateLineGST(row);
                }
            }
            
            // Update line numbers
            updateLineNumbers();
            
            console.log('=== SUCCESSFULLY LOADED EXISTING LINE ITEMS ===');
            
        } catch (error) {
            console.error('=== ERROR LOADING EXISTING LINE ITEMS ===');
            console.error('Error details:', error);
            console.error('Stack trace:', error.stack);
        }
    }
   function populateLineItemRow(row, data) {
        console.log(`=== POPULATING LINE ITEM ROW ===`);
        console.log(`Medicine: ${data.medicineName}`);
        console.log(`Is Free Item: ${data.isFreeItem}`);
        
        try {
            // Set medicine selection
            const medicineSelect = row.querySelector('.medicine-select');
            if (medicineSelect) {
                medicineSelect.value = data.medicineId;
                console.log(`Set medicine select to: ${data.medicineId}`);
            }
            
            // Set input values with explicit logging
            const quantity = row.querySelector('.quantity');
            if (quantity) {
                quantity.value = data.quantity;
                console.log(`Set quantity to: ${data.quantity}`);
            }
            
            const packPrice = row.querySelector('.pack-price');
            if (packPrice) {
                packPrice.value = data.packPrice;
                console.log(`Set pack price to: ${data.packPrice}`);
            }
            
            const mrp = row.querySelector('.mrp');
            if (mrp) {
                mrp.value = data.packMrp;
                console.log(`Set MRP to: ${data.packMrp}`);
            }
            
            const discountPercent = row.querySelector('.discount-percent');
            if (discountPercent) {
                discountPercent.value = data.discountPercent;
                console.log(`Set discount to: ${data.discountPercent}`);
            }
            
            const gstRate = row.querySelector('.gst-rate');
            if (gstRate) {
                gstRate.value = data.gstRate;
                console.log(`Set GST rate to: ${data.gstRate}`);
            }
            
            const isFreeItem = row.querySelector('.is-free-item');
            if (isFreeItem) {
                // CRITICAL: Set the checkbox value first
                isFreeItem.checked = data.isFreeItem;
                
                console.log(`Set free item checkbox to: ${data.isFreeItem}`);
                
                // Apply free item styling and readonly fields if needed
                if (data.isFreeItem) {
                    console.log(`Applying free item styling...`);
                    
                    // Add visual styling
                    row.classList.add('bg-green-50', 'dark:bg-green-900');
                    
                    // Set price and discount to zero and make readonly
                    if (packPrice) {
                        packPrice.value = '0';
                        packPrice.readOnly = true;
                        packPrice.classList.add('bg-gray-100', 'dark:bg-gray-600');
                        console.log(`Made price field readonly and set to 0`);
                    }
                    if (discountPercent) {
                        discountPercent.value = '0';
                        discountPercent.readOnly = true;
                        discountPercent.classList.add('bg-gray-100', 'dark:bg-gray-600');
                        console.log(`Made discount field readonly and set to 0`);
                    }
                    
                    // Add a visual indicator
                    const medicineCell = row.querySelector('.medicine-select').parentNode;
                    if (medicineCell && !medicineCell.querySelector('.free-badge')) {
                        const badge = document.createElement('span');
                        badge.className = 'free-badge ml-2 px-2 py-1 text-xs bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-200 rounded';
                        badge.textContent = 'Free';
                        medicineCell.appendChild(badge);
                        console.log(`Added free item badge`);
                    }
                } else {
                    console.log(`Item is not free - ensuring fields are editable`);
                    // Not a free item - ensure fields are editable
                    if (packPrice) {
                        packPrice.readOnly = false;
                        packPrice.classList.remove('bg-gray-100', 'dark:bg-gray-600');
                    }
                    if (discountPercent) {
                        discountPercent.readOnly = false;
                        discountPercent.classList.remove('bg-gray-100', 'dark:bg-gray-600');
                    }
                }
            }
            
            // Set hidden fields
            const unitsPerPack = row.querySelector('.units-per-pack');
            if (unitsPerPack) unitsPerPack.value = data.unitsPerPack;
            
            const hsnCode = row.querySelector('.hsn-code');
            if (hsnCode) hsnCode.value = data.hsnCode;
            
            console.log(`=== COMPLETED POPULATING LINE ITEM ===`);
            console.log(`Final state - Qty: ${data.quantity}, Free: ${data.isFreeItem}`);
            
        } catch (error) {
            console.error('Error populating line item row:', error);
        }
    }
    
    // NEW: Load existing line items if in edit mode
    loadExistingLineItems();
    
}); // End DOMContentLoaded

</script>
{% endblock %}