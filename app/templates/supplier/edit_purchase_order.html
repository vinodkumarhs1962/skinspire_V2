{% extends "layouts/dashboard.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block styles %}
{{ super() }}
<!-- Purchase Order Enhanced Styles with Fixed Column Widths -->
<style>
    /* FIXED: Column widths with !important */
    .invoice-table th:nth-child(1), 
    .invoice-table td:nth-child(1) { width: 40px !important; }  /* # */
    
    .invoice-table th:nth-child(2), 
    .invoice-table td:nth-child(2) { min-width: 280px !important; }  /* Medicine - EXPANDED */
    
    .invoice-table th:nth-child(3), 
    .invoice-table td:nth-child(3) { width: 70px !important; }  /* Qty - REDUCED */
    
    .invoice-table th:nth-child(4), 
    .invoice-table td:nth-child(4) { width: 90px !important; }  /* Rate */
    
    .invoice-table th:nth-child(5), 
    .invoice-table td:nth-child(5) { width: 90px !important; }  /* MRP */
    
    .invoice-table th:nth-child(6), 
    .invoice-table td:nth-child(6) { width: 70px !important; }  /* GST */
    
    .invoice-table th:nth-child(7), 
    .invoice-table td:nth-child(7) { width: 60px !important; }  /* Free */
    
    .invoice-table th:nth-child(8), 
    .invoice-table td:nth-child(8) { width: 100px !important; }  /* Total */
    
    .invoice-table th:nth-child(9), 
    .invoice-table td:nth-child(9) { width: 60px !important; }  /* Actions */

    /* Container styles */
    .po-enhanced-container {
        background: #f3f4f6;
        min-height: 100vh;
        padding: 0;
        margin: -1.5rem;
    }
    
    .dark .po-enhanced-container {
        background: #0f172a;
    }
    
    /* Header styling */
    .po-header {
        background: white;
        padding: 1.5rem;
        margin-bottom: 0;
        position: relative;
    }
    
    .dark .po-header {
        background: rgb(31 41 55);
    }
    
    /* Badge styling */
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    .badge-warning {
        background-color: rgb(254 243 199);
        color: rgb(146 64 14);
        border: 1px solid rgb(252 211 77);
    }
    
    .dark .badge-warning {
        background-color: rgba(251, 191, 36, 0.2);
        color: rgb(252 211 77);
        border-color: rgb(251 191 36);
    }
    
    /* Quick actions bar */
    .quick-actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem 1.5rem;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 1rem;
    }
    
    .dark .quick-actions-bar {
        background: rgb(31 41 55);
        border-bottom-color: rgb(55 65 81);
    }
    
    .quick-actions-left {
        display: flex;
        gap: 0.5rem;
    }
    
    /* Two-column grid for form fields */
    .po-two-column-grid {
        display: grid !important;
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        gap: 1rem !important;
        width: 100% !important;
    }
    
    @media (max-width: 768px) {
        .po-two-column-grid {
            grid-template-columns: 1fr !important;
        }
    }
</style>
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/supplier.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/universal_select.css') }}">
{% endblock %}

{% block content %}
<div class="po-enhanced-container">
    <!-- RESTORED: Complete Header with Date/Day -->
    <div class="po-header">
        <div class="info-card" style="box-shadow: none; border: none; margin: 0;">
            <div class="card-body" style="padding: 0; background: transparent;">
                <!-- Row 1: Title and Date/Status -->
                <div class="flex justify-between items-start mb-3">
                    <div style="max-width: 60%;">
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                            <i class="fas fa-edit text-blue-500"></i>
                            <span class="ml-2">{{ page_title }}</span>
                        </h1>
                        <p class="text-gray-600 dark:text-gray-400 mt-1" style="font-style: italic; font-size: 1.125rem; padding-left: 2.5rem;">
                            Modify draft purchase order details
                        </p>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem; padding-right: 1rem;">
                        <span class="badge badge-warning">Editing</span>
                        <div style="text-align: right;">
                            <div class="text-gray-600 dark:text-gray-400">
                                <i class="fas fa-calendar text-gray-500"></i>
                                <span class="ml-1 font-bold text-base">{{ current_date|default(today, true)|default('15 Sep 2025', true) }}</span>
                            </div>
                            <div class="text-gray-500 dark:text-gray-400 mt-1 font-bold text-sm">
                                {{ current_date|default(today, true)|date('l') if current_date else 'Sunday' }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 2: Breadcrumb -->
                <div class="mb-3">
                    <nav class="flex items-center space-x-1 text-sm text-gray-500">
                        <a href="{{ url_for('auth_views.dashboard') }}" class="hover:text-gray-700 dark:hover:text-gray-300">
                            Dashboard
                        </a>
                        <span class="text-gray-400 mx-2">/</span>
                        <a href="{{ url_for('universal_views.universal_list_view', entity_type='purchase_orders') }}" class="hover:text-gray-700 dark:hover:text-gray-300">
                            Purchase Orders
                        </a>
                        <span class="text-gray-400 mx-2">/</span>
                        <a href="{{ url_for('supplier_views.view_purchase_order', po_id=request.view_args.po_id) }}" class="hover:text-gray-700 dark:hover:text-gray-300">
                            View PO
                        </a>
                        <span class="text-gray-400 mx-2">/</span>
                        <span class="text-gray-700 dark:text-gray-300 font-medium">Edit</span>
                    </nav>
                </div>
            </div>
        </div>
    </div>
    
    <!-- RESTORED: Complete Quick Actions Bar -->
    <div class="quick-actions-bar">
        <div class="quick-actions-left">
            <a href="{{ url_for('universal_views.universal_list_view', entity_type='purchase_orders') }}" class="btn-secondary">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to PO List
            </a>
            <a href="{{ url_for('supplier_views.view_purchase_order', po_id=request.view_args.po_id) }}" class="btn-outline">
                <i class="fas fa-eye mr-2"></i>
                View This PO
            </a>
            <a href="{{ url_for('universal_views.universal_list_view', entity_type='suppliers') }}" class="btn-outline">
                <i class="fas fa-users mr-2"></i>
                Suppliers
            </a>
            <a href="{{ url_for('universal_views.universal_list_view', entity_type='supplier_invoices') }}" class="btn-outline">
                <i class="fas fa-file-invoice mr-2"></i>
                Invoices
            </a>
        </div>
        <button type="button" onclick="window.location.reload()" class="btn-outline">
            <i class="fas fa-undo mr-2"></i>
            Reset Changes
        </button>
    </div>

    <!-- Main Form Content -->
    <form id="purchase-order-edit-form" method="POST" class="px-6">
        {{ form.csrf_token }}
        
        <!-- ENHANCED: Complete PO Header Information with all fields -->
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 mb-6 shadow-sm">
            <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                Purchase Order Information
            </h2>
            
            <!-- Row 1: Main Fields -->
            <div class="po-two-column-grid mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">PO Number</label>
                    {{ form.po_number(class="w-full px-3 py-2 border rounded-md bg-gray-100", readonly=true) }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">PO Date <span class="text-red-500">*</span></label>
                    {{ form.po_date(class="w-full px-3 py-2 border rounded-md") }}
                </div>
            </div>

            <!-- Row 2: Supplier with Universal Select -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Supplier <span class="text-red-500">*</span>
                    <div class="bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-md p-3 mb-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="text-sm font-medium text-blue-800 dark:text-blue-200">Supplier State:</span>
                                <span id="supplier-state" class="ml-2 text-sm font-bold text-blue-900 dark:text-blue-100">
                                    {% if selected_supplier %}{{ selected_supplier.state or '--' }}{% else %}--{% endif %}
                                </span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-blue-800 dark:text-blue-200">State Code:</span>
                                <span id="supplier-state-code" class="ml-2 text-sm font-bold text-blue-900 dark:text-blue-100">
                                    {% if selected_supplier %}{{ selected_supplier.state_code or '--' }}{% else %}--{% endif %}
                                </span>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-blue-800 dark:text-blue-200">GSTIN:</span>
                                <span id="supplier-gstin" class="ml-2 text-sm font-bold text-blue-900 dark:text-blue-100">
                                    {% if selected_supplier %}{{ selected_supplier.gst_registration_number or '--' }}{% else %}--{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>

                </label>
                <select id="supplier_id" name="supplier_id" class="form-select w-full px-3 py-2 border rounded-md" required>
                    {% for choice in form.supplier_id.choices %}
                        <option value="{{ choice[0] }}" 
                                {% if choice[0] %}
                                    data-state="{{ suppliers_dict[choice[0]].state if suppliers_dict and choice[0] in suppliers_dict else '' }}"
                                    data-state-code="{{ suppliers_dict[choice[0]].state_code if suppliers_dict and choice[0] in suppliers_dict else '' }}"
                                    data-gst="{{ suppliers_dict[choice[0]].gst_registration_number if suppliers_dict and choice[0] in suppliers_dict else '' }}"
                                {% endif %}
                                {% if choice[0] and form.supplier_id.data and choice[0]|string == form.supplier_id.data|string %}selected{% endif %}>
                            {{ choice[1] }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Row 3: Dates -->
            <div class="po-two-column-grid mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Expected Delivery Date</label>
                    {{ form.expected_delivery_date(class="w-full px-3 py-2 border rounded-md") }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Quotation Date</label>
                    {{ form.quotation_date(class="w-full px-3 py-2 border rounded-md") }}
                </div>
            </div>

            <!-- Row 4: Reference and Currency -->
            <div class="po-two-column-grid mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Quotation Reference</label>
                    {{ form.quotation_id(class="w-full px-3 py-2 border rounded-md") }}
                </div>
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Currency</label>
                        {{ form.currency_code(class="w-full px-3 py-2 border rounded-md") }}
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Exchange Rate</label>
                        {{ form.exchange_rate(class="w-full px-3 py-2 border rounded-md", step="0.000001") }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Line Items Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 mb-6 shadow-sm">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                <i class="fas fa-list text-blue-500 mr-2"></i>Line Items
            </h3>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 invoice-table">
                    <thead class="bg-gray-50 dark:bg-gray-900">
                        <tr>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">#</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Medicine</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Qty</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Rate</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">MRP</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">GST</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Free</th>
                            <th class="px-2 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Total</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"></th>
                        </tr>
                    </thead>
                    <tbody id="line-items-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        {% if form.line_items %}
                            {% for item in form.line_items %}
                            <tr class="line-item-row">
                                <td class="px-2 py-2 text-center text-sm">{{ loop.index }}</td>
                                <td class="px-2 py-2">
                                    <select class="medicine-select" style="width: 280px;">
                                        <option value="">Select Medicine</option>
                                        {% for medicine in medicines %}
                                        <option value="{{ medicine.medicine_id }}" 
                                                data-gst="{{ medicine.gst_rate or 0 }}"
                                                data-hsn="{{ medicine.hsn_code or '' }}"
                                                data-pack-size="{{ medicine.pack_size or 1 }}"
                                                {% if item.medicine_id.data and medicine.medicine_id|string == item.medicine_id.data|string %}selected{% endif %}>
                                            {{ medicine.medicine_name }}
                                            {% if medicine.strength %} - {{ medicine.strength }}{% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <input type="hidden" 
                                        class="medicine-id-hidden" 
                                        value="{{ item.medicine_id.data or '' }}"
                                        name="line_items-{{ loop.index0 }}-medicine_id">
                                </td>
                                <td class="px-2 py-2 text-center">
                                    <input type="number" class="quantity form-control text-right" 
                                           style="width: 70px;" step="0.01" min="0" 
                                           value="{{ item.quantity.data or 1 }}"
                                           name="line_items-{{ loop.index0 }}-quantity">
                                </td>
                                <td class="px-2 py-2 text-center">
                                    <input type="number" class="rate form-control text-right" 
                                           style="width: 90px;" step="0.01" min="0" 
                                           value="{{ item.pack_purchase_price.data or 0 }}"
                                           name="line_items-{{ loop.index0 }}-pack_purchase_price">
                                </td>
                                <td class="px-2 py-2 text-center">
                                    <input type="number" class="mrp form-control text-right" 
                                           style="width: 90px;" step="0.01" min="0" 
                                           value="{{ item.pack_mrp.data or 0 }}"
                                           name="line_items-{{ loop.index0 }}-pack_mrp">
                                </td>
                                <td class="px-2 py-2 text-center">
                                    <span class="gst-rate text-sm">{{ item.gst_rate.data or 0 }}%</span>
                                    <input type="hidden" class="gst-rate-hidden" value="{{ item.gst_rate.data or 0 }}" 
                                           name="line_items-{{ loop.index0 }}-gst_rate">
                                    <input type="hidden" class="hsn-code-hidden" value="{{ item.hsn_code.data or '' }}" 
                                           name="line_items-{{ loop.index0 }}-hsn_code">
                                    <input type="hidden" class="units-per-pack-hidden" value="{{ item.units_per_pack.data or 1 }}" 
                                           name="line_items-{{ loop.index0 }}-units_per_pack">
                                </td>
                                <td class="px-2 py-2 text-center">
                                    <input type="checkbox" class="is-free-item" 
                                           {% if item.is_free_item.data %}checked{% endif %}
                                           name="line_items-{{ loop.index0 }}-is_free_item">
                                    <input type="hidden" class="discount-percent-hidden" value="{{ item.discount_percent.data or 0 }}" 
                                           name="line_items-{{ loop.index0 }}-discount_percent">
                                </td>
                                <td class="px-2 py-2 text-right">
                                    <div class="line-total font-medium text-sm">0.00</div>
                                    <div class="text-xs text-gray-500 gst-details mt-1"></div>
                                </td>
                                <td class="px-2 py-2 text-center">
                                    <button type="button" class="btn btn-sm btn-danger" onclick="removeLineItem(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr class="empty-row">
                                <td colspan="9" class="text-center py-4 text-gray-500">No line items</td>
                            </tr>
                        {% endif %}
                    </tbody>
                    <tfoot class="bg-gray-50 dark:bg-gray-900">
                        <tr>
                            <td colspan="7" class="px-4 py-3 text-right font-medium">Subtotal:</td>
                            <td class="px-4 py-3 text-right font-bold"><span>₹</span> <span id="subtotal">0.00</span></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="7" class="px-4 py-3 text-right font-medium">Total GST:</td>
                            <td class="px-4 py-3 text-right font-bold"><span>₹</span> <span id="total-gst">0.00</span></td>
                            <td></td>
                        </tr>
                        <tr class="border-t-2 border-gray-300 dark:border-gray-600">
                            <td colspan="7" class="px-4 py-3 text-right font-bold text-lg">Grand Total:</td>
                            <td class="px-4 py-3 text-right font-bold text-lg"><span>₹</span> <span id="grand-total">0.00</span></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="mt-4">
                <button type="button" id="add-line-item" class="btn btn-success">
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </div>
        </div>

        <!-- Additional Information Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 mb-6 shadow-sm">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                <i class="fas fa-sticky-note text-blue-500 mr-2"></i>Additional Information
            </h3>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Delivery Instructions</label>
                    {{ form.delivery_instructions(class="w-full px-3 py-2 border rounded-md", rows=4) }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Terms & Conditions</label>
                    {{ form.terms_conditions(class="w-full px-3 py-2 border rounded-md", rows=4) }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Internal Notes</label>
                    {{ form.notes(class="w-full px-3 py-2 border rounded-md", rows=4) }}
                </div>
            </div>
        </div>

        <!-- Hidden fields -->
        {{ form.medicine_ids(type="hidden") }}
        {{ form.medicine_names(type="hidden") }}
        {{ form.quantities(type="hidden") }}
        {{ form.pack_purchase_prices(type="hidden") }}
        {{ form.pack_mrps(type="hidden") }}
        {{ form.units_per_packs(type="hidden") }}
        {{ form.hsn_codes(type="hidden") }}
        {{ form.gst_rates(type="hidden") }}
        {{ form.cgst_rates(type="hidden") }}
        {{ form.sgst_rates(type="hidden") }}
        {{ form.igst_rates(type="hidden") }}
        {{ form.discount_percents(type="hidden") }}
        {{ form.is_free_items(type="hidden") }}

        <!-- Submit Actions -->
        <div class="flex justify-between items-center p-6 bg-white dark:bg-gray-800 rounded-lg shadow-sm mb-6">
            <div class="text-gray-600 dark:text-gray-400 text-sm italic">
                <i class="fas fa-info-circle mr-1"></i>
                Note: Only draft purchase orders can be edited
            </div>
            <div class="flex gap-3">
                <a href="{{ url_for('supplier_views.view_purchase_order', po_id=request.view_args.po_id) }}" class="btn-outline">
                    <i class="fas fa-times mr-2"></i>Cancel
                </a>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save mr-2"></i>Update Purchase Order
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Line Item Template -->
<template id="line-item-template">
    <tr class="line-item-row">
        <td class="px-2 py-2 text-center text-sm"><span class="row-number"></span></td>
        <td class="px-2 py-2">
            <select class="medicine-select" style="width: 280px;">
                <option value="">Select Medicine</option>
                {% for medicine in medicines %}
                <option value="{{ medicine.medicine_id }}" 
                        data-gst="{{ medicine.gst_rate or 0 }}"
                        data-hsn="{{ medicine.hsn_code or '' }}"
                        data-pack-size="{{ medicine.pack_size or 1 }}">
                    {{ medicine.medicine_name }}
                    {% if medicine.strength %} - {{ medicine.strength }}{% endif %}
                </option>
                {% endfor %}
            </select>
        </td>
        <td class="px-2 py-2 text-center">
            <input type="number" class="quantity form-control text-right" style="width: 70px;" step="0.01" min="0" value="1" name="">
        </td>
        <td class="px-2 py-2 text-center">
            <input type="number" class="rate form-control text-right" style="width: 90px;" step="0.01" min="0" value="0" name="">
        </td>
        <td class="px-2 py-2 text-center">
            <input type="number" class="mrp form-control text-right" style="width: 90px;" step="0.01" min="0" value="0" name="">
        </td>
        <td class="px-2 py-2 text-center">
            <span class="gst-rate text-sm">0%</span>
            <input type="hidden" class="gst-rate-hidden" value="0" name="">
            <input type="hidden" class="hsn-code-hidden" value="" name="">
            <input type="hidden" class="units-per-pack-hidden" value="1" name="">
        </td>
        <td class="px-2 py-2 text-center">
            <input type="checkbox" class="is-free-item" name="">
            <input type="hidden" class="discount-percent-hidden" value="0" name="">
        </td>
        <td class="px-2 py-2 text-right">
            <div class="line-total font-medium text-sm">0.00</div>
            <div class="text-xs text-gray-500 gst-details mt-1"></div>
        </td>
        <td class="px-2 py-2 text-center">
            <button type="button" class="btn btn-sm btn-danger" onclick="removeLineItem(this)">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    </tr>
</template>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/components/universal_dropdown_search_adapter.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let lineItemIndex = {{ form.line_items|length or 0 }};
    let currentSupplierState = '';
    let currentSupplierStateCode = ''; 
    
    calculateAllTotals();
    
    
    // Supplier update - FIXED: Wait for DOM to be fully ready
    const supplierSelect = document.querySelector('select[name="supplier_id"]');
    if (supplierSelect) {
        function updateSupplierInfo() {
            const option = supplierSelect.options[supplierSelect.selectedIndex];
            if (option && option.value) {
                document.getElementById('supplier-state').textContent = option.getAttribute('data-state') || '--';
                document.getElementById('supplier-state-code').textContent = option.getAttribute('data-state-code') || '--';
                document.getElementById('supplier-gstin').textContent = option.getAttribute('data-gst') || '--';
                currentSupplierStateCode = option.getAttribute('data-state-code') || '';
            }
        }
        supplierSelect.addEventListener('change', updateSupplierInfo);
        
        // FIXED: Use requestAnimationFrame to ensure DOM is ready
        requestAnimationFrame(function() {
            setTimeout(updateSupplierInfo, 100);
        });
    }
    
    // Add line item
    document.getElementById('add-line-item').addEventListener('click', function() {
        const tbody = document.getElementById('line-items-body');
        const emptyRow = tbody.querySelector('.empty-row');
        if (emptyRow) emptyRow.remove();
        
        const template = document.getElementById('line-item-template');
        const newRow = template.content.cloneNode(true);
        newRow.querySelector('.row-number').textContent = tbody.querySelectorAll('.line-item-row').length + 1;
        
        tbody.appendChild(newRow);
        lineItemIndex++;
        
    });
    
    window.removeLineItem = function(button) {
        button.closest('tr').remove();
        document.querySelectorAll('.line-item-row').forEach((row, idx) => {
            row.querySelector('td:first-child').textContent = idx + 1;
        });
        calculateAllTotals();
    };
    
    document.getElementById('line-items-body').addEventListener('change', function(e) {
        if (e.target.classList.contains('quantity') || e.target.classList.contains('rate') || e.target.classList.contains('is-free-item')) {
            calculateAllTotals();
        }
    });
    
    function calculateAllTotals() {
        let subtotal = 0, totalGst = 0;
        
        document.querySelectorAll('.line-item-row').forEach(row => {
            const qty = parseFloat(row.querySelector('.quantity').value) || 0;
            const rate = parseFloat(row.querySelector('.rate').value) || 0;
            const gstRate = parseFloat(row.querySelector('.gst-rate-hidden').value) || 0;
            const isFree = row.querySelector('.is-free-item').checked;
            
            const lineAmount = qty * rate;
            subtotal += lineAmount;
            
            let gstAmount = 0;
            if (!isFree && gstRate > 0) {
                gstAmount = lineAmount * (gstRate / 100);
                totalGst += gstAmount;
            }
            
            row.querySelector('.line-total').textContent = (lineAmount + gstAmount).toFixed(2);
        });
        
        document.getElementById('subtotal').textContent = subtotal.toFixed(2);
        document.getElementById('total-gst').textContent = totalGst.toFixed(2);
        document.getElementById('grand-total').textContent = (subtotal + totalGst).toFixed(2);
    }
    
    document.getElementById('purchase-order-edit-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const lineItems = [];
        document.querySelectorAll('.line-item-row').forEach(row => {
            const medicineId = row.querySelector('.medicine-id-hidden').value;
            const medicineName = row.querySelector('.medicine-select').value;
            
            if (medicineId && medicineName) {
                lineItems.push({
                    medicine_id: medicineId,
                    medicine_name: medicineName,
                    quantity: row.querySelector('.quantity').value,
                    rate: row.querySelector('.rate').value,
                    mrp: row.querySelector('.mrp').value || 0,
                    units_per_pack: row.querySelector('.units-per-pack-hidden').value || 1,
                    hsn_code: row.querySelector('.hsn-code-hidden').value || '',
                    gst_rate: row.querySelector('.gst-rate-hidden').value || 0,
                    is_free: row.querySelector('.is-free-item').checked
                });
            }
        });
        
        const form = this;
        form.medicine_ids.value = lineItems.map(item => item.medicine_id).join(',');
        form.medicine_names.value = lineItems.map(item => item.medicine_name).join(',');
        form.quantities.value = lineItems.map(item => item.quantity).join(',');
        form.pack_purchase_prices.value = lineItems.map(item => item.rate).join(',');
        form.pack_mrps.value = lineItems.map(item => item.mrp).join(',');
        form.units_per_packs.value = lineItems.map(item => item.units_per_pack).join(',');
        form.hsn_codes.value = lineItems.map(item => item.hsn_code).join(',');
        form.gst_rates.value = lineItems.map(item => item.gst_rate).join(',');
        
        const cgstRates = [], sgstRates = [], igstRates = [];
        lineItems.forEach(item => {
            if (currentSupplierStateCode === '29') {
                cgstRates.push(item.gst_rate / 2);
                sgstRates.push(item.gst_rate / 2);
                igstRates.push(0);
            } else {
                cgstRates.push(0);
                sgstRates.push(0);
                igstRates.push(item.gst_rate);
            }
        });
        
        form.cgst_rates.value = cgstRates.join(',');
        form.sgst_rates.value = sgstRates.join(',');
        form.igst_rates.value = igstRates.join(',');
        form.discount_percents.value = lineItems.map(() => 0).join(',');
        form.is_free_items.value = lineItems.map(item => item.is_free ? '1' : '0').join(',');
        
        this.submit();
    });
});
</script>
{% endblock %}