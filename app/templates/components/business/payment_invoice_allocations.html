<!-- templates/components/business/payment_invoice_allocations.html -->
<!-- Payment Invoice Allocations - Shows which invoices were paid by this payment -->
{% if data.has_allocations %}
<div class="payment-allocations-container">
    <!-- Summary Card -->
    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
                <p class="text-xs text-blue-700 dark:text-blue-300">Invoices Paid</p>
                <p class="text-sm font-bold text-blue-900 dark:text-blue-100">
                    {{ data.get('allocation_count', 0) }}
                    {% if data.get('is_multi_invoice_payment') %}
                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300">
                            Multi-Invoice
                        </span>
                    {% endif %}
                </p>
            </div>
            <div>
                <p class="text-xs text-blue-700 dark:text-blue-300">Invoice Payments</p>
                <p class="text-sm font-bold text-blue-900 dark:text-blue-100">
                    {{ data.get('currency_symbol', '₹') }}{{ "{:,.2f}".format(data.get('total_allocated', 0)) }}
                </p>
            </div>
            {% if data.get('has_package_installments') %}
            <div>
                <p class="text-xs text-blue-700 dark:text-blue-300">Package Installments</p>
                <p class="text-sm font-bold text-purple-900 dark:text-purple-100">
                    {{ data.get('currency_symbol', '₹') }}{{ "{:,.2f}".format(data.get('package_installment_total', 0)) }}
                </p>
            </div>
            {% endif %}
            <div>
                <p class="text-xs text-blue-700 dark:text-blue-300">Total Allocated</p>
                <p class="text-sm font-bold text-green-900 dark:text-green-100">
                    {{ data.get('currency_symbol', '₹') }}{{ "{:,.2f}".format(data.get('grand_total_allocated', data.get('total_allocated', 0))) }}
                </p>
            </div>
        </div>
    </div>

    <!-- Allocations Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-800">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        Invoice #
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        Invoice Date
                    </th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        Invoice Total
                    </th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        Allocated Amount
                    </th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        Allocation %
                    </th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        Status
                    </th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                {% for allocation in data.allocations %}
                <tr class="{% if allocation.is_cancelled %}bg-red-50 dark:bg-red-900/20{% endif %}">
                    <td class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-gray-100">
                        {{ allocation.invoice_number }}
                        {% if allocation.is_cancelled %}
                            <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300">
                                Cancelled
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">
                        {% if allocation.invoice_date %}
                            {% set invoice_date_str = allocation.invoice_date|string %}
                            {% if 'T' in invoice_date_str %}
                                {# Handle ISO format dates #}
                                {% set date_parts = invoice_date_str.split('T')[0].split('-') %}
                                {% set months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] %}
                                {% if date_parts|length >= 3 %}
                                    {{ date_parts[2] }}/{{ months[date_parts[1]|int - 1] }}/{{ date_parts[0] }}
                                {% else %}
                                    {{ allocation.invoice_date }}
                                {% endif %}
                            {% else %}
                                {# Handle pre-formatted dates #}
                                {{ allocation.invoice_date }}
                            {% endif %}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm text-right text-gray-900 dark:text-gray-100">
                        {{ data.get('currency_symbol', '₹') }}{{ "{:,.2f}".format(allocation.get('invoice_total', 0)) }}
                    </td>
                    <td class="px-4 py-3 text-sm text-right font-medium text-blue-900 dark:text-blue-100">
                        {{ data.get('currency_symbol', '₹') }}{{ "{:,.2f}".format(allocation.get('allocated_amount', 0)) }}
                    </td>
                    <td class="px-4 py-3 text-center">
                        {% set allocation_pct = (allocation.get('allocated_amount', 0) / allocation.get('invoice_total', 1) * 100) if allocation.get('invoice_total', 0) > 0 else 0 %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                            {% if allocation_pct >= 100 %}
                                bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300
                            {% elif allocation_pct >= 50 %}
                                bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300
                            {% else %}
                                bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300
                            {% endif %}">
                            {{ "{:.1f}".format(allocation_pct) }}%
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        {% if allocation.is_cancelled %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300">
                                <i class="fas fa-ban mr-1"></i> Cancelled
                            </span>
                        {% elif allocation_pct >= 100 %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300">
                                <i class="fas fa-check-circle mr-1"></i> Fully Paid
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300">
                                <i class="fas fa-hourglass-half mr-1"></i> Partial
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-center">
                        <a href="{{ url_for('universal_views.universal_detail_view', entity_type=data.get('entity_type', 'patient_invoices'), item_id=allocation.invoice_id) }}"
                           class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300"
                           target="_blank"
                           title="View Invoice Details">
                            <i class="fas fa-file-invoice"></i> View
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot class="bg-gray-50 dark:bg-gray-800">
                <tr>
                    <td colspan="3" class="px-4 py-3 text-right text-sm font-bold text-gray-900 dark:text-gray-100">
                        Total Allocated:
                    </td>
                    <td class="px-4 py-3 text-right text-sm font-bold text-blue-900 dark:text-blue-100">
                        {{ data.get('currency_symbol', '₹') }}{{ "{:,.2f}".format(data.get('total_allocated', 0)) }}
                    </td>
                    <td colspan="3"></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Package Installments Section -->
    {% if data.get('has_package_installments') %}
    <div class="mt-4">
        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
            <i class="fas fa-box text-purple-600"></i> Package Installment Payments
        </h4>
        <div class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg p-4">
            {% for installment in data.get('package_installments', []) %}
            <div class="flex justify-between items-center {% if not loop.last %}mb-3 pb-3 border-b border-purple-200 dark:border-purple-700{% endif %}">
                <div>
                    <p class="text-sm font-medium text-gray-900 dark:text-gray-100">
                        {% if installment.installment_number %}
                            Installment #{{ installment.installment_number }}
                        {% else %}
                            Package Installment Payment
                        {% endif %}
                        {% if installment.is_partial %}
                            <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300">
                                Partial Payment
                            </span>
                        {% endif %}
                    </p>
                    {% if installment.is_partial %}
                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                        Paid {{ data.get('currency_symbol', '₹') }}{{ "{:,.2f}".format(installment.amount) }}
                        of {{ data.get('currency_symbol', '₹') }}{{ "{:,.2f}".format(installment.full_installment_amount) }} due
                    </p>
                    {% endif %}
                </div>
                <div class="text-right">
                    <p class="text-sm font-bold text-purple-900 dark:text-purple-100">
                        {{ data.get('currency_symbol', '₹') }}{{ "{:,.2f}".format(installment.amount) }}
                    </p>
                    {% if installment.transaction_date %}
                    <p class="text-xs text-gray-500 dark:text-gray-400">
                        {% set date_str = installment.transaction_date|string %}
                        {% if 'T' in date_str %}
                            {% set date_parts = date_str.split('T')[0].split('-') %}
                            {{ date_parts[2] }}/{{ date_parts[1] }}/{{ date_parts[0] }}
                        {% else %}
                            {{ installment.transaction_date }}
                        {% endif %}
                    </p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            <div class="mt-3 pt-3 border-t border-purple-300 dark:border-purple-700 flex justify-between items-center">
                <p class="text-sm font-bold text-gray-900 dark:text-gray-100">Total Package Installments:</p>
                <p class="text-sm font-bold text-purple-900 dark:text-purple-100">
                    {{ data.get('currency_symbol', '₹') }}{{ "{:,.2f}".format(data.get('package_installment_total', 0)) }}
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Info Note for Multi-Invoice Payments -->
    {% if data.get('is_multi_invoice_payment') %}
    <div class="mt-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3">
        <div class="flex items-start">
            <i class="fas fa-info-circle text-yellow-600 dark:text-yellow-400 mt-0.5 mr-2"></i>
            <div class="text-sm text-yellow-800 dark:text-yellow-200">
                <strong>Multi-Invoice Payment:</strong> This payment was split across multiple invoices.
                Each invoice shows the allocated amount from this payment. Click "View" to see complete invoice details and payment history.
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% else %}
<div class="text-center py-8">
    <i class="fas fa-file-invoice-dollar text-4xl text-gray-300 dark:text-gray-600 mb-3"></i>
    <p class="text-gray-500 dark:text-gray-400">
        {{ data.get('error', 'No invoice allocations found for this payment') }}
    </p>
    {% if data.get('error') %}
    <p class="text-sm text-red-600 dark:text-red-400 mt-2">
        <i class="fas fa-exclamation-triangle"></i> {{ data.error }}
    </p>
    {% endif %}
</div>
{% endif %}
