<!-- templates/components/business/payment_history_table.html -->
<div class="container-fluid px-0" style="max-width: 100%;">

{% if data.has_history %}
<div class="payment-history-container" style="width: 100%;">

    <!-- Summary Card - Compact -->
    {% if data.get('invoice_summary') %}
    <div class="alert alert-info mb-3">
        <i class="fas fa-receipt"></i>
        <strong>Invoice:</strong> {{ data.invoice_summary.invoice_number }}
        | <strong>Total Paid:</strong> ₹{{ "{:,.2f}".format(data.summary.total_paid) }}
        | <strong>Payments:</strong> {{ data.summary.payment_count }}
        | <strong>Balance:</strong> ₹{{ "{:,.2f}".format(data.invoice_summary.balance_due) }}
    </div>
    {% endif %}

    <!-- Payment History Table - Same styling as invoice items -->
    <div class="table-responsive" style="width: 100%;">
        <table class="table table-bordered table-hover payment-items-table table-sm" style="width: 100%; table-layout: fixed;">
            <thead class="table-light">
                <tr>
                    <th width="5%" style="text-align: left !important;">#</th>
                    <th width="15%" style="text-align: left !important;">Date</th>
                    <th width="20%" style="text-align: left !important;">Receipt No.</th>
                    <th width="18%" style="text-align: left !important;">Payment Mode</th>
                    <th width="15%" class="text-end">Amount</th>
                    <th width="15%" style="text-align: center !important;">Status</th>
                    <th width="12%" style="text-align: center !important;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for payment in data.payments %}
                <tr>
                    <td style="text-align: left !important;">{{ loop.index }}</td>
                    <td>
                        {% if payment.payment_date %}
                            {% set payment_date_str = payment.payment_date|string %}
                            {% if 'T' in payment_date_str %}
                                {% set date_parts = payment_date_str.split('T')[0].split('-') %}
                                {% set months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] %}
                                {% if date_parts|length >= 3 %}
                                    {{ date_parts[2] }}-{{ months[date_parts[1]|int - 1] }}-{{ date_parts[0] }}
                                {% else %}
                                    {{ payment.payment_date }}
                                {% endif %}
                            {% else %}
                                {{ payment.payment_date }}
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <strong>{{ payment.reference_no }}</strong>
                    </td>
                    <td>
                        <span class="badge {% if payment.payment_method == 'cash' %}bg-success{% elif payment.payment_method in ['bank_transfer', 'upi'] %}bg-primary{% elif payment.payment_method == 'cheque' %}bg-warning{% else %}bg-secondary{% endif %}">
                            {{ payment.payment_method|title|replace('_', ' ') }}
                        </span>
                    </td>
                    <td class="text-end fw-bold">
                        ₹{{ "{:,.2f}".format(payment.allocated_amount) }}
                        {% if payment.is_partial %}
                        <small class="d-block text-warning" style="font-size: 0.7rem;">(Partial)</small>
                        {% endif %}
                    </td>
                    <td style="text-align: center !important;">
                        <span class="badge {% if payment.workflow_status in ['approved', 'completed'] %}bg-success{% elif payment.workflow_status == 'pending' %}bg-warning{% else %}bg-secondary{% endif %}">
                            {{ payment.workflow_status|title }}
                        </span>
                    </td>
                    <td style="text-align: center !important;">
                        <a href="{{ url_for('universal_views.universal_detail_view', entity_type='patient_payments', item_id=payment.payment_id) }}"
                           class="btn btn-sm btn-outline-primary"
                           title="View Payment"
                           target="_blank"
                           rel="noopener noreferrer">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot class="table-light">
                <tr class="table-primary">
                    <td colspan="4" class="text-end"><strong>Total Allocated to This Invoice:</strong></td>
                    <td class="text-end"><strong class="text-primary">₹{{ "{:,.2f}".format(data.summary.total_paid) }}</strong></td>
                    <td colspan="2" class="text-center">{{ data.summary.payment_count }} payment{{ 's' if data.summary.payment_count != 1 else '' }}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

{% else %}
<!-- No Payments Message -->
<div class="alert alert-info">
    <i class="fas fa-info-circle"></i>
    {{ data.get('message', 'No payments recorded for this invoice.') }}
</div>
{% endif %}

</div>

<style>
.payment-items-table {
    font-size: 0.9rem;
    width: 100% !important;
}

.payment-items-table thead th {
    background-color: #f8f9fa;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
}

.payment-items-table th,
.payment-items-table td {
    padding: 0.4rem 0.5rem !important;
    vertical-align: middle;
}

.payment-items-table tfoot td {
    font-weight: 500;
}

.payment-items-table tbody tr:hover {
    background-color: #f8f9fa;
}

.table-primary td {
    background-color: #cfe2ff !important;
}

.fw-bold {
    font-weight: bold !important;
}

.text-end {
    text-align: right !important;
}

.badge {
    font-size: 0.7rem !important;
    padding: 0.2rem 0.4rem !important;
}

.btn-sm {
    padding: 0.25rem 0.5rem !important;
    font-size: 0.8rem !important;
}

.d-block {
    display: block !important;
}
</style>