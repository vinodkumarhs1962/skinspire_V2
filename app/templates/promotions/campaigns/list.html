{% extends "layouts/dashboard.html" %}

{% block title %}{{ page_title }} - Skinspire{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/filters.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/cards.css') }}">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-4">
    <!-- Page Header -->
    <div class="mb-6">
        <!-- Row 1: Title and Date -->
        <div class="flex flex-wrap justify-between items-center">
            <div>
                <nav class="text-sm text-gray-500 mb-2">
                    <a href="{{ url_for('promotion_views.dashboard') }}" class="hover:text-blue-600">
                        <i class="fas fa-tags mr-1"></i>Promotions
                    </a>
                    <span class="mx-2">/</span>
                    <span class="text-gray-900 dark:text-white">Campaigns</span>
                </nav>
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">
                    <i class="fas fa-bullhorn mr-2 text-blue-600"></i>Campaign Promotions
                </h1>
            </div>
            <div class="text-right px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                <div class="text-base font-semibold text-gray-900 dark:text-white">{{ today_display }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">{{ today_day }}</div>
            </div>
        </div>
        <!-- Row 2: Action Buttons -->
        <div class="flex flex-wrap gap-2 mt-4">
            <a href="{{ url_for('promotion_views.dashboard') }}" class="btn-back">
                <i class="fas fa-arrow-left mr-2"></i>Back
            </a>
            <a href="{{ url_for('promotion_views.dashboard') }}" class="btn-secondary">
                <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
            </a>
            <a href="{{ url_for('promotion_views.campaign_create') }}" class="btn-primary">
                <i class="fas fa-plus mr-2"></i>New Campaign
            </a>
            <a href="{{ url_for('promotion_views.group_list') }}" class="btn-secondary">
                <i class="fas fa-object-group mr-2"></i>Campaign Groups
            </a>
            <a href="{{ url_for('promotion_views.bulk_config') }}" class="btn-secondary">
                <i class="fas fa-layer-group mr-2"></i>Bulk Config
            </a>
            <a href="{{ url_for('promotion_views.loyalty_config') }}" class="btn-secondary">
                <i class="fas fa-heart mr-2"></i>Loyalty Config
            </a>
        </div>
    </div>

    <!-- Summary Cards - Square style like universal engine -->
    <div class="grid grid-cols-4 gap-4 mb-6">
        <!-- Active Campaigns -->
        <div class="universal-stat-card clickable" onclick="applyCampaignFilter('is_active', 'true')">
            <div class="stat-card-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-card-value">{{ summary.active_count|default(0) }}</div>
            <div class="stat-card-label">Active</div>
        </div>
        <!-- Inactive Campaigns -->
        <div class="universal-stat-card clickable" onclick="applyCampaignFilter('is_active', 'false')">
            <div class="stat-card-icon neutral">
                <i class="fas fa-pause-circle"></i>
            </div>
            <div class="stat-card-value">{{ summary.inactive_count|default(0) }}</div>
            <div class="stat-card-label">Inactive</div>
        </div>
        <!-- Expiring Soon -->
        <div class="universal-stat-card">
            <div class="stat-card-icon warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-card-value">{{ summary.expiring_soon|default(0) }}</div>
            <div class="stat-card-label">Expiring Soon</div>
        </div>
        <!-- Total Uses This Month -->
        <div class="universal-stat-card">
            <div class="stat-card-icon primary">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-card-value">{{ summary.uses_this_month|default(0) }}</div>
            <div class="stat-card-label">Uses This Month</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg p-6 mb-6">
        <form id="filter-form" method="GET" action="{{ url_for('promotion_views.campaign_list') }}">
            <!-- Date Range Filter Section -->
            <div class="universal-date-filter-section mb-4">
                <div class="universal-date-filter-title">
                    <i class="fas fa-calendar-alt"></i>Date Range
                </div>
                <div class="universal-date-filter-presets-row">
                    <button type="button" class="universal-date-preset-btn universal-date-filter-preset" data-preset="today">
                        <i class="fas fa-calendar-day"></i>Today
                    </button>
                    <button type="button" class="universal-date-preset-btn universal-date-filter-preset" data-preset="this_month">
                        <i class="fas fa-calendar-alt"></i>This Month
                    </button>
                    <button type="button" class="universal-date-preset-btn universal-date-filter-preset" data-preset="financial_year">
                        <i class="fas fa-calendar"></i>Financial Year
                    </button>
                    <button type="button" class="universal-date-preset-btn universal-date-filter-preset" data-preset="clear">
                        <i class="fas fa-times"></i>Clear
                    </button>
                </div>
                <div class="universal-date-filter-inputs-row">
                    <div class="universal-date-input-group">
                        <label class="universal-date-label">From Date</label>
                        <input type="date" name="start_date" id="start_date"
                            value="{{ filters.get('start_date', '') }}"
                            class="universal-form-input">
                    </div>
                    <div class="universal-date-separator-container">
                        <span class="universal-date-filter-separator">to</span>
                    </div>
                    <div class="universal-date-input-group">
                        <label class="universal-date-label">To Date</label>
                        <input type="date" name="end_date" id="end_date"
                            value="{{ filters.get('end_date', '') }}"
                            class="universal-form-input">
                    </div>
                </div>
            </div>

            <!-- Other Filters -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                <div>
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="search">
                        Search
                    </label>
                    <input type="text" id="search" name="search" value="{{ filters.get('search', '') }}"
                           placeholder="Code, name, description..."
                           class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div>
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="is_active">
                        Status
                    </label>
                    <select id="is_active" name="is_active" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">All Statuses</option>
                        <option value="true" {% if filters.get('is_active') == true or filters.get('is_active') == 'true' %}selected{% endif %}>Active</option>
                        <option value="false" {% if filters.get('is_active') == false or filters.get('is_active') == 'false' %}selected{% endif %}>Inactive</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="promotion_type">
                        Promotion Type
                    </label>
                    <select id="promotion_type" name="promotion_type" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">All Types</option>
                        <option value="simple_discount" {% if filters.get('promotion_type') == 'simple_discount' %}selected{% endif %}>Simple Discount</option>
                        <option value="buy_x_get_y" {% if filters.get('promotion_type') == 'buy_x_get_y' %}selected{% endif %}>Buy X Get Y</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="applies_to">
                        Applies To
                    </label>
                    <select id="applies_to" name="applies_to" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">All Items</option>
                        <option value="all" {% if filters.get('applies_to') == 'all' %}selected{% endif %}>All (Universal)</option>
                        <option value="services" {% if filters.get('applies_to') == 'services' %}selected{% endif %}>Services</option>
                        <option value="medicines" {% if filters.get('applies_to') == 'medicines' %}selected{% endif %}>Medicines</option>
                        <option value="packages" {% if filters.get('applies_to') == 'packages' %}selected{% endif %}>Packages</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <div class="flex space-x-2">
                        <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            <i class="fas fa-search mr-2"></i>Filter
                        </button>
                        <a href="{{ url_for('promotion_views.campaign_list') }}" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-white font-bold py-2 px-4 rounded">
                            <i class="fas fa-times"></i>
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Active Filters Display -->
    {% set has_filters = filters.get('search') or filters.get('is_active') is not none or filters.get('promotion_type') or filters.get('applies_to') or filters.get('start_date') or filters.get('end_date') %}
    {% if has_filters %}
    <div class="universal-active-filters mb-4">
        <div class="universal-active-filters-list">
            <span class="universal-active-filters-label">
                <i class="fas fa-filter"></i> Active Filters:
            </span>
            {% if filters.get('start_date') or filters.get('end_date') %}
            <span class="universal-filter-tag">
                <span class="filter-name">Date:</span>
                <span class="filter-value">{{ filters.get('start_date', 'Any') }} to {{ filters.get('end_date', 'Any') }}</span>
                <button type="button" class="universal-filter-remove" onclick="removeFilter('start_date', 'end_date')">
                    <i class="fas fa-times"></i>
                </button>
            </span>
            {% endif %}
            {% if filters.get('search') %}
            <span class="universal-filter-tag">
                <span class="filter-name">Search:</span>
                <span class="filter-value">{{ filters.get('search') }}</span>
                <button type="button" class="universal-filter-remove" onclick="removeFilter('search')">
                    <i class="fas fa-times"></i>
                </button>
            </span>
            {% endif %}
            {% if filters.get('is_active') is not none %}
            <span class="universal-filter-tag">
                <span class="filter-name">Status:</span>
                <span class="filter-value">{{ 'Active' if filters.get('is_active') == true else 'Inactive' }}</span>
                <button type="button" class="universal-filter-remove" onclick="removeFilter('is_active')">
                    <i class="fas fa-times"></i>
                </button>
            </span>
            {% endif %}
            {% if filters.get('promotion_type') %}
            <span class="universal-filter-tag">
                <span class="filter-name">Type:</span>
                <span class="filter-value">{{ filters.get('promotion_type')|replace('_', ' ')|title }}</span>
                <button type="button" class="universal-filter-remove" onclick="removeFilter('promotion_type')">
                    <i class="fas fa-times"></i>
                </button>
            </span>
            {% endif %}
            {% if filters.get('applies_to') %}
            <span class="universal-filter-tag">
                <span class="filter-name">Applies To:</span>
                <span class="filter-value">{{ filters.get('applies_to')|title }}</span>
                <button type="button" class="universal-filter-remove" onclick="removeFilter('applies_to')">
                    <i class="fas fa-times"></i>
                </button>
            </span>
            {% endif %}
            <a href="{{ url_for('promotion_views.campaign_list') }}" class="text-red-600 hover:text-red-800 text-sm font-medium ml-2">
                <i class="fas fa-times-circle mr-1"></i>Clear All
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Results Info -->
    <div class="flex justify-between items-center mb-4 text-sm text-gray-600 dark:text-gray-400">
        <div>
            Showing {{ ((page - 1) * per_page) + 1 }} - {{ [page * per_page, total]|min }} of {{ total }} campaigns
        </div>
        <div class="flex items-center gap-2">
            <label>Per page:</label>
            <select onchange="changePerPage(this.value)" class="rounded border-gray-300 text-sm dark:bg-gray-700 dark:border-gray-600">
                <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            </select>
        </div>
    </div>

    <!-- Campaigns Table -->
    <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
        {% if campaigns and campaigns|length > 0 %}
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white dark:bg-gray-800">
                <thead>
                    <tr class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-left">
                        <th class="py-3 px-4 font-semibold">Campaign</th>
                        <th class="py-3 px-4 font-semibold">Discount</th>
                        <th class="py-3 px-4 font-semibold">Period</th>
                        <th class="py-3 px-4 font-semibold">Applies To</th>
                        <th class="py-3 px-4 font-semibold">Campaign Groups</th>
                        <th class="py-3 px-4 font-semibold text-center">Status</th>
                        <th class="py-3 px-4 font-semibold text-center">Uses</th>
                        <th class="py-3 px-4 font-semibold text-center">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% for campaign in campaigns %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="py-3 px-4">
                            <a href="{{ url_for('promotion_views.campaign_detail', campaign_id=campaign.campaign_id) }}"
                               class="text-blue-600 dark:text-blue-400 hover:underline font-medium">
                                {{ campaign.campaign_code }}
                            </a>
                            <p class="text-sm text-gray-500 dark:text-gray-400">{{ campaign.campaign_name }}</p>
                            <div class="flex flex-wrap gap-1 mt-1">
                                <!-- Promotion Type Badge -->
                                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium
                                    {% if campaign.promotion_type == 'buy_x_get_y' %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300
                                    {% else %}bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300{% endif %}">
                                    {% if campaign.promotion_type == 'buy_x_get_y' %}
                                    <i class="fas fa-gift mr-1"></i>Buy X Get Y
                                    {% else %}
                                    <i class="fas fa-percent mr-1"></i>Discount
                                    {% endif %}
                                </span>
                                {% if campaign.is_personalized %}
                                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300">
                                    <i class="fas fa-user-secret mr-1"></i>Private
                                </span>
                                {% endif %}
                                {% if campaign.target_special_group %}
                                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300">
                                    <i class="fas fa-star mr-1"></i>VIP
                                </span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="py-3 px-4">
                            <span class="font-medium text-gray-900 dark:text-white">{{ campaign.discount_value }}</span>
                            <span class="text-gray-500">{% if campaign.discount_type == 'percentage' %}%{% else %} flat{% endif %}</span>
                        </td>
                        <td class="py-3 px-4 text-sm text-gray-500 dark:text-gray-400">
                            <div>{{ campaign.start_date if campaign.start_date else '-' }}</div>
                            <div class="text-xs">to {{ campaign.end_date if campaign.end_date else '-' }}</div>
                        </td>
                        <td class="py-3 px-4">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                                {{ campaign.applies_to|title }}
                            </span>
                        </td>
                        <td class="py-3 px-4">
                            {% if campaign.target_group_details and campaign.target_group_details|length > 0 %}
                            <div class="flex flex-wrap gap-1">
                                {% for group in campaign.target_group_details[:2] %}
                                <a href="{{ url_for('promotion_views.group_detail', group_id=group.group_id) }}"
                                   class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300 hover:bg-purple-200">
                                    <i class="fas fa-object-group mr-1"></i>{{ group.group_name }}
                                </a>
                                {% endfor %}
                                {% if campaign.target_group_details|length > 2 %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-50 text-purple-600 dark:bg-purple-900/20 dark:text-purple-400">
                                    +{{ campaign.target_group_details|length - 2 }} more
                                </span>
                                {% endif %}
                            </div>
                            {% elif campaign.target_groups and campaign.target_groups.group_ids %}
                            <!-- Fallback -->
                            <div class="flex flex-wrap gap-1">
                                {% for group_name in campaign.target_group_names[:2] %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300">
                                    <i class="fas fa-object-group mr-1"></i>{{ group_name }}
                                </span>
                                {% endfor %}
                            </div>
                            {% else %}
                            <span class="text-gray-400 text-sm">-</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4 text-center">
                            <div class="flex flex-col items-center gap-1">
                                <!-- Approval Status -->
                                {% set status = campaign.status|default('approved') %}
                                {% if status == 'draft' %}
                                <span class="px-2 py-0.5 text-xs rounded-full bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-300">
                                    <i class="fas fa-file-alt mr-1"></i>Draft
                                </span>
                                {% elif status == 'pending_approval' %}
                                <span class="px-2 py-0.5 text-xs rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300">
                                    <i class="fas fa-clock mr-1"></i>Pending
                                </span>
                                {% elif status == 'rejected' %}
                                <span class="px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300">
                                    <i class="fas fa-times-circle mr-1"></i>Rejected
                                </span>
                                {% else %}
                                <span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300">
                                    <i class="fas fa-check-circle mr-1"></i>Approved
                                </span>
                                {% endif %}
                                <!-- Active/Inactive Status -->
                                {% if campaign.is_active %}
                                <span class="px-2 py-0.5 text-xs rounded-full bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800">
                                    <i class="fas fa-toggle-on mr-1"></i>Active
                                </span>
                                {% else %}
                                <span class="px-2 py-0.5 text-xs rounded-full bg-gray-50 text-gray-500 dark:bg-gray-800 dark:text-gray-400 border border-gray-200 dark:border-gray-700">
                                    <i class="fas fa-toggle-off mr-1"></i>Inactive
                                </span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="py-3 px-4 text-center">
                            <span class="font-medium text-gray-900 dark:text-white">{{ campaign.current_uses }}</span>
                            {% if campaign.max_total_uses %}
                            <span class="text-gray-500">/{{ campaign.max_total_uses }}</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex justify-center space-x-1">
                                <a href="{{ url_for('promotion_views.campaign_detail', campaign_id=campaign.campaign_id) }}"
                                   class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-1" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ url_for('promotion_views.campaign_edit', campaign_id=campaign.campaign_id) }}"
                                   class="text-yellow-600 dark:text-yellow-400 hover:text-yellow-800 dark:hover:text-yellow-300 p-1" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <!-- Approval Action Button - toggles based on status -->
                                {% set status = campaign.status|default('approved') %}
                                {% if status == 'draft' %}
                                <button type="button" onclick="submitForApproval('{{ campaign.campaign_id }}')"
                                        class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-1" title="Submit for Approval">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                                {% elif status == 'pending_approval' %}
                                <button type="button" onclick="approveCampaign('{{ campaign.campaign_id }}')"
                                        class="text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-300 p-1" title="Approve">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button type="button" onclick="rejectCampaign('{{ campaign.campaign_id }}')"
                                        class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 p-1" title="Reject">
                                    <i class="fas fa-ban"></i>
                                </button>
                                {% elif status == 'rejected' %}
                                <button type="button" onclick="resubmitCampaign('{{ campaign.campaign_id }}')"
                                        class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-1" title="Resubmit for Approval">
                                    <i class="fas fa-redo"></i>
                                </button>
                                {% else %}
                                <span class="text-green-500 p-1" title="Approved">
                                    <i class="fas fa-certificate"></i>
                                </span>
                                {% endif %}
                                {% set is_launched = status == 'approved' and campaign.start_date and campaign.start_date <= today %}
                                {% if is_launched and not campaign.is_active %}
                                <!-- Launched and inactive - cannot be re-activated -->
                                <span class="text-gray-400 p-1 cursor-not-allowed" title="Launched campaigns cannot be re-activated">
                                    <i class="fas fa-toggle-off"></i>
                                </span>
                                {% else %}
                                <button type="button" onclick="toggleCampaign('{{ campaign.campaign_id }}')"
                                        class="text-orange-600 dark:text-orange-400 hover:text-orange-800 dark:hover:text-orange-300 p-1"
                                        title="{{ 'Deactivate (launched campaign)' if is_launched else 'Toggle Active/Inactive' }}">
                                    <i class="fas fa-toggle-{{ 'on' if campaign.is_active else 'off' }}"></i>
                                </button>
                                {% endif %}
                                <button type="button" onclick="duplicateCampaign('{{ campaign.campaign_id }}')"
                                        class="text-teal-600 dark:text-teal-400 hover:text-teal-800 dark:hover:text-teal-300 p-1" title="Duplicate">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button type="button" onclick="deleteCampaign('{{ campaign.campaign_id }}', '{{ campaign.campaign_code }}')"
                                        class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 p-1" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if pages > 1 %}
        <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 flex items-center justify-between border-t border-gray-200 dark:border-gray-600 sm:px-6">
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700 dark:text-gray-300">
                        Showing <span class="font-medium">{{ (page - 1) * per_page + 1 }}</span> to <span class="font-medium">{{ [page * per_page, total]|min }}</span> of <span class="font-medium">{{ total }}</span> results
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        {% if page > 1 %}
                        <a href="{{ url_for('promotion_views.campaign_list', page=page-1, **filters) }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                        {% endif %}

                        {% set start_page = [page - 2, 1]|max %}
                        {% set end_page = [start_page + 4, pages]|min %}
                        {% set start_page = [end_page - 4, 1]|max %}

                        {% for p in range(start_page, end_page + 1) %}
                            {% if p == page %}
                            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 bg-blue-50 dark:bg-blue-900 text-sm font-medium text-blue-600 dark:text-blue-300">{{ p }}</span>
                            {% else %}
                            <a href="{{ url_for('promotion_views.campaign_list', page=p, **filters) }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">{{ p }}</a>
                            {% endif %}
                        {% endfor %}

                        {% if page < pages %}
                        <a href="{{ url_for('promotion_views.campaign_list', page=page+1, **filters) }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </div>
        {% endif %}

        {% else %}
        <div class="text-center py-12">
            <i class="fas fa-bullhorn text-5xl text-gray-300 dark:text-gray-600 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No Campaigns Found</h3>
            <p class="text-gray-500 dark:text-gray-400 mb-4">
                {% if filters %}
                No campaigns match your filter criteria. Try adjusting your filters.
                {% else %}
                Get started by creating your first promotional campaign.
                {% endif %}
            </p>
            <a href="{{ url_for('promotion_views.campaign_create') }}"
               class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-plus mr-2"></i>Create Campaign
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function changePerPage(value) {
    const url = new URL(window.location.href);
    url.searchParams.set('per_page', value);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

function toggleCampaign(campaignId) {
    console.log('toggleCampaign called with ID:', campaignId);
    if (!confirm('Are you sure you want to change the status of this campaign?')) return;

    console.log('Sending toggle request...');
    fetch(`/promotions/campaigns/${campaignId}/toggle`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Server error: ${response.status} - ${text.substring(0, 200)}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'Failed to toggle campaign status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

function duplicateCampaign(campaignId) {
    if (!confirm('Create a copy of this campaign?')) return;

    fetch(`/promotions/campaigns/${campaignId}/duplicate`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Server error: ${response.status} - ${text.substring(0, 200)}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert(data.message);
            if (data.new_campaign_id) {
                window.location.href = `/promotions/campaigns/${data.new_campaign_id}/edit`;
            } else {
                location.reload();
            }
        } else {
            alert(data.message || 'Failed to duplicate campaign');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

function deleteCampaign(campaignId, campaignCode) {
    if (!confirm(`Are you sure you want to delete campaign "${campaignCode}"? This action cannot be undone.`)) return;

    fetch(`/promotions/campaigns/${campaignId}/delete`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Server error: ${response.status} - ${text.substring(0, 200)}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'Failed to delete campaign');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

// Approval Workflow Functions
function submitForApproval(campaignId) {
    if (!confirm('Submit this campaign for approval?')) return;

    fetch(`/promotions/campaigns/${campaignId}/submit-for-approval`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || 'Failed to submit for approval');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

function approveCampaign(campaignId) {
    if (!confirm('Approve this campaign?')) return;

    fetch(`/promotions/campaigns/${campaignId}/approve`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || 'Failed to approve campaign');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

function rejectCampaign(campaignId) {
    const reason = prompt('Enter rejection reason:');
    if (reason === null) return; // User cancelled
    if (!reason.trim()) {
        alert('Rejection reason is required');
        return;
    }

    fetch(`/promotions/campaigns/${campaignId}/reject`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({ reason: reason })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || 'Failed to reject campaign');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

function resubmitCampaign(campaignId) {
    if (!confirm('Resubmit this campaign for approval?')) return;

    fetch(`/promotions/campaigns/${campaignId}/resubmit`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || 'Failed to resubmit campaign');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

// Apply filter from summary card click
function applyCampaignFilter(filterName, filterValue) {
    const url = new URL(window.location.href);
    url.searchParams.set(filterName, filterValue);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

// Remove filter(s)
function removeFilter(...filterNames) {
    const url = new URL(window.location.href);
    filterNames.forEach(name => {
        url.searchParams.delete(name);
    });
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

// Date preset handlers
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded fired - initializing date presets');
    const presetButtons = document.querySelectorAll('.universal-date-filter-preset');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const filterForm = document.getElementById('filter-form');

    console.log('Found preset buttons:', presetButtons.length);
    console.log('Start date input:', startDateInput);
    console.log('End date input:', endDateInput);
    console.log('Filter form:', filterForm);

    // Helper function to format date as YYYY-MM-DD (using local timezone)
    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Get financial year dates (April 1 to March 31)
    function getFinancialYearDates() {
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth(); // 0-indexed

        let fyStartYear, fyEndYear;
        if (currentMonth >= 3) { // April onwards (month >= 3)
            fyStartYear = currentYear;
            fyEndYear = currentYear + 1;
        } else { // Jan-March
            fyStartYear = currentYear - 1;
            fyEndYear = currentYear;
        }

        return {
            start: new Date(fyStartYear, 3, 1), // April 1
            end: new Date(fyEndYear, 2, 31) // March 31
        };
    }

    // Update active state of preset buttons
    function updateActivePreset(activePreset) {
        presetButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.preset === activePreset) {
                btn.classList.add('active');
            }
        });
    }

    presetButtons.forEach(button => {
        button.addEventListener('click', function() {
            console.log('Preset button clicked:', this.dataset.preset);
            const preset = this.dataset.preset;
            const today = new Date();
            let startDate, endDate;

            switch(preset) {
                case 'today':
                    startDate = formatDate(today);
                    endDate = formatDate(today);
                    break;
                case 'this_month':
                    startDate = formatDate(new Date(today.getFullYear(), today.getMonth(), 1));
                    endDate = formatDate(new Date(today.getFullYear(), today.getMonth() + 1, 0));
                    break;
                case 'financial_year':
                    const fy = getFinancialYearDates();
                    startDate = formatDate(fy.start);
                    endDate = formatDate(fy.end);
                    break;
                case 'clear':
                    startDate = '';
                    endDate = '';
                    break;
            }

            startDateInput.value = startDate;
            endDateInput.value = endDate;
            updateActivePreset(preset === 'clear' ? null : preset);

            // Auto-submit the form
            filterForm.submit();
        });
    });

    // Check current dates and set active preset on page load
    function checkCurrentPreset() {
        const startVal = startDateInput.value;
        const endVal = endDateInput.value;

        if (!startVal && !endVal) return;

        const today = formatDate(new Date());
        const todayDate = new Date();
        const monthStart = formatDate(new Date(todayDate.getFullYear(), todayDate.getMonth(), 1));
        const monthEnd = formatDate(new Date(todayDate.getFullYear(), todayDate.getMonth() + 1, 0));
        const fy = getFinancialYearDates();
        const fyStart = formatDate(fy.start);
        const fyEnd = formatDate(fy.end);

        if (startVal === today && endVal === today) {
            updateActivePreset('today');
        } else if (startVal === monthStart && endVal === monthEnd) {
            updateActivePreset('this_month');
        } else if (startVal === fyStart && endVal === fyEnd) {
            updateActivePreset('financial_year');
        }
    }

    checkCurrentPreset();
});
</script>
{% endblock %}
