{% extends "layouts/dashboard.html" %}

{% block title %}{{ page_title }} - Skinspire{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">
<style>
/* Buy X Get Y Autocomplete Styling */
.bxy-autocomplete-dropdown {
    position: absolute;
    z-index: 50;
    width: 100%;
    max-height: 280px;
    overflow-y: auto;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    margin-top: 4px;
}
.dark .bxy-autocomplete-dropdown {
    background: #1f2937;
    border-color: #374151;
}
.bxy-autocomplete-item {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid #f3f4f6;
    font-size: 0.8125rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.bxy-autocomplete-item:hover {
    background: #eff6ff;
}
.dark .bxy-autocomplete-item:hover {
    background: #1e3a5f;
}
.bxy-autocomplete-item-label {
    font-weight: 500;
    color: #111827;
}
.dark .bxy-autocomplete-item-label {
    color: #f9fafb;
}
.bxy-autocomplete-no-results {
    padding: 1rem;
    text-align: center;
    color: #9ca3af;
}
.bxy-form-input {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.875rem;
}
.bxy-form-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
.dark .bxy-form-input {
    background: #374151;
    border-color: #4b5563;
    color: #f9fafb;
}
.bxy-form-input:disabled {
    background: #f3f4f6;
    cursor: not-allowed;
}
.dark .bxy-form-input:disabled {
    background: #1f2937;
}
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-4">
    <!-- Page Header -->
    <div class="mb-6">
        <!-- Row 1: Title and Date -->
        <div class="flex flex-wrap justify-between items-center">
            <div>
                <nav class="text-sm text-gray-500 mb-2">
                    <a href="{{ url_for('promotion_views.dashboard') }}" class="hover:text-blue-600">
                        <i class="fas fa-tags mr-1"></i>Promotions
                    </a>
                    <span class="mx-2">/</span>
                    <a href="{{ url_for('promotion_views.campaign_list') }}" class="hover:text-blue-600">Campaigns</a>
                    <span class="mx-2">/</span>
                    <a href="{{ url_for('promotion_views.campaign_detail', campaign_id=campaign.campaign_id) }}" class="hover:text-blue-600">
                        {{ campaign.campaign_code }}
                    </a>
                    <span class="mx-2">/</span>
                    <span class="text-gray-900 dark:text-white">Edit</span>
                </nav>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                    <i class="fas fa-edit mr-2 text-yellow-600"></i>Edit Campaign: {{ campaign.campaign_code }}
                </h1>
            </div>
            <div class="text-right px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                <div class="text-base font-semibold text-gray-900 dark:text-white">{{ today_display }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">{{ today_day }}</div>
            </div>
        </div>
        <!-- Row 2: Action Buttons -->
        <div class="flex flex-wrap gap-2 mt-4">
            <a href="{{ url_for('promotion_views.campaign_detail', campaign_id=campaign.campaign_id) }}" class="btn-back">
                <i class="fas fa-arrow-left mr-2"></i>Back to View
            </a>
            <a href="{{ url_for('promotion_views.campaign_list') }}" class="btn-secondary">
                <i class="fas fa-list mr-2"></i>All Campaigns
            </a>
            <a href="{{ url_for('promotion_views.dashboard') }}" class="btn-secondary">
                <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
            </a>
        </div>
    </div>

    <!-- Form -->
    <form method="POST" action="{{ url_for('promotion_views.campaign_edit', campaign_id=campaign.campaign_id) }}" class="space-y-6">
        <!-- Basic Information -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>Basic Information
                </h3>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Campaign Code <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="campaign_code" value="{{ campaign.campaign_code }}"
                           required maxlength="50" placeholder="e.g., DIWALI2025"
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white uppercase">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Campaign Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="campaign_name" value="{{ campaign.campaign_name }}"
                           required maxlength="100"
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
                    <textarea name="description" rows="2"
                              class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">{{ campaign.description or '' }}</textarea>
                </div>
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" name="is_active" {{ 'checked' if campaign.is_active else '' }}
                               class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Active</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Discount Configuration -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-percent mr-2 text-green-600"></i>Discount Configuration
                </h3>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Promotion Type <span class="text-red-500">*</span>
                    </label>
                    <select name="promotion_type" id="promotion_type" required
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="simple_discount" {{ 'selected' if campaign.promotion_type == 'simple_discount' else '' }}>Simple Discount</option>
                        <option value="buy_x_get_y" {{ 'selected' if campaign.promotion_type == 'buy_x_get_y' else '' }}>Buy X Get Y Free</option>
                    </select>
                    <p id="buy-x-get-y-hint" class="mt-1 text-xs text-purple-600 dark:text-purple-400 {{ '' if campaign.promotion_type == 'buy_x_get_y' else 'hidden' }}">
                        <i class="fas fa-arrow-down mr-1"></i>Configure X (trigger) and Y (reward) items below
                    </p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Discount Type <span class="text-red-500">*</span>
                    </label>
                    <select name="discount_type" required
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="percentage" {{ 'selected' if campaign.discount_type == 'percentage' else '' }}>Percentage</option>
                        <option value="fixed_amount" {{ 'selected' if campaign.discount_type == 'fixed_amount' else '' }}>Fixed Amount</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        <span id="discount-value-label">Discount Value</span> <span class="text-red-500">*</span>
                        <span id="discount-unit-hint" class="text-xs text-gray-500 ml-1">{{ '(in ₹)' if campaign.discount_type == 'fixed_amount' else '(in %)' }}</span>
                    </label>
                    <div class="relative">
                        <span id="discount-unit-prefix" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 {{ '' if campaign.discount_type == 'fixed_amount' else 'hidden' }}">₹</span>
                        <input type="number" name="discount_value" id="discount_value_input" value="{{ campaign.discount_value }}"
                               required step="0.01" min="0"
                               class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white {{ 'pl-8' if campaign.discount_type == 'fixed_amount' else '' }}">
                        <span id="discount-unit-suffix" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 {{ 'hidden' if campaign.discount_type == 'fixed_amount' else '' }}">%</span>
                    </div>
                    <p id="discount-value-help" class="mt-1 text-xs text-gray-500">{{ 'Enter amount in rupees (e.g., 50 for ₹50 off per item)' if campaign.discount_type == 'fixed_amount' else 'Enter percentage (e.g., 10 for 10% off)' }}</p>
                </div>
            </div>
        </div>

        <!-- Buy X Get Y Configuration (shown when promotion_type = buy_x_get_y) -->
        {% set rules = campaign.promotion_rules or {} %}
        {% set trigger = rules.get('trigger', {}) %}
        {% set trigger_conditions = trigger.get('conditions', {}) %}
        {% set reward = rules.get('reward', {}) %}
        {% set reward_items = reward.get('items', []) %}
        {% set reward_item = reward_items[0] if reward_items else {} %}
        <div id="buy-x-get-y-config" class="bg-white dark:bg-gray-800 rounded-lg shadow border-2 border-purple-400 {{ '' if campaign.promotion_type == 'buy_x_get_y' else 'hidden' }}">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-purple-50 dark:bg-purple-900/20">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-gift mr-2 text-purple-600"></i>Buy X Get Y Configuration
                </h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    <strong>X</strong> = What customer must buy (Trigger) | <strong>Y</strong> = What they get free/discounted (Reward)
                </p>
            </div>
            <div class="p-6 space-y-6">
                <!-- Trigger Section (X) -->
                <div class="border-2 border-blue-400 rounded-lg p-4 bg-blue-50 dark:bg-blue-900/20">
                    <h4 class="font-medium text-blue-800 dark:text-blue-300 mb-3 text-lg">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-600 text-white font-bold mr-2">X</span>
                        When Customer Buys... (Trigger)
                    </h4>
                    <div class="space-y-4">
                        <!-- Item Type + Search (same row, half width) -->
                        <div class="md:w-1/2">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Item Type <span class="text-red-500">*</span></label>
                                    <select id="trigger_item_type" name="trigger_item_type" class="bxy-form-input">
                                        <option value="">-- Select Type --</option>
                                        <optgroup label="Services & Packages">
                                            <option value="Package" {{ 'selected' if trigger_conditions.get('item_type') == 'Package' else '' }}>Package</option>
                                            <option value="Service" {{ 'selected' if trigger_conditions.get('item_type') == 'Service' else '' }}>Service</option>
                                        </optgroup>
                                        <optgroup label="Medicines & Products">
                                            <option value="OTC" {{ 'selected' if trigger_conditions.get('item_type') == 'OTC' else '' }}>OTC Medicine</option>
                                            <option value="Prescription" {{ 'selected' if trigger_conditions.get('item_type') == 'Prescription' else '' }}>Prescription Medicine</option>
                                            <option value="Product" {{ 'selected' if trigger_conditions.get('item_type') == 'Product' else '' }}>Product</option>
                                            <option value="Consumable" {{ 'selected' if trigger_conditions.get('item_type') == 'Consumable' else '' }}>Consumable</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Item <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <input type="text" id="trigger_item_search" class="bxy-form-input"
                                               value="{{ trigger_conditions.get('item_name', '') }}"
                                               placeholder="{{ 'Search...' if trigger_conditions.get('item_type') else 'Select type first...' }}"
                                               {{ '' if trigger_conditions.get('item_type') else 'disabled' }}
                                               autocomplete="off">
                                        <input type="hidden" id="trigger_item_id" name="trigger_item_id" value="{{ trigger_conditions.get('item_ids', [''])[0] if trigger_conditions.get('item_ids') else '' }}">
                                        <input type="hidden" id="trigger_item_name" name="trigger_item_name" value="{{ trigger_conditions.get('item_name', '') }}">
                                        <div id="trigger_item_dropdown" class="bxy-autocomplete-dropdown hidden"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Trigger Conditions -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-blue-200 dark:border-blue-700">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Minimum Quantity</label>
                                <input type="number" name="trigger_min_quantity" id="trigger_min_quantity" min="1" step="1"
                                       value="{{ trigger_conditions.get('min_quantity', 1) }}" class="bxy-form-input">
                                <p class="text-xs text-gray-500 mt-1">How many items must be purchased</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Or Minimum Amount (Rs.)</label>
                                <input type="number" name="trigger_min_amount" id="trigger_min_amount" min="0" step="0.01"
                                       value="{{ trigger_conditions.get('min_amount', '') }}" placeholder="Optional" class="bxy-form-input">
                                <p class="text-xs text-gray-500 mt-1">Alternative: minimum purchase amount</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reward Section (Y) - Multiple Items Supported -->
                <div class="border-2 border-green-400 rounded-lg p-4 bg-green-50 dark:bg-green-900/20">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-medium text-green-800 dark:text-green-300 text-lg">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-600 text-white font-bold mr-2">Y</span>
                            They Get... (Rewards)
                        </h4>
                        <button type="button" id="add-reward-item-btn"
                                class="px-3 py-1.5 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-plus mr-1"></i>Add Another Reward
                        </button>
                    </div>

                    <!-- Container for reward items -->
                    <div id="reward-items-container" class="space-y-4">
                        {% for reward_item in reward_items %}
                        <div class="reward-item-row border border-green-300 rounded-lg p-3 bg-white dark:bg-gray-800" data-reward-index="{{ loop.index0 }}">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-sm font-medium text-green-700 dark:text-green-400">Reward Item #{{ loop.index }}</span>
                                <button type="button" class="remove-reward-btn text-red-500 hover:text-red-700 {{ 'hidden' if reward_items|length <= 1 else '' }}" title="Remove this reward">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            </div>
                            <div class="md:w-3/4">
                                <div class="grid grid-cols-4 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Type <span class="text-red-500">*</span></label>
                                        <select class="reward-item-type bxy-form-input text-sm" name="reward_item_types[]" required>
                                            <option value="">-- Type --</option>
                                            <optgroup label="Services & Packages">
                                                <option value="Package" {{ 'selected' if reward_item.get('item_type') == 'Package' else '' }}>Package</option>
                                                <option value="Service" {{ 'selected' if reward_item.get('item_type') == 'Service' else '' }}>Service</option>
                                            </optgroup>
                                            <optgroup label="Medicines & Products">
                                                <option value="OTC" {{ 'selected' if reward_item.get('item_type') == 'OTC' else '' }}>OTC Medicine</option>
                                                <option value="Prescription" {{ 'selected' if reward_item.get('item_type') == 'Prescription' else '' }}>Prescription</option>
                                                <option value="Product" {{ 'selected' if reward_item.get('item_type') == 'Product' else '' }}>Product</option>
                                                <option value="Consumable" {{ 'selected' if reward_item.get('item_type') == 'Consumable' else '' }}>Consumable</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Item <span class="text-red-500">*</span></label>
                                        <div class="relative">
                                            <input type="text" class="reward-item-search bxy-form-input text-sm"
                                                   value="{{ reward_item.get('item_name', '') }}"
                                                   placeholder="{{ 'Search...' if reward_item.get('item_type') else 'Select type first...' }}"
                                                   {{ '' if reward_item.get('item_type') else 'disabled' }}
                                                   autocomplete="off">
                                            <input type="hidden" class="reward-item-id" name="reward_item_ids[]" value="{{ reward_item.get('item_id', '') }}">
                                            <input type="hidden" class="reward-item-name" name="reward_item_names[]" value="{{ reward_item.get('item_name', '') }}">
                                            <div class="reward-item-dropdown bxy-autocomplete-dropdown hidden"></div>
                                            <div class="reward-item-loading absolute right-3 top-2 hidden">
                                                <i class="fas fa-spinner fa-spin text-gray-400 text-sm"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Qty</label>
                                            <input type="number" class="reward-quantity bxy-form-input text-sm" name="reward_quantities[]"
                                                   min="1" value="{{ reward_item.get('quantity', 1) }}" step="1">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Disc %</label>
                                            <input type="number" class="reward-discount bxy-form-input text-sm" name="reward_discounts[]"
                                                   min="0" max="100" value="{{ reward_item.get('discount_percent', 100) }}" step="1" title="100% = FREE">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <!-- Empty state - show one empty row -->
                        <div class="reward-item-row border border-green-300 rounded-lg p-3 bg-white dark:bg-gray-800" data-reward-index="0">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-sm font-medium text-green-700 dark:text-green-400">Reward Item #1</span>
                                <button type="button" class="remove-reward-btn text-red-500 hover:text-red-700 hidden" title="Remove this reward">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            </div>
                            <div class="md:w-3/4">
                                <div class="grid grid-cols-4 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Type <span class="text-red-500">*</span></label>
                                        <select class="reward-item-type bxy-form-input text-sm" name="reward_item_types[]" required>
                                            <option value="">-- Type --</option>
                                            <optgroup label="Services & Packages">
                                                <option value="Package">Package</option>
                                                <option value="Service">Service</option>
                                            </optgroup>
                                            <optgroup label="Medicines & Products">
                                                <option value="OTC">OTC Medicine</option>
                                                <option value="Prescription">Prescription</option>
                                                <option value="Product">Product</option>
                                                <option value="Consumable">Consumable</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Item <span class="text-red-500">*</span></label>
                                        <div class="relative">
                                            <input type="text" class="reward-item-search bxy-form-input text-sm"
                                                   placeholder="Select type first..." autocomplete="off" disabled>
                                            <input type="hidden" class="reward-item-id" name="reward_item_ids[]">
                                            <input type="hidden" class="reward-item-name" name="reward_item_names[]">
                                            <div class="reward-item-dropdown bxy-autocomplete-dropdown hidden"></div>
                                            <div class="reward-item-loading absolute right-3 top-2 hidden">
                                                <i class="fas fa-spinner fa-spin text-gray-400 text-sm"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Qty</label>
                                            <input type="number" class="reward-quantity bxy-form-input text-sm" name="reward_quantities[]"
                                                   min="1" value="1" step="1">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Disc %</label>
                                            <input type="number" class="reward-discount bxy-form-input text-sm" name="reward_discounts[]"
                                                   min="0" max="100" value="100" step="1" title="100% = FREE">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <p class="text-xs text-green-600 dark:text-green-400 mt-3">
                        <i class="fas fa-info-circle mr-1"></i>Add multiple rewards for promotions like "Free consultation + Free product samples"
                    </p>
                </div>
            </div>
        </div>

        <!-- Validity Period -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-calendar-alt mr-2 text-yellow-600"></i>Validity Period
                </h3>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Start Date <span class="text-red-500">*</span>
                    </label>
                    <input type="date" name="start_date" value="{{ campaign.start_date }}" required
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        End Date <span class="text-red-500">*</span>
                    </label>
                    <input type="date" name="end_date" value="{{ campaign.end_date }}" required
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
            </div>
        </div>

        <!-- Targeting -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-crosshairs mr-2 text-purple-600"></i>Targeting
                </h3>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Item Type Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Applies To <span class="text-red-500">*</span>
                        </label>
                        <select name="applies_to" id="applies_to" required
                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="all" {{ 'selected' if campaign.applies_to == 'all' else '' }}>All Items</option>
                            <option value="services" {{ 'selected' if campaign.applies_to == 'services' else '' }}>Services Only</option>
                            <option value="medicines" {{ 'selected' if campaign.applies_to == 'medicines' else '' }}>Medicines Only</option>
                            <option value="packages" {{ 'selected' if campaign.applies_to == 'packages' else '' }}>Packages Only</option>
                        </select>
                        <p class="mt-1 text-xs text-gray-500">Filter by item type (applies to all items of this type)</p>
                    </div>

                    <!-- Campaign Groups Multi-Select -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            <i class="fas fa-layer-group mr-1 text-purple-600"></i>Campaign Groups
                        </label>
                        {% set current_group_ids = (campaign.target_groups.group_ids if campaign.target_groups else []) or [] %}
                        <select name="target_group_ids" id="target_group_ids" multiple size="4"
                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            {% for group in campaign_groups %}
                            <option value="{{ group.group_id }}"
                                    {% if group.group_id|string in current_group_ids %}selected{% endif %}>
                                {{ group.group_name }} ({{ group.group_code }}) - {{ group.item_count }} items
                            </option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-xs text-gray-500">
                            Hold Ctrl/Cmd to select multiple groups. Leave empty for no group restriction.
                            {% if campaign_groups %}
                            <a href="{{ url_for('promotion_views.group_list') }}" class="text-purple-600 hover:underline ml-1">
                                <i class="fas fa-external-link-alt"></i> Manage Groups
                            </a>
                            {% else %}
                            <a href="{{ url_for('promotion_views.group_create') }}" class="text-purple-600 hover:underline ml-1">
                                <i class="fas fa-plus"></i> Create Group
                            </a>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Usage Constraints -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-shield-alt mr-2 text-orange-600"></i>Usage Constraints
                </h3>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Min Purchase Amount</label>
                    <input type="number" name="min_purchase_amount" value="{{ campaign.min_purchase_amount or '' }}"
                           step="0.01" min="0"
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Max Discount Amount</label>
                    <input type="number" name="max_discount_amount" value="{{ campaign.max_discount_amount or '' }}"
                           step="0.01" min="0"
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Max Uses per Patient</label>
                    <input type="number" name="max_uses_per_patient" value="{{ campaign.max_uses_per_patient or '' }}"
                           min="1"
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Max Total Uses</label>
                    <input type="number" name="max_total_uses" value="{{ campaign.max_total_uses or '' }}"
                           min="1"
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
            </div>
            <!-- Current Usage Info -->
            <div class="px-6 pb-6">
                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                    <p class="text-sm text-blue-800 dark:text-blue-200">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Current Usage:</strong> {{ campaign.current_uses or 0 }} times
                        {% if campaign.max_total_uses %}
                            ({{ ((campaign.current_uses or 0) / campaign.max_total_uses * 100)|round(1) }}% of limit)
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- Patient Targeting & Application Mode -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-users mr-2 text-indigo-600"></i>Patient Targeting & Application
                </h3>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Patient Target Group -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-user-tag mr-1 text-yellow-500"></i>Patient Target
                        </label>
                        <select name="target_special_group"
                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="" {{ 'selected' if not campaign.target_special_group else '' }}>All Patients</option>
                            <option value="on" {{ 'selected' if campaign.target_special_group else '' }}>VIP/Special Group Only</option>
                        </select>
                        <p class="mt-1 text-xs text-gray-500">Select which patient group can avail this promotion</p>
                    </div>

                    <!-- Application Mode -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-magic mr-1 text-purple-500"></i>Application Mode
                        </label>
                        <select name="is_personalized" id="is_personalized"
                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="" {{ 'selected' if not campaign.is_personalized else '' }}>Auto-Apply (Public)</option>
                            <option value="on" {{ 'selected' if campaign.is_personalized else '' }}>Manual Code Entry (Private)</option>
                        </select>
                        <p class="mt-1 text-xs text-gray-500">
                            Auto-Apply: Applied automatically when conditions match<br>
                            Manual: Requires campaign code entry at billing
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Terms & Conditions -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-file-contract mr-2 text-gray-600"></i>Terms & Conditions
                </h3>
            </div>
            <div class="p-6">
                <textarea name="terms_and_conditions" rows="4"
                          class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">{{ campaign.terms_and_conditions or '' }}</textarea>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex justify-between">
            <button type="button" onclick="deleteCampaign()"
                    class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                <i class="fas fa-trash mr-2"></i>Delete Campaign
            </button>
            <div class="flex gap-4">
                <a href="{{ url_for('promotion_views.campaign_detail', campaign_id=campaign.campaign_id) }}"
                   class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors dark:bg-gray-700 dark:text-gray-200">
                    Cancel
                </a>
                <button type="submit"
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-save mr-2"></i>Save Changes
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-uppercase campaign code
    const codeInput = document.querySelector('input[name="campaign_code"]');
    if (codeInput) {
        codeInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase().replace(/[^A-Z0-9_-]/g, '');
        });
    }

    // =========================================
    // BUY X GET Y CONFIGURATION
    // =========================================
    const promotionTypeSelect = document.getElementById('promotion_type');
    const buyXGetYConfig = document.getElementById('buy-x-get-y-config');
    const discountTypeSelect = document.querySelector('select[name="discount_type"]');
    const discountValueInput = document.querySelector('input[name="discount_value"]');
    const buyXGetYHint = document.getElementById('buy-x-get-y-hint');

    // Toggle Buy X Get Y config visibility
    function toggleBuyXGetYConfig() {
        if (!promotionTypeSelect || !buyXGetYConfig) return;

        // Get all required fields in Buy X Get Y section
        const bxyRequiredFields = buyXGetYConfig.querySelectorAll('[required], [data-was-required]');

        if (promotionTypeSelect.value === 'buy_x_get_y') {
            buyXGetYConfig.classList.remove('hidden');
            if (buyXGetYHint) buyXGetYHint.classList.remove('hidden');
            if (discountTypeSelect) discountTypeSelect.closest('div').classList.add('hidden');
            if (discountValueInput) discountValueInput.closest('div').classList.add('hidden');

            // Re-enable required attribute on Buy X Get Y fields
            bxyRequiredFields.forEach(field => {
                if (field.hasAttribute('data-was-required')) {
                    field.setAttribute('required', '');
                    field.removeAttribute('data-was-required');
                }
            });
        } else {
            buyXGetYConfig.classList.add('hidden');
            if (buyXGetYHint) buyXGetYHint.classList.add('hidden');
            if (discountTypeSelect) discountTypeSelect.closest('div').classList.remove('hidden');
            if (discountValueInput) discountValueInput.closest('div').classList.remove('hidden');

            // Remove required attribute from hidden Buy X Get Y fields (to prevent validation errors)
            bxyRequiredFields.forEach(field => {
                if (field.hasAttribute('required')) {
                    field.setAttribute('data-was-required', 'true');
                    field.removeAttribute('required');
                }
            });
        }
    }

    if (promotionTypeSelect) {
        promotionTypeSelect.addEventListener('change', toggleBuyXGetYConfig);
        toggleBuyXGetYConfig(); // Initial state
    }

    // =========================================
    // DISCOUNT TYPE TOGGLE (Percentage vs Fixed Amount)
    // =========================================
    function updateDiscountValueUI() {
        if (!discountTypeSelect) return;

        const discountValueInputEl = document.getElementById('discount_value_input');
        const unitHint = document.getElementById('discount-unit-hint');
        const unitPrefix = document.getElementById('discount-unit-prefix');
        const unitSuffix = document.getElementById('discount-unit-suffix');
        const helpText = document.getElementById('discount-value-help');

        if (discountTypeSelect.value === 'fixed_amount') {
            // Fixed Amount mode
            if (unitHint) unitHint.textContent = '(in ₹)';
            if (unitPrefix) unitPrefix.classList.remove('hidden');
            if (unitSuffix) unitSuffix.classList.add('hidden');
            if (discountValueInputEl) {
                discountValueInputEl.placeholder = 'e.g., 50 for ₹50 off';
                discountValueInputEl.classList.add('pl-8');
            }
            if (helpText) helpText.textContent = 'Enter amount in rupees (e.g., 50 for ₹50 off per item)';
        } else {
            // Percentage mode (default)
            if (unitHint) unitHint.textContent = '(in %)';
            if (unitPrefix) unitPrefix.classList.add('hidden');
            if (unitSuffix) unitSuffix.classList.remove('hidden');
            if (discountValueInputEl) {
                discountValueInputEl.placeholder = 'e.g., 10 for 10%';
                discountValueInputEl.classList.remove('pl-8');
            }
            if (helpText) helpText.textContent = 'Enter percentage (e.g., 10 for 10% off)';
        }
    }

    if (discountTypeSelect) {
        discountTypeSelect.addEventListener('change', updateDiscountValueUI);
        // Don't call updateDiscountValueUI on load as the template already sets correct initial state
    }

    // =========================================
    // BUY X GET Y ITEM SEARCH
    // =========================================
    function setupBxyItemSearch(prefix) {
        const typeSelect = document.getElementById(`${prefix}_item_type`);
        const searchInput = document.getElementById(`${prefix}_item_search`);
        const dropdown = document.getElementById(`${prefix}_item_dropdown`);
        const itemIdInput = document.getElementById(`${prefix}_item_id`);
        const itemNameInput = document.getElementById(`${prefix}_item_name`);

        if (!typeSelect || !searchInput) return;

        let searchTimeout;

        // Type change handler
        typeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            if (selectedType) {
                searchInput.disabled = false;
                searchInput.placeholder = `Search ${selectedType.toLowerCase()}...`;
                searchInput.value = '';
                itemIdInput.value = '';
                itemNameInput.value = '';
                searchInput.focus();
                performSearch('');
            } else {
                searchInput.disabled = true;
                searchInput.placeholder = 'Select type first...';
                searchInput.value = '';
                itemIdInput.value = '';
                itemNameInput.value = '';
                dropdown.classList.add('hidden');
            }
        });

        // Search on input
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => performSearch(this.value.trim()), 300);
        });

        // Show list on focus
        searchInput.addEventListener('focus', function() {
            if (typeSelect.value) {
                performSearch(this.value.trim());
            }
        });

        function performSearch(query) {
            const itemType = typeSelect.value;
            if (!itemType) return;

            fetch(`/invoice/web_api/item/search?q=${encodeURIComponent(query)}&type=${encodeURIComponent(itemType)}`)
                .then(response => response.json())
                .then(items => {
                    dropdown.innerHTML = '';

                    if (!items || items.length === 0) {
                        dropdown.innerHTML = '<div class="bxy-autocomplete-no-results">No items found</div>';
                        dropdown.classList.remove('hidden');
                        return;
                    }

                    items.slice(0, 20).forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'bxy-autocomplete-item';
                        const price = item.price ? parseFloat(item.price).toFixed(0) : '0';
                        const gstRate = item.gst_rate || 0;
                        div.innerHTML = `
                            <span class="bxy-autocomplete-item-label">${item.name}</span>
                            <span class="text-xs text-gray-500 ml-2">Rs.${price} | GST: ${gstRate}%</span>
                        `;

                        div.addEventListener('click', () => {
                            searchInput.value = item.name;
                            itemIdInput.value = item.id;
                            itemNameInput.value = item.name;
                            dropdown.classList.add('hidden');
                        });

                        dropdown.appendChild(div);
                    });

                    dropdown.classList.remove('hidden');
                })
                .catch(err => {
                    console.error('Search error:', err);
                    dropdown.innerHTML = '<div class="bxy-autocomplete-no-results text-red-500">Error searching</div>';
                    dropdown.classList.remove('hidden');
                });
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !dropdown.contains(e.target) && !typeSelect.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });
    }

    // Setup trigger section
    setupBxyItemSearch('trigger');

    // =========================================
    // MULTIPLE REWARD ITEMS SUPPORT
    // =========================================
    let rewardItemCounter = document.querySelectorAll('.reward-item-row').length || 1;
    const rewardItemsContainer = document.getElementById('reward-items-container');
    const addRewardBtn = document.getElementById('add-reward-item-btn');

    // Setup search for a reward item row
    function setupRewardItemSearch(row) {
        const typeSelect = row.querySelector('.reward-item-type');
        const searchInput = row.querySelector('.reward-item-search');
        const dropdown = row.querySelector('.reward-item-dropdown');
        const loadingEl = row.querySelector('.reward-item-loading');
        const itemIdInput = row.querySelector('.reward-item-id');
        const itemNameInput = row.querySelector('.reward-item-name');

        console.log('[RewardSearch] Setting up row:', row.dataset.rewardIndex);

        if (!typeSelect || !searchInput || !dropdown) {
            console.error('[RewardSearch] Missing elements in row');
            return;
        }

        let searchTimeout;

        // Type change handler
        typeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            console.log('[RewardSearch] Type changed to:', selectedType);
            if (selectedType) {
                searchInput.disabled = false;
                searchInput.placeholder = `Search ${selectedType.toLowerCase()}...`;
                searchInput.value = '';
                itemIdInput.value = '';
                itemNameInput.value = '';
                searchInput.focus();
                performSearch('');
            } else {
                searchInput.disabled = true;
                searchInput.placeholder = 'Select type first...';
                dropdown.classList.add('hidden');
            }
        });

        // Search input handler
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => performSearch(this.value), 300);
        });

        searchInput.addEventListener('focus', function() {
            if (typeSelect.value && this.value === '') {
                performSearch('');
            }
        });

        function performSearch(query) {
            const itemType = typeSelect.value;
            if (!itemType) return;

            console.log('[RewardSearch] Searching:', itemType, query);
            if (loadingEl) loadingEl.classList.remove('hidden');

            // Map item types to API types: Service->service, Package->package, OTC/Prescription/Product/Consumable->medicine
            const typeMap = {
                'Service': 'service',
                'Package': 'package',
                'OTC': 'medicine',
                'Prescription': 'medicine',
                'Product': 'medicine',
                'Consumable': 'medicine'
            };
            const apiType = typeMap[itemType] || itemType.toLowerCase();

            // Add subtype filter for medicine types (OTC, Prescription, Product, Consumable)
            const isMedicineSubtype = ['OTC', 'Prescription', 'Product', 'Consumable'].includes(itemType);
            const subtypeParam = isMedicineSubtype ? `&subtype=${encodeURIComponent(itemType)}` : '';

            fetch(`/promotions/api/items/${apiType}?search=${encodeURIComponent(query)}${subtypeParam}`)
                .then(res => res.json())
                .then(data => {
                    console.log('[RewardSearch] Response:', data);
                    if (loadingEl) loadingEl.classList.add('hidden');
                    dropdown.innerHTML = '';

                    const items = data.items || data.results || data;

                    if (!items || !Array.isArray(items) || items.length === 0) {
                        dropdown.innerHTML = '<div class="bxy-autocomplete-no-results">No items found</div>';
                        dropdown.classList.remove('hidden');
                        return;
                    }

                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'bxy-autocomplete-item';
                        const price = item.price ? parseFloat(item.price).toFixed(0) : '0';
                        div.innerHTML = `<span>${item.name}</span><span class="text-xs text-gray-500 ml-2">₹${price}</span>`;
                        div.style.cssText = 'display:flex;justify-content:space-between;align-items:center;';

                        div.addEventListener('click', () => {
                            searchInput.value = item.name;
                            itemIdInput.value = item.id;
                            itemNameInput.value = item.name;
                            dropdown.classList.add('hidden');
                        });

                        dropdown.appendChild(div);
                    });

                    dropdown.classList.remove('hidden');
                    console.log('[RewardSearch] Populated', items.length, 'items');
                })
                .catch(err => {
                    if (loadingEl) loadingEl.classList.add('hidden');
                    console.error('[RewardSearch] Error:', err);
                    dropdown.innerHTML = '<div class="bxy-autocomplete-no-results text-red-500">Error loading</div>';
                    dropdown.classList.remove('hidden');
                });
        }

        // Hide dropdown on outside click
        document.addEventListener('click', function(e) {
            if (!row.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });
    }

    // Setup existing reward items
    document.querySelectorAll('.reward-item-row').forEach(row => {
        setupRewardItemSearch(row);
    });

    // Add new reward item
    if (addRewardBtn) {
        addRewardBtn.addEventListener('click', function() {
            rewardItemCounter++;
            const newRow = document.createElement('div');
            newRow.className = 'reward-item-row border border-green-300 rounded-lg p-3 bg-white dark:bg-gray-800';
            newRow.dataset.rewardIndex = rewardItemCounter - 1;

            newRow.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="text-sm font-medium text-green-700 dark:text-green-400">Reward Item #${rewardItemCounter}</span>
                    <button type="button" class="remove-reward-btn text-red-500 hover:text-red-700" title="Remove this reward">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>
                <div class="md:w-3/4">
                    <div class="grid grid-cols-4 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Type <span class="text-red-500">*</span></label>
                            <select class="reward-item-type bxy-form-input text-sm" name="reward_item_types[]" required>
                                <option value="">-- Type --</option>
                                <optgroup label="Services & Packages">
                                    <option value="Package">Package</option>
                                    <option value="Service">Service</option>
                                </optgroup>
                                <optgroup label="Medicines & Products">
                                    <option value="OTC">OTC Medicine</option>
                                    <option value="Prescription">Prescription</option>
                                    <option value="Product">Product</option>
                                    <option value="Consumable">Consumable</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Item <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <input type="text" class="reward-item-search bxy-form-input text-sm"
                                       placeholder="Select type first..." autocomplete="off" disabled>
                                <input type="hidden" class="reward-item-id" name="reward_item_ids[]">
                                <input type="hidden" class="reward-item-name" name="reward_item_names[]">
                                <div class="reward-item-dropdown bxy-autocomplete-dropdown hidden"></div>
                                <div class="reward-item-loading absolute right-3 top-2 hidden">
                                    <i class="fas fa-spinner fa-spin text-gray-400 text-sm"></i>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Qty</label>
                                <input type="number" class="reward-quantity bxy-form-input text-sm" name="reward_quantities[]"
                                       min="1" value="1" step="1">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Disc %</label>
                                <input type="number" class="reward-discount bxy-form-input text-sm" name="reward_discounts[]"
                                       min="0" max="100" value="100" step="1" title="100% = FREE">
                            </div>
                        </div>
                    </div>
                </div>
            `;

            rewardItemsContainer.appendChild(newRow);
            setupRewardItemSearch(newRow);
            updateRemoveButtons();

            // Focus the type select of new row
            newRow.querySelector('.reward-item-type').focus();
        });
    }

    // Remove reward item
    if (rewardItemsContainer) {
        rewardItemsContainer.addEventListener('click', function(e) {
            if (e.target.closest('.remove-reward-btn')) {
                const row = e.target.closest('.reward-item-row');
                if (row && rewardItemsContainer.querySelectorAll('.reward-item-row').length > 1) {
                    row.remove();
                    updateRewardNumbers();
                    updateRemoveButtons();
                }
            }
        });
    }

    // Update reward item numbers after removal
    function updateRewardNumbers() {
        const rows = rewardItemsContainer.querySelectorAll('.reward-item-row');
        rows.forEach((row, index) => {
            row.dataset.rewardIndex = index;
            const label = row.querySelector('.text-green-700, .text-green-400');
            if (label) label.textContent = `Reward Item #${index + 1}`;
        });
        rewardItemCounter = rows.length;
    }

    // Show/hide remove buttons (hide if only one item)
    function updateRemoveButtons() {
        const rows = rewardItemsContainer.querySelectorAll('.reward-item-row');
        rows.forEach(row => {
            const removeBtn = row.querySelector('.remove-reward-btn');
            if (removeBtn) {
                removeBtn.classList.toggle('hidden', rows.length <= 1);
            }
        });
    }
});

function deleteCampaign() {
    if (!confirm('Are you sure you want to delete this campaign? This action cannot be undone.')) return;

    fetch('{{ url_for("promotion_views.campaign_delete", campaign_id=campaign.campaign_id) }}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '{{ url_for("promotion_views.campaign_list") }}';
        } else {
            alert(data.message || 'Failed to delete campaign');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}
</script>
{% endblock %}
