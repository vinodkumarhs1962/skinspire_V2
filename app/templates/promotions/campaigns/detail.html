{% extends "layouts/dashboard.html" %}

{% block title %}{{ page_title }} - Skinspire{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/cards.css') }}">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-4">
    <!-- Page Header -->
    <div class="mb-6">
        <!-- Row 1: Title and Date -->
        <div class="flex flex-wrap justify-between items-center">
            <div>
                <nav class="text-sm text-gray-500 mb-2">
                    <a href="{{ url_for('promotion_views.dashboard') }}" class="hover:text-blue-600">
                        <i class="fas fa-tags mr-1"></i>Promotions
                    </a>
                    <span class="mx-2">/</span>
                    <a href="{{ url_for('promotion_views.campaign_list') }}" class="hover:text-blue-600">Campaigns</a>
                    <span class="mx-2">/</span>
                    <span class="text-gray-900 dark:text-white">{{ campaign.campaign_code }}</span>
                </nav>
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">
                    <i class="fas fa-bullhorn mr-2 text-blue-600"></i>{{ campaign.campaign_name }}
                </h1>
            </div>
            <div class="text-right px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                <div class="text-base font-semibold text-gray-900 dark:text-white">{{ today_display }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">{{ today_day }}</div>
            </div>
        </div>
        <!-- Row 2: Action Buttons -->
        <div class="flex flex-wrap gap-2 mt-4">
            <a href="{{ url_for('promotion_views.campaign_list') }}" class="btn-back">
                <i class="fas fa-arrow-left mr-2"></i>Back
            </a>
            <a href="{{ url_for('promotion_views.dashboard') }}" class="btn-secondary">
                <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
            </a>
            <a href="{{ url_for('promotion_views.campaign_edit', campaign_id=campaign.campaign_id) }}" class="btn-warning">
                <i class="fas fa-edit mr-2"></i>Edit
            </a>
            <button type="button" onclick="duplicateCampaign()" class="btn-success">
                <i class="fas fa-copy mr-2"></i>Duplicate
            </button>
            <button type="button" onclick="toggleStatus()" class="btn-secondary">
                <i class="fas fa-toggle-{{ 'on' if campaign.is_active else 'off' }} mr-2"></i>{{ 'Deactivate' if campaign.is_active else 'Activate' }}
            </button>
            <button type="button" onclick="deleteCampaign()" class="btn-danger">
                <i class="fas fa-trash mr-2"></i>Delete
            </button>
        </div>
    </div>

    <!-- Approval Status Banner -->
    {% if campaign.status %}
    <div class="mb-6 p-4 rounded-lg border
        {% if campaign.status == 'draft' %}bg-gray-100 border-gray-300 dark:bg-gray-700 dark:border-gray-600
        {% elif campaign.status == 'pending_approval' %}bg-yellow-50 border-yellow-300 dark:bg-yellow-900/20 dark:border-yellow-600
        {% elif campaign.status == 'approved' %}bg-green-50 border-green-300 dark:bg-green-900/20 dark:border-green-600
        {% elif campaign.status == 'rejected' %}bg-red-50 border-red-300 dark:bg-red-900/20 dark:border-red-600{% endif %}">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center">
                {% if campaign.status == 'draft' %}
                <i class="fas fa-file-alt text-2xl text-gray-500 mr-3"></i>
                <div>
                    <h4 class="font-semibold text-gray-700 dark:text-gray-300">Draft</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">This campaign is in draft status and needs to be submitted for approval.</p>
                </div>
                {% elif campaign.status == 'pending_approval' %}
                <i class="fas fa-clock text-2xl text-yellow-500 mr-3"></i>
                <div>
                    <h4 class="font-semibold text-yellow-700 dark:text-yellow-300">Pending Approval</h4>
                    <p class="text-sm text-yellow-600 dark:text-yellow-400">This campaign is waiting for approval before it can be used.</p>
                </div>
                {% elif campaign.status == 'approved' %}
                <i class="fas fa-check-circle text-2xl text-green-500 mr-3"></i>
                <div>
                    <h4 class="font-semibold text-green-700 dark:text-green-300">Approved</h4>
                    <p class="text-sm text-green-600 dark:text-green-400">
                        Approved{% if campaign.approved_by %} by {{ campaign.approved_by }}{% endif %}
                        {% if campaign.approved_at %} on {{ campaign.approved_at }}{% endif %}
                    </p>
                </div>
                {% elif campaign.status == 'rejected' %}
                <i class="fas fa-times-circle text-2xl text-red-500 mr-3"></i>
                <div>
                    <h4 class="font-semibold text-red-700 dark:text-red-300">Rejected</h4>
                    <p class="text-sm text-red-600 dark:text-red-400">
                        {% if campaign.approval_notes %}{{ campaign.approval_notes }}{% else %}This campaign was rejected.{% endif %}
                    </p>
                </div>
                {% endif %}
            </div>
            <div class="flex gap-2">
                {% if campaign.status == 'draft' %}
                <button type="button" onclick="submitForApproval()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                    <i class="fas fa-paper-plane mr-2"></i>Submit for Approval
                </button>
                {% elif campaign.status == 'pending_approval' %}
                <button type="button" onclick="approveCampaign()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                    <i class="fas fa-check mr-2"></i>Approve
                </button>
                <button type="button" onclick="showRejectModal()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                    <i class="fas fa-times mr-2"></i>Reject
                </button>
                {% elif campaign.status == 'rejected' %}
                <button type="button" onclick="resubmitCampaign()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                    <i class="fas fa-redo mr-2"></i>Resubmit for Approval
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Info Cards - 4 Column Grid (Square Cards) -->
    <div class="grid grid-cols-4 gap-4 mb-6">
        <!-- Card 1: Status -->
        <div class="universal-stat-card">
            <div class="stat-card-icon {% if campaign.is_active %}success{% else %}neutral{% endif %}">
                <i class="fas fa-{{ 'check-circle' if campaign.is_active else 'pause-circle' }}"></i>
            </div>
            <div class="stat-card-value sm">{{ 'Active' if campaign.is_active else 'Inactive' }}</div>
            <div class="stat-card-label">Status</div>
        </div>

        <!-- Card 2: Discount -->
        <div class="universal-stat-card">
            <div class="stat-card-icon success">
                <i class="fas fa-percent"></i>
            </div>
            <div class="stat-card-value sm">{{ campaign.discount_value }}{% if campaign.discount_type == 'percentage' %}%{% endif %}</div>
            <div class="stat-card-label">{{ campaign.discount_type|title }} Discount</div>
        </div>

        <!-- Card 3: Total Uses -->
        <div class="universal-stat-card">
            <div class="stat-card-icon primary">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-card-value sm">{{ campaign.current_uses or 0 }}</div>
            <div class="stat-card-label">Total Uses{% if campaign.max_total_uses %} / {{ campaign.max_total_uses }}{% endif %}</div>
        </div>

        <!-- Card 4: Validity Period -->
        <div class="universal-stat-card">
            <div class="stat-card-icon info">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="stat-card-value sm">{{ campaign.end_date or 'No End' }}</div>
            <div class="stat-card-label">Valid Till</div>
        </div>
    </div>

    <!-- Details Section - Multiple Grouped Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- Card 1: Basic Information -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>Basic Information
                </h3>
            </div>
            <div class="p-6">
                <dl class="space-y-4">
                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Campaign Code</dt>
                        <dd class="text-sm text-gray-900 dark:text-white font-mono">{{ campaign.campaign_code }}</dd>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Campaign Name</dt>
                        <dd class="text-sm text-gray-900 dark:text-white">{{ campaign.campaign_name }}</dd>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Promotion Type</dt>
                        <dd>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded text-sm font-medium
                                {% if campaign.promotion_type == 'buy_x_get_y' %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300
                                {% else %}bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300{% endif %}">
                                {{ campaign.promotion_type|replace('_', ' ')|title }}
                            </span>
                        </dd>
                    </div>
                    <div class="py-2">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Description</dt>
                        <dd class="text-sm text-gray-900 dark:text-white">{{ campaign.description or 'No description provided' }}</dd>
                    </div>
                </dl>
            </div>
        </div>

        <!-- Card 2: Discount Configuration -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-tags mr-2 text-green-600"></i>Discount Configuration
                </h3>
            </div>
            <div class="p-6">
                <dl class="space-y-4">
                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Discount Type</dt>
                        <dd class="text-sm text-gray-900 dark:text-white">{{ campaign.discount_type|title }}</dd>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Discount Value</dt>
                        <dd class="text-lg font-bold text-green-600">
                            {{ campaign.discount_value }}{% if campaign.discount_type == 'percentage' %}%{% else %} flat{% endif %}
                        </dd>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Max Discount Cap</dt>
                        <dd class="text-sm text-gray-900 dark:text-white">
                            {% if campaign.max_discount_amount %}
                            <i class="fas fa-rupee-sign text-xs"></i>{{ campaign.max_discount_amount }}
                            {% else %}
                            <span class="text-gray-400">No cap</span>
                            {% endif %}
                        </dd>
                    </div>
                    <div class="flex justify-between py-2">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Auto Apply</dt>
                        <dd>
                            {% if campaign.auto_apply %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded text-sm font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300">
                                <i class="fas fa-check mr-1"></i>Yes
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded text-sm font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400">
                                <i class="fas fa-times mr-1"></i>No
                            </span>
                            {% endif %}
                        </dd>
                    </div>
                </dl>
            </div>
        </div>

        <!-- Card 3: Validity & Targeting -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-calendar-check mr-2 text-purple-600"></i>Validity & Targeting
                </h3>
            </div>
            <div class="p-6">
                <dl class="space-y-4">
                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Start Date</dt>
                        <dd class="text-sm text-gray-900 dark:text-white">{{ campaign.start_date }}</dd>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">End Date</dt>
                        <dd class="text-sm text-gray-900 dark:text-white">{{ campaign.end_date or 'No End Date' }}</dd>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Applies To</dt>
                        <dd>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded text-sm font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                                {{ campaign.applies_to|title }}
                            </span>
                        </dd>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Visibility</dt>
                        <dd>
                            {% if campaign.is_personalized %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded text-sm font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300">
                                <i class="fas fa-user-secret mr-1"></i>Private
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded text-sm font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300">
                                <i class="fas fa-globe mr-1"></i>Public
                            </span>
                            {% endif %}
                        </dd>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Patient Target</dt>
                        <dd>
                            {% if campaign.target_special_group %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded text-sm font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300">
                                <i class="fas fa-star mr-1"></i>VIP Only
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded text-sm font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400">
                                All Patients
                            </span>
                            {% endif %}
                        </dd>
                    </div>
                    <div class="py-2">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                            <i class="fas fa-object-group mr-1 text-purple-500"></i>Campaign Groups
                        </dt>
                        <dd>
                            {% if campaign.target_group_details and campaign.target_group_details|length > 0 %}
                            <div class="flex flex-wrap gap-2">
                                {% for group in campaign.target_group_details %}
                                <a href="{{ url_for('promotion_views.group_detail', group_id=group.group_id) }}"
                                   class="inline-flex items-center px-2.5 py-1 rounded text-sm font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300 hover:bg-purple-200 transition-colors">
                                    <i class="fas fa-object-group mr-1"></i>{{ group.group_name }}
                                </a>
                                {% endfor %}
                            </div>
                            {% elif campaign.target_groups and campaign.target_groups.group_ids %}
                            <!-- Fallback for backward compatibility -->
                            <div class="flex flex-wrap gap-2">
                                {% for group_name in campaign.target_group_names %}
                                <span class="inline-flex items-center px-2.5 py-1 rounded text-sm font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300">
                                    <i class="fas fa-object-group mr-1"></i>{{ group_name }}
                                </span>
                                {% endfor %}
                            </div>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded text-sm font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400">
                                <i class="fas fa-globe mr-1"></i>No Group Restriction
                            </span>
                            {% endif %}
                        </dd>
                    </div>
                </dl>
            </div>
        </div>

        <!-- Card 4: Usage Limits -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-sliders-h mr-2 text-orange-600"></i>Usage Limits
                </h3>
            </div>
            <div class="p-6">
                <dl class="space-y-4">
                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Min Purchase Amount</dt>
                        <dd class="text-sm text-gray-900 dark:text-white">
                            {% if campaign.min_purchase_amount %}
                            <i class="fas fa-rupee-sign text-xs"></i>{{ campaign.min_purchase_amount }}
                            {% else %}
                            <span class="text-gray-400">No minimum</span>
                            {% endif %}
                        </dd>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Max Uses Per Patient</dt>
                        <dd class="text-sm text-gray-900 dark:text-white">
                            {% if campaign.max_uses_per_patient %}
                            {{ campaign.max_uses_per_patient }} uses
                            {% else %}
                            <span class="text-gray-400">Unlimited</span>
                            {% endif %}
                        </dd>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Max Total Uses</dt>
                        <dd class="text-sm text-gray-900 dark:text-white">
                            {% if campaign.max_total_uses %}
                            {{ campaign.max_total_uses }} uses
                            {% else %}
                            <span class="text-gray-400">Unlimited</span>
                            {% endif %}
                        </dd>
                    </div>
                    <div class="flex justify-between py-2">
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Current Usage</dt>
                        <dd class="text-sm font-bold text-purple-600">{{ campaign.current_uses or 0 }} uses</dd>
                    </div>
                </dl>
            </div>
        </div>
    </div>

    <!-- Additional Information - Full Width Cards -->
    {% if campaign.specific_items or campaign.terms_and_conditions %}
    <div class="grid grid-cols-1 gap-6 mb-6">
        {% if campaign.specific_items %}
        <!-- Specific Items Card -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-list mr-2 text-blue-600"></i>Specific Items
                </h3>
            </div>
            <div class="p-6">
                <div class="flex flex-wrap gap-2">
                    {% for item in campaign.specific_items %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300">
                        {{ item }}
                    </span>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if campaign.terms_and_conditions %}
        <!-- Terms & Conditions Card -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-file-contract mr-2 text-gray-600"></i>Terms & Conditions
                </h3>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-900 dark:text-white whitespace-pre-line">{{ campaign.terms_and_conditions }}</p>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Audit Information Card -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                <i class="fas fa-history mr-2 text-gray-600"></i>Audit Information
            </h3>
        </div>
        <div class="p-6">
            <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex justify-between py-2">
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Created At</dt>
                    <dd class="text-sm text-gray-900 dark:text-white">{{ campaign.created_at }}</dd>
                </div>
                <div class="flex justify-between py-2">
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Last Updated</dt>
                    <dd class="text-sm text-gray-900 dark:text-white">{{ campaign.updated_at }}</dd>
                </div>
            </dl>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleStatus() {
    if (!confirm('Are you sure you want to change the status of this campaign?')) return;

    fetch('{{ url_for("promotion_views.campaign_toggle", campaign_id=campaign.campaign_id) }}', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Server error: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'Failed to toggle status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

function duplicateCampaign() {
    if (!confirm('Create a copy of this campaign?')) return;

    fetch('{{ url_for("promotion_views.campaign_duplicate", campaign_id=campaign.campaign_id) }}', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Server error: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.new_campaign_id) {
            window.location.href = `/promotions/campaigns/${data.new_campaign_id}/edit`;
        } else {
            alert(data.message || 'Failed to duplicate campaign');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

function deleteCampaign() {
    if (!confirm('Are you sure you want to delete this campaign? This action cannot be undone.')) return;

    fetch('{{ url_for("promotion_views.campaign_delete", campaign_id=campaign.campaign_id) }}', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Server error: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            window.location.href = '{{ url_for("promotion_views.campaign_list") }}';
        } else {
            alert(data.message || 'Failed to delete campaign');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

// Approval Workflow Functions
function submitForApproval() {
    if (!confirm('Submit this campaign for approval?')) return;

    fetch('{{ url_for("promotion_views.campaign_submit_for_approval", campaign_id=campaign.campaign_id) }}', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || 'Failed to submit for approval');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

function approveCampaign() {
    if (!confirm('Approve this campaign?')) return;

    fetch('{{ url_for("promotion_views.campaign_approve", campaign_id=campaign.campaign_id) }}', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || 'Failed to approve campaign');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

function showRejectModal() {
    document.getElementById('rejectModal').classList.remove('hidden');
}

function closeRejectModal() {
    document.getElementById('rejectModal').classList.add('hidden');
    document.getElementById('rejectReason').value = '';
}

function confirmReject() {
    const reason = document.getElementById('rejectReason').value.trim();
    if (!reason) {
        alert('Please provide a rejection reason');
        return;
    }

    fetch('{{ url_for("promotion_views.campaign_reject", campaign_id=campaign.campaign_id) }}', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({ reason: reason })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeRejectModal();
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || 'Failed to reject campaign');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

function resubmitCampaign() {
    if (!confirm('Resubmit this campaign for approval?')) return;

    fetch('{{ url_for("promotion_views.campaign_resubmit", campaign_id=campaign.campaign_id) }}', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || 'Failed to resubmit campaign');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeRejectModal();
    }
});
</script>

<!-- Reject Modal -->
<div id="rejectModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                <i class="fas fa-times-circle text-red-500 mr-2"></i>Reject Campaign
            </h3>
        </div>
        <div class="p-6">
            <p class="text-gray-600 dark:text-gray-400 mb-4">
                You are about to reject campaign: <strong>{{ campaign.campaign_code }}</strong>
            </p>
            <div class="mb-4">
                <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="rejectReason">
                    Rejection Reason <span class="text-red-500">*</span>
                </label>
                <textarea id="rejectReason" rows="3"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    placeholder="Please provide a reason for rejection..."></textarea>
            </div>
        </div>
        <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-2">
            <button type="button" onclick="closeRejectModal()"
                class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-white px-4 py-2 rounded">
                Cancel
            </button>
            <button type="button" onclick="confirmReject()"
                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                <i class="fas fa-times mr-1"></i>Reject
            </button>
        </div>
    </div>
</div>
{% endblock %}
