{% extends "layouts/dashboard.html" %}

{% block title %}{{ page_title }} - Skinspire{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/cards.css') }}">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-4">
    <!-- Page Header -->
    <div class="mb-6">
        <!-- Row 1: Title and Date -->
        <div class="flex flex-wrap justify-between items-center">
            <div>
                <nav class="text-sm text-gray-500 mb-2">
                    <a href="{{ url_for('promotion_views.dashboard') }}" class="hover:text-blue-600">
                        <i class="fas fa-tags mr-1"></i>Promotions
                    </a>
                    <span class="mx-2">/</span>
                    <span class="text-gray-900 dark:text-white">Campaign Groups</span>
                </nav>
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">
                    <i class="fas fa-object-group mr-2 text-purple-600"></i>Campaign Groups
                </h1>
            </div>
            <div class="text-right px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                <div class="text-base font-semibold text-gray-900 dark:text-white">{{ today_display }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">{{ today_day }}</div>
            </div>
        </div>
        <!-- Row 2: Action Buttons -->
        <div class="flex flex-wrap gap-2 mt-4">
            <a href="{{ url_for('promotion_views.dashboard') }}" class="btn-back">
                <i class="fas fa-arrow-left mr-2"></i>Back
            </a>
            <a href="{{ url_for('promotion_views.dashboard') }}" class="btn-secondary">
                <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
            </a>
            <a href="{{ url_for('promotion_views.group_create') }}" class="btn-primary">
                <i class="fas fa-plus mr-2"></i>New Group
            </a>
            <a href="{{ url_for('promotion_views.campaign_list') }}" class="btn-secondary">
                <i class="fas fa-bullhorn mr-2"></i>Campaigns
            </a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="universal-stat-card">
            <div class="stat-card-icon primary">
                <i class="fas fa-layer-group"></i>
            </div>
            <div class="stat-card-value">{{ summary.total_groups }}</div>
            <div class="stat-card-label">Total Groups</div>
        </div>
        <div class="universal-stat-card">
            <div class="stat-card-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-card-value">{{ summary.active_groups }}</div>
            <div class="stat-card-label">Active</div>
        </div>
        <div class="universal-stat-card">
            <div class="stat-card-icon info">
                <i class="fas fa-boxes"></i>
            </div>
            <div class="stat-card-value">{{ summary.total_items }}</div>
            <div class="stat-card-label">Total Items</div>
        </div>
        <div class="universal-stat-card">
            <div class="stat-card-icon warning">
                <i class="fas fa-bullhorn"></i>
            </div>
            <div class="stat-card-value">{{ summary.campaigns_with_groups }}</div>
            <div class="stat-card-label">Campaigns Using</div>
        </div>
    </div>

    <!-- Filter Toggle -->
    <div class="mb-4 flex items-center gap-4">
        <label class="inline-flex items-center cursor-pointer">
            <input type="checkbox" id="showInactive" class="sr-only peer" {% if show_inactive %}checked{% endif %}>
            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 dark:peer-focus:ring-purple-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-purple-600"></div>
            <span class="ms-3 text-sm font-medium text-gray-700 dark:text-gray-300">Show Inactive Groups</span>
        </label>
    </div>

    <!-- Groups Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Group</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Services</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Medicines</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Packages</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                {% for group in groups %}
                <tr class="{% if group.is_deleted %}bg-red-50 dark:bg-red-900/10 opacity-70{% else %}hover:bg-gray-50 dark:hover:bg-gray-700{% endif %}">
                    <td class="px-6 py-4">
                        <a href="{{ url_for('promotion_views.group_detail', group_id=group.group_id) }}" class="hover:text-purple-600">
                            <div class="font-medium {% if group.is_deleted %}line-through text-gray-500{% else %}text-gray-900 dark:text-white{% endif %}">
                                {{ group.group_name }}
                                {% if group.is_deleted %}
                                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300">
                                    <i class="fas fa-trash-alt mr-1"></i>Deleted
                                </span>
                                {% endif %}
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 font-mono {% if group.is_deleted %}line-through{% endif %}">{{ group.group_code }}</div>
                            {% if group.is_deleted and group.deleted_at %}
                            <div class="text-xs text-red-500 dark:text-red-400">Deleted on {{ group.deleted_at }}</div>
                            {% endif %}
                        </a>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if group.is_deleted %}bg-gray-100 text-gray-500{% else %}bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300{% endif %}">
                            {{ group.item_counts.service }}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if group.is_deleted %}bg-gray-100 text-gray-500{% else %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300{% endif %}">
                            {{ group.item_counts.medicine }}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if group.is_deleted %}bg-gray-100 text-gray-500{% else %}bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300{% endif %}">
                            {{ group.item_counts.package }}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        {% if group.is_deleted %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300">
                            <i class="fas fa-trash-alt mr-1"></i>Deleted
                        </span>
                        {% elif group.is_active %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300">
                            <i class="fas fa-check-circle mr-1"></i>Active
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400">
                            <i class="fas fa-pause-circle mr-1"></i>Inactive
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <a href="{{ url_for('promotion_views.group_detail', group_id=group.group_id) }}"
                               class="text-blue-600 hover:text-blue-800" title="View">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if group.is_deleted %}
                            <!-- Undelete button for deleted groups -->
                            <button onclick="undeleteGroup('{{ group.group_id }}', '{{ group.group_name }}')"
                                    class="text-green-600 hover:text-green-800" title="Restore">
                                <i class="fas fa-undo"></i>
                            </button>
                            {% else %}
                            <a href="{{ url_for('promotion_views.group_edit', group_id=group.group_id) }}"
                               class="text-yellow-600 hover:text-yellow-800" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button onclick="toggleGroup('{{ group.group_id }}')"
                                    class="text-purple-600 hover:text-purple-800" title="Toggle Status">
                                <i class="fas fa-toggle-{{ 'on' if group.is_active else 'off' }}"></i>
                            </button>
                            <button onclick="deleteGroup('{{ group.group_id }}', '{{ group.group_name }}')"
                                    class="text-red-600 hover:text-red-800" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                        <i class="fas fa-inbox text-4xl mb-2"></i>
                        <p>No campaign groups found</p>
                        <a href="{{ url_for('promotion_views.group_create') }}" class="mt-2 inline-block text-purple-600 hover:text-purple-800">
                            Create your first group
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Toggle inactive filter
    document.getElementById('showInactive').addEventListener('change', function() {
        const url = new URL(window.location.href);
        if (this.checked) {
            url.searchParams.set('show_inactive', 'true');
        } else {
            url.searchParams.delete('show_inactive');
        }
        window.location.href = url.toString();
    });

    // Toggle group status
    function toggleGroup(groupId) {
        if (!confirm('Are you sure you want to toggle this group\'s status?')) return;

        fetch(`/promotions/groups/${groupId}/toggle`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert(data.message || 'Failed to toggle group status');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while toggling group status');
        });
    }

    // Delete group
    function deleteGroup(groupId, groupName) {
        if (!confirm(`Are you sure you want to delete the group "${groupName}"?`)) return;

        fetch(`/promotions/groups/${groupId}/delete`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert(data.message || 'Failed to delete group');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting group');
        });
    }

    // Restore deleted group
    function undeleteGroup(groupId, groupName) {
        if (!confirm(`Restore the group "${groupName}"?`)) return;

        fetch(`/promotions/groups/${groupId}/undelete`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert(data.message || 'Failed to restore group');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while restoring group');
        });
    }
</script>
{% endblock %}
