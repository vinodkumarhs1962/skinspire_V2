{% extends 'layouts/dashboard.html' %}

{% block title %}Hospital Settings{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Page Header with Back Button -->
    <div class="mb-6">
        <div class="mb-3">
            <h1 class="text-2xl font-bold text-gray-900">Hospital Settings</h1>
            <p class="text-sm text-gray-500">Configure hospital-wide settings and preferences</p>
        </div>
        <div>
            <button onclick="history.back()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium border border-gray-300">
                <i class="fas fa-arrow-left mr-2"></i>Back
            </button>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} mb-4 p-4 rounded 
                            {% if category == 'success' %}bg-green-100 text-green-700 border border-green-400{% endif %}
                            {% if category == 'error' %}bg-red-100 text-red-700 border border-red-400{% endif %}
                            {% if category == 'warning' %}bg-yellow-100 text-yellow-700 border border-yellow-400{% endif %}
                            {% if category == 'info' %}bg-blue-100 text-blue-700 border border-blue-400{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Logo Upload Section -->
    <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-6">
        <div class="px-4 py-5 sm:px-6 bg-gray-50 border-b">
            <h2 class="text-lg leading-6 font-medium text-gray-900">Hospital Logo</h2>
            <p class="mt-1 max-w-2xl text-sm text-gray-500">Upload and manage your hospital's logo</p>
        </div>
        
        <div class="px-4 py-5 sm:p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Logo Preview -->
                <div>
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Current Logo</h3>
                    <div class="border rounded-lg p-4 flex justify-center items-center h-64">
                        {% if hospital and hospital.logo and hospital.logo.variants %}
                            <img 
                                src="{{ url_for('static', filename='uploads/hospital_logos/' + hospital.hospital_id|string + '/' + hospital.logo.variants.medium.filename) }}"
                                alt="{{ hospital.name|default('Hospital') }} Logo" 
                                class="max-h-full max-w-full object-contain rounded-lg"
                            >
                        {% else %}
                            <span class="text-gray-400">No logo uploaded</span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Logo Upload -->
                <div>
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Upload New Logo</h3>
                    <form 
                        action="{{ url_for('admin_views.hospital_settings') }}" 
                        method="POST" 
                        enctype="multipart/form-data"
                    >
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <div class="space-y-4">
                            <div>
                                <input 
                                    type="file" 
                                    name="upload_logo" 
                                    id="hospital_logo" 
                                    accept="image/png,image/jpeg,image/svg+xml,image/webp"
                                    class="hidden"
                                >
                                <label 
                                    for="hospital_logo" 
                                    class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 cursor-pointer text-center"
                                >
                                    Choose File
                                </label>
                                <p class="mt-1 text-xs text-gray-500">
                                    PNG, JPG, SVG, or WebP. Max 5MB.
                                </p>
                                <p id="selected-file-name" class="mt-1 text-sm text-blue-600 hidden"></p>
                            </div>
                            
                            <div class="flex space-x-4">
                                <button 
                                    type="submit" 
                                    name="upload_logo" 
                                    value="1"
                                    class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                >
                                    Upload Logo
                                </button>
                                
                                {% if hospital and hospital.logo and hospital.logo.variants %}
                                <button 
                                    type="submit" 
                                    name="remove_logo" 
                                    value="1"
                                    class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                                >
                                    Remove Logo
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6 bg-gray-50 border-b">
            <h2 class="text-lg leading-6 font-medium text-gray-900">Hospital Settings</h2>
            <p class="mt-1 max-w-2xl text-sm text-gray-500">Configure verification requirements and other settings</p>
        </div>
        
        <form method="POST" action="{{ url_for('admin_views.hospital_settings') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Verification Settings</h3>
                
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                    <!-- Phone Verification Setting -->
                    <div class="flex items-start">
                        <div class="flex items-center h-5">
                            <input id="require_phone_verification" name="require_phone_verification" type="checkbox"
                                {% if verification_settings.require_phone_verification %}checked{% endif %}
                                class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                        </div>
                        <div class="ml-3 text-sm">
                            <label for="require_phone_verification" class="font-medium text-gray-700">Require Phone Verification</label>
                            <p class="text-gray-500">Users will be required to verify their phone number</p>
                        </div>
                    </div>
                    
                    <!-- Email Verification Setting -->
                    <div class="flex items-start">
                        <div class="flex items-center h-5">
                            <input id="require_email_verification" name="require_email_verification" type="checkbox"
                                {% if verification_settings.require_email_verification %}checked{% endif %}
                                class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                        </div>
                        <div class="ml-3 text-sm">
                            <label for="require_email_verification" class="font-medium text-gray-700">Require Email Verification</label>
                            <p class="text-gray-500">Users will be required to verify their email address</p>
                        </div>
                    </div>
                    
                    <!-- Login Requirement -->
                    <div class="flex items-start">
                        <div class="flex items-center h-5">
                            <input id="verification_required_for_login" name="verification_required_for_login" type="checkbox"
                                {% if verification_settings.verification_required_for_login %}checked{% endif %}
                                class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                        </div>
                        <div class="ml-3 text-sm">
                            <label for="verification_required_for_login" class="font-medium text-gray-700">Required for Login</label>
                            <p class="text-gray-500">Users must complete verification before they can log in</p>
                        </div>
                    </div>
                    
                    <!-- Staff Verification -->
                    <div class="flex items-start">
                        <div class="flex items-center h-5">
                            <input id="verification_required_for_staff" name="verification_required_for_staff" type="checkbox"
                                {% if verification_settings.verification_required_for_staff %}checked{% endif %}
                                class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                        </div>
                        <div class="ml-3 text-sm">
                            <label for="verification_required_for_staff" class="font-medium text-gray-700">Required for Staff</label>
                            <p class="text-gray-500">Staff members must complete verification</p>
                        </div>
                    </div>
                    
                    <!-- Patient Verification -->
                    <div class="flex items-start">
                        <div class="flex items-center h-5">
                            <input id="verification_required_for_patients" name="verification_required_for_patients" type="checkbox"
                                {% if verification_settings.verification_required_for_patients %}checked{% endif %}
                                class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                        </div>
                        <div class="ml-3 text-sm">
                            <label for="verification_required_for_patients" class="font-medium text-gray-700">Required for Patients</label>
                            <p class="text-gray-500">Patients must complete verification</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-3">
                    <!-- Grace Period -->
                    <div>
                        <label for="verification_grace_period_days" class="block text-sm font-medium text-gray-700">Grace Period (Days)</label>
                        <input type="number" min="0" max="30" name="verification_grace_period_days" id="verification_grace_period_days"
                            value="{{ verification_settings.verification_grace_period_days }}"
                            class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        <p class="mt-1 text-xs text-gray-500">Days users have to complete verification after registration</p>
                    </div>
                    
                    <!-- OTP Length -->
                    <div>
                        <label for="otp_length" class="block text-sm font-medium text-gray-700">OTP Length</label>
                        <input type="number" min="4" max="8" name="otp_length" id="otp_length"
                            value="{{ verification_settings.otp_length }}"
                            class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        <p class="mt-1 text-xs text-gray-500">Number of digits in verification codes</p>
                    </div>
                    
                    <!-- OTP Expiry -->
                    <div>
                        <label for="otp_expiry_minutes" class="block text-sm font-medium text-gray-700">OTP Expiry (Minutes)</label>
                        <input type="number" min="1" max="60" name="otp_expiry_minutes" id="otp_expiry_minutes"
                            value="{{ verification_settings.otp_expiry_minutes }}"
                            class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        <p class="mt-1 text-xs text-gray-500">How long verification codes remain valid</p>
                    </div>
                    
                    <!-- Max OTP Attempts -->
                    <div>
                        <label for="max_otp_attempts" class="block text-sm font-medium text-gray-700">Max OTP Attempts</label>
                        <input type="number" min="1" max="10" name="max_otp_attempts" id="max_otp_attempts"
                            value="{{ verification_settings.max_otp_attempts }}"
                            class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        <p class="mt-1 text-xs text-gray-500">Maximum invalid attempts before code is invalidated</p>
                    </div>
                </div>
            </div>
            
            <div class="px-4 py-3 bg-gray-50 text-right sm:px-6">
                <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Save Settings
                </button>
            </div>
        </form>
    </div>

    <!-- Discount Stacking Configuration -->
    <div id="discount-stacking-config" class="bg-white shadow overflow-hidden sm:rounded-lg mt-6">
        <div class="px-4 py-5 sm:px-6 bg-gray-50 border-b">
            <h2 class="text-lg leading-6 font-medium text-gray-900">Discount Stacking Configuration</h2>
            <p class="mt-1 max-w-2xl text-sm text-gray-500">Configure how different discount types combine when applied to patient invoices</p>
        </div>

        <form id="discount-stacking-form" method="POST" action="{{ url_for('admin_views.hospital_settings') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="form_type" value="discount_stacking">

            <div class="px-4 py-5 sm:p-6">
                <!-- Two Column Layout -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- LEFT COLUMN: Discount Type Settings -->
                    <div class="space-y-4">
                        <!-- Mode Legend -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-3 mb-2">
                            <h4 class="text-xs font-semibold text-blue-800 mb-2">Stacking Mode Reference</h4>
                            <div class="text-xs text-blue-700 space-y-1">
                                <p><span class="inline-block w-16 font-semibold">Exclusive:</span> Only this discount applies. All others are ignored.</p>
                                <p><span class="inline-block w-16 font-semibold">Incremental:</span> Always adds to total. Stacks with other incremental discounts.</p>
                                <p><span class="inline-block w-16 font-semibold">Absolute:</span> Competes with other absolutes (best wins). Winner then stacks with incrementals.</p>
                            </div>
                        </div>

                        <!-- Campaign Discount -->
                        <div class="border rounded-lg p-3 bg-gray-50">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-semibold text-gray-800 flex items-center">
                                    <span class="w-2.5 h-2.5 bg-purple-500 rounded-full mr-2"></span>
                                    Campaign / Promo
                                    <button type="button" class="ml-1 text-gray-400 hover:text-gray-600" onclick="toggleHelp('campaign-help')">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/><path stroke-width="2" d="M12 16v-4M12 8h.01"/></svg>
                                    </button>
                                </h3>
                                <select name="campaign_mode" class="text-xs border-gray-300 rounded-md py-1 pl-2 pr-6 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="exclusive" {% if discount_stacking_config.campaign.mode == 'exclusive' %}selected{% endif %}>Exclusive</option>
                                    <option value="incremental" {% if discount_stacking_config.campaign.mode == 'incremental' %}selected{% endif %}>Incremental</option>
                                    <option value="absolute" {% if discount_stacking_config.campaign.mode == 'absolute' %}selected{% endif %}>Absolute</option>
                                </select>
                            </div>
                            <!-- Campaign Help Text -->
                            <div id="campaign-help" class="hidden bg-purple-50 border-l-2 border-purple-300 p-2 mb-2 text-xs text-purple-700">
                                <p class="font-semibold mb-1">Campaign/Promotion Discount</p>
                                <p class="mb-1">Promotional discounts from marketing campaigns (e.g., "Winter Sale 20% off").</p>
                                <p class="font-medium">Recommended: <span class="text-purple-900">Absolute</span></p>
                                <p class="text-purple-600 italic">If multiple campaigns apply, best one wins. Then stacks with Bulk + Loyalty.</p>
                            </div>
                            <label class="flex items-center text-xs text-gray-600">
                                <input id="buy_x_get_y_exclusive" name="buy_x_get_y_exclusive" type="checkbox"
                                    {% if discount_stacking_config.campaign.buy_x_get_y_exclusive %}checked{% endif %}
                                    class="focus:ring-blue-500 h-3.5 w-3.5 text-blue-600 border-gray-300 rounded mr-2">
                                Buy X Get Y: X items at list price (no discount on X items)
                            </label>
                        </div>

                        <!-- Loyalty Discount -->
                        <div class="border rounded-lg p-3 bg-gray-50">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-semibold text-gray-800 flex items-center">
                                    <span class="w-2.5 h-2.5 bg-green-500 rounded-full mr-2"></span>
                                    Loyalty Card
                                    <button type="button" class="ml-1 text-gray-400 hover:text-gray-600" onclick="toggleHelp('loyalty-help')">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/><path stroke-width="2" d="M12 16v-4M12 8h.01"/></svg>
                                    </button>
                                </h3>
                                <select name="loyalty_mode" class="text-xs border-gray-300 rounded-md py-1 pl-2 pr-6 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="exclusive" {% if discount_stacking_config.loyalty.mode == 'exclusive' %}selected{% endif %}>Exclusive</option>
                                    <option value="incremental" {% if discount_stacking_config.loyalty.mode == 'incremental' %}selected{% endif %}>Incremental</option>
                                    <option value="absolute" {% if discount_stacking_config.loyalty.mode == 'absolute' %}selected{% endif %}>Absolute</option>
                                </select>
                            </div>
                            <!-- Loyalty Help Text -->
                            <div id="loyalty-help" class="hidden bg-green-50 border-l-2 border-green-300 p-2 text-xs text-green-700">
                                <p class="font-semibold mb-1">Loyalty Card Discount</p>
                                <p class="mb-1">Based on patient's loyalty card tier (Bronze 2%, Silver 5%, Gold 8%, Platinum 12%).</p>
                                <p class="font-medium">Recommended: <span class="text-green-900">Incremental</span></p>
                                <p class="text-green-600 italic">Loyalty should reward patients on top of other discounts.</p>
                            </div>
                        </div>

                        <!-- Bulk Discount -->
                        <div class="border rounded-lg p-3 bg-gray-50">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-semibold text-gray-800 flex items-center">
                                    <span class="w-2.5 h-2.5 bg-blue-500 rounded-full mr-2"></span>
                                    Bulk Quantity
                                    <button type="button" class="ml-1 text-gray-400 hover:text-gray-600" onclick="toggleHelp('bulk-help')">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/><path stroke-width="2" d="M12 16v-4M12 8h.01"/></svg>
                                    </button>
                                </h3>
                                <select name="bulk_mode" class="text-xs border-gray-300 rounded-md py-1 pl-2 pr-6 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="exclusive" {% if discount_stacking_config.bulk.mode == 'exclusive' %}selected{% endif %}>Exclusive</option>
                                    <option value="incremental" {% if discount_stacking_config.bulk.mode == 'incremental' %}selected{% endif %}>Incremental</option>
                                    <option value="absolute" {% if discount_stacking_config.bulk.mode == 'absolute' %}selected{% endif %}>Absolute</option>
                                </select>
                            </div>
                            <!-- Bulk Help Text -->
                            <div id="bulk-help" class="hidden bg-blue-50 border-l-2 border-blue-300 p-2 mb-2 text-xs text-blue-700">
                                <p class="font-semibold mb-1">Bulk Quantity Discount</p>
                                <p class="mb-1">Applied when patient books multiple services (e.g., 5+ services = 15% off).</p>
                                <p class="font-medium">Recommended: <span class="text-blue-900">Incremental</span></p>
                                <p class="text-blue-600 italic">Bulk discount should stack with loyalty for maximum savings.</p>
                            </div>
                            <label class="flex items-center text-xs text-gray-600">
                                <input id="exclude_with_campaign" name="exclude_with_campaign" type="checkbox"
                                    {% if discount_stacking_config.bulk.exclude_with_campaign %}checked{% endif %}
                                    class="focus:ring-blue-500 h-3.5 w-3.5 text-blue-600 border-gray-300 rounded mr-2">
                                Exclude bulk when campaign applies (avoid double discount)
                            </label>
                        </div>

                        <!-- VIP Discount - Stacking Mode Only -->
                        <div class="border rounded-lg p-3 bg-gray-50">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-semibold text-gray-800 flex items-center">
                                    <span class="w-2.5 h-2.5 bg-amber-500 rounded-full mr-2"></span>
                                    VIP / Special Group
                                    <button type="button" class="ml-1 text-gray-400 hover:text-gray-600" onclick="toggleHelp('vip-help')">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/><path stroke-width="2" d="M12 16v-4M12 8h.01"/></svg>
                                    </button>
                                </h3>
                                <select name="vip_mode" class="text-xs border-gray-300 rounded-md py-1 pl-2 pr-6 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="exclusive" {% if discount_stacking_config.vip.mode == 'exclusive' %}selected{% endif %}>Exclusive</option>
                                    <option value="incremental" {% if discount_stacking_config.vip.mode == 'incremental' %}selected{% endif %}>Incremental</option>
                                    <option value="absolute" {% if discount_stacking_config.vip.mode == 'absolute' %}selected{% endif %}>Absolute</option>
                                </select>
                            </div>
                            <!-- VIP Help Text -->
                            <div id="vip-help" class="hidden bg-amber-50 border-l-2 border-amber-300 p-2 text-xs text-amber-700">
                                <p class="font-semibold mb-1">VIP / Special Group Stacking Mode</p>
                                <p class="mb-1">Controls how VIP campaign discounts stack with other discounts.</p>
                                <p class="font-medium">Recommended: <span class="text-amber-900">Exclusive</span></p>
                                <p class="text-amber-600 italic">VIP gets only their campaign discount. No other discounts apply.</p>
                                <p class="mt-1 text-amber-800"><strong>Note:</strong> Create VIP discounts as campaigns with "VIP/Special Group" target. Set discount %, validity dates, and other options there.</p>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: Max Cap + Example -->
                    <div class="space-y-4">
                        <!-- Max Total Discount Cap -->
                        <div class="border rounded-lg p-4 bg-yellow-50 border-yellow-200">
                            <h3 class="text-sm font-semibold text-gray-800 mb-3 flex items-center">
                                <svg class="w-4 h-4 text-yellow-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                Maximum Discount Cap
                            </h3>
                            <div class="flex items-center space-x-3">
                                <input type="number" min="0" max="100" step="1" name="max_total_discount" id="max_total_discount"
                                    value="{{ discount_stacking_config.max_total_discount or '' }}"
                                    placeholder="No limit"
                                    class="w-24 focus:ring-blue-500 focus:border-blue-500 shadow-sm text-sm border-gray-300 rounded-md">
                                <span class="text-sm text-gray-600">% (leave empty for no cap)</span>
                            </div>
                        </div>

                        <!-- Staff Discretionary Discount -->
                        <div class="border rounded-lg p-4 bg-indigo-50 border-indigo-200">
                            <h3 class="text-sm font-semibold text-gray-800 mb-3 flex items-center">
                                <svg class="w-4 h-4 text-indigo-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                Staff Discretionary Discount
                                <button type="button" class="ml-1 text-gray-400 hover:text-gray-600" onclick="toggleHelp('staff-disc-help')">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/><path stroke-width="2" d="M12 16v-4M12 8h.01"/></svg>
                                </button>
                            </h3>
                            <!-- Staff Discretionary Help -->
                            <div id="staff-disc-help" class="hidden bg-indigo-100 border-l-2 border-indigo-400 p-2 mb-3 text-xs text-indigo-700">
                                <p class="font-semibold mb-1">Staff Discretionary Discount</p>
                                <p class="mb-1">Allows staff to give additional discount at their discretion. Applied at invoice level after all other discounts.</p>
                                <p class="text-indigo-600 italic">Example: Patient complains about wait time - staff gives 2% extra off.</p>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-center space-x-3">
                                    <label class="text-xs text-gray-600 w-28">Max Allowed:</label>
                                    <input type="number" min="0" max="100" step="1" name="staff_disc_max_percent" id="staff_disc_max_percent"
                                        value="{{ staff_discretionary_config.max_percent or 5 }}"
                                        class="w-16 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm text-sm border-gray-300 rounded-md">
                                    <span class="text-xs text-gray-500">%</span>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <label class="text-xs text-gray-600 w-28">Quick Options:</label>
                                    <input type="text" name="staff_disc_options" id="staff_disc_options"
                                        value="{{ staff_discretionary_config.options | join(', ') if staff_discretionary_config.options else '1, 2, 3, 4, 5' }}"
                                        placeholder="1, 2, 3, 4, 5"
                                        class="flex-1 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm text-sm border-gray-300 rounded-md">
                                    <span class="text-xs text-gray-500">%</span>
                                </div>
                                <label class="flex items-center text-xs text-gray-600">
                                    <input name="staff_disc_requires_note" type="checkbox"
                                        {% if staff_discretionary_config.requires_note %}checked{% endif %}
                                        class="focus:ring-indigo-500 h-3.5 w-3.5 text-indigo-600 border-gray-300 rounded mr-2">
                                    Require note/reason when applying
                                </label>
                            </div>
                        </div>

                        <!-- Example Calculator -->
                        <div class="border rounded-lg p-4 bg-gray-100">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">Live Example Calculator</h4>
                            <div class="text-xs text-gray-600 space-y-2">
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="flex items-center">
                                        <span class="w-2 h-2 bg-purple-500 rounded-full mr-1.5"></span>
                                        Campaign: 10%
                                    </div>
                                    <div class="flex items-center">
                                        <span class="w-2 h-2 bg-blue-500 rounded-full mr-1.5"></span>
                                        Bulk: 5%
                                    </div>
                                    <div class="flex items-center">
                                        <span class="w-2 h-2 bg-green-500 rounded-full mr-1.5"></span>
                                        Loyalty: 3%
                                    </div>
                                    <div class="flex items-center">
                                        <span class="w-2 h-2 bg-amber-500 rounded-full mr-1.5"></span>
                                        VIP: 15%
                                    </div>
                                </div>
                                <hr class="border-gray-300">
                                <div id="example-result" class="font-semibold text-blue-700 text-sm">
                                    Total Discount: Calculating...
                                </div>
                            </div>
                        </div>

                        <!-- Recommended Configuration -->
                        <div class="border rounded-lg p-4 bg-gradient-to-br from-green-50 to-emerald-50 border-green-200">
                            <h4 class="text-sm font-semibold text-green-800 mb-2 flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                Recommended Configuration
                            </h4>
                            <div class="text-xs text-green-700 space-y-1">
                                <p><span class="inline-block w-20 font-semibold">VIP:</span> Exclusive <span class="text-green-600">(VIP gets only their discount)</span></p>
                                <p><span class="inline-block w-20 font-semibold">Campaign:</span> Absolute <span class="text-green-600">(Best promo wins, stacks with bulk/loyalty)</span></p>
                                <p><span class="inline-block w-20 font-semibold">Bulk:</span> Incremental <span class="text-green-600">(Always stacks)</span></p>
                                <p><span class="inline-block w-20 font-semibold">Loyalty:</span> Incremental <span class="text-green-600">(Always stacks)</span></p>
                                <p><span class="inline-block w-20 font-semibold">Max Cap:</span> 50% <span class="text-green-600">(Prevents excessive discounts)</span></p>
                            </div>
                        </div>

                        <!-- Common Scenarios -->
                        <div class="border rounded-lg p-4 bg-white">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">Common Scenarios</h4>
                            <div class="text-xs text-gray-600 space-y-2">
                                <div class="bg-gray-50 p-2 rounded">
                                    <p class="font-medium text-gray-800">VIP Patient (VIP=Exclusive)</p>
                                    <p class="text-gray-500">VIP 15% only. No bulk, loyalty, or promo.</p>
                                </div>
                                <div class="bg-gray-50 p-2 rounded">
                                    <p class="font-medium text-gray-800">Regular Patient with Promo</p>
                                    <p class="text-gray-500">Promo 10% + Bulk 15% + Loyalty 3% = 28%</p>
                                </div>
                                <div class="bg-gray-50 p-2 rounded">
                                    <p class="font-medium text-gray-800">Two Promos (Campaign=Absolute)</p>
                                    <p class="text-gray-500">Best promo wins (18%), then + Bulk + Loyalty</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-4 py-3 bg-gray-50 text-right sm:px-6">
                <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Save Discount Configuration
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toggle help text visibility
function toggleHelp(helpId) {
    const helpDiv = document.getElementById(helpId);
    if (helpDiv) {
        helpDiv.classList.toggle('hidden');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Logo upload handling
    const logoInput = document.getElementById('hospital_logo');
    const fileNameDisplay = document.getElementById('selected-file-name');

    if (logoInput && fileNameDisplay) {
        logoInput.addEventListener('change', function(event) {
            const file = event.target.files[0];

            if (!file) {
                fileNameDisplay.classList.add('hidden');
                return;
            }

            // Display the selected file name
            fileNameDisplay.textContent = `Selected: ${file.name}`;
            fileNameDisplay.classList.remove('hidden');

            // Validate file type
            const allowedTypes = ['image/png', 'image/jpeg', 'image/svg+xml', 'image/webp'];
            const maxSize = 5 * 1024 * 1024; // 5MB

            if (!allowedTypes.includes(file.type)) {
                alert('Invalid file type. Please upload PNG, JPG, SVG, or WebP.');
                this.value = ''; // Clear the input
                fileNameDisplay.classList.add('hidden');
                return;
            }

            // Size validation
            if (file.size > maxSize) {
                alert(`File is too large. Maximum size is ${maxSize / 1024 / 1024}MB.`);
                this.value = ''; // Clear the input
                fileNameDisplay.classList.add('hidden');
                return;
            }
        });
    }

    // Discount stacking example calculation
    function calculateExampleDiscount() {
        const form = document.getElementById('discount-stacking-form');
        const exampleResult = document.getElementById('example-result');
        if (!exampleResult || !form) return;

        // Example values
        const discounts = {
            campaign: { value: 10, mode: form.querySelector('[name="campaign_mode"]')?.value || 'exclusive' },
            bulk: { value: 5, mode: form.querySelector('[name="bulk_mode"]')?.value || 'incremental' },
            loyalty: { value: 3, mode: form.querySelector('[name="loyalty_mode"]')?.value || 'incremental' },
            vip: { value: 15, mode: form.querySelector('[name="vip_mode"]')?.value || 'absolute' }
        };

        const excludeWithCampaign = form.querySelector('[name="exclude_with_campaign"]')?.checked || false;
        const maxCap = parseFloat(form.querySelector('[name="max_total_discount"]')?.value) || null;

        let totalDiscount = 0;
        let breakdown = [];
        let absoluteCandidates = [];
        let hasExclusive = false;
        let exclusiveWinner = null;

        // Step 1: Check for any EXCLUSIVE discount (highest exclusive wins)
        for (const [type, disc] of Object.entries(discounts)) {
            if (disc.mode === 'exclusive' && disc.value > 0) {
                if (!exclusiveWinner || disc.value > exclusiveWinner.value) {
                    exclusiveWinner = { type, value: disc.value };
                }
                hasExclusive = true;
            }
        }

        if (hasExclusive && exclusiveWinner) {
            totalDiscount = exclusiveWinner.value;
            breakdown.push(`${exclusiveWinner.type.charAt(0).toUpperCase() + exclusiveWinner.type.slice(1)} ${exclusiveWinner.value}% (exclusive)`);
            // Mark others as excluded
            for (const [type, disc] of Object.entries(discounts)) {
                if (type !== exclusiveWinner.type && disc.value > 0) {
                    breakdown.push(`${type} excluded`);
                }
            }
        } else {
            // No exclusive - process incremental and absolute
            const campaignApplied = discounts.campaign.value > 0;

            for (const [type, disc] of Object.entries(discounts)) {
                if (disc.value <= 0) continue;

                // Check bulk exclusion with campaign
                if (type === 'bulk' && campaignApplied && excludeWithCampaign) {
                    breakdown.push(`Bulk excluded (campaign)`);
                    continue;
                }

                if (disc.mode === 'incremental') {
                    totalDiscount += disc.value;
                    breakdown.push(`${type.charAt(0).toUpperCase() + type.slice(1)} ${disc.value}%`);
                } else if (disc.mode === 'absolute') {
                    absoluteCandidates.push({ name: type.charAt(0).toUpperCase() + type.slice(1), value: disc.value });
                }
            }

            // Handle absolute candidates (best one wins)
            if (absoluteCandidates.length > 0) {
                const best = absoluteCandidates.reduce((a, b) => a.value > b.value ? a : b);
                totalDiscount += best.value;
                breakdown.push(`${best.name} ${best.value}% (best)`);
            }
        }

        // Apply max cap
        if (maxCap && totalDiscount > maxCap) {
            breakdown.push(`Capped to ${maxCap}%`);
            totalDiscount = maxCap;
        }

        exampleResult.innerHTML = `<strong>Total: ${totalDiscount}%</strong><br><span class="text-xs text-gray-500">${breakdown.join(' + ')}</span>`;
    }

    // Bind to all discount config inputs within the form
    const discountForm = document.getElementById('discount-stacking-form');
    if (discountForm) {
        const discountInputs = discountForm.querySelectorAll('select, input[type="checkbox"], input[type="number"]');
        discountInputs.forEach(input => {
            input.addEventListener('change', calculateExampleDiscount);
            input.addEventListener('input', calculateExampleDiscount);
        });
        // Initial calculation
        calculateExampleDiscount();
    }
});
</script>
{% endblock %}