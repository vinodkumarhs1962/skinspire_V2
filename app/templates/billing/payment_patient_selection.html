{% extends "layouts/dashboard.html" %}

{% block title %}{{ title or "Record New Payment" }}{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <!-- Page Header -->
    <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg p-6 mb-6">
        <!-- Row 1: Title and Date -->
        <div class="flex justify-between items-start mb-3">
            <div style="max-width: 60%;">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                    <i class="fas fa-money-check-alt text-blue-500"></i>
                    <span class="ml-2">Record New Payment</span>
                </h1>
                <p class="text-gray-600 dark:text-gray-400 mt-1" style="font-style: italic; font-size: 1.125rem; padding-left: 2.5rem;">
                    Select patient to record payment
                </p>
            </div>
            <div class="text-right">
                <div class="text-gray-600 dark:text-gray-400">
                    <i class="fas fa-calendar text-gray-500"></i>
                    <span class="ml-1 font-bold text-base">{{ now().strftime('%d %b %Y') }}</span>
                </div>
                <div class="text-gray-500 dark:text-gray-400 mt-1 font-bold text-sm">
                    {{ now().strftime('%A') }}
                </div>
            </div>
        </div>

        <!-- Row 2: Breadcrumb -->
        <div class="mb-4">
            <nav class="flex items-center space-x-1 text-sm text-gray-500">
                <a href="{{ url_for('auth_views.dashboard') }}" class="hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                    Dashboard
                </a>
                <span class="text-gray-400 mx-2">/</span>
                <span class="text-gray-700 dark:text-gray-300">Record New Payment</span>
            </nav>
        </div>

        <!-- Row 3: Action Buttons -->
        <div>
            <!-- Standard Back Button (Always First) -->
            <button onclick="window.history.back()" type="button" class="btn-back">
                <i class="fas fa-arrow-left icon-left"></i>Back
            </button>
        </div>
    </div>

    <!-- Patient Selection Card -->
    <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg p-6">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
            <i class="fas fa-user-circle text-blue-500 mr-2"></i>
            Select Patient
        </h2>

        <!-- Patient Search/Autocomplete -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Search Patient <span class="text-red-500">*</span>
            </label>
            <div class="relative">
                <input type="text"
                       id="patient-search"
                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                       placeholder="Type patient name, MRN, or phone number..."
                       autocomplete="off">
                <i class="fas fa-search absolute right-4 top-4 text-gray-400"></i>
            </div>

            <!-- Search Results Dropdown -->
            <div id="patient-results" class="hidden absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-96 overflow-y-auto">
                <!-- Results will be populated by JavaScript -->
            </div>

            <!-- Loading Indicator -->
            <div id="patient-loading" class="hidden absolute right-12 top-4">
                <i class="fas fa-spinner fa-spin text-blue-500"></i>
            </div>
        </div>

        <!-- Selected Patient Display -->
        <div id="selected-patient-card" class="hidden bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 rounded p-5 mb-6">
            <div class="flex items-start justify-between">
                <div class="flex items-start flex-1">
                    <i class="fas fa-user-circle text-blue-500 text-3xl mr-4 mt-1"></i>
                    <div class="flex-1">
                        <div class="font-bold text-xl text-gray-900 dark:text-white mb-2" id="selected-patient-name">
                            <!-- Patient name -->
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-base text-gray-600 dark:text-gray-400">
                            <div>
                                <strong class="text-gray-700 dark:text-gray-300">MRN:</strong> <span id="selected-patient-mrn"></span>
                            </div>
                            <div id="selected-patient-phone-container" class="hidden">
                                <i class="fas fa-phone mr-1.5"></i><span id="selected-patient-phone"></span>
                            </div>
                            <div id="selected-patient-email-container" class="hidden">
                                <i class="fas fa-envelope mr-1.5"></i><span id="selected-patient-email"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" id="clear-patient" class="ml-4 px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded transition-colors">
                    <i class="fas fa-times mr-1"></i>
                    Clear
                </button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end items-center gap-3">
            <a href="{{ url_for('universal_views.universal_list_view', entity_type='patient_invoices') }}"
               class="btn-danger">
                <i class="fas fa-times mr-2"></i>
                Cancel
            </a>
            <button type="button"
                    id="continue-btn"
                    class="btn-primary"
                    disabled>
                <i class="fas fa-arrow-right mr-2"></i>
                Continue to Payment
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    let selectedPatientId = null;

    const searchInput = document.getElementById('patient-search');
    const resultsDiv = document.getElementById('patient-results');
    const selectedCard = document.getElementById('selected-patient-card');
    const continueBtn = document.getElementById('continue-btn');
    const clearBtn = document.getElementById('clear-patient');
    const loadingIcon = document.getElementById('patient-loading');

    // Debounce timer
    let searchTimer = null;

    // Load initial list of recent patients on page load
    searchPatients('');

    // Search patients
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();

        clearTimeout(searchTimer);

        if (query.length < 2) {
            resultsDiv.classList.add('hidden');
            return;
        }

        searchTimer = setTimeout(() => {
            searchPatients(query);
        }, 300);
    });

    // Show recent patients on focus if no query
    searchInput.addEventListener('focus', function() {
        if (!this.value.trim()) {
            searchPatients('');
        }
    });

    async function searchPatients(query) {
        try {
            // Show loading indicator
            if (loadingIcon) loadingIcon.classList.remove('hidden');

            const response = await fetch(`/api/universal/patients/search?q=${encodeURIComponent(query)}&limit=20&active_only=true`);
            if (!response.ok) throw new Error('Search failed');

            const data = await response.json();
            displayResults(data.results || []);
        } catch (error) {
            console.error('Error searching patients:', error);
            resultsDiv.innerHTML = '<div class="p-4 text-red-500">Error searching patients. Please try again.</div>';
            resultsDiv.classList.remove('hidden');
        } finally {
            // Hide loading indicator
            if (loadingIcon) loadingIcon.classList.add('hidden');
        }
    }

    function displayResults(patients) {
        if (patients.length === 0) {
            resultsDiv.innerHTML = '<div class="p-4 text-gray-500">No patients found</div>';
            resultsDiv.classList.remove('hidden');
            return;
        }

        resultsDiv.innerHTML = patients.map(patient => {
            // Get patient name
            const patientName = patient.patient_name || patient.name || patient.label || 'Unknown';
            const mrn = patient.mrn || 'N/A';
            const patientId = patient.patient_id || patient.value || patient.uuid;

            // Status badge if patient is not active
            const statusBadge = patient.status_badge ?
                `<span class="ml-2 px-2 py-0.5 text-xs rounded bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">${patient.status_badge}</span>` : '';

            return `
                <div class="patient-result-item p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-200 dark:border-gray-600 last:border-0"
                     data-patient-id="${patientId}"
                     data-patient-name="${patientName}"
                     data-patient-mrn="${mrn}"
                     data-patient-phone=""
                     data-patient-email="">
                    <div class="font-semibold text-gray-900 dark:text-white">
                        ${patientName}${statusBadge}
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                        MRN: ${mrn}
                    </div>
                </div>
            `;
        }).join('');

        // Add click handlers
        document.querySelectorAll('.patient-result-item').forEach(item => {
            item.addEventListener('click', function() {
                selectPatient(this);
            });
        });

        resultsDiv.classList.remove('hidden');
    }

    function selectPatient(element) {
        selectedPatientId = element.dataset.patientId;

        // Update selected card
        document.getElementById('selected-patient-name').textContent = element.dataset.patientName;
        document.getElementById('selected-patient-mrn').textContent = element.dataset.patientMrn;

        // Phone
        if (element.dataset.patientPhone) {
            document.getElementById('selected-patient-phone').textContent = element.dataset.patientPhone;
            document.getElementById('selected-patient-phone-container').classList.remove('hidden');
        } else {
            document.getElementById('selected-patient-phone-container').classList.add('hidden');
        }

        // Email
        if (element.dataset.patientEmail) {
            document.getElementById('selected-patient-email').textContent = element.dataset.patientEmail;
            document.getElementById('selected-patient-email-container').classList.remove('hidden');
        } else {
            document.getElementById('selected-patient-email-container').classList.add('hidden');
        }

        // Show card, hide results, enable continue
        selectedCard.classList.remove('hidden');
        resultsDiv.classList.add('hidden');
        continueBtn.disabled = false;
        searchInput.value = '';
    }

    // Clear selection
    clearBtn.addEventListener('click', function() {
        selectedPatientId = null;
        selectedCard.classList.add('hidden');
        continueBtn.disabled = true;
        searchInput.value = '';
        searchInput.focus();
    });

    // Continue to payment - find first outstanding invoice
    continueBtn.addEventListener('click', async function() {
        if (!selectedPatientId) return;

        try {
            // Fetch patient's outstanding invoices
            const response = await fetch(`/api/billing/patient/${selectedPatientId}/outstanding-invoices`);
            if (!response.ok) throw new Error('Failed to fetch invoices');

            const data = await response.json();
            const invoices = data.invoices || [];

            if (invoices.length === 0) {
                alert('This patient has no outstanding invoices.');
                return;
            }

            // Redirect to payment form with first invoice (payment form will show all invoices)
            window.location.href = `/invoice/${invoices[0].invoice_id}/payment-enhanced`;
        } catch (error) {
            console.error('Error:', error);
            alert('Error loading invoices. Please try again.');
        }
    });

    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
            resultsDiv.classList.add('hidden');
        }
    });
</script>
{% endblock %}
