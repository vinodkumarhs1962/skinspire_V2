{% extends "layouts/dashboard.html" %}

{% block title %}Create Patient Invoice{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/multi_discount.css') }}">
<style>
    /* ===================================================================
       INVOICE ENHANCED STYLING - GOLD STANDARD
       Based on supplier invoice template with billing counter optimizations
       =================================================================== */

    /* Invoice Container */
    .invoice-enhanced-container {
        background: #f3f4f6;
        min-height: 100vh;
        padding: 0;
        margin: -1.5rem;
    }

    .dark .invoice-enhanced-container {
        background: #0f172a;
    }

    /* Header styling */
    .invoice-header {
        background: white;
        padding: 1.5rem;
        margin-bottom: 0;
    }

    .dark .invoice-header {
        background: rgb(31 41 55);
    }

    /* Badge styling */
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .badge-info {
        background-color: rgb(219 234 254);
        color: rgb(30 64 175);
        border: 1px solid rgb(147 197 253);
    }

    .dark .badge-info {
        background-color: rgba(59, 130, 246, 0.2);
        color: rgb(147 197 253);
        border-color: rgb(59 130 246);
    }

    /* Quick actions bar */
    .quick-actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem 1.5rem;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 1rem;
    }

    .dark .quick-actions-bar {
        background: rgb(31 41 55);
        border-bottom-color: rgb(55 65 81);
    }

    .quick-actions-left {
        display: flex;
        gap: 0.5rem;
    }

    /* Line Items Section */
    .line-items-section {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 0;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .dark .line-items-section {
        background: rgb(31 41 55);
    }

    /* Bottom action buttons */
    .bottom-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        gap: 0.75rem;
    }

    .dark .bottom-actions {
        background: rgb(31 41 55);
    }

    /* Two-column grid for form fields */
    .invoice-two-column-grid {
        display: grid !important;
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        gap: 1rem !important;
        width: 100% !important;
    }

    @media (max-width: 768px) {
        .invoice-two-column-grid {
            grid-template-columns: 1fr !important;
        }
    }

    /* Form styles */
    .universal-form-group {
        margin-bottom: 1rem !important;
    }

    .universal-form-label {
        display: block !important;
        margin-bottom: 0.25rem !important;
        font-size: 0.875rem !important;
        font-weight: 500 !important;
        color: rgb(55 65 81) !important;
    }

    .dark .universal-form-label {
        color: rgb(209 213 219) !important;
    }

    /* Patient info display */
    .patient-info {
        background: #f0f9ff;
        border: 2px solid #3b82f6;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-top: 0.5rem;
    }

    .dark .patient-info {
        background: rgba(59, 130, 246, 0.1);
        border-color: rgb(59 130 246);
    }

    .patient-info.selected {
        animation: pulse-success 0.5s ease-in-out;
    }

    @keyframes pulse-success {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.02); }
    }

    /* Table footer totals */
    .table-footer-totals {
        background: #f9fafb;
        border-top: 2px solid #e5e7eb;
    }

    .dark .table-footer-totals {
        background: rgb(55 65 81);
        border-top-color: rgb(75 85 99);
    }

    .grand-total-row {
        background: linear-gradient(135deg, rgb(239 246 255) 0%, rgb(219 234 254) 100%);
        font-size: 1.125rem;
    }

    .dark .grand-total-row {
        background: linear-gradient(135deg, rgba(30, 58, 138, 0.3) 0%, rgba(59, 130, 246, 0.2) 100%);
    }

    /* Medicine-specific fields */
    .medicine-field {
        display: none;
    }

    .medicine-field.visible {
        display: block;
    }

    .non-medicine-placeholder {
        display: inline-block;
        color: #9ca3af;
    }

    /* Batch expiry warning */
    .expiry-warning {
        color: #ef4444;
        font-weight: 600;
    }

    .expiry-near {
        color: #f59e0b;
    }

    /* Required field indicator */
    .required-indicator {
        color: #ef4444;
        margin-left: 0.25rem;
    }

    /* Keyboard shortcut hints */
    .keyboard-hint {
        font-size: 0.75rem;
        color: #6b7280;
        margin-left: 0.5rem;
    }

    .dark .keyboard-hint {
        color: #9ca3af;
    }

    /* Loading spinner */
    .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #f3f4f6;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Amount in words display */
    .amount-in-words {
        background: #fef3c7;
        border: 1px solid #fbbf24;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-top: 1rem;
        font-size: 0.875rem;
        font-style: italic;
    }

    .dark .amount-in-words {
        background: rgba(251, 191, 36, 0.1);
        border-color: #fbbf24;
    }

    /* Patient Autocomplete Dropdown Styles - v3.0 ULTIMATE FIX */
    /* CRITICAL: Override invoice.css overflow rules that are loaded after this */
    /* Target EVERY possible parent container with maximum specificity */

    /* Main containers - OVERRIDE ALL */
    .invoice-enhanced-container,
    .invoice-enhanced-container > *,
    .invoice-enhanced-container > * > *,
    div.invoice-enhanced-container,
    div.invoice-enhanced-container > div {
        overflow: visible !important;
    }

    /* Card containers - OVERRIDE ALL */
    .universal-filter-card,
    .universal-filter-card *,
    div.universal-filter-card,
    div.universal-filter-card > div,
    div.universal-filter-card > div > div {
        overflow: visible !important;
    }

    /* Card body - OVERRIDE ALL */
    .universal-filter-card-body,
    .universal-filter-card-body *,
    div.universal-filter-card-body,
    div.universal-filter-card-body > div,
    div.universal-filter-card-body > div > div {
        overflow: visible !important;
    }

    /* Grid containers - OVERRIDE ALL */
    .invoice-two-column-grid,
    .invoice-two-column-grid *,
    div.invoice-two-column-grid,
    div.invoice-two-column-grid > div,
    div.invoice-two-column-grid > div > div {
        overflow: visible !important;
    }

    /* Form groups - OVERRIDE ALL */
    .universal-form-group,
    div.universal-form-group,
    div.universal-form-group > div,
    div.universal-form-group > div > div {
        overflow: visible !important;
    }

    /* Invoice meta sections - OVERRIDE invoice.css lines 47, 75 */
    .meta-section,
    div.meta-section,
    .meta-section div,
    div.meta-section div {
        overflow: visible !important;
    }

    /* Re-enable scrolling ONLY for specific elements that need it */
    .line-items-tbody,
    .invoice-table-wrapper {
        overflow-y: auto !important;
        overflow-x: auto !important;
    }

    /* Dropdown positioning and display - CRITICAL */
    #patient_dropdown {
        position: absolute !important;
        top: 100% !important;
        left: 0 !important;
        right: 0 !important;
        margin-top: 0.25rem !important;
        background-color: white !important;
        border: 1px solid rgb(209 213 219) !important;
        border-radius: 0.375rem !important;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        z-index: 99999 !important;
        max-height: 300px !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
    }

    .dark #patient_dropdown {
        background-color: rgb(31 41 55) !important;
        border-color: rgb(75 85 99) !important;
    }

    #patient_dropdown > div {
        padding: 0.75rem !important;
        cursor: pointer !important;
        transition: background-color 0.15s ease-in-out !important;
        border-bottom: 1px solid rgb(229 231 235) !important;
    }

    .dark #patient_dropdown > div {
        border-color: rgb(75 85 99) !important;
    }

    #patient_dropdown > div:hover {
        background-color: rgb(243 244 246) !important;
    }

    .dark #patient_dropdown > div:hover {
        background-color: rgb(55 65 81) !important;
    }

    #patient_dropdown > div:last-child {
        border-bottom: none !important;
    }
</style>
{% endblock %}

{% block extra_css %}
<!-- CRITICAL: Load invoice.css first, then override with autocomplete styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/invoice.css') }}">
<!-- Bulk Discount Consultation Panel Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/bulk_discount.css') }}">
<style>
    /* Patient Autocomplete Dropdown Styles - v3.1 POST-INVOICE-CSS FIX */
    /* CRITICAL: This MUST come AFTER invoice.css to override its rules */

    /* Main containers - OVERRIDE ALL invoice.css overflow rules */
    .invoice-enhanced-container,
    .invoice-enhanced-container > *,
    .invoice-enhanced-container > * > *,
    div.invoice-enhanced-container,
    div.invoice-enhanced-container > div {
        overflow: visible !important;
    }

    /* Card containers - OVERRIDE ALL */
    .universal-filter-card,
    .universal-filter-card *,
    div.universal-filter-card,
    div.universal-filter-card > div,
    div.universal-filter-card > div > div {
        overflow: visible !important;
    }

    /* Card body - OVERRIDE ALL */
    .universal-filter-card-body,
    .universal-filter-card-body *,
    div.universal-filter-card-body,
    div.universal-filter-card-body > div,
    div.universal-filter-card-body > div > div {
        overflow: visible !important;
    }

    /* Grid containers - OVERRIDE ALL */
    .invoice-two-column-grid,
    .invoice-two-column-grid *,
    div.invoice-two-column-grid,
    div.invoice-two-column-grid > div,
    div.invoice-two-column-grid > div > div {
        overflow: visible !important;
    }

    /* Form groups - OVERRIDE ALL */
    .universal-form-group,
    div.universal-form-group,
    div.universal-form-group > div,
    div.universal-form-group > div > div {
        overflow: visible !important;
    }

    /* Invoice meta sections - OVERRIDE invoice.css lines 47, 75 */
    .meta-section,
    div.meta-section,
    .meta-section div,
    div.meta-section div {
        overflow: visible !important;
    }

    /* Re-enable scrolling ONLY for specific elements that need it */
    .line-items-tbody,
    .invoice-table-wrapper {
        overflow-y: auto !important;
        overflow-x: auto !important;
    }

    /* Dropdown positioning and display - CRITICAL */
    #patient_dropdown {
        position: absolute !important;
        top: 100% !important;
        left: 0 !important;
        right: 0 !important;
        margin-top: 0.25rem !important;
        background-color: white !important;
        border: 1px solid rgb(209 213 219) !important;
        border-radius: 0.375rem !important;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        z-index: 99999 !important;
        max-height: 300px !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
    }

    .dark #patient_dropdown {
        background-color: rgb(31 41 55) !important;
        border-color: rgb(75 85 99) !important;
    }

    #patient_dropdown > div {
        padding: 0.75rem !important;
        cursor: pointer !important;
        transition: background-color 0.15s ease-in-out !important;
        border-bottom: 1px solid rgb(229 231 235) !important;
    }

    .dark #patient_dropdown > div {
        border-color: rgb(75 85 99) !important;
    }

    #patient_dropdown > div:hover {
        background-color: rgb(243 244 246) !important;
    }

    .dark #patient_dropdown > div:hover {
        background-color: rgb(55 65 81) !important;
    }

    #patient_dropdown > div:last-child {
        border-bottom: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="invoice-enhanced-container">
    <!-- Enhanced Header with Date/Day/Status -->
    <div class="invoice-header">
        <div class="info-card" style="box-shadow: none; border: none; margin: 0;">
            <div class="card-body" style="padding: 0; background: transparent;">
                <!-- Row 1: Title and Date/Status -->
                <div class="flex justify-between items-start mb-3">
                    <div style="max-width: 60%;">
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                            <i class="fas fa-file-invoice-dollar text-blue-500"></i>
                            <span class="ml-2">Create Patient Invoice</span>
                        </h1>
                        <p class="text-gray-600 dark:text-gray-400 mt-1" style="font-style: italic; font-size: 1.125rem; padding-left: 2.5rem;">
                            Quick billing for services and medicines
                        </p>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem; padding-right: 1rem;">
                        <span class="badge badge-info">Creating</span>
                        <div style="text-align: right;">
                            <div class="text-gray-600 dark:text-gray-400">
                                <i class="fas fa-calendar text-gray-500"></i>
                                <span class="ml-1 font-bold text-base">{{ now().strftime('%d %b %Y') }}</span>
                            </div>
                            <div class="text-gray-500 dark:text-gray-400 mt-1 font-bold text-sm">
                                {{ now().strftime('%A') }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 2: Breadcrumb -->
                <div class="mb-3">
                    <nav class="flex items-center space-x-1 text-sm text-gray-500">
                        <a href="{{ url_for('auth_views.dashboard') }}" class="hover:text-gray-700 dark:hover:text-gray-300">
                            Dashboard
                        </a>
                        <span class="text-gray-400 mx-2">/</span>
                        <a href="{{ url_for('universal_views.universal_list_view', entity_type='patient_invoices') }}" class="hover:text-gray-700 dark:hover:text-gray-400 dark:hover:text-gray-300">
                            Patient Invoices
                        </a>
                        <span class="text-gray-400 mx-2">/</span>
                        <span class="text-gray-700 dark:text-gray-300 font-medium">Create New</span>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Bar -->
    <div class="quick-actions-bar">
        <div class="quick-actions-left">
            <!-- Standard Back Button (Always First) -->
            <button onclick="window.history.back()" type="button" class="btn-back">
                <i class="fas fa-arrow-left icon-left"></i>Back
            </button>
            <a href="{{ url_for('universal_views.universal_list_view', entity_type='patient_invoices') }}" class="btn-outline">
                <i class="fas fa-list mr-2"></i>
                Invoices
            </a>
            <a href="{{ url_for('universal_views.universal_list_view', entity_type='patients') }}" class="btn-outline">
                <i class="fas fa-users mr-2"></i>
                Patients
            </a>
            <a href="{{ url_for('billing_views.advance_payment_list') }}" class="btn-outline">
                <i class="fas fa-wallet mr-2"></i>
                Advances
            </a>
        </div>
        <div class="flex items-center gap-3">
            <!-- Batch Mode Toggle -->
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Batch Mode:</label>
                <button
                    id="batch-mode-toggle"
                    type="button"
                    class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                    data-mode="{{ user_batch_mode | default('manual') }}"
                    onclick="toggleBatchMode()"
                    style="background-color: {{ 'rgb(59, 130, 246)' if user_batch_mode == 'auto' else 'rgb(156, 163, 175)' }};">
                    <span class="sr-only">Toggle batch mode</span>
                    <span
                        class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                        style="transform: translateX({{ '24px' if user_batch_mode == 'auto' else '4px' }});"></span>
                </button>
                <span id="batch-mode-label" class="text-sm text-gray-600 dark:text-gray-400 font-medium">
                    {{ 'Auto' if user_batch_mode == 'auto' else 'Manual' }}
                </span>
            </div>
            <button type="button" onclick="resetInvoiceForm()" class="btn-outline" title="Ctrl+R">
                <i class="fas fa-undo mr-2"></i>
                Reset Form
            </button>
        </div>
    </div>

    <div class="px-6">

        <!-- Flash messages section -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="mb-4 bg-{{ 'green' if category == 'success' else 'red' if category == 'error' else 'blue' }}-100 border-l-4 border-{{ 'green' if category == 'success' else 'red' if category == 'error' else 'blue' }}-500 text-{{ 'green' if category == 'success' else 'red' if category == 'error' else 'blue' }}-700 p-4" role="alert">
                <p>{{ message }}</p>
            </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Inventory error specific message -->
        {% if inventory_error %}
        <div class="mb-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-3" role="alert">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <div>
                    <p class="font-bold text-sm">Inventory Issue</p>
                    <p class="text-sm">{{ inventory_error }}</p>
                    <p class="text-xs mt-1">Please adjust the quantity or select a different batch or medicine.</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Form Errors Alert -->
        {% if form.errors %}
        <div class="mb-4 bg-red-50 border-l-4 border-red-400 p-4" role="alert">
            <p class="font-medium">There were errors in your submission. Please check the form and try again.</p>
            <ul class="mt-2 text-sm list-disc list-inside">
                {% for field, errors in form.errors.items() %}
                    {% for error in errors %}
                    <li>{{ field }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Main Form -->
        <form method="POST" id="invoice-form" action="{{ url_for('billing_views.create_invoice_view') }}" class="space-y-6">
            {{ form.csrf_token }}

            <!-- Section 1: Patient & Invoice Information -->
            <div class="universal-filter-card">
                <div class="universal-filter-card-header">
                    <h3 class="universal-filter-card-title">
                        <i class="fas fa-info-circle"></i>
                        Patient & Invoice Information
                    </h3>
                </div>

                <div class="universal-filter-card-body">
                    <div class="invoice-two-column-grid">
                        <!-- Left Column -->
                        <div>
                            <!-- Patient Selection - AUTOCOMPLETE DROPDOWN -->
                            <div class="universal-form-group">
                                <label class="universal-form-label" for="patient_search">
                                    Patient <span class="required-indicator">*</span>
                                </label>
                                <div style="position: relative;">
                                    <!-- Search input (visible) -->
                                    <input type="text"
                                           id="patient_search"
                                           class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                           placeholder="Search patient by name or MRN..."
                                           autocomplete="off"
                                           autofocus>

                                    <!-- Hidden field for patient ID (populated by search component) -->
                                    {{ form.patient_id(id="patient_id") }}

                                    <!-- Dropdown results -->
                                    <div id="patient_dropdown"
                                         class="absolute z-50 w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg hidden mt-1 max-h-60 overflow-y-auto">
                                        <!-- Results will be populated by JavaScript -->
                                    </div>

                                    <!-- Loading indicator -->
                                    <div id="patient_loading"
                                         class="absolute right-3 top-3 hidden">
                                        <i class="fas fa-spinner fa-spin text-gray-400"></i>
                                    </div>
                                </div>

                                <!-- Hidden field for patient name (auto-populated by form) -->
                                {{ form.patient_name(class="hidden", id="patient_name") }}
                            </div>

                            <!-- Invoice Date -->
                            <div class="universal-form-group">
                                <label class="universal-form-label" for="{{ form.invoice_date.id }}">
                                    Invoice Date <span class="required-indicator">*</span>
                                </label>
                                {{ form.invoice_date(
                                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline",
                                    type="date",
                                    required=true
                                ) }}
                                {% if form.invoice_date.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.invoice_date.errors[0] }}</p>
                                {% endif %}
                            </div>

                            <!-- Invoice Type (Hidden - determined by line items) -->
                            <input type="hidden" name="invoice_type" id="invoice_type" value="Service">
                        </div>

                        <!-- Right Column -->
                        <div>
                            <!-- Branch (Hidden) - Use session branch or first available branch -->
                            <input type="hidden" name="branch_id" id="branch_id" value="{{ g.branch_id if g.branch_id else (branches[0]['branch_id'] if branches and branches|length > 0 else '') }}">
                            <input type="hidden" name="hospital_id" id="hospital_id" value="{{ g.hospital_id if g.hospital_id else '' }}">

                            <!-- GST Invoice (Hidden - always true) -->
                            <input type="hidden" name="is_gst_invoice" id="is_gst_invoice" value="true">

                            <!-- Interstate Checkbox (Hidden - calculated from patient address) -->
                            <input type="hidden" name="is_interstate" id="is_interstate" value="false">

                            <!-- Place of Supply -->
                            <div class="universal-form-group gst-element">
                                <label class="universal-form-label" for="{{ form.place_of_supply.id }}">
                                    Place of Supply (State) <span class="required-indicator">*</span>
                                </label>
                                <select id="{{ form.place_of_supply.id }}"
                                        name="place_of_supply"
                                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="">Select State</option>
                                    <option value="35">Andaman & Nicobar Islands (35)</option>
                                    <option value="28">Andhra Pradesh (28)</option>
                                    <option value="37">Andhra Pradesh (New) (37)</option>
                                    <option value="12">Arunachal Pradesh (12)</option>
                                    <option value="18">Assam (18)</option>
                                    <option value="10">Bihar (10)</option>
                                    <option value="04">Chandigarh (04)</option>
                                    <option value="22">Chhattisgarh (22)</option>
                                    <option value="26">Dadra & Nagar Haveli (26)</option>
                                    <option value="25">Daman & Diu (25)</option>
                                    <option value="07">Delhi (07)</option>
                                    <option value="30">Goa (30)</option>
                                    <option value="24">Gujarat (24)</option>
                                    <option value="06">Haryana (06)</option>
                                    <option value="02">Himachal Pradesh (02)</option>
                                    <option value="01">Jammu & Kashmir (01)</option>
                                    <option value="20">Jharkhand (20)</option>
                                    <option value="29" selected>Karnataka (29)</option>
                                    <option value="32">Kerala (32)</option>
                                    <option value="31">Lakshadweep (31)</option>
                                    <option value="23">Madhya Pradesh (23)</option>
                                    <option value="27">Maharashtra (27)</option>
                                    <option value="14">Manipur (14)</option>
                                    <option value="17">Meghalaya (17)</option>
                                    <option value="15">Mizoram (15)</option>
                                    <option value="13">Nagaland (13)</option>
                                    <option value="21">Odisha (21)</option>
                                    <option value="97">Other Territory (97)</option>
                                    <option value="34">Puducherry (34)</option>
                                    <option value="03">Punjab (03)</option>
                                    <option value="08">Rajasthan (08)</option>
                                    <option value="11">Sikkim (11)</option>
                                    <option value="33">Tamil Nadu (33)</option>
                                    <option value="36">Telangana (36)</option>
                                    <option value="16">Tripura (16)</option>
                                    <option value="05">Uttarakhand (05)</option>
                                    <option value="09">Uttar Pradesh (09)</option>
                                    <option value="19">West Bengal (19)</option>
                                </select>
                                {% if form.place_of_supply.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.place_of_supply.errors[0] }}</p>
                                {% endif %}
                            </div>

                            <!-- Currency (Hidden/Readonly) -->
                            <div class="universal-form-group">
                                <label class="universal-form-label" for="{{ form.currency_code.id }}">
                                    Currency <span class="text-gray-500 text-xs ml-2">(Auto-populated)</span>
                                </label>
                                {{ form.currency_code(
                                    class="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300 leading-tight cursor-not-allowed",
                                    readonly=true,
                                    value="INR"
                                ) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- MULTI-DISCOUNT OPERATIONAL PANEL (STAFF VIEW) -->
            <!-- Added: Nov 22, 2025 - Multi-discount system with Patient View -->
            <!-- ================================================== -->
            <div class="multi-discount-operational-panel" id="discount-panel" style="margin-bottom: 24px;">

                <!-- Header Section -->
                <div class="panel-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; border-radius: 8px 8px 0 0;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">üí∞</span>
                            <div>
                                <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Pricing & Discount Control</h3>
                                <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;">Real-time multi-discount calculator</p>
                            </div>
                        </div>

                        <!-- Patient View Button -->
                        <button
                            type="button"
                            onclick="openPatientView()"
                            class="btn"
                            style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; transition: all 0.3s ease;"
                            onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                            onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            <i class="fas fa-tv" style="margin-right: 8px;"></i>
                            Patient View
                        </button>
                    </div>
                </div>

                <!-- Discount Type Controls -->
                <div class="discount-controls" style="background: #f8fafc; border-left: 3px solid #667eea; border-right: 3px solid #667eea;">

                    <!-- Collapsible Header -->
                    <div id="discount-controls-header" style="padding: 16px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #e0e7ff; border-bottom: 1px solid #c7d2fe;">
                        <div>
                            <strong style="font-size: 14px; font-weight: 600; color: #3730a3;">üí≥ Discount Controls</strong>
                            <span style="font-size: 12px; color: #6366f1; margin-left: 8px;">(Click to expand/collapse)</span>
                        </div>
                        <span id="discount-toggle-icon" style="font-size: 18px; color: #667eea; transition: transform 0.3s; transform: rotate(180deg);">‚ñ≤</span>
                    </div>

                    <!-- Collapsible Content -->
                    <div id="discount-controls-content" style="padding: 20px; display: block;">
                        <div class="controls-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">

                        <!-- Standard Discount -->
                        <div class="discount-control-card" style="background: white; padding: 16px; border-radius: 8px; border: 2px solid #e5e7eb;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input
                                    type="checkbox"
                                    id="apply-standard-discount"
                                    checked
                                    style="width: 18px; height: 18px; margin-right: 10px;">
                                <div style="flex: 1;">
                                    <span class="badge-discount-standard" style="font-size: 11px; font-weight: 600;">STANDARD</span>
                                    <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">Item-level default discounts</div>
                                </div>
                                <button type="button" id="standard-eligible-toggle"
                                    style="background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; padding: 4px 8px; font-size: 11px; color: #6b7280; cursor: pointer; margin-left: 8px;"
                                    title="Show all eligible discounts">
                                    ‚ÑπÔ∏è Details
                                </button>
                            </label>
                            <div id="standard-discount-info" style="margin-top: 12px; font-size: 13px; color: #1f2937; display: none;">
                                <strong style="font-weight: 500;">Amount:</strong> <span id="standard-amount">Rs. 0.00</span>
                            </div>
                            <!-- Eligible Discounts Section -->
                            <div id="standard-eligible-discounts" style="display: block; margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 4px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">ALL ELIGIBLE DISCOUNTS:</div>
                                <div id="standard-eligible-list" style="font-size: 13px; color: #374151;">
                                    <span style="color: #9ca3af; font-style: italic;">Add items to see discounts</span>
                                </div>
                            </div>
                        </div>

                        <!-- Bulk Discount -->
                        <div class="discount-control-card" style="background: white; padding: 16px; border-radius: 8px; border: 2px solid #e5e7eb;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input
                                    type="checkbox"
                                    id="bulk-discount-enabled"
                                    style="width: 18px; height: 18px; margin-right: 10px;">
                                <div style="flex: 1;">
                                    <span class="badge-discount-bulk" style="font-size: 11px; font-weight: 600;">BULK</span>
                                    <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">Volume-based discounts (5+ items)</div>
                                </div>
                                <button type="button" id="bulk-eligible-toggle"
                                    style="background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; padding: 4px 8px; font-size: 11px; color: #6b7280; cursor: pointer; margin-left: 8px;"
                                    title="Show all eligible discounts">
                                    ‚ÑπÔ∏è Details
                                </button>
                            </label>
                            <div id="bulk-discount-info" style="margin-top: 12px; font-size: 13px; color: #1f2937; display: none;">
                                <strong style="font-weight: 500;">Services:</strong> <span id="bulk-service-count">0</span> |
                                <strong style="font-weight: 500;">Amount:</strong> <span id="bulk-amount">Rs. 0.00</span>
                            </div>
                            <!-- Eligible Discounts Section -->
                            <div id="bulk-eligible-discounts" style="display: block; margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 4px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">ALL ELIGIBLE DISCOUNTS:</div>
                                <div id="bulk-eligible-list" style="font-size: 13px; color: #374151;">
                                    <span style="color: #9ca3af; font-style: italic;">Add 5+ items for bulk discount</span>
                                </div>
                            </div>
                        </div>

                        <!-- Loyalty Discount -->
                        <div class="discount-control-card" style="background: white; padding: 16px; border-radius: 8px; border: 2px solid #e5e7eb;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input
                                    type="checkbox"
                                    id="apply-loyalty-discount"
                                    style="width: 18px; height: 18px; margin-right: 10px;"
                                    disabled>
                                <div style="flex: 1;">
                                    <span class="badge-discount-loyalty" style="font-size: 11px; font-weight: 600;">LOYALTY</span>
                                    <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">Membership card discounts</div>
                                </div>
                                <button type="button" id="loyalty-eligible-toggle"
                                    style="background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; padding: 4px 8px; font-size: 11px; color: #6b7280; cursor: pointer; margin-left: 8px;"
                                    title="Show all eligible discounts">
                                    ‚ÑπÔ∏è Details
                                </button>
                            </label>
                            <div id="loyalty-discount-info" style="margin-top: 12px; font-size: 13px; color: #1f2937; display: none;">
                                <strong style="font-weight: 500;">Card:</strong> <span id="loyalty-card-type">None</span> |
                                <strong style="font-weight: 500;">Amount:</strong> <span id="loyalty-amount">Rs. 0.00</span>
                            </div>
                            <!-- Eligible Discounts Section -->
                            <div id="loyalty-eligible-discounts" style="display: block; margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 4px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">ALL ELIGIBLE DISCOUNTS:</div>
                                <div id="loyalty-eligible-list" style="font-size: 13px; color: #374151;">
                                    <span style="color: #9ca3af; font-style: italic;">Select patient with loyalty card</span>
                                </div>
                            </div>
                        </div>

                        <!-- Campaign Discounts Card (Redesigned 2025-11-29) -->
                        <div class="discount-control-card campaign-card" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 16px; border-radius: 8px; border: 2px solid #86efac;">
                            <!-- Header -->
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center;">
                                    <span class="badge-discount-promotion" style="font-size: 11px; font-weight: 600;">CAMPAIGN</span>
                                    <span style="font-size: 12px; color: #166534; margin-left: 8px;">Auto-applied based on eligibility</span>
                                </div>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="campaign-apply-checkbox" checked onchange="toggleCampaignDiscount()"
                                           style="width: 18px; height: 18px; cursor: pointer; accent-color: #22c55e;">
                                    <span style="margin-left: 8px; font-size: 13px; font-weight: 500; color: #166534;">Apply</span>
                                </label>
                            </div>

                            <!-- Eligible Campaigns List -->
                            <div id="campaign-eligible-list" style="padding: 12px; background: white; border-radius: 6px; border: 1px solid #86efac; min-height: 60px;">
                                <div id="campaign-list-content" style="font-size: 13px; color: #374151;">
                                    <span style="color: #9ca3af; font-style: italic;">Add items to see eligible campaigns</span>
                                </div>
                            </div>

                            <!-- Applied Campaign Info (shown when campaign is applied) -->
                            <div id="campaign-applied-info" style="display: none; margin-top: 12px; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 6px; border: 1px solid #22c55e;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-size: 14px; font-weight: 600; color: #166534;">
                                            <span id="applied-campaign-name">-</span>
                                        </div>
                                        <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">
                                            <span id="applied-campaign-desc"></span>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 11px; color: #6b7280;">Discount</div>
                                        <div style="font-size: 18px; font-weight: 700; color: #16a34a;">
                                            <span id="applied-campaign-discount">0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden fields for campaign tracking -->
                            <input type="hidden" id="applied-promo-code" name="applied_promo_code" value="">
                            <input type="hidden" id="applied-campaign-id" name="applied_campaign_id" value="">
                            <input type="hidden" id="exclude-campaign" value="false">
                        </div>

                        </div>

                        <!-- VIP Auto-Apply Section (Added 2025-11-29) -->
                        <div id="vip-discount-section" class="discount-control-card vip-card" style="display: none; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 16px; border-radius: 8px; border: 2px solid #f59e0b; margin-top: 12px;">
                            <!-- Header -->
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center;">
                                    <span class="badge" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">VIP DISCOUNT</span>
                                    <span style="font-size: 12px; color: #92400e; margin-left: 8px;">Special customer discount</span>
                                </div>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="vip-auto-apply-checkbox" onchange="toggleVipAutoApply()"
                                           style="width: 18px; height: 18px; cursor: pointer; accent-color: #f59e0b;">
                                    <span style="margin-left: 8px; font-size: 13px; font-weight: 500; color: #92400e;">Auto-Apply</span>
                                </label>
                            </div>

                            <!-- VIP Status Info -->
                            <div id="vip-status-info" style="padding: 12px; background: white; border-radius: 6px; border: 1px solid #f59e0b;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-size: 14px; font-weight: 600; color: #92400e;">
                                            <span id="vip-campaign-name">VIP Customer Special</span>
                                        </div>
                                        <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                            Code: <span id="vip-campaign-code" style="font-weight: 600;">VIP2025</span>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 11px; color: #6b7280;">Discount</div>
                                        <div style="font-size: 18px; font-weight: 700; color: #d97706;">
                                            <span id="vip-discount-display">20%</span>
                                        </div>
                                    </div>
                                </div>
                                <div id="vip-apply-hint" style="margin-top: 8px; font-size: 12px; color: #6b7280; font-style: italic;">
                                    Check 'Auto-Apply' to automatically apply VIP discount, or enter code manually above.
                                </div>
                            </div>
                            <!-- Invoice-level VIP discount info (shows calculated amount) -->
                            <div id="vip-discount-info" style="display: none; margin-top: 12px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 6px; border: 1px solid #f59e0b;">
                                <!-- Populated by JavaScript -->
                            </div>
                            <!-- Hidden fields for VIP -->
                            <input type="hidden" id="vip-campaign-id" value="">
                            <input type="hidden" id="vip-discount-value" value="">
                            <input type="hidden" id="vip-discount-type" value="">
                            <input type="hidden" id="vip-enabled" value="false">
                        </div>

                        <!-- Staff Discretionary Discount Section (Added 2025-11-29) -->
                        <div id="staff-discretionary-section" class="discount-control-card staff-special-card" style="background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); padding: 16px; border-radius: 8px; border: 2px solid #a78bfa; margin-top: 12px;">
                            <!-- Header -->
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center;">
                                    <span class="badge" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">STAFF SPECIAL</span>
                                    <span style="font-size: 12px; color: #6d28d9; margin-left: 8px;">Discretionary (Incremental)</span>
                                </div>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="staff-discretionary-checkbox" onchange="toggleStaffDiscretionary()"
                                           style="width: 18px; height: 18px; cursor: pointer; accent-color: #8b5cf6;">
                                    <span style="margin-left: 8px; font-size: 13px; font-weight: 500; color: #6d28d9;">Enable</span>
                                </label>
                            </div>

                            <!-- Discretionary Controls -->
                            <div id="staff-discretionary-controls" style="display: none; padding: 12px; background: white; border-radius: 6px; border: 1px solid #a78bfa;">
                                <div style="display: flex; gap: 16px; align-items: center;">
                                    <div style="flex: 1;">
                                        <label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">Discount %</label>
                                        <select id="staff-discretionary-percent" onchange="updateStaffDiscretionary()"
                                                style="width: 100%; padding: 8px 12px; border: 2px solid #a78bfa; border-radius: 6px; font-size: 14px; background: white;">
                                            <option value="1">1%</option>
                                            <option value="2">2%</option>
                                            <option value="3">3%</option>
                                            <option value="4">4%</option>
                                            <option value="5">5%</option>
                                        </select>
                                    </div>
                                    <div style="flex: 2;">
                                        <label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">Note (Optional)</label>
                                        <input type="text" id="staff-discretionary-note" placeholder="Reason for special discount..."
                                               style="width: 100%; padding: 8px 12px; border: 2px solid #a78bfa; border-radius: 6px; font-size: 14px;">
                                    </div>
                                </div>
                                <div style="margin-top: 8px; font-size: 12px; color: #6d28d9; font-style: italic;">
                                    This discount applies on invoice subtotal (after line-item discounts).
                                </div>
                            </div>
                            <!-- Invoice-level discount info (shows calculated amount) -->
                            <div id="staff-discretionary-info" style="display: none; margin-top: 12px; padding: 12px; background: rgba(124, 58, 237, 0.1); border-radius: 6px; border: 1px solid #7c3aed;">
                                <!-- Populated by JavaScript -->
                            </div>
                            <!-- Hidden fields for discretionary -->
                            <input type="hidden" id="staff-discretionary-enabled" value="false">
                            <input type="hidden" id="staff-discretionary-value" value="0">
                        </div>

                        <!-- Priority Information -->
                        <div class="priority-info" style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 6px; font-size: 13px; color: #92400e;">
                            <strong style="font-weight: 500;">Discount Types:</strong>
                            <br>
                            <span style="font-size: 12px;">Line-Item: Campaign > Bulk/Loyalty > Standard (highest wins)</span>
                            <br>
                            <span style="font-size: 12px;">Invoice-Level: VIP + Staff Special (applied on subtotal)</span>
                        </div>

                        <!-- Live Pricing Summary INSIDE Collapsible -->
                        <div class="pricing-summary-compact" style="margin-top: 16px; padding: 16px; background: white; border: 2px solid #667eea; border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
                                üí∞ LIVE PRICING SUMMARY
                            </div>
                            <table style="width: 100%; font-size: 13px;">
                                <tr>
                                    <td style="padding: 6px 0; color: #6b7280;">Original Price:</td>
                                    <td style="padding: 6px 0; text-align: right; font-weight: 500;">
                                        <span id="summary-original-price-collapsible">‚Çπ0.00</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding: 6px 0; color: #dc2626; font-weight: 500;">Total Discount:</td>
                                    <td style="padding: 6px 0; text-align: right; font-weight: 500; color: #dc2626;">
                                        <span id="summary-discount-collapsible">- ‚Çπ0.00</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding: 6px 0; color: #6b7280;">GST:</td>
                                    <td style="padding: 6px 0; text-align: right; font-weight: 500;">
                                        <span id="summary-gst-collapsible">‚Çπ0.00</span>
                                    </td>
                                </tr>
                                <tr style="border-top: 2px solid #e5e7eb;">
                                    <td style="padding: 10px 0 6px 0; font-size: 14px; font-weight: 600; color: #1f2937;">
                                        Patient Pays (Incl. GST):
                                    </td>
                                    <td style="padding: 10px 0 6px 0; text-align: right;">
                                        <div id="summary-final-price-collapsible" style="font-size: 20px; font-weight: 700; color: #667eea;">
                                            ‚Çπ0.00
                                        </div>
                                    </td>
                                </tr>
                            </table>

                            <!-- Savings Badge -->
                            <div id="savings-badge" class="savings-badge" style="display: none; margin-top: 16px; padding: 12px 20px; background: #d1fae5; color: #065f46; border-radius: 8px; text-align: center; font-weight: 600; font-size: 14px;">
                                üí∞ You save ‚Çπ0!
                            </div>

                            <!-- Quick Action Buttons -->
                            <div style="display: flex; gap: 8px; margin-top: 16px; justify-content: center;">
                                <button
                                    type="button"
                                    onclick="recalculateDiscounts()"
                                    class="btn btn-sm"
                                    style="background: #667eea; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; transition: all 0.3s ease; white-space: nowrap;"
                                    onmouseover="this.style.background='#5568d3'"
                                    onmouseout="this.style.background='#667eea'">
                                    <i class="fas fa-calculator"></i> Recalculate
                                </button>

                                <button
                                    type="button"
                                    onclick="openPatientView()"
                                    class="btn btn-sm"
                                    style="background: white; color: #667eea; padding: 8px 16px; border-radius: 6px; border: 2px solid #667eea; cursor: pointer; font-size: 12px; transition: all 0.3s ease; white-space: nowrap;"
                                    onmouseover="this.style.background='#f3f4f6'"
                                    onmouseout="this.style.background='white'">
                                    <i class="fas fa-tv"></i> Patient View
                                </button>

                                <button
                                    type="button"
                                    onclick="resetDiscounts()"
                                    class="btn btn-sm"
                                    style="background: white; color: #ef4444; padding: 8px 16px; border-radius: 6px; border: 2px solid #ef4444; cursor: pointer; font-size: 12px; transition: all 0.3s ease; white-space: nowrap;"
                                    onmouseover="this.style.background='#fef2f2'"
                                    onmouseout="this.style.background='white'">
                                    <i class="fas fa-undo"></i> Reset
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- End Collapsible Content -->
                </div>


            </div>
            <!-- ================================================== -->
            <!-- END MULTI-DISCOUNT OPERATIONAL PANEL -->
            <!-- ================================================== -->

            <!-- Section 2: Line Items -->
            <div class="line-items-section">
                <div class="universal-filter-card-header">
                    <h3 class="universal-filter-card-title">
                        <i class="fas fa-list"></i>
                        Line Items
                    </h3>
                    <div class="flex gap-2">
                        <button type="button"
                                id="add-line-item"
                                class="btn-primary"
                                title="Alt+A"
                                accesskey="a">
                            <i class="fas fa-plus mr-2"></i>
                            <u>A</u>dd Item
                        </button>
                    </div>
                </div>

                <div class="p-0">
                    <table class="universal-table w-full">
                        <thead class="universal-table-header">
                            <tr>
                                <th class="text-center w-12">#</th>
                                <th class="w-20">Type</th>
                                <th class="w-1/5">Item</th>
                                <th class="text-left w-20">Batch</th>
                                <th class="text-left w-20">Expiry</th>
                                <th class="text-right w-14">Qty</th>
                                <th class="text-right w-20">Price</th>
                                <th class="text-right w-40">Disc%</th>
                                <th class="text-center w-14">GST%</th>
                                <th class="text-right w-28">Amount</th>
                                <th class="text-center w-12">Action</th>
                            </tr>
                        </thead>
                        <tbody id="line-items-container" class="universal-table-body">
                            <tr id="no-items-row">
                                <td colspan="11" class="py-4 px-2 text-center text-gray-500 dark:text-gray-400">
                                    <i class="fas fa-shopping-cart text-gray-300 text-3xl mb-2"></i>
                                    <p>No items added. Click "Add Item" to add products or services.</p>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot class="table-footer-totals">
                            <tr>
                                <td colspan="9" class="text-right font-semibold px-4 py-2">Subtotal:</td>
                                <td class="text-right font-semibold px-4 py-2">
                                    <span class="currency-symbol">‚Çπ</span>
                                    <span id="subtotal-display">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                            <!-- VIP Discount Row (Invoice-Level) - Added 2025-11-29 -->
                            <tr id="vip-discount-row" style="display: none; background: linear-gradient(90deg, #fef3c7 0%, #ffffff 100%);">
                                <td colspan="9" class="text-right font-semibold px-4 py-2" style="color: #d97706;">
                                    <span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-right: 8px;">VIP</span>
                                    VIP Discount (<span id="vip-discount-percent-display">0</span>%):
                                </td>
                                <td class="text-right font-semibold px-4 py-2" style="color: #d97706;">
                                    <span>- ‚Çπ</span>
                                    <span id="vip-discount-amount-display">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                            <!-- Staff Special Discount Row (Invoice-Level) - Added 2025-11-29 -->
                            <tr id="staff-special-discount-row" style="display: none; background: linear-gradient(90deg, #ede9fe 0%, #ffffff 100%);">
                                <td colspan="9" class="text-right font-semibold px-4 py-2" style="color: #7c3aed;">
                                    <span style="background: #8b5cf6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-right: 8px;">STAFF</span>
                                    Staff Special (<span id="staff-special-percent-display">0</span>%):
                                </td>
                                <td class="text-right font-semibold px-4 py-2" style="color: #7c3aed;">
                                    <span>- ‚Çπ</span>
                                    <span id="staff-special-amount-display">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="9" class="text-right font-semibold px-4 py-2">Total Discount:</td>
                                <td class="text-right font-semibold px-4 py-2">
                                    <span class="currency-symbol">‚Çπ</span>
                                    <span id="total-discount-display">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                            <tr class="cgst-row">
                                <td colspan="9" class="text-right font-semibold px-4 py-2">CGST:</td>
                                <td class="text-right font-semibold px-4 py-2">
                                    <span class="currency-symbol">‚Çπ</span>
                                    <span id="cgst-display">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                            <tr class="sgst-row">
                                <td colspan="9" class="text-right font-semibold px-4 py-2">SGST:</td>
                                <td class="text-right font-semibold px-4 py-2">
                                    <span class="currency-symbol">‚Çπ</span>
                                    <span id="sgst-display">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                            <tr class="igst-row hidden">
                                <td colspan="9" class="text-right font-semibold px-4 py-2">IGST:</td>
                                <td class="text-right font-semibold px-4 py-2">
                                    <span class="currency-symbol">‚Çπ</span>
                                    <span id="igst-display">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                            <tr class="grand-total-row">
                                <td colspan="9" class="text-right font-bold text-base px-4 py-3">Grand Total:</td>
                                <td class="text-right font-bold text-base text-blue-600 dark:text-blue-400 px-4 py-3">
                                    <span class="currency-symbol text-base">‚Çπ</span>
                                    <span id="grand-total-display" class="text-base">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Amount in Words Display -->
                <div class="amount-in-words hidden" id="amount-in-words">
                    <strong>Amount in Words:</strong> <span id="amount-in-words-text"></span>
                </div>
            </div>

            <!-- Section 3: Additional Information -->
            <div class="universal-filter-card">
                <div class="universal-filter-card-header">
                    <h3 class="universal-filter-card-title">
                        <i class="fas fa-sticky-note"></i>
                        Additional Information
                    </h3>
                </div>

                <div class="universal-filter-card-body">
                    <div class="universal-form-group">
                        <label class="universal-form-label" for="{{ form.notes.id }}">
                            Notes
                        </label>
                        {{ form.notes(
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24",
                            placeholder="Any additional notes or instructions..."
                        ) }}
                        {% if form.notes.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.notes.errors[0] }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Bottom Action Buttons -->
            <div class="bottom-actions">
                <div class="flex gap-2">
                    <a href="{{ url_for('universal_views.universal_list_view', entity_type='patient_invoices') }}"
                       class="btn-danger">
                        <i class="fas fa-times mr-2"></i>
                        Cancel
                    </a>
                    <button type="button"
                            onclick="resetInvoiceForm()"
                            class="btn-outline"
                            title="Ctrl+R">
                        <i class="fas fa-undo mr-2"></i>
                        Reset
                    </button>
                </div>
                <div class="flex gap-2">
                    <button type="submit"
                            form="invoice-form"
                            class="btn-primary"
                            title="Alt+S"
                            accesskey="s"
                            id="submit-invoice-btn">
                        <i class="fas fa-check mr-2"></i>
                        Create Invoice (Alt+<u>S</u>)
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Line Item Template -->
<template id="line-item-template">
    <tr class="line-item-row universal-table-row bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600">
        <td class="text-center px-2 py-2">
            <span class="line-number text-sm font-medium">1</span>
        </td>

        <!-- Item Type Dropdown -->
        <td class="px-2 py-2">
            <select class="item-type form-select text-sm w-full border rounded px-2 py-1" required>
                <option value="">-- Select Type --</option>
                <optgroup label="Services & Packages">
                    <option value="Package">Package</option>
                    <option value="Service">Service</option>
                </optgroup>
                <optgroup label="Medicines & Products">
                    <option value="OTC">OTC Medicine</option>
                    <option value="Prescription">Prescription Medicine</option>
                    <option value="Product">Product</option>
                    <option value="Consumable">Consumable</option>
                </optgroup>
            </select>
            <input type="hidden" class="item-id">
        </td>

        <!-- Item Search with Autocomplete -->
        <td class="px-2 py-2">
            <div class="relative">
                <input type="text"
                       class="item-search form-input text-sm w-full border rounded px-2 py-1"
                       placeholder="Type to search..."
                       autocomplete="off">
                <input type="hidden" class="item-name">
                <div class="item-search-results absolute z-50 bg-white dark:bg-gray-700 shadow-md rounded w-64 max-h-40 overflow-y-auto hidden text-xs">
                </div>
            </div>
        </td>

        <!-- Batch (Medicine-specific) -->
        <td class="px-2 py-2">
            <select class="batch-select form-select text-sm w-full border rounded px-2 py-1 medicine-field hidden">
                <option value="">Select Batch</option>
            </select>
        </td>

        <!-- Expiry Date (Medicine-specific) -->
        <td class="px-2 py-2">
            <input type="date"
                   class="expiry-date form-input text-sm w-full border rounded px-2 py-1 medicine-field hidden"
                   readonly>
        </td>

        <!-- Quantity -->
        <td class="px-2 py-2 w-16">
            <input type="number"
                   class="quantity form-input text-sm w-full text-right border rounded px-2 py-1"
                   value="1"
                   min="0.01"
                   step="0.01"
                   required>
        </td>

        <!-- Unit Price -->
        <td class="px-2 py-2 w-20">
            <input type="number"
                   class="unit-price form-input text-sm w-full text-right border rounded px-2 py-1"
                   value="0.00"
                   min="0"
                   step="0.01"
                   required>
        </td>

        <!-- Discount Percent -->
        <td class="px-2 py-2" style="position: relative;">
            <input type="number"
                   class="discount-percent form-input text-sm w-full text-right border rounded px-2 py-1"
                   value="0"
                   min="0"
                   max="100"
                   step="0.01"
                   {% if not can_edit_discount %}readonly title="Auto-calculated discount (Manager can edit)"{% endif %}
                   style="{% if not can_edit_discount %}background-color: #f3f4f6; cursor: not-allowed;{% endif %}">
            {% if not can_edit_discount %}
            <span style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #9ca3af; font-size: 12px;">
                <i class="fas fa-lock"></i>
            </span>
            {% endif %}
        </td>

        <!-- GST Rate Display -->
        <td class="text-center px-2 py-2">
            <span class="gst-rate-display text-sm">0%</span>
            <input type="hidden" class="gst-rate" value="0">
            <input type="hidden" class="is-gst-exempt" value="false">
            <input type="hidden" class="gst-inclusive" value="false">
        </td>

        <!-- Line Total -->
        <td class="text-right px-4 py-2 w-32">
            <span class="currency-symbol">‚Çπ</span>
            <span class="line-total-display font-medium">0.00</span>
        </td>

        <!-- Remove Button -->
        <td class="text-center px-2 py-2">
            <button type="button"
                    class="remove-line-item text-red-500 hover:text-red-700"
                    title="Remove this item">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    </tr>
</template>

{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Include JavaScript files (WORKING VERSION - RESTORED) -->
<!-- FIFO Allocation Modal Component -->
<script src="{{ url_for('static', filename='js/components/fifo_allocation_modal.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/invoice_item.js') }}?v=20251120_2025"></script><!-- Fixed batch API endpoint + Added line-item-changed events -->
<script src="{{ url_for('static', filename='js/pages/invoice.js') }}?v=20251117_1900"></script><!-- Cache bust - fixed 404 errors, corrected API endpoint -->
<!-- Bulk Discount Real-Time Pricing -->
<script src="{{ url_for('static', filename='js/components/invoice_bulk_discount.js') }}?v=20251121_0100"></script>
<script src="{{ url_for('static', filename='js/components/invoice_patient_view.js') }}?v=20251122_0100"></script><!-- Patient view pop-up launcher -->

<script>
// Global auth token for API calls
window.INVOICE_AUTH_TOKEN = '{{ auth_token }}';

// Permission to manually edit discount fields
// Front desk users: false (readonly, auto-calculated only)
// Managers: true (can manually override)
window.CAN_EDIT_DISCOUNT = {{ 'true' if can_edit_discount else 'false' }};

// =================================================================
// PATIENT AUTOCOMPLETE SEARCH IMPLEMENTATION
// =================================================================
function initializePatientSearch() {
    const searchInput = document.getElementById('patient_search');
    const hiddenInput = document.getElementById('patient_id');
    const dropdown = document.getElementById('patient_dropdown');
    const loadingIcon = document.getElementById('patient_loading');

    let searchTimeout = null;
    let searchCache = new Map();

    // Handle input with debounce
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();

        clearTimeout(searchTimeout);

        if (query.length === 0) {
            // Show initial list when cleared
            searchTimeout = setTimeout(() => {
                performPatientSearch('', 20);  // Initial load: 20 recent patients
            }, 200);
        } else {
            // Search with user query
            searchTimeout = setTimeout(() => {
                performPatientSearch(query, 10);  // Search: 10 results
            }, 300);
        }
    });

    // Show initial list on focus
    searchInput.addEventListener('focus', function() {
        if (searchInput.value.trim().length === 0) {
            performPatientSearch('', 20);  // Show 20 recent patients
        }
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            hideDropdown();
        }
    });

    // Perform search via API
    async function performPatientSearch(query, limit = 10) {
        const cacheKey = `${query.toLowerCase()}_${limit}`;

        // Check cache first
        if (searchCache.has(cacheKey)) {
            displayResults(searchCache.get(cacheKey));
            return;
        }

        showLoading();

        try {
            // API returns direct array of patients: [{id, name, mrn, contact}, ...]
            const response = await fetch(`/invoice/web_api/patient/search?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            if (Array.isArray(data) && data.length > 0) {
                searchCache.set(cacheKey, data);
                displayResults(data);
            } else {
                showNoResults();
            }
        } catch (error) {
            console.error('Patient search error:', error);
            showError();
        } finally {
            hideLoading();
        }
    }

    // Display search results
    function displayResults(results) {
        if (!results || results.length === 0) {
            showNoResults();
            return;
        }

        dropdown.innerHTML = '';

        results.forEach(patient => {
            const item = document.createElement('div');
            item.className = 'px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-100 dark:border-gray-600 last:border-b-0';

            item.innerHTML = `
                <div class="font-medium text-gray-900 dark:text-gray-100">${patient.name}</div>
                ${patient.mrn ? `<div class="text-sm text-gray-500 dark:text-gray-400">MRN: ${patient.mrn}</div>` : ''}
                ${patient.contact ? `<div class="text-sm text-gray-500 dark:text-gray-400">${patient.contact}</div>` : ''}
            `;

            item.addEventListener('click', () => {
                selectPatient(patient);
            });

            dropdown.appendChild(item);
        });

        showDropdown();
    }

    // Select a patient
    function selectPatient(patient) {
        // API returns: {id, name, mrn, contact}
        searchInput.value = `${patient.name} - MRN: ${patient.mrn}`;
        hiddenInput.value = patient.id;  // Set UUID
        hideDropdown();

        // Trigger change event for state calculation
        hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));

        console.log(`‚úÖ Patient selected: ${patient.name} (${patient.id})`);
    }

    // Show/hide functions
    function showLoading() {
        loadingIcon.classList.remove('hidden');
    }

    function hideLoading() {
        loadingIcon.classList.add('hidden');
    }

    function showDropdown() {
        dropdown.classList.remove('hidden');
    }

    function hideDropdown() {
        dropdown.classList.add('hidden');
    }

    function showNoResults() {
        dropdown.innerHTML = '<div class="px-3 py-2 text-center text-gray-500 dark:text-gray-400">No patients found</div>';
        showDropdown();
    }

    function showError() {
        dropdown.innerHTML = '<div class="px-3 py-2 text-center text-red-500">Search failed. Please try again.</div>';
        showDropdown();
    }

    console.log("‚úÖ Patient autocomplete search initialized");
}

document.addEventListener('DOMContentLoaded', function() {
    console.log("‚úÖ Patient Invoice Creation Page Loaded");

    // Initialize Patient Autocomplete Search
    initializePatientSearch();

    // CRITICAL: Initialize InvoiceItemComponent - THIS WAS MISSING!
    const invoiceItemComponent = new InvoiceItemComponent({
        containerId: 'line-items-container',
        templateId: 'line-item-template',
        noItemsRowId: 'no-items-row',
        addButtonId: 'add-line-item'
    });
    console.log("‚úÖ InvoiceItemComponent initialized successfully");

    // Store component globally for toggle function access
    window.invoiceItemComponent = invoiceItemComponent;

    // =================================================================
    // INITIALIZE BULK DISCOUNT MANAGER (Singleton pattern with lock to prevent duplicates)
    // =================================================================
    const hospitalId = '{{ current_user.hospital_id }}';
    const patientId = document.querySelector('[name="patient_id"]')?.value || null;

    if (!window.bulkDiscountManager && !window._bulkDiscountManagerCreating) {
        window._bulkDiscountManagerCreating = true;
        const bulkDiscountManager = new BulkDiscountManager();
        bulkDiscountManager.initialize(hospitalId, patientId);
        window.bulkDiscountManager = bulkDiscountManager;
        console.log('‚úÖ BulkDiscountManager initialized (singleton from HTML)');
    } else if (window.bulkDiscountManager) {
        console.log('‚ö†Ô∏è BulkDiscountManager already exists, skipping creation');
    } else {
        console.log('‚è≥ BulkDiscountManager creation in progress, skipping');
    }

    // Initialize VIP and Staff Discretionary sections (ALWAYS run regardless of who created manager)
    if (window.initStaffDiscretionary) {
        window.initStaffDiscretionary(hospitalId);
    }
    if (patientId && window.checkVipEligibility) {
        window.checkVipEligibility(patientId);
    }
    console.log("‚úÖ VIP and Staff Discretionary sections initialized");

    // =================================================================
    // DISCOUNT CONTROLS COLLAPSE/EXPAND TOGGLE
    // =================================================================
    const discountHeader = document.getElementById('discount-controls-header');
    const discountContent = document.getElementById('discount-controls-content');
    const discountToggleIcon = document.getElementById('discount-toggle-icon');

    if (discountHeader && discountContent && discountToggleIcon) {
        discountHeader.addEventListener('click', function() {
            if (discountContent.style.display === 'none') {
                discountContent.style.display = 'block';
                discountToggleIcon.textContent = '‚ñ≤';
                discountToggleIcon.style.transform = 'rotate(180deg)';
            } else {
                discountContent.style.display = 'none';
                discountToggleIcon.textContent = '‚ñº';
                discountToggleIcon.style.transform = 'rotate(0deg)';
            }
        });
    }

    // =================================================================
    // ELIGIBLE DISCOUNTS TOGGLE BUTTONS
    // =================================================================
    const bulkToggleBtn = document.getElementById('bulk-eligible-toggle');
    if (bulkToggleBtn && bulkDiscountManager) {
        bulkToggleBtn.addEventListener('click', function() {
            bulkDiscountManager.toggleEligibleDiscountsDisplay('bulk');
        });
    }

    const loyaltyToggleBtn = document.getElementById('loyalty-eligible-toggle');
    if (loyaltyToggleBtn && bulkDiscountManager) {
        loyaltyToggleBtn.addEventListener('click', function() {
            bulkDiscountManager.toggleEligibleDiscountsDisplay('loyalty');
        });
    }

    const standardToggleBtn = document.getElementById('standard-eligible-toggle');
    if (standardToggleBtn && bulkDiscountManager) {
        standardToggleBtn.addEventListener('click', function() {
            bulkDiscountManager.toggleEligibleDiscountsDisplay('standard');
        });
    }

    // =================================================================
    // RESTORE PATIENT SELECTION (after validation errors)
    // =================================================================
    {% if preserved_patient_name or form.patient_name.data %}
    (function() {
        const patientSearchInput = document.getElementById('patient_search');
        const patientNameField = document.getElementById('patient_name');
        const patientIdField = document.getElementById('patient_id');

        // Use explicit preserved values first, fall back to form data
        const preservedPatientName = {{ (preserved_patient_name or form.patient_name.data or '')|tojson }};
        const preservedPatientId = {{ (preserved_patient_id or form.patient_id.data or '')|tojson }};

        if (patientSearchInput && preservedPatientName) {
            patientSearchInput.value = preservedPatientName;
            console.log("‚úÖ Restored patient selection:", preservedPatientName);
        }

        if (patientIdField && preservedPatientId) {
            patientIdField.value = preservedPatientId;
            console.log("‚úÖ Restored patient ID:", preservedPatientId);
        }

        if (patientNameField && preservedPatientName) {
            patientNameField.value = preservedPatientName;
        }
    })();
    {% endif %}

    // =================================================================
    // RESTORE PRESERVED LINE ITEMS (after validation errors)
    // =================================================================
    {% if preserved_line_items %}
    console.log("üì¶ Restoring {{ preserved_line_items|length }} preserved line items...");
    const preservedItems = {{ preserved_line_items|tojson }};

    preservedItems.forEach((item, index) => {
        console.log(`Restoring item ${index + 1}:`, item);

        // Add a new row using the component
        const row = invoiceItemComponent.addLineItem();
        if (!row) {
            console.error("Failed to create row for preserved item", item);
            return;
        }

        // Populate the row with preserved data
        try {
            // Set item type
            const itemTypeSelect = row.querySelector('.item-type');
            if (itemTypeSelect && item.item_type) {
                itemTypeSelect.value = item.item_type;
                itemTypeSelect.dispatchEvent(new Event('change'));
            }

            // Set item ID and name (hidden fields)
            const itemIdInput = row.querySelector('.item-id');
            const itemNameInput = row.querySelector('.item-name');
            const itemSearchInput = row.querySelector('.item-search');

            if (itemIdInput && item.item_id) itemIdInput.value = item.item_id;
            if (itemNameInput && item.item_name) itemNameInput.value = item.item_name;
            if (itemSearchInput && item.item_name) itemSearchInput.value = item.item_name;

            // Set batch (if applicable)
            if (item.batch) {
                const batchSelect = row.querySelector('.batch-select');
                if (batchSelect) {
                    // Create option if it doesn't exist
                    const option = document.createElement('option');
                    option.value = item.batch;
                    option.textContent = item.batch;
                    batchSelect.appendChild(option);
                    batchSelect.value = item.batch;
                }
            }

            // Set expiry date (if applicable)
            if (item.expiry_date) {
                const expiryInput = row.querySelector('.expiry-date');
                if (expiryInput) expiryInput.value = item.expiry_date;
            }

            // Set quantity
            const quantityInput = row.querySelector('.quantity');
            if (quantityInput && item.quantity) {
                quantityInput.value = item.quantity;
            }

            // Set unit price
            const unitPriceInput = row.querySelector('.unit-price');
            if (unitPriceInput && item.unit_price) {
                unitPriceInput.value = item.unit_price;
            }

            // Set discount percent
            const discountInput = row.querySelector('.discount-percent');
            if (discountInput && item.discount_percent) {
                discountInput.value = item.discount_percent;
            }

            // Set GST rate (if applicable)
            if (item.gst_rate) {
                const gstRateInput = row.querySelector('.gst-rate');
                const gstRateDisplay = row.querySelector('.gst-rate-display');
                if (gstRateInput) gstRateInput.value = item.gst_rate;
                if (gstRateDisplay) gstRateDisplay.textContent = item.gst_rate + '%';
            }

            // Recalculate totals for this row
            if (window.invoiceItemComponent) {
                window.invoiceItemComponent.calculateLineTotal(row);
            }

            console.log(`‚úì Restored item ${index + 1}: ${item.item_name}`);
        } catch (error) {
            console.error(`Error restoring item ${index + 1}:`, error);
        }
    });

    // Recalculate grand totals
    if (window.invoiceItemComponent) {
        window.invoiceItemComponent.calculateTotals();
    }

    console.log("‚úÖ All preserved line items restored");
    {% endif %}

    // =================================================================
    // 1. KEYBOARD SHORTCUTS
    // =================================================================
    document.addEventListener('keydown', function(e) {
        // Alt+P: Focus patient dropdown
        if (e.altKey && e.key === 'p') {
            e.preventDefault();
            document.getElementById('patient_id')?.focus();
        }

        // Alt+A: Add line item
        if (e.altKey && e.key === 'a') {
            e.preventDefault();
            document.getElementById('add-line-item')?.click();
        }

        // Alt+S: Submit form
        if (e.altKey && e.key === 's') {
            e.preventDefault();
            document.getElementById('submit-invoice-btn')?.click();
        }

        // Ctrl+R: Reset form
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            resetInvoiceForm();
        }
    });

    // =================================================================
    // 3. FORM RESET FUNCTION
    // =================================================================
    window.resetInvoiceForm = function() {
        if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
            document.getElementById('invoice-form')?.reset();

            // Clear patient info
            document.getElementById('selected-patient-info')?.classList.add('hidden');
            document.getElementById('patient_search').value = '';
            document.getElementById('patient_id').value = '';
            document.getElementById('patient_name').value = '';

            // Clear line items
            const container = document.getElementById('line-items-container');
            if (container) {
                container.innerHTML = '<tr id="no-items-row"><td colspan="11" class="py-4 px-2 text-center text-gray-500 dark:text-gray-400"><i class="fas fa-shopping-cart text-gray-300 text-3xl mb-2"></i><p>No items added. Click "Add Item" to add products or services.</p></td></tr>';
            }

            // Reset totals
            updateTotalsDisplay();

            // Focus on patient dropdown
            document.getElementById('patient_id')?.focus();

            console.log("‚úÖ Form reset complete");
        }
    };

    // =================================================================
    // 4. TOTALS UPDATE FUNCTION (Enhanced with Invoice-Level Discounts)
    // Invoice-level discounts (VIP, Staff Special) are applied AFTER line-item totals
    // =================================================================
    function updateTotalsDisplay() {
        // Get invoice-level discounts (VIP and Staff Special)
        const vipAmountEl = document.getElementById('vip-discount-amount-display');
        const staffAmountEl = document.getElementById('staff-special-amount-display');
        const vipDiscountAmount = vipAmountEl ? parseFloat(vipAmountEl.textContent || '0') : 0;
        const staffSpecialAmount = staffAmountEl ? parseFloat(staffAmountEl.textContent || '0') : 0;
        const invoiceLevelDiscount = vipDiscountAmount + staffSpecialAmount;

        // If no invoice-level discounts, nothing to adjust
        if (invoiceLevelDiscount <= 0) {
            return;
        }

        // Read current values from display elements (set by invoice_item.js)
        const discountDisplay = document.getElementById('total-discount-display');
        const grandTotalDisplay = document.getElementById('grand-total-display');

        if (!discountDisplay || !grandTotalDisplay) {
            return;
        }

        // Get current line-item discount and grand total
        const lineItemDiscount = parseFloat(discountDisplay.textContent || '0');
        const baseGrandTotal = parseFloat(grandTotalDisplay.textContent || '0');

        // Calculate new totals with invoice-level discounts
        const totalDiscount = lineItemDiscount + invoiceLevelDiscount;
        const adjustedGrandTotal = baseGrandTotal - invoiceLevelDiscount;

        // Update display elements
        discountDisplay.textContent = totalDiscount.toFixed(2);
        grandTotalDisplay.textContent = adjustedGrandTotal.toFixed(2);

        // Update amount in words
        const amountInWords = document.getElementById('amount-in-words');
        const amountInWordsText = document.getElementById('amount-in-words-text');
        if (adjustedGrandTotal > 0) {
            if (amountInWords) amountInWords.classList.remove('hidden');
            if (amountInWordsText) amountInWordsText.textContent = numberToWords(Math.round(adjustedGrandTotal)) + ' Rupees Only';
        } else {
            if (amountInWords) amountInWords.classList.add('hidden');
        }
    }

    // Make updateTotalsDisplay globally accessible for invoice_bulk_discount.js
    window.updateTotalsDisplay = updateTotalsDisplay;

    // =================================================================
    // 5. NUMBER TO WORDS CONVERSION (for amount display)
    // =================================================================
    function numberToWords(num) {
        // Simple implementation - can be enhanced
        const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
        const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
        const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];

        if (num === 0) return 'Zero';
        if (num < 10) return ones[num];
        if (num < 20) return teens[num - 10];
        if (num < 100) return tens[Math.floor(num / 10)] + ' ' + ones[num % 10];
        if (num < 1000) return ones[Math.floor(num / 100)] + ' Hundred ' + numberToWords(num % 100);
        if (num < 100000) return numberToWords(Math.floor(num / 1000)) + ' Thousand ' + numberToWords(num % 1000);
        if (num < 10000000) return numberToWords(Math.floor(num / 100000)) + ' Lakh ' + numberToWords(num % 100000);

        return 'Amount Too Large';
    }

    // =================================================================
    // 6. FORM SUBMISSION HANDLER
    // =================================================================
    // NOTE: Form submission is handled by invoice.js - do NOT add duplicate handlers here
    // Duplicate handlers cause validation to run multiple times and interfere with submission

    // =================================================================
    // 7. SET DEFAULT VALUES (Smart Defaults)
    // =================================================================
    // Set today's date as default
    const invoiceDateField = document.getElementById('{{ form.invoice_date.id }}');
    if (invoiceDateField && !invoiceDateField.value) {
        const today = new Date().toISOString().split('T')[0];
        invoiceDateField.value = today;
    }

    // Check GST invoice by default
    const gstInvoiceCheckbox = document.getElementById('is_gst_invoice');
    if (gstInvoiceCheckbox && !gstInvoiceCheckbox.checked) {
        gstInvoiceCheckbox.checked = true;
    }

    // Set default invoice type to "Service" (most common)
    const invoiceTypeField = document.getElementById('{{ form.invoice_type.id }}');
    if (invoiceTypeField && !invoiceTypeField.value) {
        invoiceTypeField.value = 'Service';
    }

    // =================================================================
    // 8. PATIENT SELECTION - AUTO-POPULATE STATE & CALCULATE INTERSTATE
    // =================================================================
    // Note: patient_id is now a hidden field populated by Universal Entity Search
    const patientIdField = document.getElementById('patient_id');
    const placeOfSupplyDropdown = document.getElementById('{{ form.place_of_supply.id }}');
    const isInterstateField = document.getElementById('is_interstate');

    // Get hospital state code from template
    const hospitalStateCode = '{{ g.hospital.state_code if g.hospital else "" }}';

    if (patientIdField) {
        patientIdField.addEventListener('change', async function() {
            const patientId = this.value;

            if (!patientId) {
                // Reset state if no patient selected
                if (placeOfSupplyDropdown) placeOfSupplyDropdown.value = hospitalStateCode || '';
                if (isInterstateField) isInterstateField.value = 'false';
                return;
            }

            try {
                console.log(`üîµ Fetching state for patient: ${patientId}`);

                const response = await fetch(`/invoice/web_api/patient/${patientId}/state`);
                const data = await response.json();

                if (data.success) {
                    console.log('‚úÖ Patient state data received:', data);

                    // Set place of supply to patient's state (or hospital state as fallback)
                    const stateToUse = data.patient_state_code || data.hospital_state_code || hospitalStateCode;
                    if (placeOfSupplyDropdown) {
                        placeOfSupplyDropdown.value = stateToUse;
                    }

                    // Set interstate flag
                    if (isInterstateField) {
                        isInterstateField.value = data.is_interstate ? 'true' : 'false';
                    }

                    // Recalculate all line items with new interstate flag
                    recalculateAllLineItems();

                    // Reload patient loyalty card info for discount calculations
                    if (window.bulkDiscountManager) {
                        await window.bulkDiscountManager.loadPatientLoyalty(patientId);
                        // Recalculate discounts with new patient loyalty info
                        window.bulkDiscountManager.updatePricing();
                    }

                    // Check VIP eligibility for this patient (Added 2025-11-29)
                    if (window.checkVipEligibility) {
                        await window.checkVipEligibility(patientId);
                    }

                    console.log(`State set to: ${stateToUse}, Interstate: ${data.is_interstate}`);
                } else {
                    console.error('‚ùå Failed to get patient state:', data.message);
                }
            } catch (error) {
                console.error('‚ùå Error fetching patient state:', error);
            }
        });
    }

    // Handle manual place of supply changes
    if (placeOfSupplyDropdown) {
        placeOfSupplyDropdown.addEventListener('change', function() {
            const deliveryState = this.value;

            // Calculate interstate based on delivery state vs hospital state
            const isInterstate = (hospitalStateCode !== deliveryState) && deliveryState !== '';

            if (isInterstateField) {
                isInterstateField.value = isInterstate ? 'true' : 'false';
            }

            // Recalculate all line items with new interstate flag
            recalculateAllLineItems();

            console.log(`üîÑ Place of supply changed: ${deliveryState}, Interstate: ${isInterstate}`);
        });
    }

    // Function to recalculate all line items
    function recalculateAllLineItems() {
        const rows = document.querySelectorAll('.line-item-row');
        rows.forEach(row => {
            if (window.invoiceItemComponent) {
                window.invoiceItemComponent.calculateLineTotal(row);
            }
        });
        if (window.invoiceItemComponent) {
            window.invoiceItemComponent.calculateTotals();
        }
        updateTotalsDisplay();
    }

    // =================================================================
    // DISCOUNT CONTROL BUTTON FUNCTIONS
    // =================================================================

    // Recalculate discounts - trigger discount API call
    function recalculateDiscounts() {
        if (window.bulkDiscountManager) {
            console.log('üîÑ Recalculating discounts...');
            window.bulkDiscountManager.updatePricing();
        } else {
            console.error('BulkDiscountManager not initialized');
        }
    }

    // Reset all discounts to default
    function resetDiscounts() {
        if (window.bulkDiscountManager) {
            console.log('üîÑ Resetting discounts...');

            // Clear all discounts
            window.bulkDiscountManager.clearDiscounts();

            // Reset checkboxes to default state
            const standardCheckbox = document.getElementById('apply-standard-discount');
            const bulkCheckbox = document.getElementById('bulk-discount-enabled');
            const loyaltyCheckbox = document.getElementById('apply-loyalty-discount');

            if (standardCheckbox) standardCheckbox.checked = true;
            if (bulkCheckbox) bulkCheckbox.checked = false;
            if (loyaltyCheckbox && window.bulkDiscountManager.currentPatientLoyalty) {
                loyaltyCheckbox.checked = true;
            }

            // Clear promo code as well
            clearPromoCode();

            // Recalculate with default settings
            window.bulkDiscountManager.updatePricing();

            console.log('‚úÖ Discounts reset to default');
        } else {
            console.error('BulkDiscountManager not initialized');
        }
    }

    // =================================================================
    // CAMPAIGN DISCOUNT FUNCTIONS (Redesigned 2025-11-29)
    // Per-campaign checkbox support added 2025-11-29
    // =================================================================

    // Store eligible campaigns globally
    window.eligibleCampaigns = [];
    window.appliedCampaign = null;
    window.excludedCampaignIds = [];  // Array of campaign IDs to exclude

    // Toggle all campaigns (master checkbox)
    function toggleCampaignDiscount() {
        const checkbox = document.getElementById('campaign-apply-checkbox');

        if (checkbox.checked) {
            // Enable all campaigns
            window.excludedCampaignIds = [];
        } else {
            // Disable all campaigns
            window.excludedCampaignIds = window.eligibleCampaigns.map(c => c.campaign_id);
        }

        // Update individual checkboxes
        window.eligibleCampaigns.forEach(c => {
            const individualCheckbox = document.getElementById(`campaign-checkbox-${c.campaign_id}`);
            if (individualCheckbox) {
                individualCheckbox.checked = checkbox.checked;
            }
        });

        // Trigger discount recalculation
        if (window.bulkDiscountManager) {
            window.bulkDiscountManager.setExcludedCampaignIds(window.excludedCampaignIds);
            window.bulkDiscountManager.updatePricing();
        }

        console.log('All campaigns:', checkbox.checked ? 'enabled' : 'disabled');
    }

    // Toggle individual campaign
    function toggleIndividualCampaign(campaignId) {
        const checkbox = document.getElementById(`campaign-checkbox-${campaignId}`);

        if (checkbox.checked) {
            // Remove from excluded list
            window.excludedCampaignIds = window.excludedCampaignIds.filter(id => id !== campaignId);
        } else {
            // Add to excluded list
            if (!window.excludedCampaignIds.includes(campaignId)) {
                window.excludedCampaignIds.push(campaignId);
            }
        }

        // Update master checkbox state
        const masterCheckbox = document.getElementById('campaign-apply-checkbox');
        if (masterCheckbox) {
            const allEnabled = window.excludedCampaignIds.length === 0;
            const allDisabled = window.excludedCampaignIds.length === window.eligibleCampaigns.length;
            masterCheckbox.checked = !allDisabled;
            masterCheckbox.indeterminate = !allEnabled && !allDisabled;
        }

        // Trigger discount recalculation
        if (window.bulkDiscountManager) {
            window.bulkDiscountManager.setExcludedCampaignIds(window.excludedCampaignIds);
            window.bulkDiscountManager.updatePricing();
        }

        console.log('Campaign', campaignId, checkbox.checked ? 'enabled' : 'disabled');
    }

    // Update eligible campaigns display (called from discount response)
    function updateEligibleCampaigns(campaigns) {
        window.eligibleCampaigns = campaigns || [];
        const listContent = document.getElementById('campaign-list-content');
        const appliedInfo = document.getElementById('campaign-applied-info');

        if (!campaigns || campaigns.length === 0) {
            listContent.innerHTML = '<span style="color: #9ca3af; font-style: italic;">No campaigns available for current items</span>';
            appliedInfo.style.display = 'none';
            window.appliedCampaign = null;
            return;
        }

        // Build campaigns list HTML with per-campaign checkboxes
        let html = '';
        campaigns.forEach((c, idx) => {
            const discountDisplay = c.discount_type === 'percentage' ? `${c.discount_value}%` : `Rs.${c.discount_value}`;
            const isExcluded = window.excludedCampaignIds.includes(c.campaign_id);
            const isChecked = !isExcluded;
            const statusBadge = c.applied && isChecked
                ? '<span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">APPLIED</span>'
                : isChecked
                    ? '<span style="background: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 4px; font-size: 10px;">ELIGIBLE</span>'
                    : '<span style="background: #fee2e2; color: #991b1b; padding: 2px 6px; border-radius: 4px; font-size: 10px;">BYPASSED</span>';

            // Format valid till date
            const validTillText = c.end_date ? `Valid till: ${c.end_date}` : '';

            html += `
                <div style="display: flex; align-items: flex-start; padding: 10px 0; ${idx > 0 ? 'border-top: 1px solid #e5e7eb;' : ''}">
                    <div style="margin-right: 10px; padding-top: 2px;">
                        <input type="checkbox" id="campaign-checkbox-${c.campaign_id}"
                               ${isChecked ? 'checked' : ''}
                               onchange="toggleIndividualCampaign('${c.campaign_id}')"
                               style="width: 16px; height: 16px; cursor: pointer; accent-color: #22c55e;">
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 4px;">
                            <span style="font-weight: 600; color: ${isChecked ? '#166534' : '#9ca3af'};">${c.campaign_name}</span>
                            ${statusBadge}
                        </div>
                        <div style="font-size: 12px; color: #374151; margin-top: 4px;">
                            <span style="background: ${isChecked ? '#f0fdf4' : '#f3f4f6'}; padding: 2px 6px; border-radius: 3px; font-weight: 500;">${c.campaign_code || ''}</span>
                        </div>
                        ${validTillText ? `<div style="font-size: 11px; color: #6b7280; margin-top: 4px;"><i class="bi bi-calendar-event"></i> ${validTillText}</div>` : ''}
                    </div>
                    <div style="text-align: right; min-width: 60px;">
                        <div style="font-size: 18px; font-weight: 700; color: ${isChecked ? '#16a34a' : '#9ca3af'};">${discountDisplay}</div>
                        <div style="font-size: 10px; color: #6b7280;">OFF</div>
                    </div>
                </div>
            `;

            // Track applied campaign
            if (c.applied) {
                window.appliedCampaign = c;
            }
        });

        listContent.innerHTML = html;

        // Update applied campaign info
        if (window.appliedCampaign && !window.excludeCampaign) {
            document.getElementById('applied-campaign-name').textContent = window.appliedCampaign.campaign_name;
            document.getElementById('applied-campaign-desc').textContent = window.appliedCampaign.campaign_code || '';
            const discDisplay = window.appliedCampaign.discount_type === 'percentage'
                ? `${window.appliedCampaign.discount_value}%`
                : `Rs.${window.appliedCampaign.discount_value}`;
            document.getElementById('applied-campaign-discount').textContent = discDisplay;
            appliedInfo.style.display = 'block';

            // Store in hidden fields
            document.getElementById('applied-promo-code').value = window.appliedCampaign.campaign_code || '';
            document.getElementById('applied-campaign-id').value = window.appliedCampaign.campaign_id || '';
        } else {
            appliedInfo.style.display = 'none';
        }
    }

    // Make functions globally accessible
    window.toggleCampaignDiscount = toggleCampaignDiscount;
    window.toggleIndividualCampaign = toggleIndividualCampaign;
    window.updateEligibleCampaigns = updateEligibleCampaigns;

    // Legacy function stubs for backward compatibility
    function applyPromoCode() {
        console.log('applyPromoCode is deprecated - campaigns are now auto-applied');
    }
    function clearPromoCode() {
        console.log('clearPromoCode is deprecated - use campaign checkbox instead');
    }
    function showPromoResult(success, message) {
        console.log('showPromoResult:', success, message);
    }
    function showPromotionDetails(promotion) {
        console.log('showPromotionDetails:', promotion);

        // Format discount display
        let discountText = '';
        if (promotion.discount_type === 'percentage') {
            discountText = `${promotion.discount_value}%`;
        } else {
            discountText = `‚Çπ${promotion.discount_value.toFixed(2)}`;
        }
        document.getElementById('promotion-discount-display').textContent = discountText;

        promoInfoDiv.style.display = 'block';
    }

    // Allow Enter key to apply promo code
    document.addEventListener('DOMContentLoaded', function() {
        const promoInput = document.getElementById('promo-code-input');
        if (promoInput) {
            promoInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    applyPromoCode();
                }
            });
        }
    });

    // Make functions globally accessible
    window.applyPromoCode = applyPromoCode;
    window.clearPromoCode = clearPromoCode;

    // =================================================================
    // VIP DISCOUNT FUNCTIONS (Added 2025-11-29)
    // =================================================================

    // Store VIP discount config globally
    window.vipDiscountConfig = null;
    window.patientIsVip = false;

    // Check if patient is VIP and show/hide VIP section
    async function checkVipEligibility(patientId) {
        if (!patientId) {
            hideVipSection();
            return;
        }

        try {
            const response = await fetch(`/invoice/web_api/vip-eligibility/${patientId}`);
            const data = await response.json();

            if (data.is_vip && data.vip_campaign) {
                window.patientIsVip = true;
                window.vipDiscountConfig = data.vip_campaign;
                showVipSection(data.vip_campaign);

                // If auto_apply_default is true, check the checkbox
                if (data.auto_apply_default) {
                    document.getElementById('vip-auto-apply-checkbox').checked = true;
                    toggleVipAutoApply();
                }
            } else {
                window.patientIsVip = false;
                window.vipDiscountConfig = null;
                hideVipSection();
            }
        } catch (error) {
            console.error('Error checking VIP eligibility:', error);
            hideVipSection();
        }
    }

    // Show VIP discount section
    function showVipSection(campaign) {
        const section = document.getElementById('vip-discount-section');
        section.style.display = 'block';

        // Populate VIP details
        document.getElementById('vip-campaign-name').textContent = campaign.campaign_name;
        document.getElementById('vip-campaign-code').textContent = campaign.campaign_code;
        document.getElementById('vip-campaign-id').value = campaign.campaign_id;
        document.getElementById('vip-discount-value').value = campaign.discount_value;
        document.getElementById('vip-discount-type').value = campaign.discount_type;

        // Format discount display
        if (campaign.discount_type === 'percentage') {
            document.getElementById('vip-discount-display').textContent = `${campaign.discount_value}%`;
        } else {
            document.getElementById('vip-discount-display').textContent = `Rs.${campaign.discount_value}`;
        }
    }

    // Hide VIP discount section
    function hideVipSection() {
        const section = document.getElementById('vip-discount-section');
        section.style.display = 'none';
        document.getElementById('vip-auto-apply-checkbox').checked = false;
    }

    // Toggle VIP auto-apply (Updated 2025-11-29: Now invoice-level discount)
    function toggleVipAutoApply() {
        console.log('='.repeat(60));
        console.log('üîî toggleVipAutoApply [v2] called');

        const checkbox = document.getElementById('vip-auto-apply-checkbox');
        const hintDiv = document.getElementById('vip-apply-hint');
        const vipEnabledField = document.getElementById('vip-enabled');
        const vipDiscountRow = document.getElementById('vip-discount-row');

        console.log('   checkbox.checked:', checkbox ? checkbox.checked : 'not found');
        console.log('   vipConfig:', window.vipDiscountConfig);
        console.log('   bulkDiscountManager:', window.bulkDiscountManager ? 'exists' : 'NOT FOUND');

        if (checkbox.checked && window.vipDiscountConfig) {
            // Enable VIP as invoice-level discount
            vipEnabledField.value = 'true';

            // Immediately show VIP row with expected percent (amount will be calculated by API)
            if (vipDiscountRow) {
                vipDiscountRow.style.display = 'table-row';
                document.getElementById('vip-discount-percent-display').textContent = window.vipDiscountConfig.discount_value || 0;
                document.getElementById('vip-discount-amount-display').textContent = 'Calculating...';
                console.log('üìç VIP row shown immediately, percent:', window.vipDiscountConfig.discount_value);
            }

            // Update BulkDiscountManager with VIP discount
            if (window.bulkDiscountManager) {
                window.bulkDiscountManager.setVipDiscount(
                    true,
                    parseFloat(window.vipDiscountConfig.discount_value),
                    window.vipDiscountConfig.discount_type,
                    window.vipDiscountConfig.campaign_id
                );
                // Force recalculation using dedicated method that bypasses all guards
                window.bulkDiscountManager.forceRecalculateInvoiceDiscounts();
            }

            hintDiv.textContent = 'VIP discount will be applied on invoice total.';
            hintDiv.style.color = '#16a34a';
        } else {
            // Disable VIP discount
            vipEnabledField.value = 'false';

            // Hide VIP row immediately
            if (vipDiscountRow) {
                vipDiscountRow.style.display = 'none';
                console.log('üìç VIP row hidden');
            }

            if (window.bulkDiscountManager) {
                window.bulkDiscountManager.setVipDiscount(false, 0, 'percentage', null);
                // Force recalculation using dedicated method
                window.bulkDiscountManager.forceRecalculateInvoiceDiscounts();
            }

            hintDiv.textContent = "Check 'Auto-Apply' to apply VIP discount on invoice total.";
            hintDiv.style.color = '#6b7280';

            // Hide VIP info
            const vipInfoDiv = document.getElementById('vip-discount-info');
            if (vipInfoDiv) vipInfoDiv.style.display = 'none';
        }
    }

    // Make VIP functions globally accessible
    window.checkVipEligibility = checkVipEligibility;
    window.toggleVipAutoApply = toggleVipAutoApply;

    // =================================================================
    // STAFF DISCRETIONARY DISCOUNT FUNCTIONS (Added 2025-11-29)
    // =================================================================

    // Store discretionary config globally
    window.staffDiscretionaryConfig = null;

    // Initialize staff discretionary section from hospital settings
    async function initStaffDiscretionary(hospitalId) {
        try {
            const response = await fetch(`/invoice/web_api/staff-discretionary-config/${hospitalId}`);
            const data = await response.json();

            if (data.enabled) {
                window.staffDiscretionaryConfig = data;
                document.getElementById('staff-discretionary-section').style.display = 'block';

                // Populate dropdown options
                const select = document.getElementById('staff-discretionary-percent');
                select.innerHTML = '';
                (data.options || [1, 2, 3, 4, 5]).forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = `${opt}%`;
                    select.appendChild(option);
                });

                // Set default
                select.value = data.default_percent || 1;
            } else {
                document.getElementById('staff-discretionary-section').style.display = 'none';
            }
        } catch (error) {
            console.error('Error loading staff discretionary config:', error);
            // Default config if API fails
            window.staffDiscretionaryConfig = { enabled: true, max_percent: 5, default_percent: 1, options: [1,2,3,4,5] };
        }
    }

    // Toggle staff discretionary discount
    function toggleStaffDiscretionary() {
        console.log('='.repeat(60));
        console.log('üîî toggleStaffDiscretionary [v2] called');

        const checkbox = document.getElementById('staff-discretionary-checkbox');
        const controls = document.getElementById('staff-discretionary-controls');
        const enabledField = document.getElementById('staff-discretionary-enabled');
        const valueField = document.getElementById('staff-discretionary-value');
        const staffSpecialRow = document.getElementById('staff-special-discount-row');
        const staffInfoEl = document.getElementById('staff-discretionary-info');

        console.log('   checkbox.checked:', checkbox ? checkbox.checked : 'not found');
        console.log('   bulkDiscountManager:', window.bulkDiscountManager ? 'exists' : 'NOT FOUND');

        if (checkbox.checked) {
            controls.style.display = 'block';
            enabledField.value = 'true';
            const selectedPercent = document.getElementById('staff-discretionary-percent').value;
            valueField.value = selectedPercent;

            // Immediately show Staff Special row with expected percent
            if (staffSpecialRow) {
                staffSpecialRow.style.display = 'table-row';
                document.getElementById('staff-special-percent-display').textContent = selectedPercent || 0;
                document.getElementById('staff-special-amount-display').textContent = 'Calculating...';
                console.log('üìç Staff Special row shown immediately, percent:', selectedPercent);
            }

            // Trigger discount recalculation
            if (window.bulkDiscountManager) {
                window.bulkDiscountManager.setStaffDiscretionary(
                    true,
                    parseFloat(selectedPercent),
                    document.getElementById('staff-discretionary-note').value
                );
                // Force recalculation using dedicated method that bypasses all guards
                window.bulkDiscountManager.forceRecalculateInvoiceDiscounts();
            }
        } else {
            controls.style.display = 'none';
            enabledField.value = 'false';
            valueField.value = '0';

            // Hide Staff Special row and info immediately
            if (staffSpecialRow) {
                staffSpecialRow.style.display = 'none';
                console.log('üìç Staff Special row hidden');
            }
            if (staffInfoEl) {
                staffInfoEl.style.display = 'none';
            }

            // Trigger discount recalculation with staff disabled
            if (window.bulkDiscountManager) {
                window.bulkDiscountManager.setStaffDiscretionary(false, 0, '');
                // Force recalculation using dedicated method
                window.bulkDiscountManager.forceRecalculateInvoiceDiscounts();
            }
        }
    }

    // Update staff discretionary when percentage changes
    function updateStaffDiscretionary() {
        const valueField = document.getElementById('staff-discretionary-value');
        const selectedPercent = document.getElementById('staff-discretionary-percent').value;
        valueField.value = selectedPercent;

        // Update Staff Special row percent display immediately
        const staffPercentDisplay = document.getElementById('staff-special-percent-display');
        if (staffPercentDisplay) {
            staffPercentDisplay.textContent = selectedPercent || 0;
            document.getElementById('staff-special-amount-display').textContent = 'Calculating...';
            console.log('üìç Staff Special percent updated:', selectedPercent);
        }

        // Trigger discount recalculation
        if (window.bulkDiscountManager) {
            window.bulkDiscountManager.setStaffDiscretionary(
                true,
                parseFloat(selectedPercent),
                document.getElementById('staff-discretionary-note').value
            );
            // Force recalculation using dedicated method
            window.bulkDiscountManager.forceRecalculateInvoiceDiscounts();
        }
    }

    // Make staff discretionary functions globally accessible
    window.toggleStaffDiscretionary = toggleStaffDiscretionary;
    window.updateStaffDiscretionary = updateStaffDiscretionary;
    window.initStaffDiscretionary = initStaffDiscretionary;

    // Patient view function is defined in invoice_patient_view.js
    // DO NOT define openPatientView() here - it will override the proper implementation!

    // =================================================================
    // 9. INTEGRATE WITH EXISTING INVOICE.JS FUNCTIONS
    // =================================================================
    // NOTE: updateTotalsDisplay() is called from updatePricingSummary() in invoice_bulk_discount.js
    // after the discount API returns invoice-level discounts (VIP, Staff Special).
    // We don't hook into calculateTotals here to avoid interfering with core calculations.

    console.log("‚úÖ All enhancements loaded successfully");
});
</script>

<!-- PRESERVE EXISTING BATCH VALIDATION SCRIPT -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("‚úÖ Batch validation initialized");

    // Function to get batch inventory directly from server
    function getBatchInventory(medicineId, batch, callback) {
        // This function is deprecated - batch data is now stored in select option data attributes
        // Keeping for backward compatibility
        if (!medicineId || !batch) {
            callback(0);
            return;
        }
        callback(0);
    }

    // Function to validate batch quantity
    function validateBatchQuantity(row) {
        const batchSelect = row.querySelector('.batch-select');
        const quantityInput = row.querySelector('.quantity');
        const itemIdInput = row.querySelector('.item-id');

        if (!batchSelect || !quantityInput || !itemIdInput) return;
        if (batchSelect.selectedIndex <= 0) return;

        const selectedBatch = batchSelect.value;
        const requestedQty = parseFloat(quantityInput.value || 1);

        // Get available quantity from the selected option's data attribute
        const selectedOption = batchSelect.options[batchSelect.selectedIndex];
        const availableQty = parseFloat(selectedOption.getAttribute('data-available') || 0);

        console.log(`Validating batch ${selectedBatch}: requested=${requestedQty}, available=${availableQty}`);

        if (availableQty <= 0) {
            alert("‚ö†Ô∏è Warning: This batch has no available stock. Please select a different batch.");
            return;
        }

        if (requestedQty > availableQty) {
            quantityInput.value = availableQty;
            alert(`‚ö†Ô∏è Quantity adjusted to maximum available stock: ${availableQty}`);

            if (window.invoiceComponentFunctions && typeof window.invoiceComponentFunctions.calculateLineTotal === 'function') {
                window.invoiceComponentFunctions.calculateLineTotal(row);
                window.invoiceComponentFunctions.calculateTotals();
            }
        }
    }

    // Event listeners for batch selection and quantity changes
    document.addEventListener('change', function(event) {
        if (event.target.classList.contains('batch-select')) {
            const row = event.target.closest('.line-item-row');
            if (row) {
                setTimeout(function() {
                    validateBatchQuantity(row);
                }, 300);
            }
        }

        if (event.target.classList.contains('quantity')) {
            const row = event.target.closest('.line-item-row');
            if (row) {
                const itemType = row.querySelector('.item-type')?.value;
                if (itemType === 'Medicine' || itemType === 'Prescription') {
                    setTimeout(function() {
                        validateBatchQuantity(row);
                    }, 300);
                }
            }
        }
    });

    // ========================================================================
    // BATCH MODE TOGGLE HANDLER
    // ========================================================================
    window.toggleBatchMode = async function() {
        const toggle = document.getElementById('batch-mode-toggle');
        const label = document.getElementById('batch-mode-label');
        const currentMode = toggle.dataset.mode;
        const newMode = currentMode === 'manual' ? 'auto' : 'manual';

        try {
            // Update via API
            const response = await fetch('/api/auth/user/preferences/batch-mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer {{ auth_token }}`
                },
                body: JSON.stringify({ batch_mode: newMode })
            });

            const data = await response.json();

            if (data.success) {
                // Update UI
                toggle.dataset.mode = newMode;
                label.textContent = newMode === 'manual' ? 'Manual' : 'Auto';

                // Update toggle appearance
                const toggleSpan = toggle.querySelector('span:last-child');
                if (newMode === 'auto') {
                    toggle.style.backgroundColor = 'rgb(59, 130, 246)';
                    toggleSpan.style.transform = 'translateX(24px)';
                } else {
                    toggle.style.backgroundColor = 'rgb(156, 163, 175)';
                    toggleSpan.style.transform = 'translateX(4px)';
                }

                // Update invoice component batch mode if it exists
                if (window.invoiceItemComponent) {
                    window.invoiceItemComponent.batchMode = newMode;
                }

                // Show success message
                showToast(`Batch mode changed to ${newMode}`, 'success');
            } else {
                showToast('Failed to update batch mode preference', 'error');
            }
        } catch (error) {
            console.error('Error updating batch mode:', error);
            showToast('Error updating batch mode preference', 'error');
        }
    };

    // Simple toast notification function
    window.showToast = function(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
        } text-white`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    };

    // =================================================================
    // FORM VALIDATION - Validate patient selection before submission
    // =================================================================
    const invoiceForm = document.getElementById('invoice-form');
    if (invoiceForm) {
        invoiceForm.addEventListener('submit', function(event) {
            const patientIdField = document.getElementById('patient_id');
            const patientSearchInput = document.getElementById('patient_search');  // Fixed: correct ID

            // Debug logging
            console.log('Form submit - Patient ID field:', patientIdField);
            console.log('Form submit - Patient ID value:', patientIdField ? patientIdField.value : 'field not found');
            console.log('Form submit - Patient search value:', patientSearchInput ? patientSearchInput.value : 'field not found');

            // Check if patient is selected
            if (!patientIdField || !patientIdField.value || patientIdField.value === '') {
                event.preventDefault();
                event.stopPropagation();

                // Focus on patient search input
                if (patientSearchInput) {
                    patientSearchInput.focus();
                    patientSearchInput.classList.add('border-red-500');
                    setTimeout(() => {
                        patientSearchInput.classList.remove('border-red-500');
                    }, 3000);
                }

                // Show error message
                showToast('Please select a patient before submitting', 'error');
                console.error('Validation failed: patient_id is empty');
                return false;
            }

            console.log('Validation passed - patient_id:', patientIdField.value);
            return true;
        });
    }
});
</script>
{% endblock %}
