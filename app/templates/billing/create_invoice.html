{% extends "layouts/dashboard.html" %}

{% block title %}Create Patient Invoice{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* ===================================================================
       INVOICE ENHANCED STYLING - GOLD STANDARD
       Based on supplier invoice template with billing counter optimizations
       =================================================================== */

    /* Invoice Container */
    .invoice-enhanced-container {
        background: #f3f4f6;
        min-height: 100vh;
        padding: 0;
        margin: -1.5rem;
    }

    .dark .invoice-enhanced-container {
        background: #0f172a;
    }

    /* Header styling */
    .invoice-header {
        background: white;
        padding: 1.5rem;
        margin-bottom: 0;
    }

    .dark .invoice-header {
        background: rgb(31 41 55);
    }

    /* Badge styling */
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .badge-info {
        background-color: rgb(219 234 254);
        color: rgb(30 64 175);
        border: 1px solid rgb(147 197 253);
    }

    .dark .badge-info {
        background-color: rgba(59, 130, 246, 0.2);
        color: rgb(147 197 253);
        border-color: rgb(59 130 246);
    }

    /* Quick actions bar */
    .quick-actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem 1.5rem;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 1rem;
    }

    .dark .quick-actions-bar {
        background: rgb(31 41 55);
        border-bottom-color: rgb(55 65 81);
    }

    .quick-actions-left {
        display: flex;
        gap: 0.5rem;
    }

    /* Line Items Section */
    .line-items-section {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 0;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .dark .line-items-section {
        background: rgb(31 41 55);
    }

    /* Bottom action buttons */
    .bottom-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        gap: 0.75rem;
    }

    .dark .bottom-actions {
        background: rgb(31 41 55);
    }

    /* Two-column grid for form fields */
    .invoice-two-column-grid {
        display: grid !important;
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        gap: 1rem !important;
        width: 100% !important;
    }

    @media (max-width: 768px) {
        .invoice-two-column-grid {
            grid-template-columns: 1fr !important;
        }
    }

    /* Form styles */
    .universal-form-group {
        margin-bottom: 1rem !important;
    }

    .universal-form-label {
        display: block !important;
        margin-bottom: 0.25rem !important;
        font-size: 0.875rem !important;
        font-weight: 500 !important;
        color: rgb(55 65 81) !important;
    }

    .dark .universal-form-label {
        color: rgb(209 213 219) !important;
    }

    /* Patient info display */
    .patient-info {
        background: #f0f9ff;
        border: 2px solid #3b82f6;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-top: 0.5rem;
    }

    .dark .patient-info {
        background: rgba(59, 130, 246, 0.1);
        border-color: rgb(59 130 246);
    }

    .patient-info.selected {
        animation: pulse-success 0.5s ease-in-out;
    }

    @keyframes pulse-success {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.02); }
    }

    /* Table footer totals */
    .table-footer-totals {
        background: #f9fafb;
        border-top: 2px solid #e5e7eb;
    }

    .dark .table-footer-totals {
        background: rgb(55 65 81);
        border-top-color: rgb(75 85 99);
    }

    .grand-total-row {
        background: linear-gradient(135deg, rgb(239 246 255) 0%, rgb(219 234 254) 100%);
        font-size: 1.125rem;
    }

    .dark .grand-total-row {
        background: linear-gradient(135deg, rgba(30, 58, 138, 0.3) 0%, rgba(59, 130, 246, 0.2) 100%);
    }

    /* Medicine-specific fields */
    .medicine-field {
        display: none;
    }

    .medicine-field.visible {
        display: block;
    }

    .non-medicine-placeholder {
        display: inline-block;
        color: #9ca3af;
    }

    /* Batch expiry warning */
    .expiry-warning {
        color: #ef4444;
        font-weight: 600;
    }

    .expiry-near {
        color: #f59e0b;
    }

    /* Required field indicator */
    .required-indicator {
        color: #ef4444;
        margin-left: 0.25rem;
    }

    /* Keyboard shortcut hints */
    .keyboard-hint {
        font-size: 0.75rem;
        color: #6b7280;
        margin-left: 0.5rem;
    }

    .dark .keyboard-hint {
        color: #9ca3af;
    }

    /* Loading spinner */
    .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #f3f4f6;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Amount in words display */
    .amount-in-words {
        background: #fef3c7;
        border: 1px solid #fbbf24;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-top: 1rem;
        font-size: 0.875rem;
        font-style: italic;
    }

    .dark .amount-in-words {
        background: rgba(251, 191, 36, 0.1);
        border-color: #fbbf24;
    }

    /* Patient Autocomplete Dropdown Styles - v3.0 ULTIMATE FIX */
    /* CRITICAL: Override invoice.css overflow rules that are loaded after this */
    /* Target EVERY possible parent container with maximum specificity */

    /* Main containers - OVERRIDE ALL */
    .invoice-enhanced-container,
    .invoice-enhanced-container > *,
    .invoice-enhanced-container > * > *,
    div.invoice-enhanced-container,
    div.invoice-enhanced-container > div {
        overflow: visible !important;
    }

    /* Card containers - OVERRIDE ALL */
    .universal-filter-card,
    .universal-filter-card *,
    div.universal-filter-card,
    div.universal-filter-card > div,
    div.universal-filter-card > div > div {
        overflow: visible !important;
    }

    /* Card body - OVERRIDE ALL */
    .universal-filter-card-body,
    .universal-filter-card-body *,
    div.universal-filter-card-body,
    div.universal-filter-card-body > div,
    div.universal-filter-card-body > div > div {
        overflow: visible !important;
    }

    /* Grid containers - OVERRIDE ALL */
    .invoice-two-column-grid,
    .invoice-two-column-grid *,
    div.invoice-two-column-grid,
    div.invoice-two-column-grid > div,
    div.invoice-two-column-grid > div > div {
        overflow: visible !important;
    }

    /* Form groups - OVERRIDE ALL */
    .universal-form-group,
    div.universal-form-group,
    div.universal-form-group > div,
    div.universal-form-group > div > div {
        overflow: visible !important;
    }

    /* Invoice meta sections - OVERRIDE invoice.css lines 47, 75 */
    .meta-section,
    div.meta-section,
    .meta-section div,
    div.meta-section div {
        overflow: visible !important;
    }

    /* Re-enable scrolling ONLY for specific elements that need it */
    .line-items-tbody,
    .invoice-table-wrapper {
        overflow-y: auto !important;
        overflow-x: auto !important;
    }

    /* Dropdown positioning and display - CRITICAL */
    #patient_dropdown {
        position: absolute !important;
        top: 100% !important;
        left: 0 !important;
        right: 0 !important;
        margin-top: 0.25rem !important;
        background-color: white !important;
        border: 1px solid rgb(209 213 219) !important;
        border-radius: 0.375rem !important;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        z-index: 99999 !important;
        max-height: 300px !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
    }

    .dark #patient_dropdown {
        background-color: rgb(31 41 55) !important;
        border-color: rgb(75 85 99) !important;
    }

    #patient_dropdown > div {
        padding: 0.75rem !important;
        cursor: pointer !important;
        transition: background-color 0.15s ease-in-out !important;
        border-bottom: 1px solid rgb(229 231 235) !important;
    }

    .dark #patient_dropdown > div {
        border-color: rgb(75 85 99) !important;
    }

    #patient_dropdown > div:hover {
        background-color: rgb(243 244 246) !important;
    }

    .dark #patient_dropdown > div:hover {
        background-color: rgb(55 65 81) !important;
    }

    #patient_dropdown > div:last-child {
        border-bottom: none !important;
    }
</style>
{% endblock %}

{% block extra_css %}
<!-- CRITICAL: Load invoice.css first, then override with autocomplete styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/invoice.css') }}">
<style>
    /* Patient Autocomplete Dropdown Styles - v3.1 POST-INVOICE-CSS FIX */
    /* CRITICAL: This MUST come AFTER invoice.css to override its rules */

    /* Main containers - OVERRIDE ALL invoice.css overflow rules */
    .invoice-enhanced-container,
    .invoice-enhanced-container > *,
    .invoice-enhanced-container > * > *,
    div.invoice-enhanced-container,
    div.invoice-enhanced-container > div {
        overflow: visible !important;
    }

    /* Card containers - OVERRIDE ALL */
    .universal-filter-card,
    .universal-filter-card *,
    div.universal-filter-card,
    div.universal-filter-card > div,
    div.universal-filter-card > div > div {
        overflow: visible !important;
    }

    /* Card body - OVERRIDE ALL */
    .universal-filter-card-body,
    .universal-filter-card-body *,
    div.universal-filter-card-body,
    div.universal-filter-card-body > div,
    div.universal-filter-card-body > div > div {
        overflow: visible !important;
    }

    /* Grid containers - OVERRIDE ALL */
    .invoice-two-column-grid,
    .invoice-two-column-grid *,
    div.invoice-two-column-grid,
    div.invoice-two-column-grid > div,
    div.invoice-two-column-grid > div > div {
        overflow: visible !important;
    }

    /* Form groups - OVERRIDE ALL */
    .universal-form-group,
    div.universal-form-group,
    div.universal-form-group > div,
    div.universal-form-group > div > div {
        overflow: visible !important;
    }

    /* Invoice meta sections - OVERRIDE invoice.css lines 47, 75 */
    .meta-section,
    div.meta-section,
    .meta-section div,
    div.meta-section div {
        overflow: visible !important;
    }

    /* Re-enable scrolling ONLY for specific elements that need it */
    .line-items-tbody,
    .invoice-table-wrapper {
        overflow-y: auto !important;
        overflow-x: auto !important;
    }

    /* Dropdown positioning and display - CRITICAL */
    #patient_dropdown {
        position: absolute !important;
        top: 100% !important;
        left: 0 !important;
        right: 0 !important;
        margin-top: 0.25rem !important;
        background-color: white !important;
        border: 1px solid rgb(209 213 219) !important;
        border-radius: 0.375rem !important;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        z-index: 99999 !important;
        max-height: 300px !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
    }

    .dark #patient_dropdown {
        background-color: rgb(31 41 55) !important;
        border-color: rgb(75 85 99) !important;
    }

    #patient_dropdown > div {
        padding: 0.75rem !important;
        cursor: pointer !important;
        transition: background-color 0.15s ease-in-out !important;
        border-bottom: 1px solid rgb(229 231 235) !important;
    }

    .dark #patient_dropdown > div {
        border-color: rgb(75 85 99) !important;
    }

    #patient_dropdown > div:hover {
        background-color: rgb(243 244 246) !important;
    }

    .dark #patient_dropdown > div:hover {
        background-color: rgb(55 65 81) !important;
    }

    #patient_dropdown > div:last-child {
        border-bottom: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="invoice-enhanced-container">
    <!-- Enhanced Header with Date/Day/Status -->
    <div class="invoice-header">
        <div class="info-card" style="box-shadow: none; border: none; margin: 0;">
            <div class="card-body" style="padding: 0; background: transparent;">
                <!-- Row 1: Title and Date/Status -->
                <div class="flex justify-between items-start mb-3">
                    <div style="max-width: 60%;">
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                            <i class="fas fa-file-invoice-dollar text-blue-500"></i>
                            <span class="ml-2">Create Patient Invoice</span>
                        </h1>
                        <p class="text-gray-600 dark:text-gray-400 mt-1" style="font-style: italic; font-size: 1.125rem; padding-left: 2.5rem;">
                            Quick billing for services and medicines
                        </p>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem; padding-right: 1rem;">
                        <span class="badge badge-info">Creating</span>
                        <div style="text-align: right;">
                            <div class="text-gray-600 dark:text-gray-400">
                                <i class="fas fa-calendar text-gray-500"></i>
                                <span class="ml-1 font-bold text-base">{{ now().strftime('%d %b %Y') }}</span>
                            </div>
                            <div class="text-gray-500 dark:text-gray-400 mt-1 font-bold text-sm">
                                {{ now().strftime('%A') }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 2: Breadcrumb -->
                <div class="mb-3">
                    <nav class="flex items-center space-x-1 text-sm text-gray-500">
                        <a href="{{ url_for('auth_views.dashboard') }}" class="hover:text-gray-700 dark:hover:text-gray-300">
                            Dashboard
                        </a>
                        <span class="text-gray-400 mx-2">/</span>
                        <a href="{{ url_for('universal_views.universal_list_view', entity_type='patient_invoices') }}" class="hover:text-gray-700 dark:hover:text-gray-400 dark:hover:text-gray-300">
                            Patient Invoices
                        </a>
                        <span class="text-gray-400 mx-2">/</span>
                        <span class="text-gray-700 dark:text-gray-300 font-medium">Create New</span>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Bar -->
    <div class="quick-actions-bar">
        <div class="quick-actions-left">
            <!-- Standard Back Button (Always First) -->
            <button onclick="window.history.back()" type="button" class="btn-back">
                <i class="fas fa-arrow-left icon-left"></i>Back
            </button>
            <a href="{{ url_for('universal_views.universal_list_view', entity_type='patient_invoices') }}" class="btn-outline">
                <i class="fas fa-list mr-2"></i>
                Invoices
            </a>
            <a href="{{ url_for('universal_views.universal_list_view', entity_type='patients') }}" class="btn-outline">
                <i class="fas fa-users mr-2"></i>
                Patients
            </a>
            <a href="{{ url_for('billing_views.advance_payment_list') }}" class="btn-outline">
                <i class="fas fa-wallet mr-2"></i>
                Advances
            </a>
        </div>
        <div class="flex items-center gap-3">
            <!-- Batch Mode Toggle -->
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Batch Mode:</label>
                <button
                    id="batch-mode-toggle"
                    type="button"
                    class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                    data-mode="{{ user_batch_mode | default('manual') }}"
                    onclick="toggleBatchMode()"
                    style="background-color: {{ 'rgb(59, 130, 246)' if user_batch_mode == 'auto' else 'rgb(156, 163, 175)' }};">
                    <span class="sr-only">Toggle batch mode</span>
                    <span
                        class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                        style="transform: translateX({{ '24px' if user_batch_mode == 'auto' else '4px' }});"></span>
                </button>
                <span id="batch-mode-label" class="text-sm text-gray-600 dark:text-gray-400 font-medium">
                    {{ 'Auto' if user_batch_mode == 'auto' else 'Manual' }}
                </span>
            </div>
            <button type="button" onclick="resetInvoiceForm()" class="btn-outline" title="Ctrl+R">
                <i class="fas fa-undo mr-2"></i>
                Reset Form
            </button>
        </div>
    </div>

    <div class="px-6">

        <!-- Flash messages section -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="mb-4 bg-{{ 'green' if category == 'success' else 'red' if category == 'error' else 'blue' }}-100 border-l-4 border-{{ 'green' if category == 'success' else 'red' if category == 'error' else 'blue' }}-500 text-{{ 'green' if category == 'success' else 'red' if category == 'error' else 'blue' }}-700 p-4" role="alert">
                <p>{{ message }}</p>
            </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Inventory error specific message -->
        {% if inventory_error %}
        <div class="mb-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-3" role="alert">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <div>
                    <p class="font-bold text-sm">Inventory Issue</p>
                    <p class="text-sm">{{ inventory_error }}</p>
                    <p class="text-xs mt-1">Please adjust the quantity or select a different batch or medicine.</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Form Errors Alert -->
        {% if form.errors %}
        <div class="mb-4 bg-red-50 border-l-4 border-red-400 p-4" role="alert">
            <p class="font-medium">There were errors in your submission. Please check the form and try again.</p>
            <ul class="mt-2 text-sm list-disc list-inside">
                {% for field, errors in form.errors.items() %}
                    {% for error in errors %}
                    <li>{{ field }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Main Form -->
        <form method="POST" id="invoice-form" action="{{ url_for('billing_views.create_invoice_view') }}" class="space-y-6">
            {{ form.csrf_token }}

            <!-- Section 1: Patient & Invoice Information -->
            <div class="universal-filter-card">
                <div class="universal-filter-card-header">
                    <h3 class="universal-filter-card-title">
                        <i class="fas fa-info-circle"></i>
                        Patient & Invoice Information
                    </h3>
                </div>

                <div class="universal-filter-card-body">
                    <div class="invoice-two-column-grid">
                        <!-- Left Column -->
                        <div>
                            <!-- Patient Selection - AUTOCOMPLETE DROPDOWN -->
                            <div class="universal-form-group">
                                <label class="universal-form-label" for="patient_search">
                                    Patient <span class="required-indicator">*</span>
                                </label>
                                <div style="position: relative;">
                                    <!-- Search input (visible) -->
                                    <input type="text"
                                           id="patient_search"
                                           class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                           placeholder="Search patient by name or MRN..."
                                           autocomplete="off"
                                           autofocus>

                                    <!-- Hidden field for patient ID (populated by search component) -->
                                    {{ form.patient_id(id="patient_id") }}

                                    <!-- Dropdown results -->
                                    <div id="patient_dropdown"
                                         class="absolute z-50 w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg hidden mt-1 max-h-60 overflow-y-auto">
                                        <!-- Results will be populated by JavaScript -->
                                    </div>

                                    <!-- Loading indicator -->
                                    <div id="patient_loading"
                                         class="absolute right-3 top-3 hidden">
                                        <i class="fas fa-spinner fa-spin text-gray-400"></i>
                                    </div>
                                </div>

                                <!-- Hidden field for patient name (auto-populated by form) -->
                                {{ form.patient_name(class="hidden", id="patient_name") }}
                            </div>

                            <!-- Invoice Date -->
                            <div class="universal-form-group">
                                <label class="universal-form-label" for="{{ form.invoice_date.id }}">
                                    Invoice Date <span class="required-indicator">*</span>
                                </label>
                                {{ form.invoice_date(
                                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline",
                                    type="date",
                                    required=true
                                ) }}
                                {% if form.invoice_date.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.invoice_date.errors[0] }}</p>
                                {% endif %}
                            </div>

                            <!-- Invoice Type (Hidden - determined by line items) -->
                            <input type="hidden" name="invoice_type" id="invoice_type" value="Service">
                        </div>

                        <!-- Right Column -->
                        <div>
                            <!-- Branch (Hidden) - Use session branch or first available branch -->
                            <input type="hidden" name="branch_id" id="branch_id" value="{{ g.branch_id if g.branch_id else (branches[0]['branch_id'] if branches and branches|length > 0 else '') }}">

                            <!-- GST Invoice (Hidden - always true) -->
                            <input type="hidden" name="is_gst_invoice" id="is_gst_invoice" value="true">

                            <!-- Interstate Checkbox (Hidden - calculated from patient address) -->
                            <input type="hidden" name="is_interstate" id="is_interstate" value="false">

                            <!-- Place of Supply -->
                            <div class="universal-form-group gst-element">
                                <label class="universal-form-label" for="{{ form.place_of_supply.id }}">
                                    Place of Supply (State) <span class="required-indicator">*</span>
                                </label>
                                <select id="{{ form.place_of_supply.id }}"
                                        name="place_of_supply"
                                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="">Select State</option>
                                    <option value="35">Andaman & Nicobar Islands (35)</option>
                                    <option value="28">Andhra Pradesh (28)</option>
                                    <option value="37">Andhra Pradesh (New) (37)</option>
                                    <option value="12">Arunachal Pradesh (12)</option>
                                    <option value="18">Assam (18)</option>
                                    <option value="10">Bihar (10)</option>
                                    <option value="04">Chandigarh (04)</option>
                                    <option value="22">Chhattisgarh (22)</option>
                                    <option value="26">Dadra & Nagar Haveli (26)</option>
                                    <option value="25">Daman & Diu (25)</option>
                                    <option value="07">Delhi (07)</option>
                                    <option value="30">Goa (30)</option>
                                    <option value="24">Gujarat (24)</option>
                                    <option value="06">Haryana (06)</option>
                                    <option value="02">Himachal Pradesh (02)</option>
                                    <option value="01">Jammu & Kashmir (01)</option>
                                    <option value="20">Jharkhand (20)</option>
                                    <option value="29" selected>Karnataka (29)</option>
                                    <option value="32">Kerala (32)</option>
                                    <option value="31">Lakshadweep (31)</option>
                                    <option value="23">Madhya Pradesh (23)</option>
                                    <option value="27">Maharashtra (27)</option>
                                    <option value="14">Manipur (14)</option>
                                    <option value="17">Meghalaya (17)</option>
                                    <option value="15">Mizoram (15)</option>
                                    <option value="13">Nagaland (13)</option>
                                    <option value="21">Odisha (21)</option>
                                    <option value="97">Other Territory (97)</option>
                                    <option value="34">Puducherry (34)</option>
                                    <option value="03">Punjab (03)</option>
                                    <option value="08">Rajasthan (08)</option>
                                    <option value="11">Sikkim (11)</option>
                                    <option value="33">Tamil Nadu (33)</option>
                                    <option value="36">Telangana (36)</option>
                                    <option value="16">Tripura (16)</option>
                                    <option value="05">Uttarakhand (05)</option>
                                    <option value="09">Uttar Pradesh (09)</option>
                                    <option value="19">West Bengal (19)</option>
                                </select>
                                {% if form.place_of_supply.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.place_of_supply.errors[0] }}</p>
                                {% endif %}
                            </div>

                            <!-- Currency (Hidden/Readonly) -->
                            <div class="universal-form-group">
                                <label class="universal-form-label" for="{{ form.currency_code.id }}">
                                    Currency <span class="text-gray-500 text-xs ml-2">(Auto-populated)</span>
                                </label>
                                {{ form.currency_code(
                                    class="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300 leading-tight cursor-not-allowed",
                                    readonly=true,
                                    value="INR"
                                ) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Line Items -->
            <div class="line-items-section">
                <div class="universal-filter-card-header">
                    <h3 class="universal-filter-card-title">
                        <i class="fas fa-list"></i>
                        Line Items
                    </h3>
                    <div class="flex gap-2">
                        <button type="button"
                                id="add-line-item"
                                class="btn-primary"
                                title="Alt+A"
                                accesskey="a">
                            <i class="fas fa-plus mr-2"></i>
                            <u>A</u>dd Item
                        </button>
                    </div>
                </div>

                <div class="p-0">
                    <table class="universal-table w-full">
                        <thead class="universal-table-header">
                            <tr>
                                <th class="text-center w-12">#</th>
                                <th class="w-24">Type</th>
                                <th class="w-1/4">Item</th>
                                <th class="text-left w-24">Batch</th>
                                <th class="text-left w-24">Expiry</th>
                                <th class="text-right w-16">Qty</th>
                                <th class="text-right w-20">Price</th>
                                <th class="text-right w-16">Disc%</th>
                                <th class="text-center w-16">GST%</th>
                                <th class="text-right w-32">Amount</th>
                                <th class="text-center w-16">Action</th>
                            </tr>
                        </thead>
                        <tbody id="line-items-container" class="universal-table-body">
                            <tr id="no-items-row">
                                <td colspan="11" class="py-4 px-2 text-center text-gray-500 dark:text-gray-400">
                                    <i class="fas fa-shopping-cart text-gray-300 text-3xl mb-2"></i>
                                    <p>No items added. Click "Add Item" to add products or services.</p>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot class="table-footer-totals">
                            <tr>
                                <td colspan="9" class="text-right font-semibold px-4 py-2">Subtotal:</td>
                                <td class="text-right font-semibold px-4 py-2">
                                    <span class="currency-symbol">â‚¹</span>
                                    <span id="subtotal-display">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="9" class="text-right font-semibold px-4 py-2">Total Discount:</td>
                                <td class="text-right font-semibold px-4 py-2">
                                    <span class="currency-symbol">â‚¹</span>
                                    <span id="total-discount-display">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                            <tr class="cgst-row">
                                <td colspan="9" class="text-right font-semibold px-4 py-2">CGST:</td>
                                <td class="text-right font-semibold px-4 py-2">
                                    <span class="currency-symbol">â‚¹</span>
                                    <span id="cgst-display">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                            <tr class="sgst-row">
                                <td colspan="9" class="text-right font-semibold px-4 py-2">SGST:</td>
                                <td class="text-right font-semibold px-4 py-2">
                                    <span class="currency-symbol">â‚¹</span>
                                    <span id="sgst-display">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                            <tr class="igst-row hidden">
                                <td colspan="9" class="text-right font-semibold px-4 py-2">IGST:</td>
                                <td class="text-right font-semibold px-4 py-2">
                                    <span class="currency-symbol">â‚¹</span>
                                    <span id="igst-display">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                            <tr class="grand-total-row">
                                <td colspan="9" class="text-right font-bold text-base px-4 py-3">Grand Total:</td>
                                <td class="text-right font-bold text-base text-blue-600 dark:text-blue-400 px-4 py-3">
                                    <span class="currency-symbol text-base">â‚¹</span>
                                    <span id="grand-total-display" class="text-base">0.00</span>
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Amount in Words Display -->
                <div class="amount-in-words hidden" id="amount-in-words">
                    <strong>Amount in Words:</strong> <span id="amount-in-words-text"></span>
                </div>
            </div>

            <!-- Section 3: Additional Information -->
            <div class="universal-filter-card">
                <div class="universal-filter-card-header">
                    <h3 class="universal-filter-card-title">
                        <i class="fas fa-sticky-note"></i>
                        Additional Information
                    </h3>
                </div>

                <div class="universal-filter-card-body">
                    <div class="universal-form-group">
                        <label class="universal-form-label" for="{{ form.notes.id }}">
                            Notes
                        </label>
                        {{ form.notes(
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24",
                            placeholder="Any additional notes or instructions..."
                        ) }}
                        {% if form.notes.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.notes.errors[0] }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Bottom Action Buttons -->
            <div class="bottom-actions">
                <div class="flex gap-2">
                    <a href="{{ url_for('universal_views.universal_list_view', entity_type='patient_invoices') }}"
                       class="btn-danger">
                        <i class="fas fa-times mr-2"></i>
                        Cancel
                    </a>
                    <button type="button"
                            onclick="resetInvoiceForm()"
                            class="btn-outline"
                            title="Ctrl+R">
                        <i class="fas fa-undo mr-2"></i>
                        Reset
                    </button>
                </div>
                <div class="flex gap-2">
                    <button type="submit"
                            form="invoice-form"
                            class="btn-primary"
                            title="Alt+S"
                            accesskey="s"
                            id="submit-invoice-btn">
                        <i class="fas fa-check mr-2"></i>
                        Create Invoice (Alt+<u>S</u>)
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Line Item Template -->
<template id="line-item-template">
    <tr class="line-item-row universal-table-row bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600">
        <td class="text-center px-2 py-2">
            <span class="line-number text-sm font-medium">1</span>
        </td>

        <!-- Item Type Dropdown -->
        <td class="px-2 py-2">
            <select class="item-type form-select text-sm w-full border rounded px-2 py-1" required>
                <option value="">-- Select Type --</option>
                <optgroup label="Services & Packages">
                    <option value="Package">Package</option>
                    <option value="Service">Service</option>
                </optgroup>
                <optgroup label="Medicines & Products">
                    <option value="OTC">OTC Medicine</option>
                    <option value="Prescription">Prescription Medicine</option>
                    <option value="Product">Product</option>
                    <option value="Consumable">Consumable</option>
                </optgroup>
            </select>
            <input type="hidden" class="item-id">
        </td>

        <!-- Item Search with Autocomplete -->
        <td class="px-2 py-2">
            <div class="relative">
                <input type="text"
                       class="item-search form-input text-sm w-full border rounded px-2 py-1"
                       placeholder="Type to search..."
                       autocomplete="off">
                <input type="hidden" class="item-name">
                <div class="item-search-results absolute z-50 bg-white dark:bg-gray-700 shadow-md rounded w-64 max-h-40 overflow-y-auto hidden text-xs">
                </div>
            </div>
        </td>

        <!-- Batch (Medicine-specific) -->
        <td class="px-2 py-2">
            <select class="batch-select form-select text-sm w-full border rounded px-2 py-1 medicine-field hidden">
                <option value="">Select Batch</option>
            </select>
        </td>

        <!-- Expiry Date (Medicine-specific) -->
        <td class="px-2 py-2">
            <input type="date"
                   class="expiry-date form-input text-sm w-full border rounded px-2 py-1 medicine-field hidden"
                   readonly>
        </td>

        <!-- Quantity -->
        <td class="px-2 py-2 w-16">
            <input type="number"
                   class="quantity form-input text-sm w-full text-right border rounded px-2 py-1"
                   value="1"
                   min="0.01"
                   step="0.01"
                   required>
        </td>

        <!-- Unit Price -->
        <td class="px-2 py-2 w-20">
            <input type="number"
                   class="unit-price form-input text-sm w-full text-right border rounded px-2 py-1"
                   value="0.00"
                   min="0"
                   step="0.01"
                   required>
        </td>

        <!-- Discount Percent -->
        <td class="px-2 py-2">
            <input type="number"
                   class="discount-percent form-input text-sm w-full text-right border rounded px-2 py-1"
                   value="0"
                   min="0"
                   max="100"
                   step="0.01">
        </td>

        <!-- GST Rate Display -->
        <td class="text-center px-2 py-2">
            <span class="gst-rate-display text-sm">0%</span>
            <input type="hidden" class="gst-rate" value="0">
            <input type="hidden" class="is-gst-exempt" value="false">
            <input type="hidden" class="gst-inclusive" value="false">
        </td>

        <!-- Line Total -->
        <td class="text-right px-4 py-2 w-32">
            <span class="currency-symbol">â‚¹</span>
            <span class="line-total-display font-medium">0.00</span>
        </td>

        <!-- Remove Button -->
        <td class="text-center px-2 py-2">
            <button type="button"
                    class="remove-line-item text-red-500 hover:text-red-700"
                    title="Remove this item">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    </tr>
</template>

{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Include JavaScript files (WORKING VERSION - RESTORED) -->
<!-- FIFO Allocation Modal Component -->
<script src="{{ url_for('static', filename='js/components/fifo_allocation_modal.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/invoice_item.js') }}?v=20251117_1905"></script><!-- Fixed batch API endpoint -->
<script src="{{ url_for('static', filename='js/pages/invoice.js') }}?v=20251117_1900"></script><!-- Cache bust - fixed 404 errors, corrected API endpoint -->

<script>
// Global auth token for API calls
window.INVOICE_AUTH_TOKEN = '{{ auth_token }}';

// =================================================================
// PATIENT AUTOCOMPLETE SEARCH IMPLEMENTATION
// =================================================================
function initializePatientSearch() {
    const searchInput = document.getElementById('patient_search');
    const hiddenInput = document.getElementById('patient_id');
    const dropdown = document.getElementById('patient_dropdown');
    const loadingIcon = document.getElementById('patient_loading');

    let searchTimeout = null;
    let searchCache = new Map();

    // Handle input with debounce
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();

        clearTimeout(searchTimeout);

        if (query.length === 0) {
            // Show initial list when cleared
            searchTimeout = setTimeout(() => {
                performPatientSearch('', 20);  // Initial load: 20 recent patients
            }, 200);
        } else {
            // Search with user query
            searchTimeout = setTimeout(() => {
                performPatientSearch(query, 10);  // Search: 10 results
            }, 300);
        }
    });

    // Show initial list on focus
    searchInput.addEventListener('focus', function() {
        if (searchInput.value.trim().length === 0) {
            performPatientSearch('', 20);  // Show 20 recent patients
        }
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            hideDropdown();
        }
    });

    // Perform search via API
    async function performPatientSearch(query, limit = 10) {
        const cacheKey = `${query.toLowerCase()}_${limit}`;

        // Check cache first
        if (searchCache.has(cacheKey)) {
            displayResults(searchCache.get(cacheKey));
            return;
        }

        showLoading();

        try {
            // API returns direct array of patients: [{id, name, mrn, contact}, ...]
            const response = await fetch(`/invoice/web_api/patient/search?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            if (Array.isArray(data) && data.length > 0) {
                searchCache.set(cacheKey, data);
                displayResults(data);
            } else {
                showNoResults();
            }
        } catch (error) {
            console.error('Patient search error:', error);
            showError();
        } finally {
            hideLoading();
        }
    }

    // Display search results
    function displayResults(results) {
        if (!results || results.length === 0) {
            showNoResults();
            return;
        }

        dropdown.innerHTML = '';

        results.forEach(patient => {
            const item = document.createElement('div');
            item.className = 'px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-100 dark:border-gray-600 last:border-b-0';

            item.innerHTML = `
                <div class="font-medium text-gray-900 dark:text-gray-100">${patient.name}</div>
                ${patient.mrn ? `<div class="text-sm text-gray-500 dark:text-gray-400">MRN: ${patient.mrn}</div>` : ''}
                ${patient.contact ? `<div class="text-sm text-gray-500 dark:text-gray-400">${patient.contact}</div>` : ''}
            `;

            item.addEventListener('click', () => {
                selectPatient(patient);
            });

            dropdown.appendChild(item);
        });

        showDropdown();
    }

    // Select a patient
    function selectPatient(patient) {
        // API returns: {id, name, mrn, contact}
        searchInput.value = `${patient.name} - MRN: ${patient.mrn}`;
        hiddenInput.value = patient.id;  // Set UUID
        hideDropdown();

        // Trigger change event for state calculation
        hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));

        console.log(`âœ… Patient selected: ${patient.name} (${patient.id})`);
    }

    // Show/hide functions
    function showLoading() {
        loadingIcon.classList.remove('hidden');
    }

    function hideLoading() {
        loadingIcon.classList.add('hidden');
    }

    function showDropdown() {
        dropdown.classList.remove('hidden');
    }

    function hideDropdown() {
        dropdown.classList.add('hidden');
    }

    function showNoResults() {
        dropdown.innerHTML = '<div class="px-3 py-2 text-center text-gray-500 dark:text-gray-400">No patients found</div>';
        showDropdown();
    }

    function showError() {
        dropdown.innerHTML = '<div class="px-3 py-2 text-center text-red-500">Search failed. Please try again.</div>';
        showDropdown();
    }

    console.log("âœ… Patient autocomplete search initialized");
}

document.addEventListener('DOMContentLoaded', function() {
    console.log("âœ… Patient Invoice Creation Page Loaded");

    // Initialize Patient Autocomplete Search
    initializePatientSearch();

    // CRITICAL: Initialize InvoiceItemComponent - THIS WAS MISSING!
    const invoiceItemComponent = new InvoiceItemComponent({
        containerId: 'line-items-container',
        templateId: 'line-item-template',
        noItemsRowId: 'no-items-row',
        addButtonId: 'add-line-item'
    });
    console.log("âœ… InvoiceItemComponent initialized successfully");

    // Store component globally for toggle function access
    window.invoiceItemComponent = invoiceItemComponent;

    // =================================================================
    // RESTORE PRESERVED LINE ITEMS (after validation errors)
    // =================================================================
    {% if preserved_line_items %}
    console.log("ðŸ“¦ Restoring {{ preserved_line_items|length }} preserved line items...");
    const preservedItems = {{ preserved_line_items|tojson }};

    preservedItems.forEach((item, index) => {
        console.log(`Restoring item ${index + 1}:`, item);

        // Add a new row using the component
        const row = invoiceItemComponent.addLineItem();
        if (!row) {
            console.error("Failed to create row for preserved item", item);
            return;
        }

        // Populate the row with preserved data
        try {
            // Set item type
            const itemTypeSelect = row.querySelector('.item-type');
            if (itemTypeSelect && item.item_type) {
                itemTypeSelect.value = item.item_type;
                itemTypeSelect.dispatchEvent(new Event('change'));
            }

            // Set item ID and name (hidden fields)
            const itemIdInput = row.querySelector('.item-id');
            const itemNameInput = row.querySelector('.item-name');
            const itemSearchInput = row.querySelector('.item-search');

            if (itemIdInput && item.item_id) itemIdInput.value = item.item_id;
            if (itemNameInput && item.item_name) itemNameInput.value = item.item_name;
            if (itemSearchInput && item.item_name) itemSearchInput.value = item.item_name;

            // Set batch (if applicable)
            if (item.batch) {
                const batchSelect = row.querySelector('.batch-select');
                if (batchSelect) {
                    // Create option if it doesn't exist
                    const option = document.createElement('option');
                    option.value = item.batch;
                    option.textContent = item.batch;
                    batchSelect.appendChild(option);
                    batchSelect.value = item.batch;
                }
            }

            // Set expiry date (if applicable)
            if (item.expiry_date) {
                const expiryInput = row.querySelector('.expiry-date');
                if (expiryInput) expiryInput.value = item.expiry_date;
            }

            // Set quantity
            const quantityInput = row.querySelector('.quantity');
            if (quantityInput && item.quantity) {
                quantityInput.value = item.quantity;
            }

            // Set unit price
            const unitPriceInput = row.querySelector('.unit-price');
            if (unitPriceInput && item.unit_price) {
                unitPriceInput.value = item.unit_price;
            }

            // Set discount percent
            const discountInput = row.querySelector('.discount-percent');
            if (discountInput && item.discount_percent) {
                discountInput.value = item.discount_percent;
            }

            // Set GST rate (if applicable)
            if (item.gst_rate) {
                const gstRateInput = row.querySelector('.gst-rate');
                const gstRateDisplay = row.querySelector('.gst-rate-display');
                if (gstRateInput) gstRateInput.value = item.gst_rate;
                if (gstRateDisplay) gstRateDisplay.textContent = item.gst_rate + '%';
            }

            // Recalculate totals for this row
            if (window.invoiceItemComponent) {
                window.invoiceItemComponent.calculateLineTotal(row);
            }

            console.log(`âœ“ Restored item ${index + 1}: ${item.item_name}`);
        } catch (error) {
            console.error(`Error restoring item ${index + 1}:`, error);
        }
    });

    // Recalculate grand totals
    if (window.invoiceItemComponent) {
        window.invoiceItemComponent.calculateTotals();
    }

    console.log("âœ… All preserved line items restored");
    {% endif %}

    // =================================================================
    // 1. KEYBOARD SHORTCUTS
    // =================================================================
    document.addEventListener('keydown', function(e) {
        // Alt+P: Focus patient dropdown
        if (e.altKey && e.key === 'p') {
            e.preventDefault();
            document.getElementById('patient_id')?.focus();
        }

        // Alt+A: Add line item
        if (e.altKey && e.key === 'a') {
            e.preventDefault();
            document.getElementById('add-line-item')?.click();
        }

        // Alt+S: Submit form
        if (e.altKey && e.key === 's') {
            e.preventDefault();
            document.getElementById('submit-invoice-btn')?.click();
        }

        // Ctrl+R: Reset form
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            resetInvoiceForm();
        }
    });

    // =================================================================
    // 3. FORM RESET FUNCTION
    // =================================================================
    window.resetInvoiceForm = function() {
        if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
            document.getElementById('invoice-form')?.reset();

            // Clear patient info
            document.getElementById('selected-patient-info')?.classList.add('hidden');
            document.getElementById('patient_search').value = '';
            document.getElementById('patient_id').value = '';
            document.getElementById('patient_name').value = '';

            // Clear line items
            const container = document.getElementById('line-items-container');
            if (container) {
                container.innerHTML = '<tr id="no-items-row"><td colspan="11" class="py-4 px-2 text-center text-gray-500 dark:text-gray-400"><i class="fas fa-shopping-cart text-gray-300 text-3xl mb-2"></i><p>No items added. Click "Add Item" to add products or services.</p></td></tr>';
            }

            // Reset totals
            updateTotalsDisplay();

            // Focus on patient dropdown
            document.getElementById('patient_id')?.focus();

            console.log("âœ… Form reset complete");
        }
    };

    // =================================================================
    // 4. TOTALS UPDATE FUNCTION (Enhanced)
    // =================================================================
    function updateTotalsDisplay() {
        // Get totals from existing invoice.js functions
        const subtotal = parseFloat(document.getElementById('subtotal')?.textContent || '0');
        const totalDiscount = parseFloat(document.getElementById('total-discount')?.textContent || '0');
        const totalCGST = parseFloat(document.getElementById('total-cgst')?.textContent || '0');
        const totalSGST = parseFloat(document.getElementById('total-sgst')?.textContent || '0');
        const totalIGST = parseFloat(document.getElementById('total-igst')?.textContent || '0');
        const grandTotal = parseFloat(document.getElementById('grand-total')?.textContent || '0');

        // Update display elements
        document.getElementById('subtotal-display').textContent = subtotal.toFixed(2);
        document.getElementById('total-discount-display').textContent = totalDiscount.toFixed(2);
        document.getElementById('cgst-display').textContent = totalCGST.toFixed(2);
        document.getElementById('sgst-display').textContent = totalSGST.toFixed(2);
        document.getElementById('igst-display').textContent = totalIGST.toFixed(2);
        document.getElementById('grand-total-display').textContent = grandTotal.toFixed(2);

        // Show amount in words if grand total > 0
        if (grandTotal > 0) {
            document.getElementById('amount-in-words')?.classList.remove('hidden');
            document.getElementById('amount-in-words-text').textContent = numberToWords(grandTotal) + ' Rupees Only';
        } else {
            document.getElementById('amount-in-words')?.classList.add('hidden');
        }
    }

    // =================================================================
    // 5. NUMBER TO WORDS CONVERSION (for amount display)
    // =================================================================
    function numberToWords(num) {
        // Simple implementation - can be enhanced
        const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
        const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
        const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];

        if (num === 0) return 'Zero';
        if (num < 10) return ones[num];
        if (num < 20) return teens[num - 10];
        if (num < 100) return tens[Math.floor(num / 10)] + ' ' + ones[num % 10];
        if (num < 1000) return ones[Math.floor(num / 100)] + ' Hundred ' + numberToWords(num % 100);
        if (num < 100000) return numberToWords(Math.floor(num / 1000)) + ' Thousand ' + numberToWords(num % 1000);
        if (num < 10000000) return numberToWords(Math.floor(num / 100000)) + ' Lakh ' + numberToWords(num % 100000);

        return 'Amount Too Large';
    }

    // =================================================================
    // 6. FORM SUBMISSION HANDLER
    // =================================================================
    // NOTE: Form submission is handled by invoice.js - do NOT add duplicate handlers here
    // Duplicate handlers cause validation to run multiple times and interfere with submission

    // =================================================================
    // 7. SET DEFAULT VALUES (Smart Defaults)
    // =================================================================
    // Set today's date as default
    const invoiceDateField = document.getElementById('{{ form.invoice_date.id }}');
    if (invoiceDateField && !invoiceDateField.value) {
        const today = new Date().toISOString().split('T')[0];
        invoiceDateField.value = today;
    }

    // Check GST invoice by default
    const gstInvoiceCheckbox = document.getElementById('is_gst_invoice');
    if (gstInvoiceCheckbox && !gstInvoiceCheckbox.checked) {
        gstInvoiceCheckbox.checked = true;
    }

    // Set default invoice type to "Service" (most common)
    const invoiceTypeField = document.getElementById('{{ form.invoice_type.id }}');
    if (invoiceTypeField && !invoiceTypeField.value) {
        invoiceTypeField.value = 'Service';
    }

    // =================================================================
    // 8. PATIENT SELECTION - AUTO-POPULATE STATE & CALCULATE INTERSTATE
    // =================================================================
    // Note: patient_id is now a hidden field populated by Universal Entity Search
    const patientIdField = document.getElementById('patient_id');
    const placeOfSupplyDropdown = document.getElementById('{{ form.place_of_supply.id }}');
    const isInterstateField = document.getElementById('is_interstate');

    // Get hospital state code from template
    const hospitalStateCode = '{{ g.hospital.state_code if g.hospital else "" }}';

    if (patientIdField) {
        patientIdField.addEventListener('change', async function() {
            const patientId = this.value;

            if (!patientId) {
                // Reset state if no patient selected
                if (placeOfSupplyDropdown) placeOfSupplyDropdown.value = hospitalStateCode || '';
                if (isInterstateField) isInterstateField.value = 'false';
                return;
            }

            try {
                console.log(`ðŸ”µ Fetching state for patient: ${patientId}`);

                const response = await fetch(`/invoice/web_api/patient/${patientId}/state`);
                const data = await response.json();

                if (data.success) {
                    console.log('âœ… Patient state data received:', data);

                    // Set place of supply to patient's state (or hospital state as fallback)
                    const stateToUse = data.patient_state_code || data.hospital_state_code || hospitalStateCode;
                    if (placeOfSupplyDropdown) {
                        placeOfSupplyDropdown.value = stateToUse;
                    }

                    // Set interstate flag
                    if (isInterstateField) {
                        isInterstateField.value = data.is_interstate ? 'true' : 'false';
                    }

                    // Recalculate all line items with new interstate flag
                    recalculateAllLineItems();

                    console.log(`âœ… State set to: ${stateToUse}, Interstate: ${data.is_interstate}`);
                } else {
                    console.error('âŒ Failed to get patient state:', data.message);
                }
            } catch (error) {
                console.error('âŒ Error fetching patient state:', error);
            }
        });
    }

    // Handle manual place of supply changes
    if (placeOfSupplyDropdown) {
        placeOfSupplyDropdown.addEventListener('change', function() {
            const deliveryState = this.value;

            // Calculate interstate based on delivery state vs hospital state
            const isInterstate = (hospitalStateCode !== deliveryState) && deliveryState !== '';

            if (isInterstateField) {
                isInterstateField.value = isInterstate ? 'true' : 'false';
            }

            // Recalculate all line items with new interstate flag
            recalculateAllLineItems();

            console.log(`ðŸ”„ Place of supply changed: ${deliveryState}, Interstate: ${isInterstate}`);
        });
    }

    // Function to recalculate all line items
    function recalculateAllLineItems() {
        const rows = document.querySelectorAll('.line-item-row');
        rows.forEach(row => {
            if (window.invoiceItemComponent) {
                window.invoiceItemComponent.calculateLineTotal(row);
            }
        });
        if (window.invoiceItemComponent) {
            window.invoiceItemComponent.calculateTotals();
        }
        updateTotalsDisplay();
    }

    // =================================================================
    // 9. INTEGRATE WITH EXISTING INVOICE.JS FUNCTIONS
    // =================================================================
    // Hook into existing calculateTotals function
    if (window.invoiceComponentFunctions && window.invoiceComponentFunctions.calculateTotals) {
        const originalCalculateTotals = window.invoiceComponentFunctions.calculateTotals;
        window.invoiceComponentFunctions.calculateTotals = function() {
            originalCalculateTotals.apply(this, arguments);
            updateTotalsDisplay();
        };
    }

    console.log("âœ… All enhancements loaded successfully");
});
</script>

<!-- PRESERVE EXISTING BATCH VALIDATION SCRIPT -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("âœ… Batch validation initialized");

    // Function to get batch inventory directly from server
    function getBatchInventory(medicineId, batch, callback) {
        // This function is deprecated - batch data is now stored in select option data attributes
        // Keeping for backward compatibility
        if (!medicineId || !batch) {
            callback(0);
            return;
        }
        callback(0);
    }

    // Function to validate batch quantity
    function validateBatchQuantity(row) {
        const batchSelect = row.querySelector('.batch-select');
        const quantityInput = row.querySelector('.quantity');
        const itemIdInput = row.querySelector('.item-id');

        if (!batchSelect || !quantityInput || !itemIdInput) return;
        if (batchSelect.selectedIndex <= 0) return;

        const selectedBatch = batchSelect.value;
        const requestedQty = parseFloat(quantityInput.value || 1);

        // Get available quantity from the selected option's data attribute
        const selectedOption = batchSelect.options[batchSelect.selectedIndex];
        const availableQty = parseFloat(selectedOption.getAttribute('data-available') || 0);

        console.log(`Validating batch ${selectedBatch}: requested=${requestedQty}, available=${availableQty}`);

        if (availableQty <= 0) {
            alert("âš ï¸ Warning: This batch has no available stock. Please select a different batch.");
            return;
        }

        if (requestedQty > availableQty) {
            quantityInput.value = availableQty;
            alert(`âš ï¸ Quantity adjusted to maximum available stock: ${availableQty}`);

            if (window.invoiceComponentFunctions && typeof window.invoiceComponentFunctions.calculateLineTotal === 'function') {
                window.invoiceComponentFunctions.calculateLineTotal(row);
                window.invoiceComponentFunctions.calculateTotals();
            }
        }
    }

    // Event listeners for batch selection and quantity changes
    document.addEventListener('change', function(event) {
        if (event.target.classList.contains('batch-select')) {
            const row = event.target.closest('.line-item-row');
            if (row) {
                setTimeout(function() {
                    validateBatchQuantity(row);
                }, 300);
            }
        }

        if (event.target.classList.contains('quantity')) {
            const row = event.target.closest('.line-item-row');
            if (row) {
                const itemType = row.querySelector('.item-type')?.value;
                if (itemType === 'Medicine' || itemType === 'Prescription') {
                    setTimeout(function() {
                        validateBatchQuantity(row);
                    }, 300);
                }
            }
        }
    });

    // ========================================================================
    // BATCH MODE TOGGLE HANDLER
    // ========================================================================
    window.toggleBatchMode = async function() {
        const toggle = document.getElementById('batch-mode-toggle');
        const label = document.getElementById('batch-mode-label');
        const currentMode = toggle.dataset.mode;
        const newMode = currentMode === 'manual' ? 'auto' : 'manual';

        try {
            // Update via API
            const response = await fetch('/api/auth/user/preferences/batch-mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer {{ auth_token }}`
                },
                body: JSON.stringify({ batch_mode: newMode })
            });

            const data = await response.json();

            if (data.success) {
                // Update UI
                toggle.dataset.mode = newMode;
                label.textContent = newMode === 'manual' ? 'Manual' : 'Auto';

                // Update toggle appearance
                const toggleSpan = toggle.querySelector('span:last-child');
                if (newMode === 'auto') {
                    toggle.style.backgroundColor = 'rgb(59, 130, 246)';
                    toggleSpan.style.transform = 'translateX(24px)';
                } else {
                    toggle.style.backgroundColor = 'rgb(156, 163, 175)';
                    toggleSpan.style.transform = 'translateX(4px)';
                }

                // Update invoice component batch mode if it exists
                if (window.invoiceItemComponent) {
                    window.invoiceItemComponent.batchMode = newMode;
                }

                // Show success message
                showToast(`Batch mode changed to ${newMode}`, 'success');
            } else {
                showToast('Failed to update batch mode preference', 'error');
            }
        } catch (error) {
            console.error('Error updating batch mode:', error);
            showToast('Error updating batch mode preference', 'error');
        }
    };

    // Simple toast notification function
    window.showToast = function(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
        } text-white`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    };

    // =================================================================
    // FORM VALIDATION - Validate patient selection before submission
    // =================================================================
    const invoiceForm = document.getElementById('invoice-form');
    if (invoiceForm) {
        invoiceForm.addEventListener('submit', function(event) {
            const patientIdField = document.getElementById('patient_id');
            const patientSearchInput = document.getElementById('patient_search');  // Fixed: correct ID

            // Debug logging
            console.log('Form submit - Patient ID field:', patientIdField);
            console.log('Form submit - Patient ID value:', patientIdField ? patientIdField.value : 'field not found');
            console.log('Form submit - Patient search value:', patientSearchInput ? patientSearchInput.value : 'field not found');

            // Check if patient is selected
            if (!patientIdField || !patientIdField.value || patientIdField.value === '') {
                event.preventDefault();
                event.stopPropagation();

                // Focus on patient search input
                if (patientSearchInput) {
                    patientSearchInput.focus();
                    patientSearchInput.classList.add('border-red-500');
                    setTimeout(() => {
                        patientSearchInput.classList.remove('border-red-500');
                    }, 3000);
                }

                // Show error message
                showToast('Please select a patient before submitting', 'error');
                console.error('Validation failed: patient_id is empty');
                return false;
            }

            console.log('Validation passed - patient_id:', patientIdField.value);
            return true;
        });
    }
});
</script>
{% endblock %}
