{% extends "base.html" %}

{% block title %}Wallet Transactions - {{ patient.full_name }}{% endblock %}

{% block extra_css %}
<!-- Universal Engine CSS Components -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/universal_view.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/universal_form.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/wallet.css') }}">
<style>
    /* Transaction table specific styles */
    .transaction-table {
        width: 100%;
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
        border: 1px solid #e5e7eb;
    }

    .transaction-table th {
        background: #f9fafb;
        padding: 1rem;
        font-weight: 600;
        font-size: 0.875rem;
        color: #374151;
        text-align: left;
        border-bottom: 2px solid #e5e7eb;
    }

    .transaction-table td {
        padding: 1rem;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
    }

    .transaction-table tr:last-child td {
        border-bottom: none;
    }

    .transaction-table tr:hover {
        background: #f9fafb;
    }

    .txn-type-badge {
        display: inline-block;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.8125rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .txn-type-badge.load {
        background: #d1fae5;
        color: #065f46;
    }

    .txn-type-badge.redeem {
        background: #dbeafe;
        color: #1e40af;
    }

    .txn-type-badge.refund {
        background: #fef3c7;
        color: #92400e;
    }

    .txn-type-badge.expire {
        background: #fee2e2;
        color: #991b1b;
    }

    .txn-type-badge.adjustment {
        background: #e0e7ff;
        color: #3730a3;
    }

    .filter-panel {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e5e7eb;
    }

    .summary-banner {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .summary-stat {
        text-align: center;
    }

    .summary-stat-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.25rem;
    }

    .summary-stat-label {
        font-size: 0.875rem;
        opacity: 0.9;
    }

    /* Print styles */
    @media print {
        .no-print {
            display: none !important;
        }

        .print-only {
            display: block !important;
        }

        body {
            font-size: 11pt;
        }

        .transaction-table {
            border: 1px solid #000;
        }

        .transaction-table th {
            background: #f0f0f0 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .transaction-table td {
            border-bottom: 1px solid #ddd !important;
        }

        .txn-type-badge {
            border: 1px solid #333;
        }

        @page {
            margin: 1cm;
        }

        .page-break {
            page-break-before: always;
        }
    }

    .print-only {
        display: none;
    }

    .print-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .print-header h1 {
        margin: 0;
        font-size: 24pt;
    }

    .print-header .subtitle {
        font-size: 12pt;
        color: #666;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #9ca3af;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 no-print">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3">
                <i class="fas fa-history"></i> Wallet Transaction History
            </h1>
            <p class="text-muted">{{ patient.full_name }} - Complete transaction log</p>
        </div>
        <div class="col-md-4 text-right">
            <a href="{{ url_for('wallet.wallet_dashboard', patient_id=patient.patient_id) }}"
               class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            <button class="btn btn-primary" onclick="window.print()">
                <i class="fas fa-print"></i> Print
            </button>
        </div>
    </div>

    <!-- Summary Banner -->
    {% if wallet %}
    <div class="summary-banner">
        <div class="summary-stat">
            <div class="summary-stat-value">{{ "{:,}".format(wallet.points_balance) }}</div>
            <div class="summary-stat-label">Current Balance</div>
        </div>
        <div class="summary-stat">
            <div class="summary-stat-value">₹{{ "{:,.0f}".format(wallet.total_amount_loaded) }}</div>
            <div class="summary-stat-label">Total Loaded</div>
        </div>
        <div class="summary-stat">
            <div class="summary-stat-value">{{ "{:,}".format(wallet.total_points_redeemed) }}</div>
            <div class="summary-stat-label">Total Redeemed</div>
        </div>
        <div class="summary-stat">
            <div class="summary-stat-value">{{ wallet.tier_name or 'No Tier' }}</div>
            <div class="summary-stat-label">Current Tier</div>
        </div>
    </div>
    {% endif %}

    <!-- Filter Panel -->
    <div class="filter-panel">
        <form method="GET" id="filterForm">
            <div class="row">
                <div class="col-md-3">
                    <label class="font-weight-bold mb-2">Transaction Type</label>
                    <select class="form-control" name="type" onchange="document.getElementById('filterForm').submit()">
                        <option value="">All Types</option>
                        <option value="load" {% if request.args.get('type') == 'load' %}selected{% endif %}>Load</option>
                        <option value="redeem" {% if request.args.get('type') == 'redeem' %}selected{% endif %}>Redeem</option>
                        <option value="refund_service" {% if request.args.get('type') == 'refund_service' %}selected{% endif %}>Refund (Service)</option>
                        <option value="refund_wallet" {% if request.args.get('type') == 'refund_wallet' %}selected{% endif %}>Refund (Wallet)</option>
                        <option value="expire" {% if request.args.get('type') == 'expire' %}selected{% endif %}>Expired</option>
                        <option value="adjustment" {% if request.args.get('type') == 'adjustment' %}selected{% endif %}>Adjustment</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="font-weight-bold mb-2">From Date</label>
                    <input type="date" class="form-control" name="from_date"
                           value="{{ request.args.get('from_date', '') }}"
                           onchange="document.getElementById('filterForm').submit()">
                </div>
                <div class="col-md-3">
                    <label class="font-weight-bold mb-2">To Date</label>
                    <input type="date" class="form-control" name="to_date"
                           value="{{ request.args.get('to_date', '') }}"
                           onchange="document.getElementById('filterForm').submit()">
                </div>
                <div class="col-md-3">
                    <label class="font-weight-bold mb-2">Records Per Page</label>
                    <select class="form-control" name="per_page" onchange="document.getElementById('filterForm').submit()">
                        <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                        <option value="all" {% if per_page == 'all' %}selected{% endif %}>All</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12 text-right">
                    <a href="{{ url_for('wallet.wallet_transactions', patient_id=patient.patient_id) }}"
                       class="btn btn-secondary btn-sm">
                        <i class="fas fa-redo"></i> Clear Filters
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Print Header (hidden on screen) -->
<div class="print-only">
    <div class="print-header">
        <h1>{{ hospital_name or 'Skinspire Clinic' }}</h1>
        <p class="subtitle">Wallet Transaction History</p>
        <p class="subtitle">Patient: {{ patient.full_name }}</p>
        <p class="subtitle">Generated: {{ now.strftime('%d %b %Y %I:%M %p') }}</p>
        <hr>
    </div>
</div>

<!-- Transaction Table -->
<div class="container-fluid">
    <div class="card">
        <div class="card-body p-0">
            {% if transactions %}
            <div class="table-responsive">
                <table class="transaction-table">
                    <thead>
                        <tr>
                            <th style="width: 15%">Date & Time</th>
                            <th style="width: 15%">Type</th>
                            <th style="width: 12%">Points</th>
                            <th style="width: 12%">Value (₹)</th>
                            <th style="width: 12%">Balance</th>
                            <th style="width: 20%">Reference</th>
                            <th style="width: 14%">Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for txn in transactions %}
                        <tr>
                            <!-- Date & Time -->
                            <td>
                                <div style="font-weight: 600; color: #1f2937;">{{ txn.date }}</div>
                                <div style="font-size: 0.75rem; color: #9ca3af;">{{ txn.time }}</div>
                            </td>

                            <!-- Type -->
                            <td>
                                <span class="txn-type-badge {{ txn.type }}">
                                    {% if txn.type == 'load' %}
                                        <i class="fas fa-plus-circle"></i> Load
                                    {% elif txn.type == 'redeem' %}
                                        <i class="fas fa-shopping-cart"></i> Redeem
                                    {% elif txn.type == 'refund_service' %}
                                        <i class="fas fa-undo"></i> Refund
                                    {% elif txn.type == 'refund_wallet' %}
                                        <i class="fas fa-wallet"></i> Closure
                                    {% elif txn.type == 'expire' %}
                                        <i class="fas fa-clock"></i> Expired
                                    {% elif txn.type == 'adjustment' %}
                                        <i class="fas fa-edit"></i> Adjust
                                    {% endif %}
                                </span>
                            </td>

                            <!-- Points -->
                            <td>
                                {% if txn.type in ['load', 'refund_service', 'adjustment'] %}
                                    <span style="color: #10b981; font-weight: 700; font-size: 1.125rem;">
                                        +{{ "{:,}".format(txn.points) }}
                                    </span>
                                {% else %}
                                    <span style="color: #ef4444; font-weight: 700; font-size: 1.125rem;">
                                        -{{ "{:,}".format(txn.points) }}
                                    </span>
                                {% endif %}
                            </td>

                            <!-- Value -->
                            <td style="font-weight: 600;">
                                ₹{{ "{:,.2f}".format(txn.value) }}
                            </td>

                            <!-- Balance After -->
                            <td style="font-weight: 700; color: #6366f1;">
                                {{ "{:,}".format(txn.balance_after) }}
                            </td>

                            <!-- Reference -->
                            <td>
                                {% if txn.invoice_number %}
                                    <div style="font-size: 0.875rem;">
                                        <i class="fas fa-file-invoice"></i>
                                        {{ txn.invoice_number }}
                                    </div>
                                {% endif %}
                                {% if txn.payment_reference %}
                                    <div style="font-size: 0.8125rem; color: #6b7280;">
                                        Ref: {{ txn.payment_reference }}
                                    </div>
                                {% endif %}
                                {% if txn.payment_mode %}
                                    <div style="font-size: 0.8125rem; color: #6b7280;">
                                        {{ txn.payment_mode|title }}
                                    </div>
                                {% endif %}
                            </td>

                            <!-- Notes -->
                            <td style="font-size: 0.8125rem; color: #6b7280;">
                                {{ txn.notes or '-' }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination (if needed) -->
            {% if total_transactions > per_page and per_page != 'all' %}
            <div class="card-footer bg-white no-print">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <p class="mb-0 text-muted">
                            Showing {{ ((page - 1) * per_page) + 1 }} to {{ min(page * per_page, total_transactions) }} of {{ total_transactions }} transactions
                        </p>
                    </div>
                    <div class="col-md-6 text-right">
                        <nav>
                            <ul class="pagination mb-0 justify-content-end">
                                {% if page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('wallet.wallet_transactions', patient_id=patient.patient_id, page=page-1, per_page=per_page) }}">
                                        Previous
                                    </a>
                                </li>
                                {% endif %}

                                {% for p in range(1, (total_transactions // per_page) + 2) %}
                                    {% if p == page %}
                                    <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                                    {% elif p <= 3 or p >= (total_transactions // per_page) or (p >= page - 1 and p <= page + 1) %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('wallet.wallet_transactions', patient_id=patient.patient_id, page=p, per_page=per_page) }}">
                                            {{ p }}
                                        </a>
                                    </li>
                                    {% elif p == 4 or p == (total_transactions // per_page) - 1 %}
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                    {% endif %}
                                {% endfor %}

                                {% if page < (total_transactions // per_page) + 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('wallet.wallet_transactions', patient_id=patient.patient_id, page=page+1, per_page=per_page) }}">
                                        Next
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
            {% endif %}

            {% else %}
            <!-- Empty State -->
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h4>No Transactions Found</h4>
                <p>There are no wallet transactions for this patient yet.</p>
                <a href="{{ url_for('wallet.wallet_tier_management', patient_id=patient.patient_id) }}"
                   class="btn btn-primary mt-3">
                    <i class="fas fa-plus-circle"></i> Load Points
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Print button handler
    window.onbeforeprint = function() {
        document.title = 'Wallet Transactions - {{ patient.full_name }}';
    };

    window.onafterprint = function() {
        document.title = '{{ config.HOSPITAL_NAME }} - Wallet Transactions';
    };
});
</script>
{% endblock %}
