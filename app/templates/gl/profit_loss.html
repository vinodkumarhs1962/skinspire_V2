{% extends "layouts/dashboard.html" %}
{% from "components/forms.html" import input_field, select_field, date_field, checkbox_field %}
{% from "components/alerts.html" import alert %}

{% block title %}Profit and Loss Statement{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row items-start justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Profit and Loss Statement</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-1">
                View revenue, expenses, and profitability for a specified period
            </p>
        </div>
        <div class="mt-4 md:mt-0 space-x-2">
            <a href="{{ url_for('gl_views.financial_reports') }}" class="btn-secondary">
                <i class="fas fa-arrow-left mr-2"></i> Back to Reports
            </a>
            <div class="relative inline-block text-left">
                <button type="button" id="dropdown-toggle" class="btn-primary">
                    <i class="fas fa-cog mr-2"></i> Actions <i class="fas fa-chevron-down ml-2"></i>
                </button>
                <div id="dropdown-menu" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white dark:bg-gray-700 ring-1 ring-black ring-opacity-5 hidden z-10">
                    <div class="py-1" role="menu" aria-orientation="vertical">
                        <button type="button" id="print-report" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <i class="fas fa-print mr-2"></i> Print Report
                        </button>
                        <button type="button" id="export-excel" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <i class="fas fa-file-excel mr-2"></i> Export to Excel
                        </button>
                        <button type="button" id="export-pdf" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <i class="fas fa-file-pdf mr-2"></i> Export to PDF
                        </button>
                        <button type="button" id="export-csv" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <i class="fas fa-file-csv mr-2"></i> Export to CSV
                        </button>
                        <hr class="my-1 border-gray-200 dark:border-gray-600">
                        <button type="button" id="show-monthly-comparison" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <i class="fas fa-chart-line mr-2"></i> Monthly Comparison
                        </button>
                        <button type="button" id="show-quarterly-comparison" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <i class="fas fa-chart-bar mr-2"></i> Quarterly Comparison
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success or Error Alerts -->
    {% if success_message %}
    <div class="mb-6">
        {{ alert(success_message, "success") }}
    </div>
    {% endif %}
    
    {% if error_message %}
    <div class="mb-6">
        {{ alert(error_message, "error") }}
    </div>
    {% endif %}
    
    <!-- Filter/Settings Section -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6">
        <form method="GET" action="{{ url_for('gl_views.profit_loss') }}" id="profit-loss-form">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                <!-- Period Type Selection -->
                <div class="lg:col-span-2">
                    <label for="period_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Period</label>
                    <select id="period_type" name="period_type" class="form-select">
                        <option value="monthly" {% if request.args.get('period_type') == 'monthly' %}selected{% endif %}>Monthly</option>
                        <option value="quarterly" {% if request.args.get('period_type') == 'quarterly' %}selected{% endif %}>Quarterly</option>
                        <option value="yearly" {% if request.args.get('period_type') == 'yearly' %}selected{% endif %}>Yearly</option>
                        <option value="custom" {% if request.args.get('period_type') == 'custom' %}selected{% endif %}>Custom Date Range</option>
                    </select>
                </div>
                
                <!-- Month Selection (for monthly period) -->
                <div id="month-selection" class="lg:col-span-2 {{ 'hidden' if request.args.get('period_type') != 'monthly' and request.args.get('period_type') else '' }}">
                    <label for="month" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Month</label>
                    <select id="month" name="month" class="form-select">
                        <option value="1" {% if request.args.get('month') == '1' %}selected{% endif %}>January</option>
                        <option value="2" {% if request.args.get('month') == '2' %}selected{% endif %}>February</option>
                        <option value="3" {% if request.args.get('month') == '3' %}selected{% endif %}>March</option>
                        <option value="4" {% if request.args.get('month') == '4' %}selected{% endif %}>April</option>
                        <option value="5" {% if request.args.get('month') == '5' %}selected{% endif %}>May</option>
                        <option value="6" {% if request.args.get('month') == '6' %}selected{% endif %}>June</option>
                        <option value="7" {% if request.args.get('month') == '7' %}selected{% endif %}>July</option>
                        <option value="8" {% if request.args.get('month') == '8' %}selected{% endif %}>August</option>
                        <option value="9" {% if request.args.get('month') == '9' %}selected{% endif %}>September</option>
                        <option value="10" {% if request.args.get('month') == '10' %}selected{% endif %}>October</option>
                        <option value="11" {% if request.args.get('month') == '11' %}selected{% endif %}>November</option>
                        <option value="12" {% if request.args.get('month') == '12' %}selected{% endif %}>December</option>
                    </select>
                </div>
                
                <!-- Quarter Selection (for quarterly period) -->
                <div id="quarter-selection" class="lg:col-span-2 {{ 'hidden' if request.args.get('period_type') != 'quarterly' else '' }}">
                    <label for="quarter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Quarter</label>
                    <select id="quarter" name="quarter" class="form-select">
                        <option value="1" {% if request.args.get('quarter') == '1' %}selected{% endif %}>Q1 (Jan-Mar)</option>
                        <option value="2" {% if request.args.get('quarter') == '2' %}selected{% endif %}>Q2 (Apr-Jun)</option>
                        <option value="3" {% if request.args.get('quarter') == '3' %}selected{% endif %}>Q3 (Jul-Sep)</option>
                        <option value="4" {% if request.args.get('quarter') == '4' %}selected{% endif %}>Q4 (Oct-Dec)</option>
                    </select>
                </div>
                
                <!-- Year Selection (for all but custom range) -->
                <div id="year-selection" class="lg:col-span-2 {{ 'hidden' if request.args.get('period_type') == 'custom' else '' }}">
                    <label for="year" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Year</label>
                    <select id="year" name="year" class="form-select">
                        {% for year_option in available_years %}
                        <option value="{{ year_option }}" {% if request.args.get('year', current_year)|int == year_option %}selected{% endif %}>{{ year_option }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Custom Date Range Selection -->
                <div id="from-date-selection" class="lg:col-span-2 {{ 'hidden' if request.args.get('period_type') != 'custom' else '' }}">
                    <label for="from_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">From Date</label>
                    <input type="date" id="from_date" name="from_date" class="form-input" value="{{ request.args.get('from_date', '') }}">
                </div>
                
                <div id="to-date-selection" class="lg:col-span-2 {{ 'hidden' if request.args.get('period_type') != 'custom' else '' }}">
                    <label for="to_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">To Date</label>
                    <input type="date" id="to_date" name="to_date" class="form-input" value="{{ request.args.get('to_date', '') }}">
                </div>
                
                <!-- Branch Selection -->
                <div class="lg:col-span-2">
                    <label for="branch_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Branch</label>
                    <select id="branch_id" name="branch_id" class="form-select">
                        <option value="">All Branches</option>
                        {% for branch in branches %}
                        <option value="{{ branch.branch_id }}" {% if request.args.get('branch_id') == branch.branch_id %}selected{% endif %}>
                            {{ branch.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Comparison Options -->
                <div class="lg:col-span-4">
                    <label for="comparison_with" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Compare With</label>
                    <select id="comparison_with" name="comparison_with" class="form-select">
                        <option value="" {% if not request.args.get('comparison_with') %}selected{% endif %}>No Comparison</option>
                        <option value="previous_period" {% if request.args.get('comparison_with') == 'previous_period' %}selected{% endif %}>Previous Period</option>
                        <option value="same_period_last_year" {% if request.args.get('comparison_with') == 'same_period_last_year' %}selected{% endif %}>Same Period Last Year</option>
                        <option value="budget" {% if request.args.get('comparison_with') == 'budget' %}selected{% endif %}>Budget</option>
                    </select>
                </div>
                
                <!-- Detail Level -->
                <div class="lg:col-span-3">
                    <label for="detail_level" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Detail Level</label>
                    <select id="detail_level" name="detail_level" class="form-select">
                        <option value="summary" {% if request.args.get('detail_level') == 'summary' %}selected{% endif %}>Summary</option>
                        <option value="detailed" {% if request.args.get('detail_level') == 'detailed' %}selected{% endif %}>Detailed</option>
                        <option value="comprehensive" {% if request.args.get('detail_level') == 'comprehensive' %}selected{% endif %}>Comprehensive</option>
                    </select>
                </div>
                
                <!-- Include Zero Balances -->
                <div class="lg:col-span-3">
                    <div class="flex items-center mt-6">
                        <input id="include_zero_balances" name="include_zero_balances" type="checkbox" class="form-checkbox" {% if request.args.get('include_zero_balances') == 'on' %}checked{% endif %}>
                        <label for="include_zero_balances" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
                            Include accounts with zero balances
                        </label>
                    </div>
                </div>
                
                <!-- Apply Filters Button -->
                <div class="lg:col-span-6 flex justify-end items-center mt-2">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-sync-alt mr-2"></i> Generate Report
                    </button>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Financial Performance Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Revenue -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Total Revenue</p>
            <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">{{ total_revenue|currencyformat }}</h3>
            {% if comparison_data and comparison_data.total_revenue %}
            <div class="flex items-center mt-2 text-sm">
                {% if comparison_data.total_revenue_change > 0 %}
                <span class="text-green-600 dark:text-green-400 flex items-center">
                    <i class="fas fa-arrow-up mr-1"></i> {{ comparison_data.total_revenue_change }}%
                </span>
                {% elif comparison_data.total_revenue_change < 0 %}
                <span class="text-red-600 dark:text-red-400 flex items-center">
                    <i class="fas fa-arrow-down mr-1"></i> {{ comparison_data.total_revenue_change|abs }}%
                </span>
                {% else %}
                <span class="text-gray-500 dark:text-gray-400 flex items-center">
                    <i class="fas fa-minus mr-1"></i> 0%
                </span>
                {% endif %}
                <span class="ml-2 text-gray-500 dark:text-gray-400">vs {{ comparison_period_text }}</span>
            </div>
            {% endif %}
        </div>
        
        <!-- Expenses -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Total Expenses</p>
            <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">{{ total_expenses|currencyformat }}</h3>
            {% if comparison_data and comparison_data.total_expenses %}
            <div class="flex items-center mt-2 text-sm">
                {% if comparison_data.total_expenses_change < 0 %}
                <span class="text-green-600 dark:text-green-400 flex items-center">
                    <i class="fas fa-arrow-down mr-1"></i> {{ comparison_data.total_expenses_change|abs }}%
                </span>
                {% elif comparison_data.total_expenses_change > 0 %}
                <span class="text-red-600 dark:text-red-400 flex items-center">
                    <i class="fas fa-arrow-up mr-1"></i> {{ comparison_data.total_expenses_change }}%
                </span>
                {% else %}
                <span class="text-gray-500 dark:text-gray-400 flex items-center">
                    <i class="fas fa-minus mr-1"></i> 0%
                </span>
                {% endif %}
                <span class="ml-2 text-gray-500 dark:text-gray-400">vs {{ comparison_period_text }}</span>
            </div>
            {% endif %}
        </div>
        
        <!-- Net Profit -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Net Profit</p>
            <h3 class="text-xl font-bold {{ 'text-green-600 dark:text-green-400' if net_profit >= 0 else 'text-red-600 dark:text-red-400' }}">
                {{ net_profit|currencyformat }}
            </h3>
            {% if comparison_data and comparison_data.net_profit %}
            <div class="flex items-center mt-2 text-sm">
                {% if comparison_data.net_profit_change > 0 %}
                <span class="text-green-600 dark:text-green-400 flex items-center">
                    <i class="fas fa-arrow-up mr-1"></i> {{ comparison_data.net_profit_change }}%
                </span>
                {% elif comparison_data.net_profit_change < 0 %}
                <span class="text-red-600 dark:text-red-400 flex items-center">
                    <i class="fas fa-arrow-down mr-1"></i> {{ comparison_data.net_profit_change|abs }}%
                </span>
                {% else %}
                <span class="text-gray-500 dark:text-gray-400 flex items-center">
                    <i class="fas fa-minus mr-1"></i> 0%
                </span>
                {% endif %}
                <span class="ml-2 text-gray-500 dark:text-gray-400">vs {{ comparison_period_text }}</span>
            </div>
            {% endif %}
        </div>
        
        <!-- Profit Margin -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Profit Margin</p>
            <h3 class="text-xl font-bold {{ 'text-green-600 dark:text-green-400' if profit_margin >= 0 else 'text-red-600 dark:text-red-400' }}">
                {{ profit_margin|round(2) }}%
            </h3>
            {% if comparison_data and comparison_data.profit_margin %}
            <div class="flex items-center mt-2 text-sm">
                {% if comparison_data.profit_margin_change > 0 %}
                <span class="text-green-600 dark:text-green-400 flex items-center">
                    <i class="fas fa-arrow-up mr-1"></i> {{ comparison_data.profit_margin_change }}%
                </span>
                {% elif comparison_data.profit_margin_change < 0 %}
                <span class="text-red-600 dark:text-red-400 flex items-center">
                    <i class="fas fa-arrow-down mr-1"></i> {{ comparison_data.profit_margin_change|abs }}%
                </span>
                {% else %}
                <span class="text-gray-500 dark:text-gray-400 flex items-center">
                    <i class="fas fa-minus mr-1"></i> 0%
                </span>
                {% endif %}
                <span class="ml-2 text-gray-500 dark:text-gray-400">vs {{ comparison_period_text }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Report Header -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
        <div class="text-center">
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100">{{ hospital.name }}</h2>
            <p class="text-gray-600 dark:text-gray-400">
                Profit and Loss Statement
                {% if branch %}
                - {{ branch.name }}
                {% endif %}
            </p>
            <p class="text-gray-600 dark:text-gray-400">
                For the period {{ report_period_text }}
            </p>
        </div>
    </div>
    
    <!-- Financial Performance Chart -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md mb-6">
        <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
            <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Financial Performance</h2>
        </div>
        
        <div class="p-6">
            <div class="h-64" id="financial-performance-chart"></div>
        </div>
    </div>
    
    <!-- Profit & Loss Statement Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md mb-6">
        <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
            <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Income Statement</h2>
        </div>
        
        <div class="p-6">
            {% if statement_data %}
            <div class="overflow-x-auto">
                <table class="min-w-full table-auto" id="profit-loss-table">
                    <thead>
                        <tr class="bg-gray-50 dark:bg-gray-700">
                            <th class="px-4 py-2 text-left text-gray-500 dark:text-gray-300 font-medium text-xs uppercase tracking-wider">Account</th>
                            <th class="px-4 py-2 text-right text-gray-500 dark:text-gray-300 font-medium text-xs uppercase tracking-wider">Current Period</th>
                            {% if comparison_data %}
                            <th class="px-4 py-2 text-right text-gray-500 dark:text-gray-300 font-medium text-xs uppercase tracking-wider">{{ comparison_period_text }}</th>
                            <th class="px-4 py-2 text-right text-gray-500 dark:text-gray-300 font-medium text-xs uppercase tracking-wider">Variance</th>
                            <th class="px-4 py-2 text-right text-gray-500 dark:text-gray-300 font-medium text-xs uppercase tracking-wider">% Change</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Revenue Section -->
                        <tr class="bg-gray-100 dark:bg-gray-600">
                            <td colspan="{{ 5 if comparison_data else 2 }}" class="px-4 py-2 font-semibold text-gray-700 dark:text-gray-200">
                                Revenue
                            </td>
                        </tr>
                        
                        {% for item in statement_data.revenue %}
                        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'font-semibold' if item.is_category else '' }}">
                            <td class="px-4 py-3 text-gray-800 dark:text-gray-200">
                                <div class="{{ 'pl-4' if not item.is_category else '' }}">
                                    {{ item.account_name }}
                                </div>
                            </td>
                            <td class="px-4 py-3 text-right {{ 'text-gray-800 dark:text-gray-200 font-medium' if item.amount != 0 else 'text-gray-500 dark:text-gray-400' }}">
                                {{ item.amount|currencyformat }}
                            </td>
                            {% if comparison_data %}
                            <td class="px-4 py-3 text-right {{ 'text-gray-800 dark:text-gray-200 font-medium' if item.comparison_amount != 0 else 'text-gray-500 dark:text-gray-400' }}">
                                {{ item.comparison_amount|currencyformat if item.comparison_amount != None else '-' }}
                            </td>
                            <td class="px-4 py-3 text-right {{ 'text-gray-800 dark:text-gray-200 font-medium' if item.variance != 0 else 'text-gray-500 dark:text-gray-400' }}">
                                {{ item.variance|currencyformat if item.variance != None else '-' }}
                            <td class="px-4 py-3 text-right 
                                {{ 'text-red-600 dark:text-red-400 font-medium' if item.percent_change > 0 else 
                                   'text-green-600 dark:text-green-400 font-medium' if item.percent_change < 0 else 
                                   'text-gray-500 dark:text-gray-400' }}">
                                {{ (item.percent_change|string + '%') if item.percent_change != None else '-' }}
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                        
                        <!-- Total Revenue Row -->
                        <tr class="border-b dark:border-gray-700 bg-blue-50 dark:bg-blue-900/20 font-semibold">
                            <td class="px-4 py-3 text-gray-800 dark:text-gray-200">
                                Total Revenue
                            </td>
                            <td class="px-4 py-3 text-right text-gray-800 dark:text-gray-200">
                                {{ total_revenue|currencyformat }}
                            </td>
                            {% if comparison_data %}
                            <td class="px-4 py-3 text-right text-gray-800 dark:text-gray-200">
                                {{ comparison_data.total_revenue|currencyformat if comparison_data.total_revenue != None else '-' }}
                            </td>
                            <td class="px-4 py-3 text-right text-gray-800 dark:text-gray-200">
                                {{ comparison_data.total_revenue_variance|currencyformat if comparison_data.total_revenue_variance != None else '-' }}
                            </td>
                            <td class="px-4 py-3 text-right 
                                {{ 'text-green-600 dark:text-green-400' if comparison_data.total_revenue_change > 0 else 
                                   'text-red-600 dark:text-red-400' if comparison_data.total_revenue_change < 0 else 
                                   'text-gray-800 dark:text-gray-200' }}">
                                {{ (comparison_data.total_revenue_change|string + '%') if comparison_data.total_revenue_change != None else '-' }}
                            </td>
                            {% endif %}
                        </tr>
                        
                        <!-- Expenses Section -->
                        <tr class="bg-gray-100 dark:bg-gray-600">
                            <td colspan="{{ 5 if comparison_data else 2 }}" class="px-4 py-2 font-semibold text-gray-700 dark:text-gray-200">
                                Expenses
                            </td>
                        </tr>
                        
                        {% for item in statement_data.expenses %}
                        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'font-semibold' if item.is_category else '' }}">
                            <td class="px-4 py-3 text-gray-800 dark:text-gray-200">
                                <div class="{{ 'pl-4' if not item.is_category else '' }}">
                                    {{ item.account_name }}
                                </div>
                            </td>
                            <td class="px-4 py-3 text-right {{ 'text-gray-800 dark:text-gray-200 font-medium' if item.amount != 0 else 'text-gray-500 dark:text-gray-400' }}">
                                {{ item.amount|currencyformat }}
                            </td>
                            {% if comparison_data %}
                            <td class="px-4 py-3 text-right {{ 'text-gray-800 dark:text-gray-200 font-medium' if item.comparison_amount != 0 else 'text-gray-500 dark:text-gray-400' }}">
                                {{ item.comparison_amount|currencyformat if item.comparison_amount != None else '-' }}
                            </td>
                            <td class="px-4 py-3 text-right {{ 'text-gray-800 dark:text-gray-200 font-medium' if item.variance != 0 else 'text-gray-500 dark:text-gray-400' }}">
                                {{ item.variance|currencyformat if item.variance != None else '-' }}
                            </td>
                            <td class="px-4 py-3 text-right 
                                {{ 'text-red-600 dark:text-red-400 font-medium' if item.percent_change > 0 else 
                                   'text-green-600 dark:text-green-400 font-medium' if item.percent_change < 0 else 
                                   'text-gray-500 dark:text-gray-400' }}">
                                {{ (item.percent_change|string{{ (item.percent_change|string + '%') if item.percent_change != None else '-' }}
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                        
                        <!-- Total Expenses Row -->
                        <tr class="border-b dark:border-gray-700 bg-blue-50 dark:bg-blue-900/20 font-semibold">
                            <td class="px-4 py-3 text-gray-800 dark:text-gray-200">
                                Total Expenses
                            </td>
                            <td class="px-4 py-3 text-right text-gray-800 dark:text-gray-200">
                                {{ total_expenses|currencyformat }}
                            </td>
                            {% if comparison_data %}
                            <td class="px-4 py-3 text-right text-gray-800 dark:text-gray-200">
                                {{ comparison_data.total_expenses|currencyformat if comparison_data.total_expenses != None else '-' }}
                            </td>
                            <td class="px-4 py-3 text-right text-gray-800 dark:text-gray-200">
                                {{ comparison_data.total_expenses_variance|currencyformat if comparison_data.total_expenses_variance != None else '-' }}
                            </td>
                            <td class="px-4 py-3 text-right 
                                {{ 'text-red-600 dark:text-red-400' if comparison_data.total_expenses_change > 0 else 
                                   'text-green-600 dark:text-green-400' if comparison_data.total_expenses_change < 0 else 
                                   'text-gray-800 dark:text-gray-200' }}">
                                {{ (comparison_data.total_expenses_change|string + '%') if comparison_data.total_expenses_change != None else '-' }}
                            </td>
                            {% endif %}
                        </tr>
                        
                        <!-- Net Profit Row -->
                        <tr class="border-b dark:border-gray-700 bg-gray-100 dark:bg-gray-600 font-bold">
                            <td class="px-4 py-3 text-gray-800 dark:text-gray-200">
                                Net Profit
                            </td>
                            <td class="px-4 py-3 text-right {{ 'text-green-600 dark:text-green-400' if net_profit >= 0 else 'text-red-600 dark:text-red-400' }}">
                                {{ net_profit|currencyformat }}
                            </td>
                            {% if comparison_data %}
                            <td class="px-4 py-3 text-right {{ 'text-green-600 dark:text-green-400' if comparison_data.net_profit >= 0 else 'text-red-600 dark:text-red-400' }}">
                                {{ comparison_data.net_profit|currencyformat if comparison_data.net_profit != None else '-' }}
                            </td>
                            <td class="px-4 py-3 text-right {{ 'text-green-600 dark:text-green-400' if comparison_data.net_profit_variance >= 0 else 'text-red-600 dark:text-red-400' }}">
                                {{ comparison_data.net_profit_variance|currencyformat if comparison_data.net_profit_variance != None else '-' }}
                            </td>
                            <td class="px-4 py-3 text-right 
                                {{ 'text-green-600 dark:text-green-400' if comparison_data.net_profit_change > 0 else 
                                   'text-red-600 dark:text-red-400' if comparison_data.net_profit_change < 0 else 
                                   'text-gray-800 dark:text-gray-200' }}">
                                {{ (comparison_data.net_profit_change|string + '%') if comparison_data.net_profit_change != None else '-' }}
                            </td>
                            {% endif %}
                        </tr>
                        
                        <!-- Profit Margin Row -->
                        <tr class="bg-gray-50 dark:bg-gray-700 font-semibold">
                            <td class="px-4 py-3 text-gray-800 dark:text-gray-200">
                                Profit Margin
                            </td>
                            <td class="px-4 py-3 text-right {{ 'text-green-600 dark:text-green-400' if profit_margin >= 0 else 'text-red-600 dark:text-red-400' }}">
                                {{ profit_margin|round(2) }}%
                            </td>
                            {% if comparison_data %}
                            <td class="px-4 py-3 text-right {{ 'text-green-600 dark:text-green-400' if comparison_data.profit_margin >= 0 else 'text-red-600 dark:text-red-400' }}">
                                {{ (comparison_data.profit_margin|round(2)|string + '%') if comparison_data.profit_margin != None else '-' }}
                            </td>
                            <td class="px-4 py-3 text-right {{ 'text-green-600 dark:text-green-400' if comparison_data.profit_margin_variance >= 0 else 'text-red-600 dark:text-red-400' }}">
                                {{ (comparison_data.profit_margin_variance|round(2)|string + '%') if comparison_data.profit_margin_variance != None else '-' }}
                            </td>
                            <td class="px-4 py-3 text-right 
                                {{ 'text-green-600 dark:text-green-400' if comparison_data.profit_margin_change > 0 else 
                                   'text-red-600 dark:text-red-400' if comparison_data.profit_margin_change < 0 else 
                                   'text-gray-800 dark:text-gray-200' }}">
                                {{ (comparison_data.profit_margin_change|string + '%') if comparison_data.profit_margin_change != None else '-' }}
                            </td>
                            {% endif %}
                        </tr>
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-8">
                <i class="fas fa-chart-line text-gray-400 text-5xl mb-4"></i>
                <p class="text-gray-600 dark:text-gray-400">No statement data available for the selected criteria</p>
                <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">Try adjusting your filters or check your chart of accounts</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Revenue Breakdown Chart -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
            <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Revenue Breakdown</h2>
            </div>
            
            <div class="p-6">
                <div class="h-64" id="revenue-breakdown-chart"></div>
            </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
            <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Expense Breakdown</h2>
            </div>
            
            <div class="p-6">
                <div class="h-64" id="expense-breakdown-chart"></div>
            </div>
        </div>
    </div>
    
    <!-- Additional Analysis and Notes -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md mb-6">
        <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
            <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Analysis & Notes</h2>
        </div>
        
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Key Performance Indicators -->
                <div>
                    <h3 class="text-md font-medium text-gray-700 dark:text-gray-300 mb-3 border-b border-gray-200 dark:border-gray-700 pb-2">Key Metrics</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Revenue Per Patient:</span>
                            <span class="font-medium text-gray-800 dark:text-gray-200">{{ revenue_per_patient|currencyformat if revenue_per_patient else 'N/A' }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Cost Per Patient:</span>
                            <span class="font-medium text-gray-800 dark:text-gray-200">{{ cost_per_patient|currencyformat if cost_per_patient else 'N/A' }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Operating Margin:</span>
                            <span class="font-medium {{ 'text-green-600 dark:text-green-400' if operating_margin >= 0 else 'text-red-600 dark:text-red-400' }}">
                                {{ operating_margin|round(2) }}% if operating_margin else 'N/A' }}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Top Revenue Source:</span>
                            <span class="font-medium text-gray-800 dark:text-gray-200">{{ top_revenue_source if top_revenue_source else 'N/A' }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Top Expense Category:</span>
                            <span class="font-medium text-gray-800 dark:text-gray-200">{{ top_expense_category if top_expense_category else 'N/A' }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Trend Analysis -->
                <div>
                    <h3 class="text-md font-medium text-gray-700 dark:text-gray-300 mb-3 border-b border-gray-200 dark:border-gray-700 pb-2">Trend Analysis</h3>
                    <div class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
                        {% if trend_analysis %}
                        {% for trend in trend_analysis %}
                        <p>
                            <i class="{{ trend.icon }} mr-1 {{ trend.color }}"></i>
                            {{ trend.text }}
                        </p>
                        {% endfor %}
                        {% else %}
                        <p>Trend analysis not available. Enable comparison with previous periods to see trends.</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Recommendations -->
                <div>
                    <h3 class="text-md font-medium text-gray-700 dark:text-gray-300 mb-3 border-b border-gray-200 dark:border-gray-700 pb-2">Recommendations</h3>
                    <div class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
                        {% if recommendations %}
                        {% for recommendation in recommendations %}
                        <p>
                            <i class="fas fa-lightbulb mr-1 text-yellow-500"></i>
                            {{ recommendation }}
                        </p>
                        {% endfor %}
                        {% else %}
                        <p>Analysis-based recommendations not available for the selected period.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Accountant Notes -->
            {% if accountant_notes %}
            <div class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-4">
                <h3 class="text-md font-medium text-gray-700 dark:text-gray-300 mb-3">Accountant Notes</h3>
                <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <p class="text-gray-600 dark:text-gray-400">{{ accountant_notes }}</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Comparison Modal -->
    <div id="comparison-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 dark:bg-gray-800 opacity-75"></div>
            </div>
            
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100" id="comparison-modal-title">
                                Monthly Comparison
                            </h3>
                            
                            <div class="mt-4">
                                <div class="h-80" id="comparison-chart"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" id="close-comparison-modal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dropdown toggle functionality
    const dropdownToggle = document.getElementById('dropdown-toggle');
    const dropdownMenu = document.getElementById('dropdown-menu');
    
    if (dropdownToggle && dropdownMenu) {
        dropdownToggle.addEventListener('click', function() {
            dropdownMenu.classList.toggle('hidden');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            if (!dropdownToggle.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.add('hidden');
            }
        });
    }
    
    // Period type change handler
    const periodTypeSelect = document.getElementById('period_type');
    const monthSelection = document.getElementById('month-selection');
    const quarterSelection = document.getElementById('quarter-selection');
    const yearSelection = document.getElementById('year-selection');
    const fromDateSelection = document.getElementById('from-date-selection');
    const toDateSelection = document.getElementById('to-date-selection');
    
    if (periodTypeSelect) {
        periodTypeSelect.addEventListener('change', function() {
            const periodType = this.value;
            
            // Show/hide period selection fields based on period type
            if (monthSelection) monthSelection.classList.toggle('hidden', periodType !== 'monthly');
            if (quarterSelection) quarterSelection.classList.toggle('hidden', periodType !== 'quarterly');
            if (yearSelection) yearSelection.classList.toggle('hidden', periodType === 'custom');
            if (fromDateSelection) fromDateSelection.classList.toggle('hidden', periodType !== 'custom');
            if (toDateSelection) toDateSelection.classList.toggle('hidden', periodType !== 'custom');
        });
    }
    
    // Print functionality
    const printReportBtn = document.getElementById('print-report');
    if (printReportBtn) {
        printReportBtn.addEventListener('click', function() {
            window.print();
        });
    }
    
    // Export to Excel functionality
    const exportExcelBtn = document.getElementById('export-excel');
    if (exportExcelBtn) {
        exportExcelBtn.addEventListener('click', function() {
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('export', 'excel');
            window.location.href = currentUrl.toString();
        });
    }
    
    // Export to PDF functionality
    const exportPdfBtn = document.getElementById('export-pdf');
    if (exportPdfBtn) {
        exportPdfBtn.addEventListener('click', function() {
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('export', 'pdf');
            window.location.href = currentUrl.toString();
        });
    }
    
    // Export to CSV functionality
    const exportCsvBtn = document.getElementById('export-csv');
    if (exportCsvBtn) {
        exportCsvBtn.addEventListener('click', function() {
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('export', 'csv');
            window.location.href = currentUrl.toString();
        });
    }
    
    // Financial Performance Chart
    const financialPerformanceChart = document.getElementById('financial-performance-chart');
    if (financialPerformanceChart) {
        const ctx = financialPerformanceChart.getContext('2d');
        const isDarkMode = document.querySelector('html').classList.contains('dark');
        const textColor = isDarkMode ? '#D1D5DB' : '#4B5563';
        const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Revenue', 'Expenses', 'Net Profit'],
                datasets: [
                    {
                        label: 'Current Period',
                        data: [
                            {{ total_revenue }},
                            {{ total_expenses }},
                            {{ net_profit }}
                        ],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.7)', // Green for revenue
                            'rgba(239, 68, 68, 0.7)',  // Red for expenses
                            {{ 'rgba(59, 130, 246, 0.7)' if net_profit >= 0 else 'rgba(239, 68, 68, 0.7)' }} // Blue or red for net profit
                        ],
                        borderWidth: 1
                    },
                    {% if comparison_data %}
                    {
                        label: '{{ comparison_period_text }}',
                        data: [
                            {{ comparison_data.total_revenue if comparison_data.total_revenue != None else 0 }},
                            {{ comparison_data.total_expenses if comparison_data.total_expenses != None else 0 }},
                            {{ comparison_data.net_profit if comparison_data.net_profit != None else 0 }}
                        ],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.3)', // Green for revenue
                            'rgba(239, 68, 68, 0.3)',  // Red for expenses
                            {{ 'rgba(59, 130, 246, 0.3)' if comparison_data.net_profit >= 0 else 'rgba(239, 68, 68, 0.3)' }} // Blue or red for net profit
                        ],
                        borderWidth: 1
                    }
                    {% endif %}
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: {{ 'true' if comparison_data else 'false' }},
                        labels: {
                            color: textColor
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-IN', {
                                        style: 'currency',
                                        currency: 'INR'
                                    }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: gridColor
                        },
                        ticks: {
                            color: textColor
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: gridColor
                        },
                        ticks: {
                            color: textColor,
                            callback: function(value) {
                                return new Intl.NumberFormat('en-IN', {
                                    style: 'currency',
                                    currency: 'INR',
                                    notation: 'compact',
                                    compactDisplay: 'short'
                                }).format(value);
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Revenue Breakdown Chart
    const revenueBreakdownChart = document.getElementById('revenue-breakdown-chart');
    if (revenueBreakdownChart && {{ revenue_breakdown|tojson if revenue_breakdown else 'false' }}) {
        const ctx = revenueBreakdownChart.getContext('2d');
        const isDarkMode = document.querySelector('html').classList.contains('dark');
        const textColor = isDarkMode ? '#D1D5DB' : '#4B5563';
        
        const revenueData = {{ revenue_breakdown.data|tojson if revenue_breakdown and revenue_breakdown.data else '[]'|safe }};
        const revenueLabels = {{ revenue_breakdown.labels|tojson if revenue_breakdown and revenue_breakdown.labels else '[]'|safe }};
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: revenueLabels,
                datasets: [{
                    data: revenueData,
                    backgroundColor: [
                        'rgba(16, 185, 129, 0.7)',  // Green
                        'rgba(59, 130, 246, 0.7)',  // Blue
                        'rgba(245, 158, 11, 0.7)',  // Yellow
                        'rgba(139, 92, 246, 0.7)',  // Purple
                        'rgba(236, 72, 153, 0.7)',  // Pink
                        'rgba(6, 182, 212, 0.7)'    // Cyan
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: textColor
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const formattedValue = new Intl.NumberFormat('en-IN', {
                                    style: 'currency',
                                    currency: 'INR'
                                }).format(value);
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                
                                return `${label}: ${formattedValue} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Expense Breakdown Chart
    const expenseBreakdownChart = document.getElementById('expense-breakdown-chart');
    if (expenseBreakdownChart && {{ expense_breakdown|tojson if expense_breakdown else 'false' }}) {
        const ctx = expenseBreakdownChart.getContext('2d');
        const isDarkMode = document.querySelector('html').classList.contains('dark');
        const textColor = isDarkMode ? '#D1D5DB' : '#4B5563';
        
        const expenseData = {{ expense_breakdown.data|tojson if expense_breakdown and expense_breakdown.data else '[]'|safe }};
        const expenseLabels = {{ expense_breakdown.labels|tojson if expense_breakdown and expense_breakdown.labels else '[]'|safe }};
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: expenseLabels,
                datasets: [{
                    data: expenseData,
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.7)',   // Red
                        'rgba(249, 115, 22, 0.7)',  // Orange
                        'rgba(245, 158, 11, 0.7)',  // Yellow
                        'rgba(16, 185, 129, 0.7)',  // Green
                        'rgba(59, 130, 246, 0.7)',  // Blue
                        'rgba(139, 92, 246, 0.7)'   // Purple
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: textColor
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const formattedValue = new Intl.NumberFormat('en-IN', {
                                    style: 'currency',
                                    currency: 'INR'
                                }).format(value);
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                
                                return `${label}: ${formattedValue} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Monthly Comparison Modal and Chart
    const showMonthlyComparisonBtn = document.getElementById('show-monthly-comparison');
    const showQuarterlyComparisonBtn = document.getElementById('show-quarterly-comparison');
    const comparisonModal = document.getElementById('comparison-modal');
    const closeComparisonModalBtn = document.getElementById('close-comparison-modal');
    const comparisonModalTitle = document.getElementById('comparison-modal-title');
    
    function openComparisonModal(type) {
        if (comparisonModal) {
            comparisonModal.classList.remove('hidden');
            
            if (comparisonModalTitle) {
                comparisonModalTitle.textContent = type === 'monthly' ? 'Monthly Comparison' : 'Quarterly Comparison';
            }
            
            renderComparisonChart(type);
        }
    }
    
    function closeComparisonModal() {
        if (comparisonModal) {
            comparisonModal.classList.add('hidden');
        }
    }
    
    if (showMonthlyComparisonBtn) {
        showMonthlyComparisonBtn.addEventListener('click', function() {
            openComparisonModal('monthly');
        });
    }
    
    if (showQuarterlyComparisonBtn) {
        showQuarterlyComparisonBtn.addEventListener('click', function() {
            openComparisonModal('quarterly');
        });
    }
    
    if (closeComparisonModalBtn) {
        closeComparisonModalBtn.addEventListener('click', closeComparisonModal);
    }
    
    // Close modal when clicking outside
    if (comparisonModal) {
        comparisonModal.addEventListener('click', function(event) {
            if (event.target === comparisonModal) {
                closeComparisonModal();
            }
        });
    }
    
    function renderComparisonChart(type) {
        const comparisonChart = document.getElementById('comparison-chart');
        if (!comparisonChart) return;
        
        // Clear existing chart if any
        if (comparisonChart._chart) {
            comparisonChart._chart.destroy();
        }
        
        const ctx = comparisonChart.getContext('2d');
        const isDarkMode = document.querySelector('html').classList.contains('dark');
        const textColor = isDarkMode ? '#D1D5DB' : '#4B5563';
        const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        
        // Get comparison data based on type
        let labels, revenueData, expenseData, profitData;
        
        if (type === 'monthly') {
            labels = {{ monthly_comparison.labels|tojson if monthly_comparison and monthly_comparison.labels else '[]'|safe }};
            revenueData = {{ monthly_comparison.revenueData = {{ monthly_comparison.revenue|tojson if monthly_comparison and monthly_comparison.revenue else '[]'|safe }};
            expenseData = {{ monthly_comparison.expenses|tojson if monthly_comparison and monthly_comparison.expenses else '[]'|safe }};
            profitData = {{ monthly_comparison.profit|tojson if monthly_comparison and monthly_comparison.profit else '[]'|safe }};
        } else {
            labels = {{ quarterly_comparison.labels|tojson if quarterly_comparison and quarterly_comparison.labels else '[]'|safe }};
            revenueData = {{ quarterly_comparison.revenue|tojson if quarterly_comparison and quarterly_comparison.revenue else '[]'|safe }};
            expenseData = {{ quarterly_comparison.expenses|tojson if quarterly_comparison and quarterly_comparison.expenses else '[]'|safe }};
            profitData = {{ quarterly_comparison.profit|tojson if quarterly_comparison and quarterly_comparison.profit else '[]'|safe }};
        }
        
        // Create the chart
        comparisonChart._chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Revenue',
                        data: revenueData,
                        backgroundColor: 'rgba(16, 185, 129, 0.7)', // Green
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Expenses',
                        data: expenseData,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)', // Red
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Net Profit',
                        data: profitData,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)', // Blue
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        type: 'line',
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            color: textColor
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-IN', {
                                        style: 'currency',
                                        currency: 'INR'
                                    }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: gridColor
                        },
                        ticks: {
                            color: textColor
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: gridColor
                        },
                        ticks: {
                            color: textColor,
                            callback: function(value) {
                                return new Intl.NumberFormat('en-IN', {
                                    style: 'currency',
                                    currency: 'INR',
                                    notation: 'compact',
                                    compactDisplay: 'short'
                                }).format(value);
                            }
                        }
                    },
                    y1: {
                        position: 'right',
                        beginAtZero: true,
                        grid: {
                            drawOnChartArea: false
                        },
                        ticks: {
                            color: textColor,
                            callback: function(value) {
                                return new Intl.NumberFormat('en-IN', {
                                    style: 'currency',
                                    currency: 'INR',
                                    notation: 'compact',
                                    compactDisplay: 'short'
                                }).format(value);
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}