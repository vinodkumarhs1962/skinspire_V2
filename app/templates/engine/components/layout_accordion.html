<!-- templates/engine/components/layout_accordion.html -->
<!-- Exact extraction from working universal_view.html with custom renderer logic intact -->
<div class="universal-accordion-view">
    {% for tab in assembled_data.field_sections %}
        {% for section in tab.sections %}
            <div class="universal-accordion-section bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 mb-4">
                <!-- Accordion Header (Clickable) -->
                <button type="button" 
                        class="universal-accordion-header w-full px-6 py-4 bg-gray-50 dark:bg-gray-900 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-200 flex items-center justify-between text-left"
                        onclick="toggleAccordion('{{ tab.key }}_{{ section.key }}')">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 flex items-center">
                        {% if section.icon %}
                            <i class="{{ section.icon }} mr-2 text-gray-500 dark:text-gray-400"></i>
                        {% endif %}
                        {{ section.title }}
                    </h3>
                    <i class="fas fa-chevron-down text-gray-500 dark:text-gray-400 transition-transform duration-200" id="chevron-{{ tab.key }}_{{ section.key }}"></i>
                </button>
                
                <!-- Accordion Content -->
                <div id="content-{{ tab.key }}_{{ section.key }}" class="universal-accordion-content {% if not loop.first %}hidden{% endif %}">
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-{{ section.columns or 2 }} gap-6">
                            {% for field in section.fields|sort(attribute='view_order') %}
                                <div class="{{ field['css_class'] }} {% if field['columns_span'] == 'full' or (field['custom_renderer'] and 'table-responsive' in field['custom_renderer'].get('css_classes', '')) %}md:col-span-{{ section.columns or 2 }}{% endif %}">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                        {{ field['label'] }}
                                    </label>
                                    <!-- Check if this field has a custom renderer -->
                                    {% if field['is_custom_renderer'] and field['custom_renderer'] %}
                                        <div class="custom-renderer-field {{ field['custom_renderer']['css_classes'] }}">
                                        {% if field['custom_renderer']['context_function'] and service %}
                                            {% set func_name = field['custom_renderer']['context_function'] %}
                                            
                                            <!-- ✅ UNIVERSAL: All methods use same parameter pattern -->
                                            {% if func_name == 'get_po_items_for_payment' and hasattr(service, 'get_po_items_for_payment') %}
                                                {% set data = service.get_po_items_for_payment(item_id=item_id, item=item, hospital_id=current_hospital_id, branch_id=current_branch_id) %}
                                                
                                            {% elif func_name == 'get_invoice_items_for_payment' and hasattr(service, 'get_invoice_items_for_payment') %}
                                                {% set data = service.get_invoice_items_for_payment(item_id=item_id, item=item, hospital_id=current_hospital_id, branch_id=current_branch_id) %}
                                                
                                            {% elif func_name == 'get_supplier_payment_history_6months' and hasattr(service, 'get_supplier_payment_history_6months') %}
                                                {% set data = service.get_supplier_payment_history_6months(item_id=item_id, item=item, hospital_id=current_hospital_id, branch_id=current_branch_id) %}
                                                
                                            {% elif func_name == 'get_payment_workflow_timeline' and hasattr(service, 'get_payment_workflow_timeline') %}
                                                {% set data = service.get_payment_workflow_timeline(item_id=item_id, item=item, hospital_id=current_hospital_id, branch_id=current_branch_id) %}
                                                
                                            {% elif func_name == 'get_supplier_payment_summary' and hasattr(service, 'get_supplier_payment_summary') %}
                                                {% set data = service.get_supplier_payment_summary(item_id=item_id, item=item, hospital_id=current_hospital_id, branch_id=current_branch_id) %}
                                                
                                            {% elif func_name == 'get_supplier_invoice_history' and hasattr(service, 'get_supplier_invoice_history') %}
                                                {% set data = service.get_supplier_invoice_history(item_id=item_id, item=item, hospital_id=current_hospital_id, branch_id=current_branch_id) %}
                                                
                                            {% else %}
                                                <!-- Unknown function - show error -->
                                                {% set data = {'error': 'Unknown context function: ' ~ func_name, 'has_error': true} %}
                                            {% endif %}
                                            
                                            <!-- Include the custom template with the data -->
                                            {% if data and not data.get('has_error') %}
                                                {% include field['custom_renderer']['template'] %}
                                            {% else %}
                                                <div class="text-center py-4">
                                                    <i class="fas fa-info-circle text-3xl text-gray-300 dark:text-gray-600 mb-2"></i>
                                                    <p class="text-gray-500 dark:text-gray-400 text-sm">
                                                        {{ data.get('error', 'No data available') }}
                                                    </p>
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <!-- Custom renderer without context function - just include template -->
                                            {% include field['custom_renderer']['template'] %}
                                        {% endif %}
                                    </div>
                                    {% else %}
                                        <!-- Regular field rendering remains the same -->
                                        <div class="text-sm text-gray-900 dark:text-gray-100">
                                            {% if field['field_type'] == 'currency' %}
                                                {{ field['value'] or '₹ 0.00' }}
                                            {% elif field['field_type'] == 'date' %}
                                                {{ field['value']|dateformat if field['value'] else '—' }}
                                            {% elif field['field_type'] == 'datetime' %}
                                                {{ field['value']|datetimeformat if field['value'] else '—' }}
                                            {% elif field['field_type'] == 'boolean' %}
                                                {% if field['value'] %}
                                                    <span class="text-green-600 dark:text-green-400">
                                                        <i class="fas fa-check-circle"></i> Yes
                                                    </span>
                                                {% else %}
                                                    <span class="text-gray-400 dark:text-gray-500">
                                                        <i class="fas fa-times-circle"></i> No
                                                    </span>
                                                {% endif %}
                                            {% elif field['field_type'] == 'status' %}
                                                <span class="status-badge status-{{ field['value']|lower|replace(' ', '-') }}">
                                                    {{ field['value']|title|replace('_', ' ') }}
                                                </span>
                                            {% elif field['field_type'] == 'textarea' or field['field_type'] == 'text_area' %}
                                                <div class="whitespace-pre-wrap">{{ field['value'] or '—' }}</div>
                                            {% else %}
                                                {{ field['value'] or '—' }}
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endfor %}
</div>