<!-- templates/engine/components/layout_accordion.html -->
<!-- Exact extraction from working universal_view.html with custom renderer logic intact -->
<div class="universal-accordion-view">
    {% for tab in assembled_data.field_sections %}
        {% for section in tab.sections %}
            <div class="universal-accordion-section bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 mb-4">
                <!-- Accordion Header (Clickable) -->
                <button type="button" 
                        class="universal-accordion-header w-full px-6 py-4 bg-gray-50 dark:bg-gray-900 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-200 flex items-center justify-between text-left"
                        onclick="toggleAccordion('{{ tab.key }}_{{ section.key }}')">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 flex items-center">
                        {% if section.icon %}
                            <i class="{{ section.icon }} mr-2 text-gray-500 dark:text-gray-400"></i>
                        {% endif %}
                        {{ section.title }}
                    </h3>
                    <i class="fas fa-chevron-down text-gray-500 dark:text-gray-400 transition-transform duration-200" id="chevron-{{ tab.key }}_{{ section.key }}"></i>
                </button>
                
                <!-- Accordion Content -->
                <div id="content-{{ tab.key }}_{{ section.key }}" class="universal-accordion-content {% if not loop.first %}hidden{% endif %}">
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-{{ section.columns or 2 }} gap-6">
                            {% for field in section.fields|sort(attribute='view_order') %}
                                <div class="{{ field['css_class'] }} {% if field['columns_span'] == 'full' or (field['custom_renderer'] and 'table-responsive' in field['custom_renderer'].get('css_classes', '')) %}md:col-span-{{ section.columns or 2 }}{% endif %}">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                        {{ field['label'] }}
                                    </label>
                                    
                                    {% if field.get('is_custom_renderer') and field.get('custom_renderer') %}
                                        <!-- Custom Renderer Field -->
                                        {% set func_name = field['custom_renderer'].get('context_function') %}
                                        
                                        {% if func_name and service %}
                                            {% set method = attribute(service, func_name, None) %}
                                            {% set data = method(item_id=item_id, item=item, hospital_id=current_hospital_id, branch_id=current_branch_id) if method else None %}
                                            
                                            {% if data %}
                                                <div class="custom-renderer-wrapper {{ field['custom_renderer'].get('css_classes', '') }}">
                                                    {% with data=data %}
                                                        {% include field['custom_renderer'].get('template') ignore missing %}
                                                    {% endwith %}
                                                </div>
                                            {% else %}
                                                <div class="text-muted">
                                                    <i class="fas fa-info-circle"></i>
                                                    {% if not method %}
                                                        Function '{{ func_name }}' not found
                                                    {% else %}
                                                        No data available
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        {% elif field['custom_renderer'].get('template') %}
                                            <!-- Template without context function -->
                                            <div class="custom-renderer-wrapper {{ field['custom_renderer'].get('css_classes', '') }}">
                                                {% include field['custom_renderer'].get('template') ignore missing %}
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <!-- Regular Field -->
                                        <div class="text-gray-900 dark:text-gray-100">
                                            {{ field['value'] if not field['is_empty'] else '-' }}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endfor %}
</div>