<!-- templates/engine/components/layout_tabbed.html -->
<!-- Exact extraction from working universal_view.html with custom renderer logic intact -->

<div class="universal-tabbed-view bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
    <!-- Tab Navigation -->
    <div class="universal-tab-navigation">
        <nav class="-mb-px flex space-x-4 overflow-x-auto" aria-label="Tabs">
            {% for tab in assembled_data.field_sections %}
                <button type="button" 
                        data-tab="{{ tab.key }}" 
                        class="universal-tab-button {% if loop.first %}active text-blue-600 dark:text-blue-400 border-blue-600 dark:border-blue-400{% else %}text-gray-500 dark:text-gray-400 border-transparent{% endif %}"
                        onclick="switchUniversalTab('{{ tab.key }}')">
                    {% if tab.icon %}
                        <i class="{{ tab.icon }}"></i>
                    {% endif %}
                    {{ tab.label }}
                </button>
            {% endfor %}
        </nav>
    </div>
    
    <!-- Tab Content -->
    <div class="universal-tab-content relative">
        {% for tab in assembled_data.field_sections %}
            <div id="tab-{{ tab.key }}" class="universal-tab-panel p-6 {% if not loop.first and not tab.default_active %}hidden{% endif %}">
                {% for section in tab.sections %}
                    <!-- Section Header -->
                    <div class="universal-field-section bg-gray-50 dark:bg-gray-900 rounded-lg mb-6">
                        <div class="universal-section-header px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="universal-section-title text-lg font-semibold text-gray-900 dark:text-gray-100 flex items-center">
                                {% if section.icon %}
                                    <i class="{{ section.icon }} mr-2 text-blue-600 dark:text-blue-400"></i>
                                {% endif %}
                                {{ section.title }}
                            </h3>
                        </div>
                        
                        <!-- Section Fields -->
                        <div class="universal-section-fields p-6">
                            <div class="grid grid-cols-1 md:grid-cols-{{ section.columns or 2 }} gap-6">
                                {% for field in section.fields|sort(attribute='view_order') %}
                                    <div class="{{ field['css_class'] }} {% if field['columns_span'] == 'full' or (field['custom_renderer'] and 'table-responsive' in field['custom_renderer'].get('css_classes', '')) %}md:col-span-{{ section.columns or 2 }}{% endif %}">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                            {{ field['label'] }}
                                        </label>
                                        
                                        {% if field.get('is_custom_renderer') and field.get('custom_renderer') %}
                                            <!-- Custom Renderer Field -->
                                            {% set func_name = field['custom_renderer'].get('context_function') %}
                                            
                                            {% if func_name and service %}
                                                {% set method = attribute(service, func_name, None) %}
                                                {% set data = method(item_id=item_id, item=item, hospital_id=current_hospital_id, branch_id=current_branch_id) if method else None %}
                                                
                                                {% if data %}
                                                    <div class="custom-renderer-wrapper {{ field['custom_renderer'].get('css_classes', '') }}">
                                                        {% with data=data %}
                                                            {% include field['custom_renderer'].get('template') ignore missing %}
                                                        {% endwith %}
                                                    </div>
                                                {% else %}
                                                    <div class="text-muted">
                                                        <i class="fas fa-info-circle"></i>
                                                        {% if not method %}
                                                            Function '{{ func_name }}' not found
                                                        {% else %}
                                                            No data available
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                            {% elif field['custom_renderer'].get('template') %}
                                                <!-- Template without context function -->
                                                <div class="custom-renderer-wrapper {{ field['custom_renderer'].get('css_classes', '') }}">
                                                    {% include field['custom_renderer'].get('template') ignore missing %}
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <!-- Regular Field -->
                                            <div class="text-gray-900 dark:text-gray-100">
                                                {{ field['value']|safe if not field['is_empty'] else '-' }}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>
</div>