{% extends "layouts/dashboard.html" %}

{% block styles %}
    {{ super() }}
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/components/universal_form.css') }}"> -->
{% endblock %}

{% block title %}Edit {{ entity_config.name }} - {{ entity.get(entity_config.title_field, 'Item') if entity else 'Item' }}{% endblock %}

{% block content %}
<div class="universal-form-page">
    <!-- Enhanced Page Header with Info Card -->
    <div class="page-header mb-4">
        <!-- Header Card with 3-row layout -->
        <div class="info-card mb-3">
            <div class="card-body">
                <!-- Row 1: Title and Date -->
                <div class="flex justify-between items-center mb-3">
                    <h1 class="text-2xl font-bold">
                        <i class="{{ entity_config.icon }} text-blue-500"></i>
                        <span class="ml-2">Edit {{ entity_config.entity_label or entity_config.name }}</span>
                    </h1>
                    <span class="text-sm text-gray-600">{{ current_date if current_date else '' }}</span>
                </div>
                
                <!-- Row 2: Entity Details with Print Profile -->
                <div class="mb-4 p-3 bg-gray-50 rounded">
                    <div class="flex justify-between items-center text-lg">
                        <div class="flex-1">
                            {% if entity and entity_config.title_field and entity.get(entity_config.title_field) %}
                                <span class="font-semibold text-gray-800">{{ entity.get(entity_config.title_field) }}</span>
                            {% endif %}
                        </div>
                        <div class="flex-1 text-center">
                            <span class="text-gray-600">ID: {{ item_id[:8] }}...</span>
                        </div>
                        <div class="flex-1 text-right">
                            {% if entity and entity.get('status') %}
                                <span class="text-gray-600">Status:</span>
                                <span class="badge badge-{{ 'success' if entity.get('status') == 'active' else 'warning' }} text-base ml-1">
                                    {{ entity.get('status')|title }}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Row 3: Action Buttons -->
                <div class="flex justify-between items-center">
                    <!-- Standard Back Button (Always First) -->
                    <button onclick="window.history.back()" type="button" class="btn-back">
                        <i class="fas fa-arrow-left icon-left"></i>Back
                    </button>
                    <div class="flex gap-2">
                        <a href="{{ url_for('universal_views.universal_detail_view', entity_type=entity_type, item_id=item_id) }}"
                           class="btn-secondary">
                            <i class="fas fa-eye"></i>
                            <span class="ml-2">View Details</span>
                        </a>
                        <a href="{{ url_for('universal_views.universal_document_view', entity_type=entity_type, item_id=item_id, doc_type='profile') }}" 
                            class="btn-outline btn-sm" 
                            target="_blank">
                            <i class="fas fa-print"></i>
                            <span class="ml-2">Print Profile</span>
                        </a>
                        {% if can_delete(entity_config.entity_type) %}
                        <button type="button" 
                                class="btn-danger" 
                                onclick="confirmDelete('{{ url_for('universal_views.universal_delete_view', entity_type=entity_type, item_id=item_id) }}')"
                                title="Delete {{ entity[entity_config.title_field] if entity and entity_config.title_field and entity_config.title_field in entity else 'this item' }}">
                            <i class="fas fa-trash"></i>
                            <span class="ml-2">Delete</span>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Form Section -->
    <form method="POST" 
          action="{{ url_for('universal_views.universal_edit_view', entity_type=entity_type, item_id=item_id) }}"
          id="universal-edit-form"
          class="universal-crud-form"
          novalidate>
         
        <!-- CSRF Token -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <div class="info-card">
            <div class="card-header">
                <h3 class="text-xl font-bold text-gray-700">
                    <i class="{{ entity_config.icon }} text-gray-500 text-lg"></i>
                    <span class="ml-2">{{ entity_config.name }} Information</span>
                </h3>
            </div>
            
            <div class="card-body">
                <!-- Display any form errors -->
                {% if form_errors %}
                <div class="alert alert-danger mb-4">
                    <strong>Please correct the following errors:</strong>
                    <ul class="mt-2 mb-0">
                        {% for error in form_errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- Form container with subtle background -->
                <div class="form-container">
                    <!-- Group fields by section -->
                    {% set fields_by_section = {} %}
                    {% for field_name in entity_config.edit_fields %}
                        {% set field = entity_config.fields|selectattr('name', 'equalto', field_name)|first %}
                        {% if field %}
                            {% set section_key = field.section|default('basic_info') %}
                            {% if section_key not in fields_by_section %}
                                {% set _ = fields_by_section.update({section_key: []}) %}
                            {% endif %}
                            {% set _ = fields_by_section[section_key].append(field) %}
                        {% endif %}
                    {% endfor %}

                    <!-- Render each section as a separate card -->
                    {% for section_key, section_fields in fields_by_section.items() %}
                        {% set section_def = entity_config.form_section_definitions.get(section_key) if entity_config.form_section_definitions else None %}
                        
                        <!-- Collapsible Form Section Card -->
                        <div class="section-card collapsible {{ section_key }}" data-section="{{ section_key }}">
                            <div class="section-header" onclick="toggleSection('{{ section_key }}')">
                                <h4 class="section-title flex items-center flex-grow">
                                    {% if section_def and section_def.icon %}
                                        <i class="{{ section_def.icon }} text-gray-600"></i>
                                    {% endif %}
                                    <span class="ml-2">{{ section_def.title if section_def else section_key|replace('_', ' ')|title }}</span>
                                    <i class="fas fa-chevron-down ml-auto transition-transform section-toggle ml-4"></i>
                                </h4>
                            </div>
                            
                            <!-- Section Body -->
                            <div class="section-body">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {% for field in section_fields|sort(attribute='view_order') %}
                                        {% set current_value = entity[field.name] if entity and field.name in entity else '' %}
                                        
                                        <!-- Full width for textarea and address fields -->
                                        <div class="{% if field.field_type.value in ['textarea', 'rich_text'] or field.name == 'address' %}md:col-span-2{% endif %}">
                                            <div class="universal-form-group">
                                                <label for="{{ field.name }}" class="universal-form-label">
                                                    {{ field.label }}
                                                    {% if field.name in entity_config.required_fields %}
                                                        <span class="text-red-500">*</span>
                                                    {% endif %}
                                                </label>
                                                
                                                {% if field.field_type.value == 'boolean' or field.name == 'black_listed' %}
                                                    <!-- Checkbox handling -->
                                                    <div class="form-check">
                                                        <input type="checkbox" 
                                                               class="form-check-input" 
                                                               id="{{ field.name }}" 
                                                               name="{{ field.name }}"
                                                               value="true"
                                                               {% if current_value == True or current_value == 'true' or current_value == 'True' or current_value == 1 or current_value == '1' %}checked{% endif %}
                                                               {% if field.name in entity_config.required_fields %}required{% endif %}>
                                                        <label class="form-check-label" for="{{ field.name }}">
                                                            {{ field.help_text if field.help_text else 'Check if ' + field.label.lower() }}
                                                        </label>
                                                    </div>
                                                    
                                                {% elif field.field_type.value == 'select' or field.name == 'status' %}
                                                    <select class="universal-form-input"
                                                            id="{{ field.name }}"
                                                            name="{{ field.name }}"
                                                            {% if field.name in entity_config.required_fields %}required{% endif %}>
                                                        {% if field.options %}
                                                            <!-- Use field-specific options if defined -->
                                                            <option value="">Select {{ field.label }}</option>
                                                            {% for option in field.options %}
                                                                {% if option is mapping %}
                                                                    <option value="{{ option.value }}" {% if current_value == option.value %}selected{% endif %}>
                                                                        {{ option.label }}
                                                                    </option>
                                                                {% else %}
                                                                    <option value="{{ option }}" {% if current_value == option %}selected{% endif %}>
                                                                        {{ option }}
                                                                    </option>
                                                                {% endif %}
                                                            {% endfor %}
                                                        {% elif field.name == 'status' %}
                                                            <!-- Fallback for status field without options -->
                                                            <option value="active" {% if current_value == 'active' %}selected{% endif %}>Active</option>
                                                            <option value="inactive" {% if current_value == 'inactive' %}selected{% endif %}>Inactive</option>
                                                        {% endif %}
                                                    </select>
                                                    
                                                {% elif field.field_type.value == 'textarea' or field.name == 'address' %}
                                                    <textarea class="universal-form-input" 
                                                              id="{{ field.name }}" 
                                                              name="{{ field.name }}"
                                                              rows="3"
                                                              placeholder="{{ field.placeholder or 'Enter ' + field.label.lower() }}"
                                                              {% if field.name in entity_config.required_fields %}required{% endif %}>{{ current_value }}</textarea>
                                                              
                                                {% elif field.field_type.value in ['date', 'datetime'] %}
                                                    <input type="{{ field.field_type.value }}" 
                                                           class="universal-form-input" 
                                                           id="{{ field.name }}" 
                                                           name="{{ field.name }}"
                                                           value="{{ current_value }}"
                                                           {% if field.name in entity_config.required_fields %}required{% endif %}>
                                                           
                                                {% elif field.field_type.value in ['number', 'amount', 'currency'] or field.name in ['credit_limit', 'credit_days'] %}
                                                    <input type="number" 
                                                           class="universal-form-input" 
                                                           id="{{ field.name }}" 
                                                           name="{{ field.name }}"
                                                           value="{{ current_value }}"
                                                           step="{% if field.field_type.value == 'currency' or field.name == 'credit_limit' %}0.01{% else %}1{% endif %}"
                                                           placeholder="{{ field.placeholder or 'Enter ' + field.label.lower() }}"
                                                           {% if field.name == 'credit_days' %}min="0" max="365"{% endif %}
                                                           {% if field.min_value %}min="{{ field.min_value }}"{% endif %}
                                                           {% if field.name in entity_config.required_fields %}required{% endif %}>
                                                           
                                                {% elif field.name == 'gst_registration_number' %}
                                                    <input type="text" 
                                                           class="universal-form-input" 
                                                           id="{{ field.name }}" 
                                                           name="{{ field.name }}"
                                                           value="{{ current_value }}"
                                                           placeholder="15-character GST Number"
                                                           pattern="[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}"
                                                           maxlength="15"
                                                           style="text-transform: uppercase;">
                                                           
                                                {% elif field.name == 'pan_number' %}
                                                    <input type="text" 
                                                           class="universal-form-input" 
                                                           id="{{ field.name }}" 
                                                           name="{{ field.name }}"
                                                           value="{{ current_value }}"
                                                           placeholder="10-character PAN"
                                                           pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}"
                                                           maxlength="10"
                                                           style="text-transform: uppercase;">
                                                           
                                                {% elif field.name == 'pincode' %}
                                                    <input type="text" 
                                                           class="universal-form-input" 
                                                           id="{{ field.name }}" 
                                                           name="{{ field.name }}"
                                                           value="{{ current_value }}"
                                                           placeholder="6-digit PIN code"
                                                           pattern="[0-9]{6}"
                                                           maxlength="6">
                                                           
                                                {% elif field.name == 'email' %}
                                                    <input type="email" 
                                                           class="universal-form-input" 
                                                           id="{{ field.name }}" 
                                                           name="{{ field.name }}"
                                                           value="{{ current_value }}"
                                                           placeholder="{{ field.placeholder or 'email@example.com' }}"
                                                           {% if field.name in entity_config.required_fields %}required{% endif %}>
                                                           
                                                {% else %}
                                                    <!-- Default text input -->
                                                    <input type="text" 
                                                           class="universal-form-input" 
                                                           id="{{ field.name }}" 
                                                           name="{{ field.name }}"
                                                           value="{{ current_value }}"
                                                           placeholder="{{ field.placeholder or 'Enter ' + field.label.lower() }}"
                                                           {% if field.max_length %}maxlength="{{ field.max_length }}"{% endif %}
                                                           {% if field.pattern %}pattern="{{ field.pattern }}"{% endif %}
                                                           {% if field.name in entity_config.required_fields %}required{% endif %}>
                                                {% endif %}
                                                
                                                {% if field.help_text %}
                                                    <small class="help-text">{{ field.help_text }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    
                    <!-- Required Fields Note -->
                    <div class="required-note">
                        <span class="text-red-500">*</span> Required fields
                    </div>
                </div> <!-- Close form-container -->
                
                <!-- Metadata Section -->
                {% if entity %}
                <div class="metadata-section">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <strong>Created:</strong> 
                            {% if entity.created_at %}
                                {{ entity.created_at.strftime("%Y-%m-%d %H:%M") if entity.created_at else 'Unknown' }}
                            {% else %}
                                Unknown
                            {% endif %}
                            {% if entity.created_by %}
                                by {{ entity.created_by }}
                            {% endif %}
                        </div>
                        <div>
                            <strong>Last Updated:</strong> 
                            {% if entity.updated_at %}
                                {{ entity.updated_at.strftime("%Y-%m-%d %H:%M") if entity.updated_at else 'Never' }}
                            {% else %}
                                Never
                            {% endif %}
                            {% if entity.updated_by %}
                                by {{ entity.updated_by }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div> <!-- Close card-body -->
            
            <!-- Form Actions with Universal Engine Color Standards -->
            <div class="card-footer">
                <div class="flex justify-center gap-4 w-full">
                    <!-- PRIMARY: Main save action (blue) -->
                    <button type="submit" name="action" value="save" class="btn-primary" style="min-width: 120px;">
                        <i class="fas fa-save"></i>
                        <span class="ml-2">Update</span>
                    </button>
                    
                    <!-- SUCCESS: Positive continuation (green) -->
                    <button type="submit" name="action" value="save_and_continue" class="btn-success" style="min-width: 150px;">
                        <i class="fas fa-edit"></i>
                        <span class="ml-2">Save & Continue</span>
                    </button>
                    
                    <!-- WARNING: Caution - data loss possible (amber) -->
                    <button type="reset" class="btn-warning" style="min-width: 100px;">
                        <i class="fas fa-undo"></i>
                        <span class="ml-2">Reset</span>
                    </button>
                    
                    <!-- SECONDARY: Navigation away (gray) -->
                    <a href="{{ url_for('universal_views.universal_detail_view', entity_type=entity_type, item_id=item_id) }}" 
                       class="btn-secondary text-center" style="min-width: 100px;">
                        <i class="fas fa-times"></i>
                        <span class="ml-2">Cancel</span>
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Delete Confirmation Modal (Optional) -->
<div id="deleteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Confirm Delete</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">
                    Are you sure you want to delete this item? This action cannot be undone.
                </p>
            </div>
            <div class="items-center px-4 py-3">
                <button id="confirmDeleteBtn" class="btn-danger">
                    <i class="fas fa-trash mr-2"></i>Delete
                </button>
                <button onclick="closeDeleteModal()" class="btn-secondary ml-2">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Discontinuation Confirmation Modal -->
<div id="discontinuationModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-6 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl leading-6 font-bold text-red-600">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Confirm Plan Discontinuation
                </h3>
                <button onclick="closeDiscontinuationModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="px-7 py-3">
                <!-- Loading State -->
                <div id="discontinuation-loading" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-3"></i>
                    <p class="text-gray-600">Loading discontinuation details...</p>
                </div>

                <!-- Preview Content -->
                <div id="discontinuation-content" class="hidden">
                    <!-- Patient and Package Info -->
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <strong>Patient:</strong> <span id="preview-patient-name"></span>
                            </div>
                            <div>
                                <strong>Package:</strong> <span id="preview-package-name"></span>
                            </div>
                            <div>
                                <strong>Invoice:</strong> <span id="preview-invoice-number"></span>
                            </div>
                            <div>
                                <strong>Plan:</strong> <span id="preview-plan-number"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Impact -->
                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-4">
                        <h4 class="font-bold text-gray-800 mb-3">Financial Impact</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-gray-600">Total Package Amount:</span>
                                <span class="font-semibold float-right" id="preview-total-amount"></span>
                            </div>
                            <div>
                                <span class="text-gray-600">Per-Session Cost:</span>
                                <span class="font-semibold float-right text-blue-600" id="preview-session-value"></span>
                            </div>
                            <div>
                                <span class="text-gray-600">Total Sessions:</span>
                                <span class="font-semibold float-right" id="preview-total-sessions"></span>
                            </div>
                            <div>
                                <span class="text-gray-600">Completed Sessions:</span>
                                <span class="font-semibold float-right" id="preview-completed-sessions"></span>
                            </div>
                            <div class="col-span-2 border-t pt-2 mt-1">
                                <span class="text-gray-600">Patient Liability (Completed):</span>
                                <span class="font-bold float-right text-orange-600" id="preview-patient-liability"></span>
                            </div>
                            <div class="col-span-2">
                                <span class="text-gray-600">Amount Paid:</span>
                                <span class="font-bold float-right text-green-600" id="preview-paid-amount"></span>
                            </div>
                            <div class="col-span-2 border-t pt-2 mt-1">
                                <span class="text-gray-600">Remaining Sessions:</span>
                                <span class="font-bold text-lg float-right text-red-600" id="preview-remaining-sessions"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Items to Cancel -->
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                        <h4 class="font-bold text-gray-800 mb-2">Items to be Cancelled</h4>
                        <div class="text-sm">
                            <div class="flex justify-between py-1">
                                <span class="text-gray-600">Scheduled Sessions:</span>
                                <span class="font-semibold" id="preview-scheduled-sessions"></span>
                            </div>
                            <div class="flex justify-between py-1">
                                <span class="text-gray-600">Pending Installments:</span>
                                <span class="font-semibold" id="preview-pending-installments"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Discontinuation Reason -->
                    <div class="mb-4">
                        <label for="discontinuation-reason-input" class="block text-sm font-semibold text-gray-700 mb-2">
                            Discontinuation Reason <span class="text-red-500">*</span>
                        </label>
                        <textarea id="discontinuation-reason-input"
                                  rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="Enter reason for discontinuation (required)"></textarea>
                    </div>

                    <!-- Reversal & Refund Calculation -->
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                        <h4 class="font-bold text-gray-800 mb-3">
                            <i class="fas fa-calculator mr-2"></i>
                            Credit Note Calculation
                        </h4>

                        <!-- Patient Liability Calculation -->
                        <div class="bg-white p-4 rounded mb-3 border border-gray-200">
                            <h5 class="text-sm font-bold text-gray-700 mb-3">
                                <i class="fas fa-user-tag mr-1 text-orange-500"></i>
                                Patient Liability (Completed Sessions):
                            </h5>
                            <div class="flex items-center gap-2 text-sm font-mono bg-gray-50 p-3 rounded">
                                <input type="number"
                                       id="per-session-cost-input"
                                       class="w-24 px-2 py-1 border border-blue-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-right font-semibold text-blue-600"
                                       step="0.01"
                                       min="0">
                                <span class="text-gray-600">×</span>
                                <input type="text"
                                       id="completed-sessions-display"
                                       class="w-16 px-2 py-1 bg-gray-100 border border-gray-300 rounded text-center text-gray-700"
                                       readonly>
                                <span class="text-gray-600">=</span>
                                <input type="text"
                                       id="patient-liability-calc"
                                       class="flex-1 px-2 py-1 bg-orange-50 border border-orange-300 rounded text-right font-bold text-orange-600"
                                       readonly>
                            </div>
                            <p class="text-xs text-gray-600 mt-2 ml-1">
                                Per-session cost × Completed sessions = Patient liability
                            </p>
                        </div>

                        <!-- Cash Refund Calculation -->
                        <div class="bg-white p-4 rounded mb-3 border border-gray-200">
                            <h5 class="text-sm font-bold text-gray-700 mb-3">
                                <i class="fas fa-money-bill-wave mr-1 text-green-500"></i>
                                Cash Refund to Patient:
                            </h5>
                            <div class="flex items-center gap-2 text-sm font-mono bg-gray-50 p-3 rounded">
                                <input type="text"
                                       id="paid-amount-display"
                                       class="w-28 px-2 py-1 bg-gray-100 border border-gray-300 rounded text-right text-gray-700"
                                       readonly>
                                <span class="text-gray-600">−</span>
                                <input type="text"
                                       id="patient-liability-display"
                                       class="w-28 px-2 py-1 bg-gray-100 border border-gray-300 rounded text-right text-gray-700"
                                       readonly>
                                <span class="text-gray-600">=</span>
                                <input type="text"
                                       id="cash-refund-calc"
                                       class="flex-1 px-2 py-1 bg-green-50 border border-green-300 rounded text-right font-bold text-green-600"
                                       readonly>
                            </div>
                            <p class="text-xs text-gray-600 mt-2 ml-1">
                                Paid amount − Patient liability = Cash refund (rounded to nearest ₹)
                            </p>
                        </div>

                        <!-- Reversal Value Calculation -->
                        <div class="bg-white p-4 rounded mb-3 border border-gray-200">
                            <h5 class="text-sm font-bold text-gray-700 mb-3">
                                <i class="fas fa-undo mr-1 text-blue-500"></i>
                                AR/GL Reversal Value (Unused Sessions):
                            </h5>
                            <div class="flex items-center gap-2 text-sm font-mono bg-gray-50 p-3 rounded">
                                <input type="text"
                                       id="per-session-cost-display"
                                       class="w-24 px-2 py-1 bg-gray-100 border border-gray-300 rounded text-right text-gray-700"
                                       readonly>
                                <span class="text-gray-600">×</span>
                                <input type="text"
                                       id="remaining-sessions-display"
                                       class="w-16 px-2 py-1 bg-gray-100 border border-gray-300 rounded text-center text-gray-700"
                                       readonly>
                                <span class="text-gray-600">=</span>
                                <input type="text"
                                       id="reversal-value-calc"
                                       class="flex-1 px-2 py-1 bg-blue-50 border border-blue-300 rounded text-right font-bold text-blue-600"
                                       readonly>
                            </div>
                            <p class="text-xs text-gray-600 mt-2 ml-1">
                                Per-session cost × Remaining sessions = Reversal amount
                            </p>
                        </div>

                        <!-- Final Adjustment -->
                        <div class="border-t pt-3 mt-2">
                            <p class="text-sm text-gray-600 mb-3">
                                <strong>Final Credit Note Amount</strong> (editable for adjustments):
                            </p>
                            <div class="flex items-center gap-4">
                                <div class="flex-1">
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">
                                        Calculated Reversal:
                                    </label>
                                    <input type="text"
                                           id="calculated-refund-display"
                                           class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-gray-600 font-bold"
                                           readonly>
                                </div>
                                <div class="flex-1">
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">
                                        Final Amount: <span class="text-red-500">*</span>
                                    </label>
                                    <input type="number"
                                           id="adjustment-amount-input"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-bold"
                                           step="0.01"
                                           min="0"
                                           required>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                <i class="fas fa-info-circle"></i> You can adjust the final credit note amount (e.g., deduct cancellation fees)
                            </p>
                        </div>
                    </div>

                    <!-- Warning -->
                    <div class="bg-red-100 border-l-4 border-red-600 p-4 mb-4">
                        <p class="text-sm text-red-800">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            <strong>Warning:</strong> This action will:
                        </p>
                        <ul class="text-sm text-red-700 mt-2 ml-6 list-disc">
                            <li>Cancel all scheduled sessions</li>
                            <li>Cancel all pending installments</li>
                            <li>Create a credit note for the adjustment amount</li>
                            <li><strong>Reduce AR liability</strong> - Patient will only owe for completed sessions</li>
                            <li>Post entries to AR subledger (credit entry to reduce receivable)</li>
                            <li>Post GL entries (Dr: Package Revenue, Cr: Accounts Receivable)</li>
                            <li>If payment was made: Mark for refund processing</li>
                        </ul>
                    </div>
                </div>

                <!-- Error Display -->
                <div id="discontinuation-error" class="hidden bg-red-100 border-l-4 border-red-600 p-4 mb-4">
                    <p class="text-sm text-red-800">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <strong>Error:</strong> <span id="discontinuation-error-message"></span>
                    </p>
                </div>
            </div>

            <!-- Modal Actions -->
            <div class="items-center px-4 py-3 flex justify-end gap-3">
                <button onclick="closeDiscontinuationModal()" class="btn-secondary">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button id="confirmDiscontinuationBtn" onclick="confirmDiscontinuation()" class="btn-danger">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Confirm Discontinuation
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Include Universal Form CRUD JS if available -->
<script src="{{ url_for('static', filename='js/components/universal_form_crud.js') }}"></script>

<script>
// Set global entity type and ID for the CRUD engine
window.entityType = '{{ entity_type }}';
window.entityId = '{{ item_id }}';

document.addEventListener('DOMContentLoaded', function() {
    console.log('Edit form initialized for {{ entity_type }}/{{ item_id }}');
    
    // Store original values for change detection
    const form = document.getElementById('universal-edit-form');
    const originalValues = {};
    let isSubmitting = false; // Add flag to track submission
    
    if (form) {
        // Store original values
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            if (input.type === 'checkbox' || input.type === 'radio') {
                originalValues[input.name] = input.checked;
            } else {
                originalValues[input.name] = input.value;
            }
        });
        
        // Mark changed fields
        form.addEventListener('change', function(e) {
            const field = e.target;
            if (field.name in originalValues) {
                const currentValue = field.type === 'checkbox' || field.type === 'radio' ? 
                                   field.checked : field.value;
                
                if (currentValue !== originalValues[field.name]) {
                    field.classList.add('field-changed');
                    field.parentElement.classList.add('has-changes');
                } else {
                    field.classList.remove('field-changed');
                    field.parentElement.classList.remove('has-changes');
                }
            }
        });
        
        // Warn before leaving if changes exist
        window.addEventListener('beforeunload', function(e) {
            // Don't warn if we're submitting the form
            if (isSubmitting) {
                return;
            }
            
            const changedFields = form.querySelectorAll('.field-changed');
            if (changedFields.length > 0) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                return e.returnValue;
            }
        });
        
        // Handle form submission properly
        form.addEventListener('submit', function(e) {
            console.log('Form submit triggered');
            isSubmitting = true; // Set flag to prevent beforeunload warning
            
            // Show loading state on clicked button only
            const submitButtons = form.querySelectorAll('button[type="submit"]');
            submitButtons.forEach(btn => {
                // Only disable the clicked button
                if (e.submitter === btn) {
                    btn.disabled = true;
                    const originalHTML = btn.innerHTML;
                    btn.dataset.originalHTML = originalHTML;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span class="ml-2">Saving...</span>';
                }
            });
            
            // Form will submit normally
            return true;
        });
    }
});

// Delete confirmation
function confirmDelete(url) {
    if (confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = url;
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = '{{ csrf_token() }}';
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Optional: Modal functions if using modal
function openDeleteModal() {
    document.getElementById('deleteModal').classList.remove('hidden');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
}
// Collapsible sections functionality
function toggleSection(sectionKey) {
    const section = document.querySelector(`.section-card[data-section="${sectionKey}"]`);
    if (section) {
        section.classList.toggle('collapsed');
        // Save state to localStorage
        const isCollapsed = section.classList.contains('collapsed');
        localStorage.setItem(`section_${sectionKey}_collapsed`, isCollapsed);
    }
}

// Restore collapsed state on page load
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.section-card.collapsible').forEach(section => {
        const sectionKey = section.dataset.section;
        const isCollapsed = localStorage.getItem(`section_${sectionKey}_collapsed`) === 'true';
        if (isCollapsed) {
            section.classList.add('collapsed');
        }
    });
});

// ============================================================================
// DISCONTINUATION WORKFLOW FOR PACKAGE PAYMENT PLANS
// ============================================================================

let discontinuationPreviewData = null;
let originalStatusValue = null;

document.addEventListener('DOMContentLoaded', function() {
    // Only activate for package_payment_plans entity
    if (window.entityType !== 'package_payment_plans') {
        return;
    }

    const form = document.getElementById('universal-edit-form');
    const statusField = document.querySelector('#status');

    if (!form || !statusField) {
        return;
    }

    // Store original status value
    originalStatusValue = statusField.value;

    // Intercept form submission
    form.addEventListener('submit', function(e) {
        const newStatus = statusField.value;

        // Check if status is being changed to 'discontinued'
        if (newStatus === 'discontinued' && originalStatusValue !== 'discontinued') {
            e.preventDefault(); // Stop form submission
            e.stopPropagation();

            console.log('Discontinuation detected - showing modal');
            showDiscontinuationModal();
        }
    });
});

function showDiscontinuationModal() {
    const modal = document.getElementById('discontinuationModal');
    const loading = document.getElementById('discontinuation-loading');
    const content = document.getElementById('discontinuation-content');
    const error = document.getElementById('discontinuation-error');

    // Show modal with loading state
    modal.classList.remove('hidden');
    loading.classList.remove('hidden');
    content.classList.add('hidden');
    error.classList.add('hidden');

    // Call preview API
    fetch(`/api/package/plan/${window.entityId}/discontinuation-preview`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Store preview data
            discontinuationPreviewData = data;

            // Populate modal fields
            document.getElementById('preview-patient-name').textContent = data.patient_name || 'N/A';
            document.getElementById('preview-package-name').textContent = data.package_name || 'N/A';
            document.getElementById('preview-invoice-number').textContent = data.invoice_number || 'N/A';
            document.getElementById('preview-plan-number').textContent = data.plan_number || 'N/A';

            document.getElementById('preview-total-amount').textContent = '₹' + parseFloat(data.total_amount).toFixed(2);
            document.getElementById('preview-session-value').textContent = '₹' + parseFloat(data.session_value || 0).toFixed(2);
            document.getElementById('preview-total-sessions').textContent = data.total_sessions;
            document.getElementById('preview-completed-sessions').textContent = data.completed_sessions;
            document.getElementById('preview-patient-liability').textContent = '₹' + parseFloat(data.patient_liability || 0).toFixed(2);
            document.getElementById('preview-paid-amount').textContent = '₹' + parseFloat(data.paid_amount).toFixed(2);
            document.getElementById('preview-remaining-sessions').textContent = data.remaining_sessions;

            document.getElementById('preview-scheduled-sessions').textContent = data.scheduled_sessions;
            document.getElementById('preview-pending-installments').textContent = data.pending_installments;

            // Store original data for calculations
            window.discontinuationCalcData = {
                sessionValue: parseFloat(data.session_value || 0),
                completedSessions: parseInt(data.completed_sessions || 0),
                remainingSessions: parseInt(data.remaining_sessions || 0),
                paidAmount: parseFloat(data.paid_amount || 0)
            };

            // Populate calculation fields
            document.getElementById('per-session-cost-input').value = window.discontinuationCalcData.sessionValue.toFixed(2);
            document.getElementById('completed-sessions-display').value = window.discontinuationCalcData.completedSessions;
            document.getElementById('remaining-sessions-display').value = window.discontinuationCalcData.remainingSessions;
            document.getElementById('paid-amount-display').value = '₹' + window.discontinuationCalcData.paidAmount.toFixed(2);

            // Initial calculation
            recalculateDiscontinuation();

            // Add event listener for per-session cost changes
            const perSessionInput = document.getElementById('per-session-cost-input');
            if (perSessionInput) {
                perSessionInput.addEventListener('input', recalculateDiscontinuation);
            }

            // Show content, hide loading
            loading.classList.add('hidden');
            content.classList.remove('hidden');
        } else {
            // Show error
            loading.classList.add('hidden');
            error.classList.remove('hidden');
            document.getElementById('discontinuation-error-message').textContent = data.error || 'Failed to load discontinuation preview';
        }
    })
    .catch(err => {
        console.error('Error loading discontinuation preview:', err);
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        document.getElementById('discontinuation-error-message').textContent = 'Network error: ' + err.message;
    });
}

function recalculateDiscontinuation() {
    if (!window.discontinuationCalcData) return;

    // Get current per-session cost (editable)
    const perSessionCost = parseFloat(document.getElementById('per-session-cost-input').value) || 0;
    const completedSessions = window.discontinuationCalcData.completedSessions;
    const remainingSessions = window.discontinuationCalcData.remainingSessions;
    const paidAmount = window.discontinuationCalcData.paidAmount;

    // Calculate patient liability
    const patientLiability = perSessionCost * completedSessions;

    // Calculate cash refund (rounded to nearest rupee)
    const cashRefundExact = paidAmount - patientLiability;
    const cashRefund = Math.round(cashRefundExact);  // Round to nearest rupee

    // Calculate reversal value
    const reversalValue = perSessionCost * remainingSessions;

    // Update display fields
    document.getElementById('per-session-cost-display').value = '₹' + perSessionCost.toFixed(2);
    document.getElementById('patient-liability-calc').value = '₹' + patientLiability.toFixed(2);
    document.getElementById('patient-liability-display').value = '₹' + patientLiability.toFixed(2);
    document.getElementById('cash-refund-calc').value = '₹' + cashRefund.toFixed(0);
    document.getElementById('reversal-value-calc').value = '₹' + reversalValue.toFixed(2);

    // Update final adjustment fields
    document.getElementById('calculated-refund-display').value = '₹' + reversalValue.toFixed(2);
    document.getElementById('adjustment-amount-input').value = reversalValue.toFixed(2);
}

function closeDiscontinuationModal() {
    const modal = document.getElementById('discontinuationModal');
    modal.classList.add('hidden');

    // Reset status field to original value
    const statusField = document.querySelector('#status');
    if (statusField && originalStatusValue) {
        statusField.value = originalStatusValue;
    }

    // Clear modal data
    discontinuationPreviewData = null;
    window.discontinuationCalcData = null;
}

function confirmDiscontinuation() {
    const reasonInput = document.getElementById('discontinuation-reason-input');
    const amountInput = document.getElementById('adjustment-amount-input');
    const confirmBtn = document.getElementById('confirmDiscontinuationBtn');

    // Validate inputs
    const reason = reasonInput.value.trim();
    const amount = parseFloat(amountInput.value);

    if (!reason) {
        alert('Please enter a discontinuation reason');
        reasonInput.focus();
        return;
    }

    if (isNaN(amount) || amount < 0) {
        alert('Please enter a valid adjustment amount');
        amountInput.focus();
        return;
    }

    // Disable button and show loading
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

    // Call discontinue API
    fetch(`/api/package/plan/${window.entityId}/discontinue`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            discontinuation_reason: reason,
            adjustment_amount: amount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Success! Show message and redirect
            alert('✅ Plan discontinued successfully!\n\n' +
                  `Credit Note: ${data.credit_note ? data.credit_note.credit_note_number : 'N/A'}\n` +
                  `Refund Amount: ₹${parseFloat(data.refund_amount).toFixed(2)}\n` +
                  `Sessions Cancelled: ${data.sessions_cancelled}\n` +
                  `Installments Cancelled: ${data.installments_cancelled}`);

            // Redirect to detail view
            window.location.href = `/universal/${window.entityType}/detail/${window.entityId}`;
        } else {
            // Show error
            alert('❌ Discontinuation failed:\n\n' + (data.error || 'Unknown error'));
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Confirm Discontinuation';
        }
    })
    .catch(err => {
        console.error('Error processing discontinuation:', err);
        alert('❌ Network error:\n\n' + err.message);
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Confirm Discontinuation';
    });
}
</script>
{% endblock %}