{% extends "layouts/dashboard.html" %}

{% block content %}
<!-- =============================================================================
UNIVERSAL LIST TEMPLATE - FIXED FOR GOLD STANDARD COMPATIBILITY
Fixed: Summary cards, Filter layout, Table data, Debug code issues
============================================================================= -->

<div class="container mx-auto px-4 py-6" data-entity-type="{{ assembled_data.entity_config.entity_type if assembled_data and assembled_data.entity_config and assembled_data.entity_config.entity_type else 'supplier_payments' }}">
    {% set auto_submit_enabled = assembled_data.entity_config.get('enable_auto_submit', True) if assembled_data and assembled_data.entity_config else True %}
    <!-- ✅ Page Header using gold standard structure -->
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6">
        <div>
            <!-- First Line: Hospital and Branch (bold, bigger fonts, spaced) -->
            <div class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-2">
                {% if assembled_data and assembled_data.get('hospital_name') and assembled_data.get('branch_name') %}
                    {{ assembled_data.hospital_name }} <span class="mx-3">•</span> {{ assembled_data.branch_name }}
                {% elif assembled_data and assembled_data.get('hospital_name') %}
                    {{ assembled_data.hospital_name }}
                {% else %}
                    Hospital • Branch
                {% endif %}
            </div>
            
            <!-- Current Date and Day (Right aligned on same line) -->
            <div class="text-right ml-4">
                <div class="text-lg font-semibold text-gray-900 dark:text-gray-100" id="current-date">
                    <!-- Date will be set by JavaScript -->
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400" id="current-day">
                    <!-- Day will be set by JavaScript -->
                </div>
            </div>

            <!-- Second Line: Entity Title with colored icon (left aligned) -->
            <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-1">
                <i class="{{ assembled_data.entity_config.icon if assembled_data and assembled_data.entity_config and assembled_data.entity_config.icon else 'fas fa-money-bill-wave' }} text-blue-600"></i>
                {{ assembled_data.entity_config.page_title if assembled_data and assembled_data.entity_config and assembled_data.entity_config.page_title else 'Universal List' }}
            </h1>
            
            <!-- Third Line: Description (left aligned) -->
            <p class="text-gray-600 dark:text-gray-400">
                {{ assembled_data.entity_config.description if assembled_data and assembled_data.entity_config and assembled_data.entity_config.description else 'Universal entity management' }}
            </p>
        </div>
        


        <!-- ✅ Action buttons using existing btn classes -->
        <div class="flex space-x-2 mt-4 md:mt-0">
            {% if assembled_data and assembled_data.entity_config and assembled_data.entity_config.actions %}
                {% set has_create_action = false %}
                {% for action in assembled_data.entity_config.actions %}
                    {% if action.show_in_toolbar %}
                        {% if action.id == 'create' %}
                            {% set has_create_action = true %}
                        {% endif %}
                        <a href="{{ action.get_url({}, assembled_data.entity_config) }}" 
                        class="{{ action.button_type.value }}">
                            <i class="{{ action.icon }} icon-left"></i>{{ action.label }}
                        </a>
                    {% endif %}
                {% endfor %}
                
                <!-- Add smart create button if not in actions -->
                {% if not has_create_action and can_create(assembled_data.entity_config.entity_type) %}
                    {% set create_url = get_crud_url(assembled_data.entity_config.entity_type, 'create') %}
                    {% if create_url != '#' %}
                        <a href="{{ create_url }}" class="btn-primary">
                            <i class="fas fa-plus icon-left"></i>Add New {{ assembled_data.entity_config.name }}
                        </a>
                    {% endif %}
                {% endif %}
            {% else %}
                <!-- Fallback: Smart create button -->
                {% if can_create(assembled_data.entity_config.entity_type) %}
                    {% set create_url = get_crud_url(assembled_data.entity_config.entity_type, 'create') %}
                    {% if create_url != '#' %}
                        <a href="{{ create_url }}" class="btn-primary">
                            <i class="fas fa-plus icon-left"></i>Add New
                        </a>
                    {% endif %}
                {% endif %}
            {% endif %}
            <button class="btn-secondary" onclick="handleUniversalExport('csv')">
                <i class="fas fa-download icon-left"></i>Export
            </button>
        </div>
    </div>

    <!-- ✅ FIXED: Summary Cards with dictionary access instead of attribute access -->
    {% set safe_summary = assembled_data.get('summary', {}) if assembled_data else {} %}
    {% set safe_pagination = assembled_data.get('pagination', {}) if assembled_data else {} %}
    {% set safe_items = assembled_data.get('items', []) if assembled_data else [] %}
    {% set safe_total_count = safe_pagination.get('total_count', safe_summary.get('total_count', safe_items|length)) %}
    

    <!-- ✅ Configuration-Driven Summary Cards using backend assembled data -->
    {% if assembled_data and assembled_data.summary_cards %}
        <!-- Primary: Use data assembler's _assemble_summary_cards output -->
        <div class="card-grid cols-4 mb-6">
            {% for card in assembled_data.summary_cards %}
            {% set current_summary = assembled_data.get('summary', {}) %}
            {% set card_value = current_summary.get(card.get('field', ''), card.get('raw_value', 0)) %}
            {% set formatted_value = ("Rs.{:,.2f}".format(card_value|float) if card.get('type') == 'currency' else "{:,}".format(card_value|int if card_value else 0)) %}
            
            <div class="stat-card{% if card.filterable %} clickable{% endif %}"
                {% if card.filterable and card.filter_field and card.filter_value %}
                onclick="applySummaryFilter('{{ card.filter_field }}', '{{ card.filter_value }}')"
                {% elif card.filterable and card.id == 'total_count' %}
                onclick="clearUniversalFilters()"
                {% endif %}>
                <div class="{{ card.get('icon_css_class', 'stat-card-icon info') }}">
                    <i class="{{ card.icon }}"></i>
                </div>
                {% if card.get('card_type') == 'detail' %}
                
                <!-- ✅ GENERIC: Detail card rendering for breakdowns -->
                <div class="stat-card-value" style="font-size: 0.7rem; line-height: 1.1; padding: 2px 0;">
                    {% set breakdown_data = current_summary %}
                    {% set breakdown_fields = card.get('breakdown_fields', {}) %}
                    {% if breakdown_fields %}
                        {% for field_key, field_config in breakdown_fields.items() %}
                            {% set amount = breakdown_data.get(field_key, 0) %}
                            {% if amount and amount > 0 %}
                            <div style="margin-bottom: 2px; display: flex; align-items: center; justify-content: space-between;">
                                <span class="breakdown-row-label">
                                    <span class="breakdown-icon-tab">
                                        <i class="{{ field_config.get('icon', 'fas fa-circle') }} {{ field_config.get('color', 'text-gray-600') }}"></i>
                                    </span>
                                    <span class="breakdown-label-text">{{ field_config.get('label', field_key) }}</span>
                                </span>
                                <span class="breakdown-amount-value">
                                    {% if card.get('type') == 'currency' %}₹{{ "{:,.0f}".format(amount|float) }}{% else %}{{ amount }}{% endif %}
                                </span>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div>{{ formatted_value if card.get('field') else card.value }}</div>
                    {% endif %}
                </div>
                {% else %}
                <!-- ✅ STANDARD: Summary card rendering (existing behavior) -->
                <div class="stat-card-value">{{ formatted_value if card.get('field') else card.value }}</div>
                {% endif %}
                
                <div class="stat-card-label">{{ card.label }}</div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- ✅ Fallback: Use gold standard pattern if no summary_cards assembled -->
        <div class="card-grid cols-4 mb-6">
            <div class="stat-card clickable" onclick="clearUniversalFilters()">
                <div class="stat-card-icon primary">
                    <i class="{{ assembled_data.get('entity_config', {}).get('icon', 'fas fa-list') }}"></i>
                </div>
                <div class="stat-card-value">{{ safe_total_count }}</div>
                <div class="stat-card-label">Total {{ assembled_data.get('entity_config', {}).get('plural_name', 'Records') }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon success">
                    <i class="fas fa-rupee-sign"></i>
                </div>
                <div class="stat-card-value">₹{{ "%.2f"|format(safe_summary.get('total_amount', 0)|float) }}</div>
                <div class="stat-card-label">Total Amount</div>
            </div>
            <div class="stat-card clickable" onclick="applySummaryFilter('this_month', 'true')">
                <div class="stat-card-icon primary">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="stat-card-value">{{ safe_summary.get('this_month_count', 0) }}</div>
                <div class="stat-card-label">This Month</div>
            </div>
            <div class="stat-card clickable" onclick="applySummaryFilter('status', 'pending')">
                <div class="stat-card-icon danger">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-card-value">{{ safe_summary.get('pending_count', 0) }}</div>
                <div class="stat-card-label">Pending</div>
            </div>
        </div>
    {% endif %}

    <!-- ✅ FIXED: Filter Card with proper horizontal layout -->
    <div class="universal-filter-card-header">
        <h3 class="universal-filter-card-title">
            <i class="fas fa-filter"></i>Filter {{ assembled_data.entity_config.plural_name if assembled_data and assembled_data.entity_config and assembled_data.entity_config.plural_name else 'Records' }}
        </h3>
        <div class="universal-filter-results-count">
            <span id="results-count">{{ safe_total_count }} results</span>
        </div>
    </div>
        
        <div class="universal-filter-card-body">
            <form method="GET" action="{{ request.path }}" id="universal-filter-form" class="universal-filter-form">
                
                <!-- ✅ SECTION 1: Date Filter (Always Visible) -->
                <div class="universal-date-filter-container">
                    <div class="universal-date-filter-section">
                        <div class="universal-date-filter-title">
                            <i class="fas fa-calendar-alt"></i>Date Range
                        </div>
                        
                        <div class="universal-date-filter-presets-row">
                            <button type="button" class="universal-date-preset-btn universal-date-filter-preset" data-preset="today">
                                <i class="fas fa-calendar-day"></i>Today
                            </button>
                            <button type="button" class="universal-date-preset-btn universal-date-filter-preset" data-preset="this_month">
                                <i class="fas fa-calendar-alt"></i>This Month
                            </button>
                            <button type="button" class="universal-date-preset-btn universal-date-filter-preset" data-preset="financial_year">
                                <i class="fas fa-calendar-year"></i>Financial Year
                            </button>
                            <button type="button" class="universal-date-preset-btn universal-date-filter-preset" data-preset="clear">
                                <i class="fas fa-times"></i>Clear
                            </button>
                        </div>
                        
                        <!-- Row 2: Date Input Fields (Full Width) -->
                        <div class="universal-date-filter-inputs-row">
                            <div class="universal-date-input-group">
                                <label class="universal-date-label">From Date</label>
                                <input type="date" name="start_date" id="start_date" 
                                    value="{{ request.args.get('start_date', '') }}" 
                                    class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                            </div>
                            <div class="universal-date-separator-container">
                                <span class="universal-date-filter-separator">to</span>
                            </div>
                            <div class="universal-date-input-group">
                                <label class="universal-date-label">To Date</label>
                                <input type="date" name="end_date" id="end_date" 
                                    value="{{ request.args.get('end_date', '') }}" 
                                    class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ✅ SECTION 2: Filter Fields -->
                <div class="universal-other-filters-container">
                    <div class="universal-other-filters-section">
                        <div class="universal-filter-grid">
                            
                            <!-- ✅ BACKWARD COMPATIBILITY: Keep hardcoded filters for supplier_payments -->
                            {% if assembled_data and assembled_data.entity_config and assembled_data.entity_config.entity_type == 'supplier_payments' %}
                                <!-- BYPASS: Keep existing supplier_payments filters until migrated to view -->
                                <div class="universal-form-group">
                                    <label class="universal-form-label">Text Search</label>
                                    <input type="text" name="search" 
                                        value="{{ request.args.get('search', '') }}" 
                                        placeholder="Search records..."
                                        class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                </div>
                                
                                <div class="universal-form-group">
                                    <label class="universal-form-label">Reference No.</label>
                                    <input type="text" name="reference_no" 
                                        value="{{ request.args.get('reference_no', '') }}" 
                                        placeholder="Search by reference number..."
                                        class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                </div>
                                
                                <div class="universal-form-group">
                                    <label class="universal-form-label">Status</label>
                                    <select name="workflow_status" class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                        <option value="">All Status</option>
                                        <option value="pending" {{ 'selected' if request.args.get('workflow_status') == 'pending' else '' }}>Pending</option>
                                        <option value="pending_approval" {{ 'selected' if request.args.get('workflow_status') == 'pending_approval' else '' }}>Pending Approval</option>
                                        <option value="approved" {{ 'selected' if request.args.get('workflow_status') == 'approved' else '' }}>Approved</option>
                                        <option value="rejected" {{ 'selected' if request.args.get('workflow_status') == 'rejected' else '' }}>Rejected</option>
                                        <option value="completed" {{ 'selected' if request.args.get('workflow_status') == 'completed' else '' }}>Completed</option>
                                    </select>
                                </div>
                                
                                <div class="universal-form-group">
                                    <label class="universal-form-label">Payment Method</label>
                                    <select name="payment_method" class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                        <option value="">All Methods</option>
                                        <option value="cash" {{ 'selected' if request.args.get('payment_method') == 'cash' else '' }}>Cash</option>
                                        <option value="cheque" {{ 'selected' if request.args.get('payment_method') == 'cheque' else '' }}>Cheque</option>
                                        <option value="bank_transfer" {{ 'selected' if request.args.get('payment_method') == 'bank_transfer' else '' }}>Bank Transfer</option>
                                        <option value="upi" {{ 'selected' if request.args.get('payment_method') == 'upi' else '' }}>UPI</option>
                                    </select>
                                </div>
                                
                                <div class="universal-form-group">
                                    <label class="universal-form-label">Min Amount</label>
                                    <input type="number" name="amount_min" 
                                        value="{{ request.args.get('amount_min', '') }}"
                                        placeholder="Minimum amount..."
                                        class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                </div>
                                
                                <div class="universal-form-group">
                                    <label class="universal-form-label">Max Amount</label>
                                    <input type="number" name="amount_max" 
                                        value="{{ request.args.get('amount_max', '') }}"
                                        placeholder="Maximum amount..."
                                        class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                </div>
                                
                            {% elif assembled_data.filter_fields %}
                                <!-- ✅ CONFIGURATION-DRIVEN: Dynamic filters with operator-enhanced labels -->
                                {% for field in assembled_data.filter_fields %}
                                    {% if field.type == 'select' and field.options|length > 0 %}
                                        <div class="universal-form-group">
                                            <label class="universal-form-label">{{ field.label }}</label>
                                            <select name="{{ field.name }}" class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                                {% for option in field.options %}
                                                    <option value="{{ option.value }}" 
                                                        {{ 'selected' if request.args.get(field.name) == option.value else '' }}>
                                                        {{ option.label }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        
                                    {% elif field.type == 'date' %}
                                        <!-- ✅ NOW HANDLES SINGLE DATE FIELDS -->
                                        <div class="universal-form-group">
                                            <label class="universal-form-label">{{ field.label }}</label>
                                            <input type="date" name="{{ field.name }}" 
                                                value="{{ field.value }}"
                                                placeholder="{{ field.placeholder }}"
                                                title="{{ field.placeholder }}"
                                                class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                        </div>
                                        
                                    {% elif field.type == 'number' %}
                                        <div class="universal-form-group">
                                            <label class="universal-form-label">{{ field.label }}</label>
                                            <input type="number" name="{{ field.name }}" 
                                                value="{{ field.value }}"
                                                placeholder="{{ field.placeholder }}"
                                                title="{{ field.placeholder }}"
                                                class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                        </div>
                                        
                                    {% elif field.type == 'email' %}
                                        <div class="universal-form-group">
                                            <label class="universal-form-label">{{ field.label }}</label>
                                            <input type="email" name="{{ field.name }}" 
                                                value="{{ field.value }}"
                                                placeholder="{{ field.placeholder }}"
                                                class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                        </div>
                                        
                                    {% elif field.type == 'text' %}
                                        <!-- Regular text input -->
                                        <div class="universal-form-group">
                                            <label class="universal-form-label">{{ field.label }}</label>
                                            <input type="text" name="{{ field.name }}" 
                                                value="{{ field.value }}"
                                                placeholder="{{ field.placeholder }}"
                                                title="{{ field.placeholder }}"
                                                class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                        </div>
                                    {% endif %}
                                    <!-- Note: date_range fields are handled in Section 1 (Date Filter) -->
                                {% endfor %}
                                
                            {% else %}
                                <!-- FALLBACK: Basic search if no filter fields configured -->
                                <div class="universal-form-group">
                                    <label class="universal-form-label">Text Search</label>
                                    <input type="text" name="search" 
                                        value="{{ request.args.get('search', '') }}" 
                                        placeholder="Search records..."
                                        class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                </div>
                            {% endif %}
                            
                        </div>
                    </div>
                </div>

                <!-- ✅ SECTION 3: Filter Actions (Full Width, At Bottom) -->
                <div class="universal-filter-actions">
                    <div class="universal-filter-actions-left">
                        {% if not auto_submit_enabled %}
                        <!-- Apply Filters button only visible when auto-submit is disabled -->
                        <button type="submit" class="btn-primary" id="apply-filters-btn">
                            <i class="fas fa-search icon-left"></i>Apply Filters
                        </button>
                        {% endif %}
                        <a href="{{ request.path }}" class="btn-secondary">
                            <i class="fas fa-undo icon-left"></i>Reset All
                        </a>
                        
                        <!-- Show Deleted Records Toggle (GET request, no form) -->
                        <div class="d-inline ms-3">
                            <div class="form-check form-switch d-inline-flex align-items-center">
                                <input class="form-check-input" 
                                    type="checkbox" 
                                    id="showDeletedToggle"
                                    {% if current_user.show_deleted_records %}checked{% endif %}
                                    onchange="toggleDeleted(this.checked)"
                                    style="cursor: pointer;">
                                <label class="form-check-label ms-2" for="showDeletedToggle" style="cursor: pointer;">
                                    Show Deleted
                                    {% if current_user.show_deleted_records %}
                                        <span class="badge badge-warning ms-1">ON</span>
                                    {% endif %}
                                </label>
                            </div>
                        </div>

                        <script>
                        function toggleDeleted(show) {
                            // Build clean URL with toggle parameter
                            const url = new URL(window.location.href);
                            
                            // Remove any system parameters from current URL
                            const systemParams = ['csrf_token', 'redirect_url', 'entity_type', '_'];
                            systemParams.forEach(param => url.searchParams.delete(param));
                            
                            // Add toggle parameter
                            url.searchParams.set('toggle_deleted', show ? 'true' : 'false');
                            
                            // Navigate to clean URL
                            window.location.href = url.toString();
                        }
                        </script>
                    </div>
                    <div class="universal-filter-actions-right">
                        <button type="button" onclick="handleUniversalExport('csv')" class="btn-outline">
                            <i class="fas fa-download icon-left"></i>Export CSV
                        </button>
                        {% if not auto_submit_enabled %}
                        <button type="button" class="btn-outline" onclick="saveUniversalFilters()">
                            <i class="fas fa-save icon-left"></i>Save Filters
                        </button>
                        {% endif %}
                    </div>
                </div>
            </form>
            
            <!-- ✅ ENHANCED: Filter Summary matching Gold Standard -->
            <div class="universal-filter-summary" id="filter-summary">
                <p class="universal-filter-summary-text">
                    <i class="fas fa-info-circle icon-left"></i>
                    <span id="summary-text">
                        {% if safe_total_count %}
                            Showing {{ safe_total_count }} {{ assembled_data.entity_config.plural_name.lower() if assembled_data and assembled_data.entity_config and assembled_data.entity_config.plural_name else 'records' }}
                            {% set has_active_filters = false %}
                            {% set system_fields = ['page', 'per_page', 'sort', 'direction', 'csrf_token', 'entity_type', 'redirect_url', 'show_deleted', '_'] %}
                            {% for key, value in request.args.items() %}
                                {% if key not in system_fields and value and not key.startswith('_') %}
                                    {% set has_active_filters = true %}
                                {% endif %}
                            {% endfor %}
                            {% if has_active_filters %}
                                matching your filters
                            {% endif %}
                        {% else %}
                            No {{ assembled_data.entity_config.plural_name.lower() if assembled_data and assembled_data.entity_config and assembled_data.entity_config.plural_name else 'records' }} found matching your criteria
                        {% endif %}
                    </span>
                </p>
            </div>

            <!-- ✅ ENHANCED: Modern Active Filters Display -->
            <div class="universal-active-filters-enhanced" id="active-filters">
                {% set has_filters = false %}
                {% set filter_count = 0 %}
                {% set system_fields = ['page', 'per_page', 'sort', 'direction', 'csrf_token', 'entity_type', 'redirect_url', 'show_deleted', '_'] %}
                
                <!-- First pass: count filters -->
                {% for key, value in request.args.items() %}
                    {% if key not in system_fields and value and not key.startswith('_') %}
                        {% set has_filters = true %}  <!-- FIX: Use consistent variable name -->
                        {% set filter_count = filter_count + 1 %}
                    {% endif %}
                {% endfor %}
                
                {% if has_filters %}
                <div class="universal-active-filters-container">
                    <!-- Filter Header with Count and Clear All -->
                    <div class="universal-active-filters-header">
                        <div class="universal-active-filters-info">
                            <i class="fas fa-filter-circle-dollar"></i>
                            <span class="universal-active-filters-label">Active Filters</span>
                            <span class="universal-active-filters-count">{{ filter_count }}</span>
                        </div>
                        <button type="button" class="universal-clear-all-filters-btn" onclick="clearUniversalFilters()">
                            <i class="fas fa-times-circle"></i>Clear All
                        </button>
                    </div>
                    
                    <!-- Filter Tags Grid -->
                    <div class="universal-active-filters-grid">
                        {% for key, value in request.args.items() %}
                            {% if key not in system_fields and value and not key.startswith('_') %}
                            <div class="universal-filter-tag-enhanced">
                                <div class="universal-filter-tag-content">
                                    <span class="universal-filter-tag-label">{{ key.replace('_', ' ').title() }}</span>
                                    <span class="universal-filter-tag-value">{{ cell_value|safe }}</span>
                                </div>
                                <button type="button" class="universal-filter-tag-remove" onclick="removeFilter('{{ key }}')" title="Remove this filter">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    
                    <!-- Filter Summary Stats -->
                    <div class="universal-active-filters-summary">
                        <span class="universal-filters-summary-text">
                            <i class="fas fa-info-circle"></i>
                            {{ filter_count }} filter{{ 's' if filter_count != 1 else '' }} applied • 
                            <span class="universal-results-preview">{{ safe_total_count }} result{{ 's' if safe_total_count != 1 else '' }} found</span>
                        </span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ✅ FIXED: Data Table with proper data access -->
    {% if safe_items and safe_items|length > 0 %}
    <div class="info-card">
        <div class="card-header">
            <div class="card-header-content">
                <h3 class="card-title">
                    {{ assembled_data.entity_config.plural_name if assembled_data and assembled_data.entity_config and assembled_data.entity_config.plural_name else 'Records' }}
                    {% set current_page = safe_pagination.get('page', 1) %}
                    {% set per_page = safe_pagination.get('per_page', 20) %}
                    {% set displayed_count = [per_page, safe_total_count]|min %}
                    <span class="badge badge-info">{{ displayed_count }} of {{ safe_total_count }}</span>
                </h3>
                <div class="card-actions" style="display: none;">
                    <button type="button" class="btn-outline btn-sm" onclick="toggleBulkMode()">
                        <i class="fas fa-check-square icon-left"></i>Bulk Select
                    </button>
                    <button type="button" class="btn-outline btn-sm" onclick="refreshData()">
                        <i class="fas fa-refresh icon-left"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
        
        <div class="universal-table-container">
            <table class="universal-data-table">
                <thead>
                    <tr>                       
                        <!-- DYNAMIC COLUMN HEADERS FROM CONFIGURATION -->
                        {% set table_columns = assembled_data.get('table_columns', []) %}
                        {% if table_columns %}
                            {% for column in table_columns %}
                                <th class="universal-table-header {% if column.sortable %}universal-sortable-header{% endif %} {{ column.css_class }}"
                                    {% if column.sortable %}onclick="handleUniversalSort('{{ column.name }}')"{% endif %}
                                    style="{% if column.width and column.width != 'auto' %}width: {{ column.width }};{% endif %} text-align: {% if column.field_type in ['currency', 'amount', 'decimal', 'number'] %}right{% else %}{{ column.align|default('left') }}{% endif %};">
                                    {{ column.label }}
                                    {% if column.sortable %}
                                        <i class="fas fa-sort universal-sort-indicator"></i>
                                    {% endif %}
                                </th>
                            {% endfor %}
                        {% endif %}
                        
                        <th class="universal-table-header actions-column">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% set items_list = assembled_data.get('items', []) %}
                    {% if items_list and items_list|length > 0 %}
                        {% for item in items_list %}
                        {% set outer_loop_index = loop.index0 %}
                        <tr class="universal-table-row universal-clickable-row {% if item.is_deleted %}deleted-row{% endif %}" 
                            onclick="handleRowClick(event, '{{ item.get(assembled_data.entity_config.primary_key, '') }}')"
                            {% if item.is_deleted %}title="This record has been deleted"{% endif %}>
                            
                            <!-- DYNAMIC CELLS BASED ON COLUMNS -->
                            {% for column in table_columns %}
                                {# ✅ CRITICAL FIX: Enhanced virtual field handling #}
                                {% if assembled_data.table_data %}
                                    {# Use pre-formatted data from data assembler first #}
                                    {% set table_row = assembled_data.table_data[outer_loop_index] %}
                                    {% set cell_value = table_row.get(column.name, item.get(column.name, '')) %}
                                {% else %}
                                    {# Enhanced fallback with virtual field support #}
                                    {% if column.virtual and column.virtual_target and column.virtual_key %}
                                        {% set virtual_data = item.get(column.virtual_target, {}) %}
                                        {% set cell_value = virtual_data.get(column.virtual_key, '') if virtual_data else '' %}
                                    {% else %}
                                        {% set cell_value = item.get(column.name, '') %}
                                    {% endif %}
                                {% endif %}
                                <td class="{{ column.css_class }} {{ column.css_classes }}" 
                                    style="{% if column.width and column.width != 'auto' %}width: {{ column.width }};{% endif %} text-align: {% if column.field_type in ['currency', 'amount', 'decimal', 'number'] %}right{% else %}{{ column.align|default('left') }}{% endif %};"
                                    title="{{ cell_value|striptags if cell_value and cell_value not in ['', '—', '&mdash;', 'â€"'] else '' }}">
                                    
                                    <!-- Handle complex display types first -->
                                    {% if column.complex_display_type == 'entity_reference' %}
                                        <!-- First check if the value is already populated (supplier_name is at top level) -->
                                        {% if cell_value %}
                                            {{ cell_value|safe }}
                                        {% elif column.related_field and item.get(column.related_field) %}
                                            <!-- Fall back to related entity object if direct value is empty -->
                                            {% set related_entity = item.get(column.related_field) %}
                                            {% if related_entity is mapping %}
                                                <!-- Use the field name from the column as the key in related entity -->
                                                {{ related_entity.get(column.name, related_entity.get(column.related_display_field or 'name', 'â€"'))|safe }}
                                            {% else %}
                                                {{ 'â€"' }}
                                            {% endif %}
                                        {% else %}
                                            {{ 'â€"' }}
                                        {% endif %}

                                    <!-- Format based on field type -->
                                    {% elif column.field_type == 'currency' or column.field_type == 'amount' %}
                                        {% if cell_value %}
                                            <!-- Check for mixed payment breakdown based on active filter -->
                                            {% if column.get('format_pattern') == 'mixed_payment_breakdown' 
                                            and item.get('payment_method') == 'mixed' 
                                            and request.args.get('payment_method') %}
                                                
                                                {% set method_mapping = {
                                                    'cash': {'field': 'cash_amount', 'label': 'Cash'},
                                                    'cheque': {'field': 'cheque_amount', 'label': 'Cheque'},
                                                    'bank_transfer': {'field': 'bank_transfer_amount', 'label': 'Bank'},
                                                    'upi': {'field': 'upi_amount', 'label': 'UPI'}
                                                } %}
                                                
                                                {% set filtered_method = request.args.get('payment_method') %}
                                                {% if filtered_method in method_mapping %}
                                                    {% set field_name = method_mapping[filtered_method]['field'] %}
                                                    {% set label = method_mapping[filtered_method]['label'] %}
                                                    {% set breakdown_amount = item.get(field_name, 0)|float %}
                                                    
                                                    {% if breakdown_amount > 0 %}
                                                        <div>
                                                            <div>₹{{ "{:,.2f}".format(cell_value|float) }}</div>
                                                            <div class="text-xs text-gray-600">({{ label }}: ₹{{ "{:,.0f}".format(breakdown_amount) }})</div>
                                                        </div>
                                                    {% else %}
                                                        ₹{{ "{:,.2f}".format(cell_value|float) }}
                                                    {% endif %}
                                                {% else %}
                                                    ₹{{ "{:,.2f}".format(cell_value|float) }}
                                                {% endif %}
                                            {% else %}
                                                <!-- Regular amount display -->
                                                ₹{{ "{:,.2f}".format(cell_value|float) }}
                                            {% endif %}
                                        {% else %}
                                            —
                                        {% endif %}
                                        
                                    {% elif column.field_type == 'select' and column.name == 'payment_method' %}
                                        <!-- Special handling for payment method with icons -->
                                        {% if cell_value %}
                                            {% set method_icons = {
                                                'cash': 'fas fa-money-bill text-green-600',
                                                'cheque': 'fas fa-money-check text-blue-600',
                                                'bank_transfer': 'fas fa-university text-blue-600',
                                                'upi': 'fas fa-mobile-alt text-purple-600',
                                                'mixed': 'fas fa-coins text-warning'
                                            } %}
                                            <i class="{{ method_icons.get(cell_value|lower, 'fas fa-credit-card') }}"></i>
                                            {{ cell_value|title }}
                                        {% else %}
                                            _
                                        {% endif %}
                                        
                                    {% elif column.field_type == 'status_badge' or column.field_type == 'status' %}
                                        <!-- Status badges need safe filter to render HTML -->
                                        {{ cell_value|safe }}
                                    {% else %}
                                            
                                        <!-- Default text display -->
                                        {{ cell_value|default('—', true)|safe if '&' in (cell_value|string) else cell_value|default('—', true) }}
                                        
                                    {% endif %}
                                </td>
                            {% endfor %}
                            
                            <!-- Smart Actions column -->
                            <td class="actions-column" onclick="event.stopPropagation()">
                                <div class="universal-table-actions">
                                    {% set item_id = item.get(assembled_data.entity_config.primary_key) %}
                                    
                                    <!-- View Button (Always show for all entities) -->
                                    {% if assembled_data.entity_config.enable_detail_view != false %}
                                        <a href="{{ get_crud_url(assembled_data.entity_config.entity_type, 'view', item_id) }}" 
                                        class="btn-info btn-sm" title="View">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    {% endif %}
                                    
                                    <!-- Edit Button (Master entities only) -->
                                    {% if can_edit(assembled_data.entity_config.entity_type) and not item.get('deleted_flag') and not item.get('is_deleted') %}
                                        {% set edit_url = get_crud_url(assembled_data.entity_config.entity_type, 'update', item_id) %}
                                        {% if edit_url != '#' %}
                                            <a href="{{ edit_url }}" 
                                            class="btn-primary btn-sm" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                    
                                    <!-- Custom Actions from Configuration -->
                                    {% for action in assembled_data.entity_config.actions %}
                                        {% if action.show_in_list and action.id not in ['view', 'edit', 'delete', 'create'] %}
                                            {% set action_url = action.get_url(item, assembled_data.entity_config) %}
                                            {% if action.confirmation_required %}
                                                <a href="#" 
                                                onclick="confirmAction('{{ action_url }}', '{{ action.confirmation_message }}'); return false;"
                                                class="{{ action.button_type.value }} btn-sm" 
                                                title="{{ action.label }}">
                                                    <i class="{{ action.icon }}"></i>
                                                </a>
                                            {% else %}
                                                <a href="{{ action_url }}" 
                                                class="{{ action.button_type.value }} btn-sm" 
                                                title="{{ action.label }}">
                                                    <i class="{{ action.icon }}"></i>
                                                </a>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="{{ (table_columns|length) + 2 }}" class="text-center py-4 text-gray-500">
                                No {{ assembled_data.entity_config.plural_name|lower }} found
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>



        <!-- ✅ Pagination -->
        {% set per_page = safe_pagination.get('per_page', 20) %}
        {% set current_page = safe_pagination.get('page', 1) %}
        {% set total_pages = safe_pagination.get('total_pages', 1) %}

        {% if safe_total_count > per_page %}
        <div class="universal-pagination-container">
            <div class="universal-pagination-info">
                {% set start_record = (current_page - 1) * per_page + 1 %}
                {% set end_record = [current_page * per_page, safe_total_count]|min %}
                
                Showing {{ start_record }} to {{ end_record }} of {{ safe_total_count }} results
            </div>
            <div class="universal-pagination-buttons">
                {% set has_prev = current_page > 1 %}
                {% set has_next = current_page < total_pages %}
                
                {% if has_prev %}
                    <button class="universal-pagination-button" onclick="handleUniversalPagination({{ current_page - 1 }})">Previous</button>
                {% endif %}
                
                {% set start_page = [1, current_page - 2]|max %}
                {% set end_page = [total_pages, current_page + 2]|min %}
                
                {% for p in range(start_page, end_page + 1) %}
                    {% if p == current_page %}
                        <span class="universal-pagination-button active">{{ p }}</span>
                    {% else %}
                        <button class="universal-pagination-button" onclick="handleUniversalPagination({{ p }})">{{ p }}</button>
                    {% endif %}
                {% endfor %}
                
                {% if has_next %}
                    <button class="universal-pagination-button" onclick="handleUniversalPagination({{ current_page + 1 }})">Next</button>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    
    {% else %}
    <!-- ✅ Empty state -->
    <div class="universal-empty-state">
        <div class="universal-empty-state-icon">
            <i class="{{ assembled_data.entity_config.icon if assembled_data and assembled_data.entity_config and assembled_data.entity_config.icon else 'fas fa-inbox' }}"></i>
        </div>
        <h3 class="universal-empty-state-title">No Records Found</h3>
        <p class="universal-empty-state-description">
            No records match your current filters.
        </p>
        <div class="universal-empty-state-actions">
            <button type="button" class="btn-secondary" onclick="clearUniversalFilters()">
                <i class="fas fa-filter"></i>Clear Filters
            </button>
            {% if can_create(assembled_data.entity_config.entity_type) %}
                {% set create_url = get_crud_url(assembled_data.entity_config.entity_type, 'create') %}
                {% if create_url != '#' %}
                    <a href="{{ create_url }}" class="btn-primary">
                        <i class="fas fa-plus"></i>
                        Add New {{ assembled_data.entity_config.name }}
                    </a>
                {% endif %}
            {% else %}
                <!-- No create permission - show view-only message -->
                <p class="text-muted">You don't have permission to create new records.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- ✅ COMPLETE FIXED JAVASCRIPT SECTION FOR universal_list.html -->
<!-- ✅ FIXED: Replace the entire JavaScript section at the end of universal_list.html -->

<!-- JavaScript Libraries -->
<script src="{{ url_for('static', filename='js/components/universal_forms.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/universal_navigation.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/universal_utils.js') }}"></script>

<!-- Backend State -->
<div style="display: none;" 
     id="backend-filter-state"
     data-default-preset="financial_year"
     data-start-date="{{ request.args.get('start_date', '') }}"
     data-end-date="{{ request.args.get('end_date', '') }}">
</div>

<!-- Entity Configuration -->
<script>
// ✅ FIXED: Use actual server data instead of hardcoded values
{% if assembled_data and assembled_data.entity_config %}
window.assembledData = {
    entity_config: {
        entity_type: "{{ assembled_data.entity_config.entity_type }}",
        enable_saved_filter_suggestions: {{ assembled_data.entity_config.enable_saved_filter_suggestions|tojson }},
        enable_auto_submit: {{ assembled_data.entity_config.enable_auto_submit|tojson }},
        primary_key: "{{ assembled_data.entity_config.primary_key }}",
        name: "{{ assembled_data.entity_config.name }}",
        plural_name: "{{ assembled_data.entity_config.plural_name }}"
    }
};
{% else %}
// Fallback if no assembled data
window.assembledData = {
    entity_config: {
        entity_type: "unknown",
        enable_saved_filter_suggestions: true,
        enable_auto_submit: true
    }
};
{% endif %}

console.log('📋 Universal List template loaded');
console.log('🔧 Entity config:', window.assembledData.entity_config);
console.log('🔧 Entity type:', window.assembledData.entity_config.entity_type);
</script>

<!-- Utility Functions -->
<script>
/**
 * Apply summary card filter
 */
function applySummaryFilter(fieldName, fieldValue) {
    const url = new URL(window.location);
    url.searchParams.set(fieldName, fieldValue);
    url.searchParams.delete('page');
    window.location.href = url.toString();
}

/**
 * Clear all filters
 */
function clearUniversalFilters() {
    const url = new URL(window.location);
    const newUrl = new URL(url.pathname, url.origin);
    window.location.href = newUrl.toString();
}

/**
 * Remove individual filter
 */
function removeFilter(filterName) {
    const url = new URL(window.location);
    url.searchParams.delete(filterName);
    url.searchParams.delete('page');
    window.location.href = url.toString();
}

/**
 * Handle table row click to open payment view
 */
function handleRowClick(event, paymentId) {
    console.log('🔍 Row clicked with payment ID:', paymentId);
    console.log('🔍 Payment ID type:', typeof paymentId);
    console.log('🔍 Payment ID length:', paymentId ? paymentId.length : 'undefined');
    
    if (!paymentId) {
        console.warn('❌ No payment ID provided for row click');
        return;
    }
    
    // Get entity type from page data
    const entityType = document.querySelector('[data-entity-type]')?.dataset.entityType || 'supplier_payments';
    
    // Use universal view route
    const targetUrl = `/universal/${entityType}/view/${paymentId}`;
    console.log('🔍 Navigating to URL:', targetUrl);
    
    window.location.href = targetUrl;
}


/**
 * Export functionality
 */
function handleUniversalExport(format) {
    const entityType = document.querySelector('[data-entity-type]')?.dataset.entityType || 'universal';
    const currentParams = new URLSearchParams(window.location.search);
    currentParams.set('export', format);
    
    const exportUrl = `/universal/${entityType}/export?${currentParams.toString()}`;
    window.open(exportUrl, '_blank');
}

/**
 * Refresh page data
 */
function refreshData() {
    window.location.reload();
}

/**
 * Confirm delete action
 */
function confirmDelete(itemId, itemName = 'this record') {
    if (confirm(`Are you sure you want to delete ${itemName}?`)) {
        console.log('Delete confirmed for item:', itemId);
    }
}

console.log('✅ Universal List utility functions loaded');

/**
 * Toggle showing deleted records
 * NOTE: Now handled by form submission to universal_toggle_deleted route
 */
// Function removed - using form submission pattern instead
</script>

<script>
function confirmAction(url, message) {
    if (confirm(message)) {
        window.location.href = url;
    }
    return false;
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    
    // Set current date in dd/mm/yyyy format
    const dateStr = now.toLocaleDateString('en-GB'); // dd/mm/yyyy format
    document.getElementById('current-date').textContent = dateStr;
    
    // Set current day
    const dayStr = now.toLocaleDateString('en-US', { weekday: 'long' });
    document.getElementById('current-day').textContent = dayStr;
});
// Smart delete button handler
document.addEventListener('DOMContentLoaded', function() {
    // Handle all delete buttons with class 'delete-btn'
    const deleteButtons = document.querySelectorAll('.delete-btn');
    
    deleteButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const deleteUrl = this.dataset.deleteUrl;
            const entityName = this.dataset.entityName || 'this item';
            
            if (confirm(`Are you sure you want to delete ${entityName}?`)) {
                // Use fetch API instead of form submission to avoid URL pollution
                fetch(deleteUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Clean reload without parameters
                        window.location.href = window.location.pathname;
                    } else {
                        alert(data.message || 'Failed to delete');
                    }
                })
                .catch(error => {
                    console.error('Delete error:', error);
                    alert('An error occurred while deleting');
                });
            }
        });
    });
});

function getCSRFToken() {
    // Try to get CSRF token from various sources
    const csrfInput = document.querySelector('[name=csrf_token]');
    if (csrfInput) return csrfInput.value;
    
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) return csrfMeta.content;
    
    // Get from cookie if available
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrf_token') return value;
    }
    
    return '';
}
</script>


</div> <!-- ✅ Close main container -->

{% endblock %} <!-- ✅ CRITICAL: Template block closure -->