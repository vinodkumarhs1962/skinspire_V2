{% extends "layouts/dashboard.html" %}

{% block content %}
<!-- =============================================================================
UNIVERSAL LIST TEMPLATE - FIXED FOR GOLD STANDARD COMPATIBILITY
Fixed: Summary cards, Filter layout, Table data, Debug code issues
============================================================================= -->

<div class="container mx-auto px-4 py-6" data-entity-type="{{ assembled_data.entity_config.entity_type if assembled_data and assembled_data.entity_config and assembled_data.entity_config.entity_type else 'supplier_payments' }}">
    {% set auto_submit_enabled = assembled_data.entity_config.get('enable_auto_submit', True) if assembled_data and assembled_data.entity_config else True %}
    <!-- ✅ Page Header using gold standard structure -->
    <div class="mb-6">
        <!-- First Row: Hospital/Branch and Date/Time -->
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-3">
            <!-- Left: Hospital and Branch (bold, bigger fonts, spaced) -->
            <div class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                {% if assembled_data and assembled_data.get('hospital_name') and assembled_data.get('branch_name') %}
                    {{ assembled_data.hospital_name }} <span class="mx-3">•</span> {{ assembled_data.branch_name }}
                {% elif assembled_data and assembled_data.get('hospital_name') %}
                    {{ assembled_data.hospital_name }}
                {% else %}
                    Hospital • Branch
                {% endif %}
            </div>

            <!-- Right: Current Date and Day (Top-right corner) -->
            <div class="text-right mt-2 md:mt-0">
                <div class="text-lg font-semibold text-gray-900 dark:text-gray-100" id="current-date">
                    <!-- Date will be set by JavaScript -->
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400" id="current-day">
                    <!-- Day will be set by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Second Row: Entity Title and Description -->
        <div class="mb-3">
            <!-- Entity Title with colored icon (left aligned) -->
            <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-1">
                <i class="{{ assembled_data.entity_config.icon if assembled_data and assembled_data.entity_config and assembled_data.entity_config.icon else 'fas fa-money-bill-wave' }} text-blue-600"></i>
                {{ assembled_data.entity_config.page_title if assembled_data and assembled_data.entity_config and assembled_data.entity_config.page_title else 'Universal List' }}
            </h1>

            <!-- Description (left aligned) -->
            <p class="text-gray-600 dark:text-gray-400">
                {{ assembled_data.entity_config.description if assembled_data and assembled_data.entity_config and assembled_data.entity_config.description else 'Universal entity management' }}
            </p>
        </div>

        <!-- Third Row: Action Buttons -->
        <div class="flex flex-wrap gap-2">
                <!-- Standard Back Button (Always First) -->
                <button onclick="window.history.back()" type="button" class="btn-back">
                    <i class="fas fa-arrow-left icon-left"></i>Back
                </button>

            {% if assembled_data and assembled_data.entity_config and assembled_data.entity_config.actions %}
                {% set has_create_action = false %}
                {% for action in assembled_data.entity_config.actions %}
                    {# Show actions configured for LIST page toolbar #}
                    {% if action.show_in_list_toolbar %}
                        {% if action.id == 'create' %}
                            {% set has_create_action = true %}
                        {% endif %}
                        <a href="{{ action.get_url(assembled_data, assembled_data.entity_config) }}"
                        class="{{ action.button_type.value }}">
                            <i class="{{ action.icon }} icon-left"></i>{{ action.label }}
                        </a>
                    {% endif %}
                {% endfor %}
                
                <!-- Add smart create button if not in actions -->
                {% if not has_create_action and can_create(assembled_data.entity_config.entity_type) %}
                    {% set create_url = get_crud_url(assembled_data.entity_config.entity_type, 'create') %}
                    {% if create_url != '#' %}
                        <a href="{{ create_url }}" class="btn-primary">
                            <i class="fas fa-plus icon-left"></i>Add New {{ assembled_data.entity_config.name }}
                        </a>
                    {% endif %}
                {% endif %}
            {% else %}
                <!-- Fallback: Smart create button -->
                {% if can_create(assembled_data.entity_config.entity_type) %}
                    {% set create_url = get_crud_url(assembled_data.entity_config.entity_type, 'create') %}
                    {% if create_url != '#' %}
                        <a href="{{ create_url }}" class="btn-primary">
                            <i class="fas fa-plus icon-left"></i>Add New
                        </a>
                    {% endif %}
                {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- ✅ GENERIC: Info Card (Config-driven, entity-agnostic) -->
    {% if assembled_data.entity_config.get('show_info_card', False) and assembled_data.get('info_card') %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 mb-6" style="padding: 1.25rem !important;">
        <!-- Name Section -->
        <div style="margin-bottom: 1rem !important; padding-bottom: 0.75rem !important; border-bottom: 1px solid rgb(229 231 235) !important;">
            <h3 style="font-size: 1.5rem !important; font-weight: 700 !important; color: rgb(17 24 39) !important; line-height: 1.2 !important; margin: 0 !important;" class="dark:text-gray-100">
                {{ assembled_data.info_card.title }}
            </h3>
        </div>

        <!-- Fields Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3" style="gap: 1rem !important;">
            {% for field in assembled_data.info_card.fields %}
            {% if field.value %}
            <div class="flex items-start {% if field.full_width %}col-span-1 md:col-span-2 xl:col-span-3{% endif %}" style="gap: 0.875rem !important; padding: 0.75rem !important; background: rgb(249 250 251) !important; border-radius: 0.5rem !important;" class="dark:bg-gray-700">
                <i class="{{ field.icon }} {{ field.icon_color }}" style="flex-shrink: 0 !important; font-size: 1.25rem !important; margin-top: 0.125rem !important;"></i>
                <div style="flex-grow: 1 !important; min-width: 0 !important;">
                    <div style="font-size: 0.75rem !important; font-weight: 600 !important; color: rgb(107 114 128) !important; text-transform: uppercase !important; letter-spacing: 0.05em !important; margin-bottom: 0.375rem !important;" class="dark:text-gray-400">{{ field.label }}</div>
                    <div style="font-size: 1rem !important; font-weight: 600 !important; color: rgb(17 24 39) !important; line-height: 1.4 !important; word-break: break-word !important;" class="dark:text-gray-100">
                        {{ field.value }}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- ✅ FIXED: Summary Cards with dictionary access instead of attribute access -->
    {% set safe_summary = assembled_data.get('summary', {}) if assembled_data else {} %}
    {% set safe_pagination = assembled_data.get('pagination', {}) if assembled_data else {} %}
    {% set safe_items = assembled_data.get('items', []) if assembled_data else [] %}
    {% set safe_total_count = safe_pagination.get('total_count', safe_summary.get('total_count', safe_items|length)) %}
    

    <!-- ✅ Configuration-Driven Summary Cards using backend assembled data -->
    {% if assembled_data and assembled_data.summary_cards %}
        <!-- Primary: Use data assembler's _assemble_summary_cards output -->
        <div class="card-grid cols-4 mb-6">
            {% for card in assembled_data.summary_cards %}
            {% set current_summary = assembled_data.get('summary', {}) %}
            {% set card_value = current_summary.get(card.get('field', ''), card.get('raw_value', 0)) %}
            {% set formatted_value = ("Rs.{:,.2f}".format(card_value|float) if card.get('type') == 'currency' else "{:,}".format(card_value|int if card_value else 0)) %}
            
            <div class="stat-card{% if card.filterable %} clickable{% endif %}"
                {% if card.filterable and card.filter_field and card.filter_value %}
                onclick="applySummaryFilter('{{ card.filter_field }}', '{{ card.filter_value }}')"
                {% elif card.filterable and card.id == 'total_count' %}
                onclick="clearUniversalFilters()"
                {% endif %}>
                <div class="{{ card.get('icon_css_class', 'stat-card-icon info') }}">
                    <i class="{{ card.icon }}"></i>
                </div>
                {% if card.get('card_type') == 'detail' %}
                
                <!-- ✅ GENERIC: Detail card rendering for breakdowns -->
                <div class="stat-card-value" style="font-size: 0.7rem; line-height: 1.1; padding: 2px 0;">
                    {% set breakdown_data = card.get('breakdown_data', {}) %}
                    {% set breakdown_fields = card.get('breakdown_fields', {}) %}
                    {% if breakdown_fields %}
                        {% for field_key, field_config in breakdown_fields.items() %}
                            {% set amount = breakdown_data.get(field_key, 0) %}
                            {% if amount and amount > 0 %}
                            <div style="margin-bottom: 2px; display: flex; align-items: center; justify-content: space-between;">
                                <span class="breakdown-row-label">
                                    <span class="breakdown-icon-tab">
                                        <i class="{{ field_config.get('icon', 'fas fa-circle') }} {{ field_config.get('color', 'text-gray-600') }}"></i>
                                    </span>
                                    <span class="breakdown-label-text">{{ field_config.get('label', field_key) }}</span>
                                </span>
                                <span class="breakdown-amount-value">
                                    {% if card.get('type') == 'currency' %}
                                        ₹{{ (amount|float|round|int)|format_number(decimals=0, use_indian_format=True) }}
                                    {% else %}
                                        {{ amount }}
                                    {% endif %}
                                </span>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div>{{ formatted_value if card.get('field') else card.value }}</div>
                    {% endif %}
                </div>
                {% else %}
                <!-- ✅ STANDARD: Summary card rendering (existing behavior) -->
                <div class="stat-card-value">{{ formatted_value if card.get('field') else card.value }}</div>
                {% endif %}
                
                <div class="stat-card-label">{{ card.label }}</div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- ✅ Fallback: Use gold standard pattern if no summary_cards assembled -->
        <div class="card-grid cols-4 mb-6">
            <div class="stat-card clickable" onclick="clearUniversalFilters()">
                <div class="stat-card-icon primary">
                    <i class="{{ assembled_data.get('entity_config', {}).get('icon', 'fas fa-list') }}"></i>
                </div>
                <div class="stat-card-value">{{ safe_total_count }}</div>
                <div class="stat-card-label">Total {{ assembled_data.get('entity_config', {}).get('plural_name', 'Records') }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon success">
                    <i class="fas fa-rupee-sign"></i>
                </div>
                <div class="stat-card-value">₹{{ "%.2f"|format(safe_summary.get('total_amount', 0)|float) }}</div>
                <div class="stat-card-label">Total Amount</div>
            </div>
            <div class="stat-card clickable" onclick="applySummaryFilter('this_month', 'true')">
                <div class="stat-card-icon primary">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="stat-card-value">{{ safe_summary.get('this_month_count', 0) }}</div>
                <div class="stat-card-label">This Month</div>
            </div>
            <div class="stat-card clickable" onclick="applySummaryFilter('status', 'pending')">
                <div class="stat-card-icon danger">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-card-value">{{ safe_summary.get('pending_count', 0) }}</div>
                <div class="stat-card-label">Pending</div>
            </div>
        </div>
    {% endif %}

    <!-- ✅ FIXED: Filter Card with proper horizontal layout -->
    {% if assembled_data.entity_config.get('show_filter_card', True) %}
    <div class="universal-filter-card-header">
        <h3 class="universal-filter-card-title">
            <i class="fas fa-filter"></i>Filter {{ assembled_data.entity_config.plural_name if assembled_data and assembled_data.entity_config and assembled_data.entity_config.plural_name else 'Records' }}
        </h3>
        <div class="universal-filter-results-count">
            <span id="results-count">{{ safe_total_count }} results</span>
        </div>
    </div>
        
        <div class="universal-filter-card-body">
            <form method="GET" action="{{ request.path }}" id="universal-filter-form" class="universal-filter-form">
                
                <!-- ✅ SECTION 1: Date Filter (Always Visible) -->
                <div class="universal-date-filter-container">
                    <div class="universal-date-filter-section">
                        <div class="universal-date-filter-title">
                            <i class="fas fa-calendar-alt"></i>Date Range
                        </div>
                        
                        <div class="universal-date-filter-presets-row">
                            <button type="button" class="universal-date-preset-btn universal-date-filter-preset" data-preset="today">
                                <i class="fas fa-calendar-day"></i>Today
                            </button>
                            <button type="button" class="universal-date-preset-btn universal-date-filter-preset" data-preset="this_month">
                                <i class="fas fa-calendar-alt"></i>This Month
                            </button>
                            <button type="button" class="universal-date-preset-btn universal-date-filter-preset" data-preset="financial_year">
                                <i class="fas fa-calendar-year"></i>Financial Year
                            </button>
                            <button type="button" class="universal-date-preset-btn universal-date-filter-preset" data-preset="clear">
                                <i class="fas fa-times"></i>Clear
                            </button>
                        </div>
                        
                        <!-- Row 2: Date Input Fields (Full Width) -->
                        <div class="universal-date-filter-inputs-row">
                            <div class="universal-date-input-group">
                                <label class="universal-date-label">From Date</label>
                                <input type="date" name="start_date" id="start_date" 
                                    value="{{ request.args.get('start_date', '') }}" 
                                    class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                            </div>
                            <div class="universal-date-separator-container">
                                <span class="universal-date-filter-separator">to</span>
                            </div>
                            <div class="universal-date-input-group">
                                <label class="universal-date-label">To Date</label>
                                <input type="date" name="end_date" id="end_date" 
                                    value="{{ request.args.get('end_date', '') }}" 
                                    class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ✅ SECTION 2: Filter Fields -->
                <div class="universal-other-filters-container">
                    <div class="universal-other-filters-section">
                        <div class="universal-filter-grid">      
                            {% if assembled_data.filter_fields %}
                                <!-- ✅ CONFIGURATION-DRIVEN: Dynamic filters with operator-enhanced labels -->
                                {% for field in assembled_data.filter_fields %}
                                    <!-- ✅ NEW: Entity Dropdown Filter (v5.1) -->
                                    {% if field.type == 'entity_dropdown' %}
                                        <div class="universal-form-group">
                                            <label class="universal-form-label">{{ field.label }}</label>
                                            <div class="entity-dropdown-container"
                                                 data-filter-type="entity_dropdown"
                                                 data-name="{{ field.name }}"
                                                 data-value="{{ field.value }}"
                                                 data-display-value="{{ field.display_value }}"
                                                 data-placeholder="{{ field.placeholder }}"
                                                 data-entity-config='{{ field.entity_config | tojson }}'>
                                                <!-- Dropdown will be initialized by JavaScript -->
                                                <input type="hidden"
                                                       name="{{ field.name }}"
                                                       value="{{ field.value }}"
                                                       class="entity-dropdown-hidden-input">
                                                <input type="text"
                                                       class="universal-form-input entity-dropdown-search"
                                                       placeholder="{{ field.placeholder }}"
                                                       value="{{ field.display_value }}">
                                                <div class="entity-dropdown-results" style="display: none;"></div>
                                            </div>
                                        </div>

                                    {% elif field.type == 'autocomplete' %}
                                        <div class="universal-form-group">
                                            <label class="universal-form-label">{{ field.label }}</label>
                                            <div class="universal-autocomplete-wrapper" style="position: relative;">
                                                <!-- Search input with name attribute (submits the filter) -->
                                                <!-- When item selected, stores UUID in value, displays name as placeholder/data attribute -->
                                                <input type="text"
                                                       id="{{ field.display_name }}_search"
                                                       name="{{ field.display_name }}"
                                                       class="universal-form-input universal-autocomplete-search"
                                                       placeholder="{{ field.placeholder }}"
                                                       autocomplete="off"
                                                       value="{{ field.value or '' }}"
                                                       data-autocomplete-type="{{ field.autocomplete_config.entity_type }}"
                                                       data-value-field="{{ field.autocomplete_config.value_field }}"
                                                       data-display-field="{{ field.display_name }}"
                                                       data-display-text=""
                                                       data-config='{{ field.autocomplete_config | tojson }}'>

                                                <!-- Dropdown results -->
                                                <div id="{{ field.display_name }}_dropdown"
                                                     class="universal-autocomplete-dropdown absolute z-50 w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg hidden mt-1 max-h-60 overflow-y-auto">
                                                </div>

                                                <!-- Loading indicator -->
                                                <div id="{{ field.display_name }}_loading"
                                                     class="absolute right-3 top-3 hidden">
                                                    <i class="fas fa-spinner fa-spin text-gray-400"></i>
                                                </div>
                                            </div>
                                        </div>

                                    {% elif field.type == 'select' and field.options|length > 0 %}
                                        <div class="universal-form-group">
                                            <label class="universal-form-label">{{ field.label }}</label>
                                            <select name="{{ field.name }}" class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                                {% for option in field.options %}
                                                    <option value="{{ option.value }}" 
                                                        {{ 'selected' if request.args.get(field.name, '') == option.value else '' }}>
                                                        {{ option.label }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        
                                    {% elif field.type == 'date' %}
                                        <!-- ✅ NOW HANDLES SINGLE DATE FIELDS -->
                                        <div class="universal-form-group">
                                            <label class="universal-form-label">{{ field.label }}</label>
                                            <input type="date" name="{{ field.name }}" 
                                                value="{{ field.value }}"
                                                placeholder="{{ field.placeholder }}"
                                                title="{{ field.placeholder }}"
                                                class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                        </div>
                                        
                                    {% elif field.type == 'number' %}
                                        <div class="universal-form-group">
                                            <label class="universal-form-label">{{ field.label }}</label>
                                            <input type="number" name="{{ field.name }}" 
                                                value="{{ field.value }}"
                                                placeholder="{{ field.placeholder }}"
                                                title="{{ field.placeholder }}"
                                                class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                        </div>
                                        
                                    {% elif field.type == 'email' %}
                                        <div class="universal-form-group">
                                            <label class="universal-form-label">{{ field.label }}</label>
                                            <input type="email" name="{{ field.name }}" 
                                                value="{{ field.value }}"
                                                placeholder="{{ field.placeholder }}"
                                                class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                        </div>
                                        
                                    {% elif field.type == 'text' %}
                                        <!-- Regular text input -->
                                        <div class="universal-form-group">
                                            <label class="universal-form-label">{{ field.label }}</label>
                                            <input type="text" name="{{ field.name }}" 
                                                value="{{ field.value }}"
                                                placeholder="{{ field.placeholder }}"
                                                title="{{ field.placeholder }}"
                                                class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                        </div>
                                    {% endif %}
                                    <!-- Note: date_range fields are handled in Section 1 (Date Filter) -->
                                {% endfor %}
                                
                            {% else %}
                                <!-- FALLBACK: Basic search if no filter fields configured -->
                                <div class="universal-form-group">
                                    <label class="universal-form-label">Text Search</label>
                                    <input type="text" name="search" 
                                        value="{{ request.args.get('search', '') }}" 
                                        placeholder="Search records..."
                                        class="universal-form-input{% if auto_submit_enabled %} universal-filter-auto-submit{% endif %}">
                                </div>
                            {% endif %}
                            
                        </div>
                    </div>
                </div>

                <!-- ✅ SECTION 3: Filter Actions (Full Width, At Bottom) -->
                <div class="universal-filter-actions">
                    <div class="universal-filter-actions-left">
                        {% if not auto_submit_enabled %}
                        <!-- Apply Filters button only visible when auto-submit is disabled -->
                        <button type="submit" class="btn-primary" id="apply-filters-btn">
                            <i class="fas fa-search icon-left"></i>Apply Filters
                        </button>
                        {% endif %}
                        <a href="{{ request.path }}" class="btn-secondary">
                            <i class="fas fa-undo icon-left"></i>Reset All
                        </a>
                        
                        <!-- Show Deleted Records Toggle (GET request, no form) -->
                        <div class="d-inline ms-3">
                            <div class="form-check form-switch d-inline-flex align-items-center">
                                <input class="form-check-input" 
                                    type="checkbox" 
                                    id="showDeletedToggle"
                                    {% if current_user.show_deleted_records %}checked{% endif %}
                                    onchange="toggleDeleted(this.checked)"
                                    style="cursor: pointer;">
                                <label class="form-check-label ms-2" for="showDeletedToggle" style="cursor: pointer;">
                                    Show Deleted
                                    {% if current_user.show_deleted_records %}
                                        <span class="badge badge-warning ms-1">ON</span>
                                    {% endif %}
                                </label>
                            </div>
                        </div>

                        <script>
                        function toggleDeleted(show) {
                            // Build clean URL with toggle parameter
                            const url = new URL(window.location.href);
                            
                            // Remove any system parameters from current URL
                            const systemParams = ['csrf_token', 'redirect_url', 'entity_type', '_'];
                            systemParams.forEach(param => url.searchParams.delete(param));
                            
                            // Add toggle parameter
                            url.searchParams.set('toggle_deleted', show ? 'true' : 'false');
                            
                            // Navigate to clean URL
                            window.location.href = url.toString();
                        }
                        </script>
                    </div>
                    <div class="universal-filter-actions-right">
                        <button type="button" onclick="handleUniversalExport('csv')" class="btn-outline">
                            <i class="fas fa-download icon-left"></i>Export CSV
                        </button>
                        {% if not auto_submit_enabled %}
                        <button type="button" class="btn-outline" onclick="saveUniversalFilters()">
                            <i class="fas fa-save icon-left"></i>Save Filters
                        </button>
                        {% endif %}
                    </div>
                </div>
            </form>
            
            <!-- ✅ ENHANCED: Filter Summary matching Gold Standard -->
            <div class="universal-filter-summary" id="filter-summary">
                <p class="universal-filter-summary-text">
                    <i class="fas fa-info-circle icon-left"></i>
                    <span id="summary-text">
                        {% if safe_total_count %}
                            Showing {{ safe_total_count }} {{ assembled_data.entity_config.plural_name.lower() if assembled_data and assembled_data.entity_config and assembled_data.entity_config.plural_name else 'records' }}
                            {% set has_active_filters = false %}
                            {% set system_fields = ['page', 'per_page', 'sort', 'direction', 'csrf_token', 'entity_type', 'redirect_url', 'show_deleted', '_'] %}
                            {% for key, value in request.args.items() %}
                                {% if key not in system_fields and value and not key.startswith('_') %}
                                    {% set has_active_filters = true %}
                                {% endif %}
                            {% endfor %}
                            {% if has_active_filters %}
                                matching your filters
                            {% endif %}
                        {% else %}
                            No {{ assembled_data.entity_config.plural_name.lower() if assembled_data and assembled_data.entity_config and assembled_data.entity_config.plural_name else 'records' }} found matching your criteria
                        {% endif %}
                    </span>
                </p>
            </div>

            <!-- ✅ ENHANCED: Modern Active Filters Display -->
            <div class="universal-active-filters-enhanced" id="active-filters">
                {% set has_filters = false %}
                {% set filter_count = 0 %}
                {% set system_fields = ['page', 'per_page', 'sort', 'direction', 'csrf_token', 'entity_type', 'redirect_url', 'show_deleted', '_'] %}
                
                <!-- First pass: count filters -->
                {% for key, value in request.args.items() %}
                    {% if key not in system_fields and value and not key.startswith('_') %}
                        {% set has_filters = true %}  <!-- FIX: Use consistent variable name -->
                        {% set filter_count = filter_count + 1 %}
                    {% endif %}
                {% endfor %}
                
                {% if has_filters %}
                <div class="universal-active-filters-container">
                    <!-- Filter Header with Count and Clear All -->
                    <div class="universal-active-filters-header">
                        <div class="universal-active-filters-info">
                            <i class="fas fa-filter-circle-dollar"></i>
                            <span class="universal-active-filters-label">Active Filters</span>
                            <span class="universal-active-filters-count">{{ filter_count }}</span>
                        </div>
                        <button type="button" class="universal-clear-all-filters-btn" onclick="clearUniversalFilters()">
                            <i class="fas fa-times-circle"></i>Clear All
                        </button>
                    </div>
                    
                    <!-- Filter Tags Grid -->
                    <div class="universal-active-filters-grid">
                        {% for key, value in request.args.items() %}
                            {% if key not in system_fields and value and not key.startswith('_') %}
                            <div class="universal-filter-tag-enhanced">
                                <div class="universal-filter-tag-content">
                                    <span class="universal-filter-tag-label">{{ key.replace('_', ' ').title() }}</span>
                                    <span class="universal-filter-tag-value">{{ cell_value|safe }}</span>
                                </div>
                                <button type="button" class="universal-filter-tag-remove" onclick="removeFilter('{{ key }}')" title="Remove this filter">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    
                    <!-- Filter Summary Stats -->
                    <div class="universal-active-filters-summary">
                        <span class="universal-filters-summary-text">
                            <i class="fas fa-info-circle"></i>
                            {{ filter_count }} filter{{ 's' if filter_count != 1 else '' }} applied • 
                            <span class="universal-results-preview">{{ safe_total_count }} result{{ 's' if safe_total_count != 1 else '' }} found</span>
                        </span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ✅ FIXED: Data Table with proper data access -->
    {% if safe_items and safe_items|length > 0 %}
    <div class="info-card">
        <div class="card-header">
            <div class="card-header-content">
                <h3 class="card-title">
                    {{ assembled_data.entity_config.plural_name if assembled_data and assembled_data.entity_config and assembled_data.entity_config.plural_name else 'Records' }}
                    {% set current_page = safe_pagination.get('page', 1) %}
                    {% set per_page = safe_pagination.get('per_page', 20) %}
                    {% set displayed_count = [per_page, safe_total_count]|min %}
                    <span class="badge badge-info">{{ displayed_count }} of {{ safe_total_count }}</span>
                </h3>
                <div class="card-actions" style="display: none;">
                    <button type="button" class="btn-outline btn-sm" onclick="toggleBulkMode()">
                        <i class="fas fa-check-square icon-left"></i>Bulk Select
                    </button>
                    <button type="button" class="btn-outline btn-sm" onclick="refreshData()">
                        <i class="fas fa-refresh icon-left"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
        
        <div class="universal-table-container">
            <table class="universal-data-table">
                <thead>
                    <tr>                       
                        <!-- DYNAMIC COLUMN HEADERS FROM CONFIGURATION -->
                        {% set table_columns = assembled_data.get('table_columns', []) %}
                        {% if table_columns %}
                            {% for column in table_columns %}
                                <th class="universal-table-header {% if column.sortable %}universal-sortable-header{% endif %} {{ column.css_class }}"
                                    {% if column.sortable %}onclick="handleUniversalSort('{{ column.name }}')"{% endif %}
                                    title="{{ column.label }}{% if column.sortable %} - Click to sort{% endif %}"
                                    style="{% if column.width and column.width != 'auto' %}width: {{ column.width }};{% endif %} text-align: {% if column.field_type in ['currency', 'amount', 'decimal', 'number'] %}right{% else %}{{ column.align|default('left') }}{% endif %};">
                                    {{ column.label }}
                                    {% if column.sortable %}
                                        <i class="fas fa-sort universal-sort-indicator"></i>
                                    {% endif %}
                                </th>
                            {% endfor %}
                        {% endif %}
                        
                        <th class="universal-table-header actions-column">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% set items_list = assembled_data.get('items', []) %}
                    {% if items_list and items_list|length > 0 %}
                        {% for item in items_list %}
                        {% set outer_loop_index = loop.index0 %}
                        <tr class="universal-table-row universal-clickable-row {% if item.is_deleted %}deleted-row{% endif %}"
                            {% if item.is_deleted %}title="This record has been deleted"{% endif %}>
                            
                            <!-- DYNAMIC CELLS BASED ON COLUMNS -->
                            {% for column in table_columns %}
                                {# ✅ CRITICAL FIX: Enhanced virtual field handling #}
                                {% if assembled_data.table_data %}
                                    {# Use pre-formatted data from data assembler first #}
                                    {% set table_row = assembled_data.table_data[outer_loop_index] %}
                                    {% set cell_value = table_row.get(column.name, item.get(column.name, '')) %}
                                {% else %}
                                    {# Enhanced fallback with virtual field support #}
                                    {% if column.virtual and column.virtual_target and column.virtual_key %}
                                        {% set virtual_data = item.get(column.virtual_target, {}) %}
                                        {% set cell_value = virtual_data.get(column.virtual_key, '') if virtual_data else '' %}
                                    {% else %}
                                        {% set cell_value = item.get(column.name, '') %}
                                    {% endif %}
                                {% endif %}
                                <td class="{{ column.css_class }} {{ column.css_classes }}"
                                    onclick="handleRowClick(event, '{{ item.get(assembled_data.entity_config.primary_key, '') }}')"
                                    style="{% if column.width and column.width != 'auto' %}width: {{ column.width }};{% endif %} text-align: {% if column.field_type in ['currency', 'amount', 'decimal', 'number'] %}right{% else %}{{ column.align|default('left') }}{% endif %};"
                                    title="{{ cell_value|striptags if cell_value and cell_value not in ['', '—', '&mdash;', 'â€"'] else '' }}">
                                    
                                    <!-- Handle complex display types first -->
                                    {% if column.complex_display_type == 'entity_reference' %}
                                        <!-- First check if the value is already populated (supplier_name is at top level) -->
                                        {% if cell_value %}
                                            {{ cell_value|safe }}
                                        {% elif column.related_field and item.get(column.related_field) %}
                                            <!-- Fall back to related entity object if direct value is empty -->
                                            {% set related_entity = item.get(column.related_field) %}
                                            {% if related_entity is mapping %}
                                                <!-- Use the field name from the column as the key in related entity -->
                                                {{ related_entity.get(column.name, related_entity.get(column.related_display_field or 'name', 'â€"'))|safe }}
                                            {% else %}
                                                {{ 'â€"' }}
                                            {% endif %}
                                        {% else %}
                                            {{ 'â€"' }}
                                        {% endif %}

                                    <!-- Format based on field type -->
                                    {% elif column.field_type == 'currency' or column.field_type == 'amount' %}
                                        {% if cell_value %}
                                            <!-- Check for mixed payment breakdown based on active filter -->
                                            {% if column.get('format_pattern') == 'mixed_payment_breakdown' 
                                            and item.get('payment_method') == 'mixed' 
                                            and request.args.get('payment_method') %}
                                                
                                                {% set method_mapping = {
                                                    'cash': {'field': 'cash_amount', 'label': 'Cash'},
                                                    'cheque': {'field': 'cheque_amount', 'label': 'Cheque'},
                                                    'bank_transfer': {'field': 'bank_transfer_amount', 'label': 'Bank'},
                                                    'upi': {'field': 'upi_amount', 'label': 'UPI'}
                                                } %}
                                                
                                                {% set filtered_method = request.args.get('payment_method') %}
                                                {% if filtered_method in method_mapping %}
                                                    {% set field_name = method_mapping[filtered_method]['field'] %}
                                                    {% set label = method_mapping[filtered_method]['label'] %}
                                                    {% set breakdown_amount = item.get(field_name, 0)|float %}
                                                    
                                                    {% if breakdown_amount > 0 %}
                                                        <div>
                                                            <div>₹{{ "{:,.2f}".format(cell_value|float) }}</div>
                                                            <div class="text-xs text-gray-600">({{ label }}: ₹{{ "{:,.0f}".format(breakdown_amount) }})</div>
                                                        </div>
                                                    {% else %}
                                                        ₹{{ "{:,.2f}".format(cell_value|float) }}
                                                    {% endif %}
                                                {% else %}
                                                    ₹{{ "{:,.2f}".format(cell_value|float) }}
                                                {% endif %}
                                            {% else %}
                                                <!-- Regular amount display -->
                                                ₹{{ "{:,.2f}".format(cell_value|float) }}
                                            {% endif %}
                                        {% else %}
                                            —
                                        {% endif %}
                                        
                                    {% elif column.field_type == 'select' and column.name == 'payment_method' %}
                                        <!-- Special handling for payment method with icons -->
                                        {% if cell_value %}
                                            {% set method_icons = {
                                                'cash': 'fas fa-money-bill text-green-600',
                                                'cheque': 'fas fa-money-check text-blue-600',
                                                'bank_transfer': 'fas fa-university text-blue-600',
                                                'upi': 'fas fa-mobile-alt text-purple-600',
                                                'mixed': 'fas fa-coins text-warning'
                                            } %}
                                            <i class="{{ method_icons.get(cell_value|lower, 'fas fa-credit-card') }}"></i>
                                            {{ cell_value|title }}
                                        {% else %}
                                            _
                                        {% endif %}
                                        
                                    {% elif column.field_type == 'status_badge' or column.field_type == 'status' %}
                                        <!-- Status badges need safe filter to render HTML -->
                                        {{ cell_value|safe }}
                                    {% else %}
                                        {# Check if column is configured for text wrapping (respect configuration) #}
                                        {% if column.css_classes and 'text-wrap' in column.css_classes %}
                                            <!-- Config says wrap - show full text, let CSS handle wrapping -->
                                            {{ cell_value|default('—', true)|safe if '&' in (cell_value|string) else cell_value|default('—', true) }}
                                        {% else %}
                                            {# DEFAULT: Middle truncation for text fields - shows first 10 and last 4 chars #}
                                            {% set cell_text = cell_value|default('—', true)|string %}
                                            {% if cell_text and cell_text not in ['—', '', '&mdash;'] and cell_text|length > 15 %}
                                                {% set start_chars = cell_text[:10] %}
                                                {% set end_chars = cell_text[-4:] %}
                                                <span class="truncate-middle-wrapper" title="{{ cell_text }}">
                                                    <span class="truncate-middle-start">{{ start_chars }}</span><span class="truncate-middle-ellipsis">...</span><span class="truncate-middle-end">{{ end_chars }}</span>
                                                </span>
                                            {% else %}
                                                <!-- Default text display for short text -->
                                                {{ cell_value|default('—', true)|safe if '&' in (cell_value|string) else cell_value|default('—', true) }}
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                </td>
                            {% endfor %}
                            
                            <!-- Smart Actions column -->
                            <td class="actions-column-fixed" onclick="event.stopPropagation()">
                                <div class="universal-table-actions-improved">
                                    {% set item_id = item.get(assembled_data.entity_config.primary_key) %}
                                    
                                    <!-- Only show other actions if not deleted -->
                                    {% if not item.get('is_deleted') and not item.get('deleted_flag') %}
                                        <!-- Show configured inline actions based on conditions -->
                                        {% for action in assembled_data.entity_config.actions %}
                                            {% if action.show_in_list and (not action.display_type or action.display_type.value == 'button') %}
                                                {# Evaluate ALL conditions - all must pass #}
                                                {% set show_action = true %}
                                                
                                                {% if action.conditions %}
                                                    {% for field, allowed_values in action.conditions.items() %}
                                                        {# Skip fields that don't exist in the item #}
                                                        {% if field in ['can_be_approved', 'can_be_deleted', 'can_be_unapproved', 'has_invoice'] %}
                                                            {# Skip virtual fields that might not exist #}
                                                        {% else %}
                                                            {% set field_value = item.get(field) %}
                                                            {# DEBUG: Log condition evaluation for delete action #}
                                                            {% if action.id == 'delete_row' or action.id == 'delete' %}
                                                                <!-- DEBUG: Action {{ action.id }}, Field {{ field }}={{ field_value }}, Allowed={{ allowed_values }} -->
                                                            {% endif %}
                                                            {# ✅ FIXED: Handle None case for is_deleted - treat as False #}
                                                            {% if field == 'is_deleted' and field_value is none %}
                                                                {% set field_value = false %}
                                                            {% endif %}
                                                            {% if field_value not in allowed_values %}
                                                                {% set show_action = false %}
                                                                {% if action.id == 'delete_row' or action.id == 'delete' %}
                                                                    <!-- DEBUG: Hiding {{ action.id }} because {{ field }}={{ field_value }} not in {{ allowed_values }} -->
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                                
                                                {# Additional check to prevent both approve and unapprove showing #}
                                                {% if action.id == 'approve' and item.get('po_status') != 'draft' %}
                                                    {% set show_action = false %}
                                                {% elif action.id == 'unapprove' and item.get('po_status') != 'approved' %}
                                                    {% set show_action = false %}
                                                {% elif action.id == 'cancel' and item.get('po_status') == 'cancelled' %}
                                                    {% set show_action = false %}
                                                {# ✅ NEW: Hide Create Invoice for draft and cancelled POs #}
                                                {% elif action.id == 'create_invoice' and item.get('po_status') in ['draft', 'cancelled'] %}
                                                    {% set show_action = false %}
                                                {% endif %}
                                                
                                                {% if show_action %}
                                                    {% set action_url = action.get_url(item, assembled_data.entity_config) %}
                                                    {% set btn_type = action.button_type.value|replace('btn-', '') %}
                                                    
                                                    {% if action.confirmation_required %}
                                                        <a href="#" 
                                                        onclick="confirmAction('{{ action_url }}', '{{ action.confirmation_message }}'); return false;"
                                                        class="btn-action-sm btn-{{ btn_type }}"
                                                        title="{{ action.label }}">
                                                            <i class="{{ action.icon }} action-icon-sm"></i>
                                                        </a>
                                                    {% else %}
                                                        <a href="{{ action_url }}" 
                                                        class="btn-action-sm btn-{{ btn_type }}"
                                                        title="{{ action.label }}">
                                                            <i class="{{ action.icon }} action-icon-sm"></i>
                                                        </a>
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="{{ (table_columns|length) + 2 }}" class="text-center py-4 text-gray-500">
                                No {{ assembled_data.entity_config.plural_name|lower }} found
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>



        <!-- ✅ Pagination -->
        {% set per_page = safe_pagination.get('per_page', 20) %}
        {% set current_page = safe_pagination.get('page', 1) %}
        {% set total_pages = safe_pagination.get('total_pages', 1) %}

        {% if safe_total_count > per_page %}
        <div class="universal-pagination-container">
            <div class="universal-pagination-info">
                {% set start_record = (current_page - 1) * per_page + 1 %}
                {% set end_record = [current_page * per_page, safe_total_count]|min %}
                
                Showing {{ start_record }} to {{ end_record }} of {{ safe_total_count }} results
            </div>
            <div class="universal-pagination-buttons">
                {% set has_prev = current_page > 1 %}
                {% set has_next = current_page < total_pages %}
                
                {% if has_prev %}
                    <button class="universal-pagination-button" onclick="handleUniversalPagination({{ current_page - 1 }})">Previous</button>
                {% endif %}
                
                {% set start_page = [1, current_page - 2]|max %}
                {% set end_page = [total_pages, current_page + 2]|min %}
                
                {% for p in range(start_page, end_page + 1) %}
                    {% if p == current_page %}
                        <span class="universal-pagination-button active">{{ p }}</span>
                    {% else %}
                        <button class="universal-pagination-button" onclick="handleUniversalPagination({{ p }})">{{ p }}</button>
                    {% endif %}
                {% endfor %}
                
                {% if has_next %}
                    <button class="universal-pagination-button" onclick="handleUniversalPagination({{ current_page + 1 }})">Next</button>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    
    {% else %}
    <!-- ✅ Empty state -->
    <div class="universal-empty-state">
        <div class="universal-empty-state-icon">
            <i class="{{ assembled_data.entity_config.icon if assembled_data and assembled_data.entity_config and assembled_data.entity_config.icon else 'fas fa-inbox' }}"></i>
        </div>
        <h3 class="universal-empty-state-title">No Records Found</h3>
        <p class="universal-empty-state-description">
            No records match your current filters.
        </p>
        <div class="universal-empty-state-actions">
            <button type="button" class="btn-secondary" onclick="clearUniversalFilters()">
                <i class="fas fa-filter"></i>Clear Filters
            </button>
            {% if can_create(assembled_data.entity_config.entity_type) %}
                {% set create_url = get_crud_url(assembled_data.entity_config.entity_type, 'create') %}
                {% if create_url != '#' %}
                    <a href="{{ create_url }}" class="btn-primary">
                        <i class="fas fa-plus"></i>
                        Add New {{ assembled_data.entity_config.name }}
                    </a>
                {% endif %}
            {% else %}
                <!-- No create permission - show view-only message -->
                <p class="text-muted">You don't have permission to create new records.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- ✅ COMPLETE FIXED JAVASCRIPT SECTION FOR universal_list.html -->
<!-- ✅ FIXED: Replace the entire JavaScript section at the end of universal_list.html -->

<!-- JavaScript Libraries -->
<script src="{{ url_for('static', filename='js/components/universal_forms.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/universal_navigation.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/universal_utils.js') }}"></script>

<!-- Backend State -->
<div style="display: none;" 
     id="backend-filter-state"
     data-default-preset="financial_year"
     data-start-date="{{ request.args.get('start_date', '') }}"
     data-end-date="{{ request.args.get('end_date', '') }}">
</div>

<!-- Entity Configuration -->
<script>
// ✅ FIXED: Use actual server data instead of hardcoded values
{% if assembled_data and assembled_data.entity_config %}
window.assembledData = {
    entity_config: {
        entity_type: "{{ assembled_data.entity_config.entity_type }}",
        enable_saved_filter_suggestions: {{ assembled_data.entity_config.enable_saved_filter_suggestions|tojson }},
        enable_auto_submit: {{ assembled_data.entity_config.enable_auto_submit|tojson }},
        primary_key: "{{ assembled_data.entity_config.primary_key }}",
        name: "{{ assembled_data.entity_config.name }}",
        plural_name: "{{ assembled_data.entity_config.plural_name }}"
    }
};
{% else %}
// Fallback if no assembled data
window.assembledData = {
    entity_config: {
        entity_type: "unknown",
        enable_saved_filter_suggestions: true,
        enable_auto_submit: true
    }
};
{% endif %}

console.log('📋 Universal List template loaded');
console.log('🔧 Entity config:', window.assembledData.entity_config);
console.log('🔧 Entity type:', window.assembledData.entity_config.entity_type);
</script>
<!-- ============================================
     ENTITY DROPDOWN ENHANCEMENT (v5.1)
     Progressive Enhancement for Searchable Entity Dropdowns
     ============================================ -->
{% if assembled_data.filter_fields|selectattr('type', 'equalto', 'entity_dropdown')|list %}
    <!-- Entity Dropdown Resources -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/universal_entity_dropdown.css') }}">
    
    <!-- ADD: Prevent duplicate script loading -->
    <script>
    (function() {
        // Prevent multiple script loads
        if (!window.EntityDropdownScriptLoaded) {
            window.EntityDropdownScriptLoaded = true;
            
            var script = document.createElement('script');
            script.src = "{{ url_for('static', filename='js/components/universal_entity_dropdown.js') }}";
            script.async = false;
            
            script.onload = function() {
                console.log('✅ Entity dropdown script loaded successfully');
                
                // Initialize dropdowns after script loads
                setTimeout(function() {
                    if (window.initializeEntityDropdowns && !window.entityDropdownInitializing) {
                        window.initializeEntityDropdowns();
                    }
                }, 200);
            };
            
            script.onerror = function() {
                console.error('❌ Failed to load entity dropdown script');
            };
            
            document.head.appendChild(script);
        } else {
            console.log('Entity dropdown script already loaded');
            // Re-initialize if needed
            setTimeout(function() {
                if (window.initializeEntityDropdowns && !window.entityDropdownInitializing) {
                    window.initializeEntityDropdowns();
                }
            }, 200);
        }
    })();
    </script>
{% endif %}
<!-- Utility Functions -->
<script>
/**
 * Apply summary card filter
 */
function applySummaryFilter(fieldName, fieldValue) {
    const url = new URL(window.location);
    url.searchParams.set(fieldName, fieldValue);
    url.searchParams.delete('page');
    window.location.href = url.toString();
}

/**
 * Clear all filters
 */
function clearUniversalFilters() {
    const url = new URL(window.location);
    const newUrl = new URL(url.pathname, url.origin);
    window.location.href = newUrl.toString();
}

/**
 * Remove individual filter
 */
function removeFilter(filterName) {
    const url = new URL(window.location);
    url.searchParams.delete(filterName);
    url.searchParams.delete('page');
    window.location.href = url.toString();
}

/**
 * Handle table row click to open entity detail view
 * Generic function that works with any entity type in Universal Engine
 */
function handleRowClick(event, itemId) {
    console.log('🔍 Row clicked with item ID:', itemId);
    console.log('🔍 Item ID type:', typeof itemId);
    console.log('🔍 Item ID length:', itemId ? itemId.length : 'undefined');

    if (!itemId) {
        console.warn('❌ No item ID provided for row click');
        return;
    }

    // Prevent navigation if clicking on button or link
    if (event.target.closest('button, a, .btn, .dropdown-toggle')) {
        console.log('🔍 Clicked on button/link, ignoring row click');
        return;
    }

    // Get entity type from page data
    const entityType = document.querySelector('[data-entity-type]')?.dataset.entityType;

    if (!entityType) {
        console.warn('❌ No entity type found on page');
        return;
    }

    // Special handling for different entity types
    let targetUrl;

    if (entityType === 'consolidated_invoice_detail') {
        // In consolidated detail view: clicking on child invoice row → navigate to individual patient invoice detail
        targetUrl = `/universal/patient_invoices/detail/${itemId}`;
    } else if (entityType === 'consolidated_patient_invoices') {
        // In consolidated list view: clicking on parent invoice row → navigate to consolidated invoice detail
        targetUrl = `/universal/consolidated_invoice_detail/${itemId}`;
    } else {
        // Default: use standard Universal Engine detail route
        targetUrl = `/universal/${entityType}/detail/${itemId}`;
    }

    console.log('🔍 Navigating to URL:', targetUrl);

    window.location.href = targetUrl;
}


/**
 * Export functionality
 */
function handleUniversalExport(format) {
    const entityType = document.querySelector('[data-entity-type]')?.dataset.entityType || 'universal';
    const currentParams = new URLSearchParams(window.location.search);
    currentParams.set('export', format);
    
    const exportUrl = `/universal/${entityType}/export?${currentParams.toString()}`;
    window.open(exportUrl, '_blank');
}

/**
 * Refresh page data
 */
function refreshData() {
    window.location.reload();
}

/**
 * Confirm delete action
 */
function confirmDelete(itemId, itemName = 'this record') {
    if (confirm(`Are you sure you want to delete ${itemName}?`)) {
        console.log('Delete confirmed for item:', itemId);
    }
}

console.log('✅ Universal List utility functions loaded');

/**
 * Toggle showing deleted records
 * NOTE: Now handled by form submission to universal_toggle_deleted route
 */
// Function removed - using form submission pattern instead
</script>

<script>
function confirmAction(url, message) {
    if (confirm(message)) {
        window.location.href = url;
    }
    return false;
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    
    // Set current date in dd/mm/yyyy format
    const dateStr = now.toLocaleDateString('en-GB'); // dd/mm/yyyy format
    document.getElementById('current-date').textContent = dateStr;
    
    // Set current day
    const dayStr = now.toLocaleDateString('en-US', { weekday: 'long' });
    document.getElementById('current-day').textContent = dayStr;
});
// Smart delete button handler
document.addEventListener('DOMContentLoaded', function() {
    // Handle all delete buttons with class 'delete-btn'
    const deleteButtons = document.querySelectorAll('.delete-btn');
    
    deleteButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const deleteUrl = this.dataset.deleteUrl;
            const entityName = this.dataset.entityName || 'this item';
            
            if (confirm(`Are you sure you want to delete ${entityName}?`)) {
                // Use fetch API instead of form submission to avoid URL pollution
                fetch(deleteUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Clean reload without parameters
                        window.location.href = window.location.pathname;
                    } else {
                        alert(data.message || 'Failed to delete');
                    }
                })
                .catch(error => {
                    console.error('Delete error:', error);
                    alert('An error occurred while deleting');
                });
            }
        });
    });
});

function getCSRFToken() {
    // Try to get CSRF token from various sources
    const csrfInput = document.querySelector('[name=csrf_token]');
    if (csrfInput) return csrfInput.value;

    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) return csrfMeta.content;

    // Get from cookie if available
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrf_token') return value;
    }

    return '';
}

// =================================================================
// UNIVERSAL AUTOCOMPLETE FILTER IMPLEMENTATION
// =================================================================
class UniversalAutocompleteFilter {
    constructor(searchInput) {
        this.searchInput = searchInput;
        this.config = JSON.parse(searchInput.dataset.config);
        this.entityType = searchInput.dataset.autocompleteType;
        this.valueField = searchInput.dataset.valueField;
        this.displayField = searchInput.dataset.displayField;

        // No longer using hidden input - UUID is stored in search input value
        this.dropdown = document.getElementById(`${this.displayField}_dropdown`);
        this.loadingIcon = document.getElementById(`${this.displayField}_loading`);

        this.searchTimeout = null;
        this.searchCache = new Map();

        this.init();
    }

    init() {
        // Handle input with debounce
        this.searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            clearTimeout(this.searchTimeout);

            if (query.length === 0) {
                // Show initial list when cleared
                this.searchTimeout = setTimeout(() => {
                    this.performSearch('', this.config.initial_load_limit);
                }, 200);
            } else if (query.length >= this.config.min_chars) {
                this.searchTimeout = setTimeout(() => {
                    this.performSearch(query, this.config.search_limit);
                }, 300);
            } else {
                this.hideDropdown();
            }
        });

        // Show initial list on focus
        this.searchInput.addEventListener('focus', () => {
            if (this.searchInput.value.trim().length === 0) {
                this.performSearch('', this.config.initial_load_limit);
            }
        });

        // Hide dropdown on outside click
        document.addEventListener('click', (e) => {
            if (!this.searchInput.contains(e.target) && !this.dropdown.contains(e.target)) {
                this.hideDropdown();
            }
        });

        console.log(`✅ Universal autocomplete filter initialized for ${this.displayField} (entity: ${this.entityType})`);
    }

    async performSearch(query, limit) {
        const cacheKey = `${query}_${limit}`;

        // Check cache
        if (this.searchCache.has(cacheKey)) {
            this.displayResults(this.searchCache.get(cacheKey));
            return;
        }

        this.showLoading();

        try {
            const url = `${this.config.api_endpoint}?q=${encodeURIComponent(query)}&limit=${limit}`;
            const response = await fetch(url);
            const data = await response.json();

            if (data.success && data.results) {
                this.searchCache.set(cacheKey, data.results);
                this.displayResults(data.results);
            } else {
                this.showNoResults();
            }
        } catch (error) {
            console.error('Patient search error:', error);
            this.showError();
        } finally {
            this.hideLoading();
        }
    }

    displayResults(results) {
        if (!results || results.length === 0) {
            this.showNoResults();
            return;
        }

        this.dropdown.innerHTML = '';

        results.forEach(patient => {
            const item = document.createElement('div');
            item.className = 'universal-autocomplete-item';

            // Build status badge HTML if status exists
            let statusBadge = '';
            if (patient.status && patient.status !== 'active') {
                const badgeColor = patient.status === 'deleted' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                statusBadge = `<span class="text-xs px-2 py-0.5 rounded ${badgeColor} ml-2">${patient.status.toUpperCase()}</span>`;
            }

            item.innerHTML = `
                <div class="patient-name">
                    ${patient.display || patient.patient_name}
                    ${statusBadge}
                </div>
                ${patient.mrn ? `<div class="patient-mrn">MRN: ${patient.mrn}</div>` : ''}
            `;

            item.addEventListener('click', () => {
                this.selectPatient(patient);
            });

            this.dropdown.appendChild(item);
        });

        this.showDropdown();
    }

    selectPatient(patient) {
        // Store UUID in the input value (this gets submitted as patient_name=uuid)
        const uuidValue = patient[this.config.value_field] || patient.value;
        this.searchInput.value = uuidValue;

        // Store display name in data attribute for reference
        const displayName = patient.display || patient.patient_name || patient.label;
        this.searchInput.dataset.displayText = displayName;

        this.hideDropdown();

        console.log(`✅ ${this.entityType} selected: ${displayName} (UUID: ${uuidValue})`);

        // ✅ CRITICAL: Submit filter form to apply the filter
        const filterForm = this.searchInput.closest('form');
        if (filterForm) {
            console.log(`✅ Submitting filter form for ${this.entityType} filter (patient_name=${uuidValue})`);
            filterForm.submit();
        }
    }

    showLoading() {
        this.loadingIcon?.classList.remove('hidden');
    }

    hideLoading() {
        this.loadingIcon?.classList.add('hidden');
    }

    showDropdown() {
        this.dropdown.classList.remove('hidden');
    }

    hideDropdown() {
        this.dropdown.classList.add('hidden');
    }

    showNoResults() {
        this.dropdown.innerHTML = '<div class="patient-autocomplete-item text-center text-gray-500 dark:text-gray-400">No patients found</div>';
        this.showDropdown();
    }

    showError() {
        this.dropdown.innerHTML = '<div class="patient-autocomplete-item text-center text-red-500">Search failed. Please try again.</div>';
        this.showDropdown();
    }
}

// Auto-initialize all universal autocomplete filters
document.addEventListener('DOMContentLoaded', function() {
    const autocompleteSearchInputs = document.querySelectorAll('.universal-autocomplete-search');

    autocompleteSearchInputs.forEach(input => {
        new UniversalAutocompleteFilter(input);
    });

    if (autocompleteSearchInputs.length > 0) {
        console.log(`✅ Initialized ${autocompleteSearchInputs.length} universal autocomplete filter(s)`);
    }
});


</script>

<style>
/* Universal Autocomplete Filter Styles - v3.0 UNIVERSAL */
.universal-autocomplete-wrapper {
    position: relative;
    overflow: visible !important;  /* CRITICAL: Allow dropdown to extend */
}

/* CRITICAL: Allow dropdown to extend beyond filter card */
.universal-filter-panel,
.filter-panel-content,
.universal-form-group {
    overflow: visible !important;
}

.universal-autocomplete-dropdown {
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    right: 0 !important;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    max-height: 300px;
    overflow-y: auto;
    z-index: 99999 !important;  /* CRITICAL: High z-index */
}

.universal-autocomplete-item {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    transition: background-color 0.15s ease-in-out;
    border-bottom: 1px solid #e5e7eb;
}

.dark .universal-autocomplete-item {
    border-bottom-color: #374151;
}

.universal-autocomplete-item:last-child {
    border-bottom: none;
}

.universal-autocomplete-item:hover {
    background-color: #f3f4f6;
}

.dark .universal-autocomplete-item:hover {
    background-color: #374151;
}

.universal-autocomplete-item .patient-name,
.universal-autocomplete-item .item-name {
    font-weight: 500;
    color: #111827;
}

.dark .universal-autocomplete-item .patient-name,
.dark .universal-autocomplete-item .item-name {
    color: #f9fafb;
}

.universal-autocomplete-item .patient-mrn,
.universal-autocomplete-item .item-code {
    font-size: 0.875rem;
    color: #6b7280;
}

.dark .patient-autocomplete-item .patient-mrn {
    color: #9ca3af;
}
</style>

</div> <!-- ✅ Close main container -->

{% endblock %} <!-- ✅ CRITICAL: Template block closure -->